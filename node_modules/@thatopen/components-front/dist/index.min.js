var t=Object.defineProperty,e=(e,i,s)=>(((e,i,s)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s})(e,"symbol"!=typeof i?i+"":i,s),s);import*as i from"@thatopen/fragments";import{DataMap as s,DataSet as n,FragmentsModels as r}from"@thatopen/fragments";import*as o from"three";import{Vector3 as a,Vector2 as l,Plane as h,Line3 as c,Box3 as d,Mesh as u,Raycaster as p,Quaternion as f,Euler as m,Matrix4 as g,Triangle as v,Sphere as _,Ray as y,BufferAttribute as w,FrontSide as b,Controls as x,Object3D as S,MeshBasicMaterial as E,LineBasicMaterial as C,CylinderGeometry as T,BoxGeometry as P,BufferGeometry as A,Float32BufferAttribute as M,OctahedronGeometry as O,Line as D,TorusGeometry as z,SphereGeometry as I,PlaneGeometry as k,DoubleSide as L,BackSide as N,OrthographicCamera as B,ShaderMaterial as U,UniformsUtils as R,WebGLRenderTarget as F,HalfFloatType as V,NoBlending as j,Clock as H,DataTexture as W,RepeatWrapping as G,MeshNormalMaterial as Z,AddEquation as Y,ZeroFactor as X,DstAlphaFactor as q,DstColorFactor as Q,CustomBlending as K,Color as J,DepthTexture as $,DepthStencilFormat as tt,UnsignedInt248Type as et,NearestFilter as it,RGBAFormat as st,UnsignedByteType as nt,RawShaderMaterial as rt,ColorManagement as ot,SRGBTransfer as at,LinearToneMapping as lt,ReinhardToneMapping as ht,CineonToneMapping as ct,ACESFilmicToneMapping as dt,AgXToneMapping as ut,NeutralToneMapping as pt,CustomToneMapping as ft,Texture as mt,LinearFilter as gt,InstancedBufferGeometry as vt,InstancedInterleavedBuffer as _t,InterleavedBufferAttribute as yt,WireframeGeometry as wt,ShaderLib as bt,UniformsLib as xt,Vector4 as St,MathUtils as Et}from"three";import*as Ct from"web-ifc";var Tt=Object.defineProperty,Pt=(t,e,i)=>(((t,e,i)=>{e in t?Tt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i})(t,"symbol"!=typeof e?e+"":e,i),i);let At=class{constructor(){Pt(this,"enabled",!0),Pt(this,"trigger",t=>{if(!this.enabled)return;const e=this.handlers.slice(0);for(const i of e)i(t)}),Pt(this,"handlers",[])}add(t){this.handlers.push(t)}remove(t){this.handlers=this.handlers.filter(e=>e!==t)}reset(){this.handlers.length=0}};class Mt{constructor(t){Pt(this,"isDisposeable",()=>"dispose"in this&&"onDisposed"in this),Pt(this,"isResizeable",()=>"resize"in this&&"getSize"in this),Pt(this,"isUpdateable",()=>"onAfterUpdate"in this&&"onBeforeUpdate"in this&&"update"in this),Pt(this,"isHideable",()=>"visible"in this),Pt(this,"isConfigurable",()=>"setup"in this&&"config"in this&&"onSetup"in this),Pt(this,"isSerializable",()=>"import"in this&&"export"in this),this.components=t}}class Ot extends Mt{}class Dt extends Mt{constructor(t){super(t),Pt(this,"worlds",new s),Pt(this,"onWorldChanged",new At),Pt(this,"_currentWorld",null),this.onWorldChanged.add(({world:t,action:e})=>{"removed"===e&&this.worlds.delete(t.uuid)})}set currentWorld(t){this._currentWorld=t}get currentWorld(){return this._currentWorld}}class zt extends Dt{constructor(){super(...arguments),Pt(this,"hasCameraControls",()=>"controls"in this)}}class It extends Dt{constructor(){super(...arguments),Pt(this,"onAfterUpdate",new At),Pt(this,"onBeforeUpdate",new At),Pt(this,"onDisposed",new At),Pt(this,"onResize",new At),Pt(this,"onClippingPlanesUpdated",new At),Pt(this,"clippingPlanes",[])}updateClippingPlanes(){this.onClippingPlanesUpdated.trigger()}setPlane(t,e,i){e.isLocal=i;const s=this.clippingPlanes.indexOf(e);t&&-1===s?this.clippingPlanes.push(e):!t&&s>-1&&this.clippingPlanes.splice(s,1),this.three.clippingPlanes=this.clippingPlanes.filter(t=>!t.isLocal)}}const kt=class t extends Ot{constructor(e){super(e),Pt(this,"_disposedComponents",new Set),Pt(this,"enabled",!0),e.add(t.uuid,this)}get(){return this._disposedComponents}destroy(t,e=!0,i=!0){t.removeFromParent();const s=t;s.dispose&&s.dispose(),this.disposeGeometryAndMaterials(t,e),i&&s.children&&s.children.length&&this.disposeChildren(s),t.children.length=0}disposeGeometry(t){t.boundsTree&&t.disposeBoundsTree&&t.disposeBoundsTree(),t.dispose()}disposeGeometryAndMaterials(e,i){const s=e;s.geometry&&this.disposeGeometry(s.geometry),i&&s.material&&t.disposeMaterial(s),s.material=[],s.geometry=null}disposeChildren(t){for(const e of t.children)this.destroy(e)}static disposeMaterial(t){if(t.material)if(Array.isArray(t.material))for(const e of t.material)e.dispose();else t.material.dispose()}};Pt(kt,"uuid","76e9cd8e-ad8f-4753-9ef6-cbc60f7247fe");let Lt=kt;const Nt=class t{static create(){const e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return`${t._lut[255&e]+t._lut[e>>8&255]+t._lut[e>>16&255]+t._lut[e>>24&255]}-${t._lut[255&i]}${t._lut[i>>8&255]}-${t._lut[i>>16&15|64]}${t._lut[i>>24&255]}-${t._lut[63&s|128]}${t._lut[s>>8&255]}-${t._lut[s>>16&255]}${t._lut[s>>24&255]}${t._lut[255&n]}${t._lut[n>>8&255]}${t._lut[n>>16&255]}${t._lut[n>>24&255]}`.toLowerCase()}static validate(e){if(!t._pattern.test(e))throw new Error(`${e} is not a valid UUID v4.\n\n- If you're the tool creator, you can take one from https://www.uuidgenerator.net/.\n\n- If you're using a platform tool, verify the uuid isn't misspelled or contact the tool creator.`)}};Pt(Nt,"_pattern",/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/),Pt(Nt,"_lut",["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"]);let Bt=Nt;var Ut=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Rt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Ft={},Vt={};!function(t){const e=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",i="["+e+"]["+(e+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*",s=new RegExp("^"+i+"$");t.isExist=function(t){return typeof t<"u"},t.isEmptyObject=function(t){return 0===Object.keys(t).length},t.merge=function(t,e,i){if(e){const s=Object.keys(e),n=s.length;for(let r=0;r<n;r++)t[s[r]]="strict"===i?[e[s[r]]]:e[s[r]]}},t.getValue=function(e){return t.isExist(e)?e:""},t.isName=function(t){const e=s.exec(t);return!(null===e||typeof e>"u")},t.getAllMatches=function(t,e){const i=[];let s=e.exec(t);for(;s;){const n=[];n.startIndex=e.lastIndex-s[0].length;const r=s.length;for(let t=0;t<r;t++)n.push(s[t]);i.push(n),s=e.exec(t)}return i},t.nameRegexp=i}(Vt);const jt=Vt,Ht={allowBooleanAttributes:!1,unpairedTags:[]};function Wt(t){return" "===t||"\t"===t||"\n"===t||"\r"===t}function Gt(t,e){const i=e;for(;e<t.length;e++)if("?"==t[e]||" "==t[e]){const s=t.substr(i,e-i);if(e>5&&"xml"===s)return $t("InvalidXml","XML declaration allowed only at the start of the document.",ie(t,e));if("?"==t[e]&&">"==t[e+1]){e++;break}continue}return e}function Zt(t,e){if(t.length>e+5&&"-"===t[e+1]&&"-"===t[e+2]){for(e+=3;e<t.length;e++)if("-"===t[e]&&"-"===t[e+1]&&">"===t[e+2]){e+=2;break}}else if(t.length>e+8&&"D"===t[e+1]&&"O"===t[e+2]&&"C"===t[e+3]&&"T"===t[e+4]&&"Y"===t[e+5]&&"P"===t[e+6]&&"E"===t[e+7]){let i=1;for(e+=8;e<t.length;e++)if("<"===t[e])i++;else if(">"===t[e]&&(i--,0===i))break}else if(t.length>e+9&&"["===t[e+1]&&"C"===t[e+2]&&"D"===t[e+3]&&"A"===t[e+4]&&"T"===t[e+5]&&"A"===t[e+6]&&"["===t[e+7])for(e+=8;e<t.length;e++)if("]"===t[e]&&"]"===t[e+1]&&">"===t[e+2]){e+=2;break}return e}Ft.validate=function(t,e){e=Object.assign({},Ht,e);const i=[];let s=!1,n=!1;"\ufeff"===t[0]&&(t=t.substr(1));for(let r=0;r<t.length;r++)if("<"===t[r]&&"?"===t[r+1]){if(r+=2,r=Gt(t,r),r.err)return r}else{if("<"!==t[r]){if(Wt(t[r]))continue;return $t("InvalidChar","char '"+t[r]+"' is not expected.",ie(t,r))}{let o=r;if(r++,"!"===t[r]){r=Zt(t,r);continue}{let a=!1;"/"===t[r]&&(a=!0,r++);let l="";for(;r<t.length&&">"!==t[r]&&" "!==t[r]&&"\t"!==t[r]&&"\n"!==t[r]&&"\r"!==t[r];r++)l+=t[r];if(l=l.trim(),"/"===l[l.length-1]&&(l=l.substring(0,l.length-1),r--),!ee(l)){let e;return e=0===l.trim().length?"Invalid space after '<'.":"Tag '"+l+"' is an invalid name.",$t("InvalidTag",e,ie(t,r))}const h=qt(t,r);if(!1===h)return $t("InvalidAttr","Attributes for '"+l+"' have open quote.",ie(t,r));let c=h.value;if(r=h.index,"/"===c[c.length-1]){const i=r-c.length;c=c.substring(0,c.length-1);const n=Kt(c,e);if(!0!==n)return $t(n.err.code,n.err.msg,ie(t,i+n.err.line));s=!0}else if(a){if(!h.tagClosed)return $t("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",ie(t,r));if(c.trim().length>0)return $t("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",ie(t,o));if(0===i.length)return $t("InvalidTag","Closing tag '"+l+"' has not been opened.",ie(t,o));{const e=i.pop();if(l!==e.tagName){let i=ie(t,e.tagStartPos);return $t("InvalidTag","Expected closing tag '"+e.tagName+"' (opened in line "+i.line+", col "+i.col+") instead of closing tag '"+l+"'.",ie(t,o))}0==i.length&&(n=!0)}}else{const a=Kt(c,e);if(!0!==a)return $t(a.err.code,a.err.msg,ie(t,r-c.length+a.err.line));if(!0===n)return $t("InvalidXml","Multiple possible root nodes found.",ie(t,r));-1!==e.unpairedTags.indexOf(l)||i.push({tagName:l,tagStartPos:o}),s=!0}for(r++;r<t.length;r++)if("<"===t[r]){if("!"===t[r+1]){r++,r=Zt(t,r);continue}if("?"!==t[r+1])break;if(r=Gt(t,++r),r.err)return r}else if("&"===t[r]){const e=Jt(t,r);if(-1==e)return $t("InvalidChar","char '&' is not expected.",ie(t,r));r=e}else if(!0===n&&!Wt(t[r]))return $t("InvalidXml","Extra text at the end",ie(t,r));"<"===t[r]&&r--}}}return s?1==i.length?$t("InvalidTag","Unclosed tag '"+i[0].tagName+"'.",ie(t,i[0].tagStartPos)):!(i.length>0)||$t("InvalidXml","Invalid '"+JSON.stringify(i.map(t=>t.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):$t("InvalidXml","Start tag expected.",1)};const Yt='"',Xt="'";function qt(t,e){let i="",s="",n=!1;for(;e<t.length;e++){if(t[e]===Yt||t[e]===Xt)""===s?s=t[e]:s!==t[e]||(s="");else if(">"===t[e]&&""===s){n=!0;break}i+=t[e]}return""===s&&{value:i,index:e,tagClosed:n}}const Qt=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function Kt(t,e){const i=jt.getAllMatches(t,Qt),s={};for(let t=0;t<i.length;t++){if(0===i[t][1].length)return $t("InvalidAttr","Attribute '"+i[t][2]+"' has no space in starting.",se(i[t]));if(void 0!==i[t][3]&&void 0===i[t][4])return $t("InvalidAttr","Attribute '"+i[t][2]+"' is without value.",se(i[t]));if(void 0===i[t][3]&&!e.allowBooleanAttributes)return $t("InvalidAttr","boolean attribute '"+i[t][2]+"' is not allowed.",se(i[t]));const n=i[t][2];if(!te(n))return $t("InvalidAttr","Attribute '"+n+"' is an invalid name.",se(i[t]));if(s.hasOwnProperty(n))return $t("InvalidAttr","Attribute '"+n+"' is repeated.",se(i[t]));s[n]=1}return!0}function Jt(t,e){if(";"===t[++e])return-1;if("#"===t[e])return function(t,e){let i=/\d/;for("x"===t[e]&&(e++,i=/[\da-fA-F]/);e<t.length;e++){if(";"===t[e])return e;if(!t[e].match(i))break}return-1}(t,++e);let i=0;for(;e<t.length;e++,i++)if(!(t[e].match(/\w/)&&i<20)){if(";"===t[e])break;return-1}return e}function $t(t,e,i){return{err:{code:t,msg:e,line:i.line||i,col:i.col}}}function te(t){return jt.isName(t)}function ee(t){return jt.isName(t)}function ie(t,e){const i=t.substring(0,e).split(/\r?\n/);return{line:i.length,col:i[i.length-1].length+1}}function se(t){return t.startIndex+t[1].length}var ne={};const re={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(t,e,i){return t}};ne.buildOptions=function(t){return Object.assign({},re,t)},ne.defaultOptions=re;const oe=Vt;function ae(t,e){let i="";for(;e<t.length&&"'"!==t[e]&&'"'!==t[e];e++)i+=t[e];if(i=i.trim(),-1!==i.indexOf(" "))throw new Error("External entites are not supported");const s=t[e++];let n="";for(;e<t.length&&t[e]!==s;e++)n+=t[e];return[i,n,e]}function le(t,e){return"!"===t[e+1]&&"-"===t[e+2]&&"-"===t[e+3]}function he(t,e){return"!"===t[e+1]&&"E"===t[e+2]&&"N"===t[e+3]&&"T"===t[e+4]&&"I"===t[e+5]&&"T"===t[e+6]&&"Y"===t[e+7]}function ce(t,e){return"!"===t[e+1]&&"E"===t[e+2]&&"L"===t[e+3]&&"E"===t[e+4]&&"M"===t[e+5]&&"E"===t[e+6]&&"N"===t[e+7]&&"T"===t[e+8]}function de(t,e){return"!"===t[e+1]&&"A"===t[e+2]&&"T"===t[e+3]&&"T"===t[e+4]&&"L"===t[e+5]&&"I"===t[e+6]&&"S"===t[e+7]&&"T"===t[e+8]}function ue(t,e){return"!"===t[e+1]&&"N"===t[e+2]&&"O"===t[e+3]&&"T"===t[e+4]&&"A"===t[e+5]&&"T"===t[e+6]&&"I"===t[e+7]&&"O"===t[e+8]&&"N"===t[e+9]}function pe(t){if(oe.isName(t))return t;throw new Error(`Invalid entity name ${t}`)}const fe=/^[-+]?0x[a-fA-F0-9]+$/,me=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,ge={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};const ve=Vt,_e=class{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,e){"__proto__"===t&&(t="#__proto__"),this.child.push({[t]:e})}addChild(t){"__proto__"===t.tagname&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child})}},ye=function(t,e){const i={};if("O"!==t[e+3]||"C"!==t[e+4]||"T"!==t[e+5]||"Y"!==t[e+6]||"P"!==t[e+7]||"E"!==t[e+8])throw new Error("Invalid Tag instead of DOCTYPE");{e+=9;let s=1,n=!1,r=!1,o="";for(;e<t.length;e++)if("<"!==t[e]||r)if(">"===t[e]){if(r?"-"===t[e-1]&&"-"===t[e-2]&&(r=!1,s--):s--,0===s)break}else"["===t[e]?n=!0:o+=t[e];else{if(n&&he(t,e))e+=7,[entityName,val,e]=ae(t,e+1),-1===val.indexOf("&")&&(i[pe(entityName)]={regx:RegExp(`&${entityName};`,"g"),val:val});else if(n&&ce(t,e))e+=8;else if(n&&de(t,e))e+=8;else if(n&&ue(t,e))e+=9;else{if(!le)throw new Error("Invalid DOCTYPE");r=!0}s++,o=""}if(0!==s)throw new Error("Unclosed DOCTYPE")}return{entities:i,i:e}},we=function(t,e={}){if(e=Object.assign({},ge,e),!t||"string"!=typeof t)return t;let i=t.trim();if(void 0!==e.skipLike&&e.skipLike.test(i))return t;if("0"===t)return 0;if(e.hex&&fe.test(i))return function(t,e){if(parseInt)return parseInt(t,e);if(Number.parseInt)return Number.parseInt(t,e);if(window&&window.parseInt)return window.parseInt(t,e);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(i,16);if(-1!==i.search(/[eE]/)){const s=i.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(s){if(e.leadingZeros)i=(s[1]||"")+s[3];else if("0"!==s[2]||"."!==s[3][0])return t;return e.eNotation?Number(i):t}return t}{const s=me.exec(i);if(s){const n=s[1],r=s[2];let o=function(t){return t&&-1!==t.indexOf(".")&&(t=t.replace(/0+$/,""),"."===t?t="0":"."===t[0]?t="0"+t:"."===t[t.length-1]&&(t=t.substr(0,t.length-1))),t}(s[3]);if(!e.leadingZeros&&r.length>0&&n&&"."!==i[2])return t;if(!e.leadingZeros&&r.length>0&&!n&&"."!==i[1])return t;if(e.leadingZeros&&r===t)return 0;{const s=Number(i),a=""+s;return-1!==a.search(/[eE]/)?e.eNotation?s:t:-1!==i.indexOf(".")?"0"===a&&""===o||a===o||n&&a==="-"+o?s:t:r?o===a||n+o===a?s:t:i===a||i===n+a?s:t}}return t}};function be(t){const e=Object.keys(t);for(let i=0;i<e.length;i++){const s=e[i];this.lastEntities[s]={regex:new RegExp("&"+s+";","g"),val:t[s]}}}function xe(t,e,i,s,n,r,o){if(void 0!==t&&(this.options.trimValues&&!s&&(t=t.trim()),t.length>0)){o||(t=this.replaceEntitiesValue(t));const s=this.options.tagValueProcessor(e,t,i,n,r);return null==s?t:typeof s!=typeof t||s!==t?s:this.options.trimValues||t.trim()===t?ke(t,this.options.parseTagValue,this.options.numberParseOptions):t}}function Se(t){if(this.options.removeNSPrefix){const e=t.split(":"),i="/"===t.charAt(0)?"/":"";if("xmlns"===e[0])return"";2===e.length&&(t=i+e[1])}return t}const Ee=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function Ce(t,e,i){if(!this.options.ignoreAttributes&&"string"==typeof t){const i=ve.getAllMatches(t,Ee),s=i.length,n={};for(let t=0;t<s;t++){const s=this.resolveNameSpace(i[t][1]);let r=i[t][4],o=this.options.attributeNamePrefix+s;if(s.length)if(this.options.transformAttributeName&&(o=this.options.transformAttributeName(o)),"__proto__"===o&&(o="#__proto__"),void 0!==r){this.options.trimValues&&(r=r.trim()),r=this.replaceEntitiesValue(r);const t=this.options.attributeValueProcessor(s,r,e);n[o]=null==t?r:typeof t!=typeof r||t!==r?t:ke(r,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(n[o]=!0)}if(!Object.keys(n).length)return;if(this.options.attributesGroupName){const t={};return t[this.options.attributesGroupName]=n,t}return n}}const Te=function(t){t=t.replace(/\r\n?/g,"\n");const e=new _e("!xml");let i=e,s="",n="";for(let r=0;r<t.length;r++)if("<"===t[r])if("/"===t[r+1]){const e=De(t,">",r,"Closing Tag is not closed.");let o=t.substring(r+2,e).trim();if(this.options.removeNSPrefix){const t=o.indexOf(":");-1!==t&&(o=o.substr(t+1))}this.options.transformTagName&&(o=this.options.transformTagName(o)),i&&(s=this.saveTextToParentTag(s,i,n));const a=n.substring(n.lastIndexOf(".")+1);if(o&&-1!==this.options.unpairedTags.indexOf(o))throw new Error(`Unpaired tag can not be used as closing tag: </${o}>`);let l=0;a&&-1!==this.options.unpairedTags.indexOf(a)?(l=n.lastIndexOf(".",n.lastIndexOf(".")-1),this.tagsNodeStack.pop()):l=n.lastIndexOf("."),n=n.substring(0,l),i=this.tagsNodeStack.pop(),s="",r=e}else if("?"===t[r+1]){let e=ze(t,r,!1,"?>");if(!e)throw new Error("Pi Tag is not closed.");if(s=this.saveTextToParentTag(s,i,n),!(this.options.ignoreDeclaration&&"?xml"===e.tagName||this.options.ignorePiTags)){const t=new _e(e.tagName);t.add(this.options.textNodeName,""),e.tagName!==e.tagExp&&e.attrExpPresent&&(t[":@"]=this.buildAttributesMap(e.tagExp,n,e.tagName)),this.addChild(i,t,n)}r=e.closeIndex+1}else if("!--"===t.substr(r+1,3)){const e=De(t,"--\x3e",r+4,"Comment is not closed.");if(this.options.commentPropName){const o=t.substring(r+4,e-2);s=this.saveTextToParentTag(s,i,n),i.add(this.options.commentPropName,[{[this.options.textNodeName]:o}])}r=e}else if("!D"===t.substr(r+1,2)){const e=ye(t,r);this.docTypeEntities=e.entities,r=e.i}else if("!["===t.substr(r+1,2)){const e=De(t,"]]>",r,"CDATA is not closed.")-2,o=t.substring(r+9,e);s=this.saveTextToParentTag(s,i,n);let a=this.parseTextData(o,i.tagname,n,!0,!1,!0,!0);null==a&&(a=""),this.options.cdataPropName?i.add(this.options.cdataPropName,[{[this.options.textNodeName]:o}]):i.add(this.options.textNodeName,a),r=e+2}else{let o=ze(t,r,this.options.removeNSPrefix),a=o.tagName;const l=o.rawTagName;let h=o.tagExp,c=o.attrExpPresent,d=o.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),i&&s&&"!xml"!==i.tagname&&(s=this.saveTextToParentTag(s,i,n,!1));const u=i;if(u&&-1!==this.options.unpairedTags.indexOf(u.tagname)&&(i=this.tagsNodeStack.pop(),n=n.substring(0,n.lastIndexOf("."))),a!==e.tagname&&(n+=n?"."+a:a),this.isItStopNode(this.options.stopNodes,n,a)){let e="";if(h.length>0&&h.lastIndexOf("/")===h.length-1)"/"===a[a.length-1]?(a=a.substr(0,a.length-1),n=n.substr(0,n.length-1),h=a):h=h.substr(0,h.length-1),r=o.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(a))r=o.closeIndex;else{const i=this.readStopNodeData(t,l,d+1);if(!i)throw new Error(`Unexpected end of ${l}`);r=i.i,e=i.tagContent}const s=new _e(a);a!==h&&c&&(s[":@"]=this.buildAttributesMap(h,n,a)),e&&(e=this.parseTextData(e,a,n,!0,c,!0,!0)),n=n.substr(0,n.lastIndexOf(".")),s.add(this.options.textNodeName,e),this.addChild(i,s,n)}else{if(h.length>0&&h.lastIndexOf("/")===h.length-1){"/"===a[a.length-1]?(a=a.substr(0,a.length-1),n=n.substr(0,n.length-1),h=a):h=h.substr(0,h.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const t=new _e(a);a!==h&&c&&(t[":@"]=this.buildAttributesMap(h,n,a)),this.addChild(i,t,n),n=n.substr(0,n.lastIndexOf("."))}else{const t=new _e(a);this.tagsNodeStack.push(i),a!==h&&c&&(t[":@"]=this.buildAttributesMap(h,n,a)),this.addChild(i,t,n),i=t}s="",r=d}}else s+=t[r];return e.child};function Pe(t,e,i){const s=this.options.updateTag(e.tagname,i,e[":@"]);!1===s||("string"==typeof s&&(e.tagname=s),t.addChild(e))}const Ae=function(t){if(this.options.processEntities){for(let e in this.docTypeEntities){const i=this.docTypeEntities[e];t=t.replace(i.regx,i.val)}for(let e in this.lastEntities){const i=this.lastEntities[e];t=t.replace(i.regex,i.val)}if(this.options.htmlEntities)for(let e in this.htmlEntities){const i=this.htmlEntities[e];t=t.replace(i.regex,i.val)}t=t.replace(this.ampEntity.regex,this.ampEntity.val)}return t};function Me(t,e,i,s){return t&&(void 0===s&&(s=0===Object.keys(e.child).length),void 0!==(t=this.parseTextData(t,e.tagname,i,!1,!!e[":@"]&&0!==Object.keys(e[":@"]).length,s))&&""!==t&&e.add(this.options.textNodeName,t),t=""),t}function Oe(t,e,i){const s="*."+i;for(const i in t){const n=t[i];if(s===n||e===n)return!0}return!1}function De(t,e,i,s){const n=t.indexOf(e,i);if(-1===n)throw new Error(s);return n+e.length-1}function ze(t,e,i,s=">"){const n=function(t,e,i=">"){let s,n="";for(let r=e;r<t.length;r++){let e=t[r];if(s)e===s&&(s="");else if('"'===e||"'"===e)s=e;else if(e===i[0]){if(!i[1])return{data:n,index:r};if(t[r+1]===i[1])return{data:n,index:r}}else"\t"===e&&(e=" ");n+=e}}(t,e+1,s);if(!n)return;let r=n.data;const o=n.index,a=r.search(/\s/);let l=r,h=!0;-1!==a&&(l=r.substring(0,a),r=r.substring(a+1).trimStart());const c=l;if(i){const t=l.indexOf(":");-1!==t&&(l=l.substr(t+1),h=l!==n.data.substr(t+1))}return{tagName:l,tagExp:r,closeIndex:o,attrExpPresent:h,rawTagName:c}}function Ie(t,e,i){const s=i;let n=1;for(;i<t.length;i++)if("<"===t[i])if("/"===t[i+1]){const r=De(t,">",i,`${e} is not closed`);if(t.substring(i+2,r).trim()===e&&(n--,0===n))return{tagContent:t.substring(s,i),i:r};i=r}else if("?"===t[i+1])i=De(t,"?>",i+1,"StopNode is not closed.");else if("!--"===t.substr(i+1,3))i=De(t,"--\x3e",i+3,"StopNode is not closed.");else if("!["===t.substr(i+1,2))i=De(t,"]]>",i,"StopNode is not closed.")-2;else{const s=ze(t,i,">");s&&((s&&s.tagName)===e&&"/"!==s.tagExp[s.tagExp.length-1]&&n++,i=s.closeIndex)}}function ke(t,e,i){if(e&&"string"==typeof t){const e=t.trim();return"true"===e||"false"!==e&&we(t,i)}return ve.isExist(t)?t:""}var Le=class{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(t,e)=>String.fromCharCode(Number.parseInt(e,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(t,e)=>String.fromCharCode(Number.parseInt(e,16))}},this.addExternalEntities=be,this.parseXml=Te,this.parseTextData=xe,this.resolveNameSpace=Se,this.buildAttributesMap=Ce,this.isItStopNode=Oe,this.replaceEntitiesValue=Ae,this.readStopNodeData=Ie,this.saveTextToParentTag=Me,this.addChild=Pe}},Ne={};function Be(t,e,i){let s;const n={};for(let r=0;r<t.length;r++){const o=t[r],a=Ue(o);let l="";if(l=void 0===i?a:i+"."+a,a===e.textNodeName)void 0===s?s=o[a]:s+=""+o[a];else{if(void 0===a)continue;if(o[a]){let t=Be(o[a],e,l);const i=Fe(t,e);o[":@"]?Re(t,o[":@"],l,e):1!==Object.keys(t).length||void 0===t[e.textNodeName]||e.alwaysCreateTextNode?0===Object.keys(t).length&&(e.alwaysCreateTextNode?t[e.textNodeName]="":t=""):t=t[e.textNodeName],void 0!==n[a]&&n.hasOwnProperty(a)?(Array.isArray(n[a])||(n[a]=[n[a]]),n[a].push(t)):e.isArray(a,l,i)?n[a]=[t]:n[a]=t}}}return"string"==typeof s?s.length>0&&(n[e.textNodeName]=s):void 0!==s&&(n[e.textNodeName]=s),n}function Ue(t){const e=Object.keys(t);for(let t=0;t<e.length;t++){const i=e[t];if(":@"!==i)return i}}function Re(t,e,i,s){if(e){const n=Object.keys(e),r=n.length;for(let o=0;o<r;o++){const r=n[o];s.isArray(r,i+"."+r,!0,!0)?t[r]=[e[r]]:t[r]=e[r]}}}function Fe(t,e){const{textNodeName:i}=e,s=Object.keys(t).length;return!(0!==s&&(1!==s||!t[i]&&"boolean"!=typeof t[i]&&0!==t[i]))}Ne.prettify=function(t,e){return Be(t,e)};const{buildOptions:Ve}=ne,je=Le,{prettify:He}=Ne,We=Ft;var Ge=class{constructor(t){this.externalEntities={},this.options=Ve(t)}parse(t,e){if("string"!=typeof t){if(!t.toString)throw new Error("XML data is accepted in String or Bytes[] form.");t=t.toString()}if(e){!0===e&&(e={});const i=We.validate(t,e);if(!0!==i)throw Error(`${i.err.msg}:${i.err.line}:${i.err.col}`)}const i=new je(this.options);i.addExternalEntities(this.externalEntities);const s=i.parseXml(t);return this.options.preserveOrder||void 0===s?s:He(s,this.options)}addEntity(t,e){if(-1!==e.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==t.indexOf("&")||-1!==t.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===e)throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=e}};function Ze(t,e,i,s){let n="",r=!1;for(let o=0;o<t.length;o++){const a=t[o],l=Ye(a);if(void 0===l)continue;let h="";if(h=0===i.length?l:`${i}.${l}`,l===e.textNodeName){let t=a[l];qe(h,e)||(t=e.tagValueProcessor(l,t),t=Qe(t,e)),r&&(n+=s),n+=t,r=!1;continue}if(l===e.cdataPropName){r&&(n+=s),n+=`<![CDATA[${a[l][0][e.textNodeName]}]]>`,r=!1;continue}if(l===e.commentPropName){n+=s+`\x3c!--${a[l][0][e.textNodeName]}--\x3e`,r=!0;continue}if("?"===l[0]){const t=Xe(a[":@"],e),i="?xml"===l?"":s;let o=a[l][0][e.textNodeName];o=0!==o.length?" "+o:"",n+=i+`<${l}${o}${t}?>`,r=!0;continue}let c=s;""!==c&&(c+=e.indentBy);const d=s+`<${l}${Xe(a[":@"],e)}`,u=Ze(a[l],e,h,c);-1!==e.unpairedTags.indexOf(l)?e.suppressUnpairedNode?n+=d+">":n+=d+"/>":u&&0!==u.length||!e.suppressEmptyNode?u&&u.endsWith(">")?n+=d+`>${u}${s}</${l}>`:(n+=d+">",u&&""!==s&&(u.includes("/>")||u.includes("</"))?n+=s+e.indentBy+u+s:n+=u,n+=`</${l}>`):n+=d+"/>",r=!0}return n}function Ye(t){const e=Object.keys(t);for(let i=0;i<e.length;i++){const s=e[i];if(t.hasOwnProperty(s)&&":@"!==s)return s}}function Xe(t,e){let i="";if(t&&!e.ignoreAttributes)for(let s in t){if(!t.hasOwnProperty(s))continue;let n=e.attributeValueProcessor(s,t[s]);n=Qe(n,e),!0===n&&e.suppressBooleanAttributes?i+=` ${s.substr(e.attributeNamePrefix.length)}`:i+=` ${s.substr(e.attributeNamePrefix.length)}="${n}"`}return i}function qe(t,e){let i=(t=t.substr(0,t.length-e.textNodeName.length-1)).substr(t.lastIndexOf(".")+1);for(let s in e.stopNodes)if(e.stopNodes[s]===t||e.stopNodes[s]==="*."+i)return!0;return!1}function Qe(t,e){if(t&&t.length>0&&e.processEntities)for(let i=0;i<e.entities.length;i++){const s=e.entities[i];t=t.replace(s.regex,s.val)}return t}const Ke=function(t,e){let i="";return e.format&&e.indentBy.length>0&&(i="\n"),Ze(t,e,"",i)},Je={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function $e(t){this.options=Object.assign({},Je,t),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=ii),this.processTextOrObjNode=ti,this.options.format?(this.indentate=ei,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function ti(t,e,i){const s=this.j2x(t,i+1);return void 0!==t[this.options.textNodeName]&&1===Object.keys(t).length?this.buildTextValNode(t[this.options.textNodeName],e,s.attrStr,i):this.buildObjectNode(s.val,e,s.attrStr,i)}function ei(t){return this.options.indentBy.repeat(t)}function ii(t){return!(!t.startsWith(this.options.attributeNamePrefix)||t===this.options.textNodeName)&&t.substr(this.attrPrefixLen)}$e.prototype.build=function(t){return this.options.preserveOrder?Ke(t,this.options):(Array.isArray(t)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(t={[this.options.arrayNodeName]:t}),this.j2x(t,0).val)},$e.prototype.j2x=function(t,e){let i="",s="";for(let n in t)if(Object.prototype.hasOwnProperty.call(t,n))if(typeof t[n]>"u")this.isAttribute(n)&&(s+="");else if(null===t[n])this.isAttribute(n)?s+="":"?"===n[0]?s+=this.indentate(e)+"<"+n+"?"+this.tagEndChar:s+=this.indentate(e)+"<"+n+"/"+this.tagEndChar;else if(t[n]instanceof Date)s+=this.buildTextValNode(t[n],n,"",e);else if("object"!=typeof t[n]){const r=this.isAttribute(n);if(r)i+=this.buildAttrPairStr(r,""+t[n]);else if(n===this.options.textNodeName){let e=this.options.tagValueProcessor(n,""+t[n]);s+=this.replaceEntitiesValue(e)}else s+=this.buildTextValNode(t[n],n,"",e)}else if(Array.isArray(t[n])){const i=t[n].length;let r="",o="";for(let a=0;a<i;a++){const i=t[n][a];if(!(typeof i>"u"))if(null===i)"?"===n[0]?s+=this.indentate(e)+"<"+n+"?"+this.tagEndChar:s+=this.indentate(e)+"<"+n+"/"+this.tagEndChar;else if("object"==typeof i)if(this.options.oneListGroup){const t=this.j2x(i,e+1);r+=t.val,this.options.attributesGroupName&&i.hasOwnProperty(this.options.attributesGroupName)&&(o+=t.attrStr)}else r+=this.processTextOrObjNode(i,n,e);else if(this.options.oneListGroup){let t=this.options.tagValueProcessor(n,i);t=this.replaceEntitiesValue(t),r+=t}else r+=this.buildTextValNode(i,n,"",e)}this.options.oneListGroup&&(r=this.buildObjectNode(r,n,o,e)),s+=r}else if(this.options.attributesGroupName&&n===this.options.attributesGroupName){const e=Object.keys(t[n]),s=e.length;for(let r=0;r<s;r++)i+=this.buildAttrPairStr(e[r],""+t[n][e[r]])}else s+=this.processTextOrObjNode(t[n],n,e);return{attrStr:i,val:s}},$e.prototype.buildAttrPairStr=function(t,e){return e=this.options.attributeValueProcessor(t,""+e),e=this.replaceEntitiesValue(e),this.options.suppressBooleanAttributes&&"true"===e?" "+t:" "+t+'="'+e+'"'},$e.prototype.buildObjectNode=function(t,e,i,s){if(""===t)return"?"===e[0]?this.indentate(s)+"<"+e+i+"?"+this.tagEndChar:this.indentate(s)+"<"+e+i+this.closeTag(e)+this.tagEndChar;{let n="</"+e+this.tagEndChar,r="";return"?"===e[0]&&(r="?",n=""),!i&&""!==i||-1!==t.indexOf("<")?!1!==this.options.commentPropName&&e===this.options.commentPropName&&0===r.length?this.indentate(s)+`\x3c!--${t}--\x3e`+this.newLine:this.indentate(s)+"<"+e+i+r+this.tagEndChar+t+this.indentate(s)+n:this.indentate(s)+"<"+e+i+r+">"+t+n}},$e.prototype.closeTag=function(t){let e="";return-1!==this.options.unpairedTags.indexOf(t)?this.options.suppressUnpairedNode||(e="/"):e=this.options.suppressEmptyNode?"/":`></${t}`,e},$e.prototype.buildTextValNode=function(t,e,i,s){if(!1!==this.options.cdataPropName&&e===this.options.cdataPropName)return this.indentate(s)+`<![CDATA[${t}]]>`+this.newLine;if(!1!==this.options.commentPropName&&e===this.options.commentPropName)return this.indentate(s)+`\x3c!--${t}--\x3e`+this.newLine;if("?"===e[0])return this.indentate(s)+"<"+e+i+"?"+this.tagEndChar;{let n=this.options.tagValueProcessor(e,t);return n=this.replaceEntitiesValue(n),""===n?this.indentate(s)+"<"+e+i+this.closeTag(e)+this.tagEndChar:this.indentate(s)+"<"+e+i+">"+n+"</"+e+this.tagEndChar}},$e.prototype.replaceEntitiesValue=function(t){if(t&&t.length>0&&this.options.processEntities)for(let e=0;e<this.options.entities.length;e++){const i=this.options.entities[e];t=t.replace(i.regex,i.val)}return t};var si={XMLParser:Ge,XMLBuilder:$e};class ni{}Pt(ni,"parser",new si.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0})),Pt(ni,"builder",new si.XMLBuilder({attributeNamePrefix:"$",ignoreAttributes:!1,suppressBooleanAttributes:!1}));class ri{static join(t){const e={};for(const i of t)for(const t in i)if(e[t])for(const s of i[t])e[t].add(s);else e[t]=new Set(i[t]);return e}static intersect(t){if(0===t.length)return{};let e=ri.clone(t[0]);for(let i=1;i<t.length;i++){const s=t[i],n={};for(const t in e)if(s[t]){const i=new Set;for(const n of e[t])s[t].has(n)&&i.add(n);i.size>0&&(n[t]=i)}e=n}return e}static clone(t){const e={};for(const i in t)e[i]=new Set(t[i]);return e}static remove(t,e,i=!1){i&&(t=ri.clone(t));for(const i in e)if(t[i]){for(const s of e[i])t[i].delete(s);0===t[i].size&&delete t[i]}}static add(t,e,i=!1){i&&(t=ri.clone(t));for(const i in e)if(t[i])for(const s of e[i])t[i].add(s);else t[i]=new Set(e[i])}static append(t,e,...i){let s=t[e];s||(s=new Set,t[e]=s);for(const t of i)s.add(t)}static isEqual(t,e){const i=Object.keys(t),s=Object.keys(e);if(i.length!==s.length)return!1;for(const s of i){if(!e[s]||t[s].size!==e[s].size)return!1;for(const i of t[s])if(!e[s].has(i))return!1}return!0}static isEmpty(t){return 0===Object.values(t).reduce((t,e)=>t+e.size,0)}static toRaw(t){const e={};for(const i in t)e[i]=Array.from(t[i]);return e}static fromRaw(t){const e={};for(const i in t)e[i]=new Set(t[i]);return e}}class oi{static isEntry(t){return new Set(["Boolean","Color","Text","Number","Select","Vector3","TextSet","None"]).has(t.type)}static copySchema(t,e={}){for(const i in t){const s=t[i];this.isEntry(s)?e[i]=this.copyEntry(s):(e[i]={},this.copySchema(s,e[i]))}return e}static copyEntry(t){if("Boolean"===t.type){const e=t;return{type:e.type,value:e.value}}if("Color"===t.type){const e=t;return{type:e.type,value:e.value.clone()}}if("Text"===t.type){const e=t;return{type:e.type,value:e.value}}if("Number"===t.type){const e=t;return{type:e.type,value:e.value,min:e.min,max:e.max,interpolable:e.interpolable}}if("Select"===t.type){const e=t;return{type:e.type,value:e.value,multiple:e.multiple,options:new Set(e.options)}}if("Vector3"===t.type){const e=t;return{type:e.type,value:e.value.clone()}}if("TextSet"===t.type){const e=t;return{type:e.type,value:new Set(e.value)}}if("None"===t.type){const e=t;return{type:e.type,value:e.value}}throw new Error("Invalid entry!")}}class ai{constructor(){Pt(this,"list",new Set)}add(t){for(const e of t)this.list.add(e)}remove(t){for(const e of t)this.list.delete(e)}set(t){for(const e of this.list)e.enabled=t}reset(){for(const t of this.list)t.reset()}}class li{constructor(t,e,i,s){Pt(this,"_component"),Pt(this,"name"),Pt(this,"uuid"),this._component=t,this.name=i,this.uuid=s??Bt.create(),e.get(ci).list.set(this.uuid,this)}get controls(){return oi.copySchema(this._config)}set(t){for(const e in t)if(e in this){this[e]=t[e].value}}export(t=this._config,e={}){for(const i in t){const s=t[i];if(oi.isEntry(s))if("Color"===s.type){const{r:t,g:n,b:r}=s.value;e[i]={...s,value:{r:t,g:n,b:r}}}else if("Vector3"===s.type){const{x:t,y:n,z:r}=s.value;e[i]={...s,value:{x:t,y:n,z:r}}}else if("TextSet"===s.type){const t=Array.from(s.value);e[i]={...s,value:t}}else if("Select"===s.type){const t=Array.from(s.options);e[i]={...s,options:t}}else e[i]={...s};else e[i]={},this.export(s,e[i])}return e}import(t,e={},i=!0){for(const i in t){const s=t[i];if(oi.isEntry(s))if("Color"===s.type){const{r:t,g:n,b:r}=s.value;e[i]={...s,value:new o.Color(t,n,r)}}else if("Vector3"===s.type){const{x:t,y:n,z:r}=s.value;e[i]={...s,value:new o.Vector3(t,n,r)}}else"TextSet"===s.type?e[i]={...s,value:new Set(s.value)}:"Select"===s.type?e[i]={...s,options:new Set(s.options)}:e[i]={...s};else e[i]={},this.import(s,e[i],!1)}i&&this.set(e)}}const hi=class t extends Ot{constructor(e){super(e),Pt(this,"list",new s),Pt(this,"enabled",!0),e.add(t.uuid,this)}};Pt(hi,"uuid","b8c764e0-6b24-4e77-9a32-35fa728ee5b4");let ci=hi;class di{constructor(t){Pt(this,"_event"),Pt(this,"_position",new o.Vector2),Pt(this,"onDisposed",new At),Pt(this,"updateMouseInfo",t=>{this._event=t}),this.dom=t,this.setupEvents(!0)}get position(){return this.updatePosition(!1),this._position.clone()}get rawPosition(){return this.updatePosition(!0),this._position.clone()}dispose(){this.setupEvents(!1),this.onDisposed.trigger(),this.onDisposed.reset()}updatePosition(t){if(this._event){const e=this.dom.getBoundingClientRect();this._position.x=this.getPositionX(e,this._event,t),this._position.y=this.getPositionY(e,this._event,t)}}getPositionY(t,e,i){const s=this.getDataObject(e);return i?s.clientY:-(s.clientY-t.top)/(t.bottom-t.top)*2+1}getPositionX(t,e,i){const s=this.getDataObject(e);return i?s.clientX:(s.clientX-t.left)/(t.right-t.left)*2-1}getDataObject(t){return t instanceof MouseEvent?t:t.touches[0]}setupEvents(t){t?(this.dom.addEventListener("pointermove",this.updateMouseInfo),this.dom.addEventListener("touchstart",this.updateMouseInfo)):(this.dom.removeEventListener("pointermove",this.updateMouseInfo),this.dom.removeEventListener("touchstart",this.updateMouseInfo))}}const ui=class t extends Ot{constructor(e){super(e),Pt(this,"onDisposed",new At),Pt(this,"onBeforeDispose",new At),Pt(this,"onFragmentsLoaded",new At),Pt(this,"baseCoordinationModel",""),Pt(this,"baseCoordinationMatrix",new o.Matrix4),Pt(this,"enabled",!0),Pt(this,"_core"),this.components.add(t.uuid,this)}get initialized(){return!!this._core}get list(){return this.core.models.list}get core(){if(!this._core)throw new Error("FragmentsManager not initialized. Call init() first.");return this._core}get _hasCoordinationModel(){return""!==this.baseCoordinationModel}dispose(){this.onBeforeDispose.trigger(),this._core&&(this.core.dispose(),this._core=void 0),this.baseCoordinationModel="",this.onFragmentsLoaded.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}init(t){this._core=new r(t),this.core.onModelLoaded.add(async()=>{if(this._hasCoordinationModel)return;const t=[...this.list.values()][0];t&&(this.baseCoordinationModel=t.modelId,this.baseCoordinationMatrix=await t.getCoordinationMatrix())}),this.list.onItemDeleted.add(()=>{this.list.size>0||(this.baseCoordinationModel="",this.baseCoordinationMatrix=new o.Matrix4)})}async raycast(t){const e=[];for(const i of this.core.models.list.values())if(t.snappingClasses&&t.snappingClasses.length>0){const s=await i.raycastWithSnapping(t);if(s&&s.length>0)e.push(s[0]);else{const s=await i.raycast(t);s&&e.push(s)}}else{const s=await i.raycast(t);s&&e.push(s)}if(await Promise.all(e),0===e.length)return;let i=e[0],s=i.distance;for(let t=1;t<e.length;t++)e[t].distance<s&&(s=e[t].distance,i=e[t]);return i}async getPositions(t){const e=[],i=async(t,i)=>{const s=await t.getPositions(i);for(const t of s)e.push(t)},s=[];for(const e in t){const n=this.core.models.list.get(e);n&&s.push(i(n,Array.from(t[e])))}return await Promise.all(s),e}async getBBoxes(t){const e=[],i=async(t,i)=>{const s=await t.getBoxes(i);if(s)for(const t of s)e.push(t)},s=[];for(const e in t){const n=this.core.models.list.get(e);n&&s.push(i(n,Array.from(t[e])))}return await Promise.all(s),e}async highlight(t,e){await this.forEachModel(e,"highlight",t)}async getData(t,e){const i={};for(const[s,n]of Object.entries(t)){const t=this.list.get(s);if(!t)continue;if(0===n.size){i[s]=[];continue}const r=await t.getItemsData([...n],e);i[s]=r}return i}async resetHighlight(t){await this.forEachModel(t,"resetHighlight")}async forEachModel(t,e,...i){const s={};if(t)for(const e in t){const i=t[e];s[e]=Array.from(i)}else for(const t of this.core.models.list.keys())s[t]=void 0;const n=[];for(const t in s){const r=this.core.models.list.get(t);if(r){const o=s[t],a=r[e](o,...i);n.push(a)}}await Promise.all(n)}async guidsToModelIdMap(t){const e={};for(const[i,s]of this.list){const n=(await s.getLocalIdsByGuids([...t])).filter(t=>null!==t);e[i]=new Set(n)}return e}async modelIdMapToGuids(t){const e=[];for(const[i,s]of Object.entries(t)){const t=this.list.get(i);if(!t)continue;const n=(await t.getGuidsByLocalIds([...s])).filter(t=>null!==t);e.push(...n)}return e}applyBaseCoordinateSystem(t,e){const i=new o.Matrix4;return e&&i.copy(e.clone()).invert(),i.multiply(this.baseCoordinationMatrix),t.applyMatrix4(i),i}};Pt(ui,"uuid","fef46874-46a3-461b-8c44-2922ab77c806");let pi=ui;class fi{constructor(){Pt(this,"wasm",{path:"",absolute:!1,logLevel:Ct.LogLevel.LOG_LEVEL_OFF}),Pt(this,"webIfc",{COORDINATE_TO_ORIGIN:!0}),Pt(this,"autoSetWasm",!0),Pt(this,"customLocateFileHandler",null)}}Pt(class t extends Ot{constructor(e){super(e),Pt(this,"onDisposed",new At),Pt(this,"onIfcStartedLoading",new At),Pt(this,"onIfcImporterInitialized",new At),Pt(this,"onSetup",new At),Pt(this,"settings",new fi),Pt(this,"webIfc",new Ct.IfcAPI),Pt(this,"enabled",!0),this.components.add(t.uuid,this)}dispose(){this.webIfc=null,this.onDisposed.trigger(t.uuid),this.onDisposed.reset()}async setup(t){this.settings={...this.settings,...t},this.settings.autoSetWasm&&await this.autoSetWasm(),this.onSetup.trigger()}async load(t,e,s,n){const r=this.components.get(pi);if(!r.initialized)throw new Error("You need to initialize fragments first.");this.settings.autoSetWasm&&await this.autoSetWasm(),r.core.settings.autoCoordinate=e;const o=new i.IfcImporter;o.wasm.path=this.settings.wasm.path,o.wasm.absolute=this.settings.wasm.absolute,o.webIfcSettings=this.settings.webIfc,this.onIfcImporterInitialized.trigger(o),null!=n&&n.instanceCallback&&n.instanceCallback(o);const a=await o.process({...null==n?void 0:n.processData,bytes:t});return await r.core.load(a,{modelId:s,userData:null==n?void 0:n.userData})}async readIfcFile(t){const{path:e,absolute:i,logLevel:s}=this.settings.wasm;return this.webIfc.SetWasmPath(e,i),await this.webIfc.Init(this.settings.customLocateFileHandler||void 0),s&&this.webIfc.SetLogLevel(s),this.webIfc.OpenModel(t,this.settings.webIfc)}cleanUp(){try{this.webIfc.Dispose()}catch{console.log("Web-ifc wasn't disposed.")}this.webIfc=null,this.webIfc=new Ct.IfcAPI}async autoSetWasm(){const t=await fetch(`https://unpkg.com/@thatopen/components@${lo.release}/package.json`);if(!t.ok)return void console.warn("Couldn't get openbim-components package.json. Set wasm settings manually.");const e=await t.json();if("web-ifc"in e.peerDependencies){const t=e.peerDependencies["web-ifc"];this.settings.wasm.path=`https://unpkg.com/web-ifc@${t}/`,this.settings.wasm.absolute=!0}else console.warn("Couldn't get web-ifc from peer dependencies in openbim-components. Set wasm settings manually.")}},"uuid","a659add7-1418-4771-a0d6-7d4d438e4624");const mi=class t extends Ot{constructor(e){super(e),Pt(this,"enabled",!0),this.components.add(t.uuid,this)}async set(t,e){const i=this.components.get(pi),s=[];if(e)for(const[n,r]of Object.entries(e)){const e=i.list.get(n);e&&s.push(e.setVisible([...r],t))}else for(const e of i.list.values())s.push(e.setVisible(void 0,t));await Promise.all(s),await i.core.update(!0)}async isolate(t){await Promise.all([this.set(!1),this.set(!0,t)])}async toggle(t){const e=[],i=this.components.get(pi);for(const[s,n]of Object.entries(t)){const t=i.list.get(s);t&&e.push(t.toggleVisible([...n]))}await Promise.all(e),await i.core.update(!0)}async getVisibilityMap(t,e){const i=[],s=[],n=this.components.get(pi);if(e)for(const r of e){const e=n.list.get(r);e&&(i.push(e.modelId),s.push(e.getItemsByVisibility(t)))}else for(const e of n.list.values())i.push(e.modelId),s.push(e.getItemsByVisibility(t));const r=await Promise.all(s),o={};for(const[t,e]of i.entries())o[e]=r[t];return o}};Pt(mi,"uuid","dd9ccf2d-8a21-4821-b7f6-2949add16a29");let gi=mi;const vi=class t extends Ot{constructor(e){super(e),Pt(this,"enabled",!0),Pt(this,"onDisposed",new At),Pt(this,"list",new i.DataSet),this.components.add(t.uuid,this)}dispose(e=!0){this.list.clear(),this.onDisposed.trigger(t.uuid),e&&(this.onDisposed.reset(),this.list.eventsEnabled=!1,this.list.dispose())}get(){const t=new o.Box3;for(const e of this.list)t.union(e);return t}async addFromModelIdMap(t){const e=this.components.get(pi),i=new o.Box3;for(const[s,n]of Object.entries(t)){const t=e.list.get(s);if(!t)continue;const r=await t.getMergedBox([...n]);i.union(r)}this.list.add(i)}addFromModels(t){const e=this.components.get(pi);for(const[i,s]of e.list)t&&!t.some(t=>t.test(i))||this.list.add(s.box)}async getCenter(t){this.list.clear(),await this.addFromModelIdMap(t);const e=this.get();this.list.clear();const i=new o.Vector3;return e.getCenter(i),i}async getCameraOrientation(t,e=1){const i=this.components.get(pi);this.list.clear();for(const[t,e]of i.list)this.list.add(e.box);const s=this.get();this.list.clear();const n=new o.Vector3;s.getCenter(n);const r=new o.Vector3;s.getSize(r);const a=Math.max(r.x,r.y,r.z)*e,l=new o.Vector3;switch(t){case"front":default:l.set(n.x,n.y,n.z+a);break;case"back":l.set(n.x,n.y,n.z-a);break;case"left":l.set(n.x-a,n.y,n.z);break;case"right":l.set(n.x+a,n.y,n.z);break;case"top":l.set(n.x,n.y+a,n.z);break;case"bottom":l.set(n.x,n.y-a,n.z)}return{position:l,target:n}}};Pt(vi,"uuid","d1444724-dba6-4cdd-a0c7-68ee1450d166");let _i=vi;class yi{constructor(t,e){Pt(this,"name","Query"),Pt(this,"customData",{}),Pt(this,"_components"),Pt(this,"_queries",[]),Pt(this,"_aggregation","exclusive"),Pt(this,"result",null),Pt(this,"cache",!0),Pt(this,"serializeQueryParameters",t=>{var e;return{categories:null==(e=t.categories)?void 0:e.map(t=>t.source),attributes:t.attributes?{aggregation:t.attributes.aggregation,queries:t.attributes.queries.map(this.serializeAttributeQuery)}:void 0,relation:t.relation?{name:t.relation.name,query:t.relation.query?this.serializeQueryParameters(t.relation.query):void 0}:void 0}}),Pt(this,"deserializeQueryParameters",t=>{var e;return{categories:null==(e=t.categories)?void 0:e.map(t=>new RegExp(t)),attributes:t.attributes?{aggregation:t.attributes.aggregation,queries:t.attributes.queries.map(this.deserializeAttributeQuery)}:void 0,relation:t.relation?{name:t.relation.name,query:t.relation.query?this.deserializeQueryParameters(t.relation.query):void 0}:void 0}}),this._components=t,this.queries=e}set queries(t){this._queries=t,this.clearCache()}get queries(){return this._queries}set aggregation(t){t!==this._aggregation&&this.clearCache(),this._aggregation=t}get aggregation(){return this._aggregation}async test(t){const{modelIds:e,force:i}={force:!1,...t};if(this.result&&!i)return this.result;const s=await this._components.get(bi).getItems(this.queries,{modelIds:e,aggregation:this.aggregation});return this.cache&&(this.result=s),s}clearCache(){this.result=null}serializeAttributeQuery(t){let e;return e=Array.isArray(t.value)?t.value.map(t=>t.source):t.value instanceof RegExp?t.value.source:t.value,{name:t.name.source,value:e,type:t.type instanceof RegExp?t.type.source:t.type,negate:t.negate,itemIds:t.itemIds}}toJSON(){return{guid:this._components.get(bi).list.getKey(this)??Bt.create(),name:this.name,customData:this.customData,queries:this.queries.map(this.serializeQueryParameters),aggregation:this.aggregation,cache:this.cache}}deserializeAttributeQuery(t){let e;return e=Array.isArray(t.value)?t.value.map(t=>new RegExp(t)):"string"==typeof t.value?new RegExp(t.value):t.value,{name:new RegExp(t.name),value:e,type:t.type?new RegExp(t.type):void 0,negate:t.negate,itemIds:t.itemIds}}fromJSON(t){return this.name=t.name,this.customData=t.customData,this.aggregation=t.aggregation,this.cache=t.cache,this.queries=t.queries.map(this.deserializeQueryParameters),this}}const wi=class t extends Ot{constructor(e){super(e),Pt(this,"enabled",!0),Pt(this,"list",new i.DataMap),e.add(t.uuid,this)}async getItems(t,e){let i;if(e){const{modelIds:t,items:s}=e;if(s){const t=Object.keys(s);t.length>0&&(i=t.map(t=>new RegExp(`^${t}$`)))}else t&&(i=t)}const s=(null==e?void 0:e.aggregation)??"exclusive",n=this.components.get(pi),r=await Promise.all(t.map(async t=>{const s={};return await Promise.all(Array.from(n.list).map(async([n,r])=>{var o;if(i&&!i.some(t=>t.test(n)))return;const a=null==(o=null==e?void 0:e.items)?void 0:o[n],l=await r.getItemsByQuery(t,{localIds:a?[...a]:void 0});s[n]=new Set(l)})),s}));return"inclusive"===s?ri.join(r):ri.intersect(r)}create(t,e){const i=new yi(this.components,e);return this.list.set(t,i),i}async addFromCategories(t){const e=new Set,i=this.components.get(pi);for(const[s,n]of i.list){if(t&&!t.some(t=>t.test(s)))continue;const i=(await n.getItemsWithGeometryCategories()).filter(t=>null!==t),r=new Set(i);for(const t of r)this.list.has(t)||(this.create(t,[{categories:[new RegExp(`^${t}$`)]}]),e.add(t))}return[...e]}import(t){const{data:e}=t,i=[];if(!e)return i;for(const t of e){const e=this.create(t.guid,[]);e.fromJSON(t),i.push(e)}return i}export(){const t=[];for(const[e,i]of this.list.entries()){const s={...i.toJSON(),name:e};t.push(s)}return{data:t}}};Pt(wi,"uuid","0da7ad77-f734-42ca-942f-a074adfd1e3a");let bi=wi;const xi=class t extends Ot{constructor(e){super(e),Pt(this,"enabled",!0),Pt(this,"onDisposed",new At),Pt(this,"list",new i.DataMap),Pt(this,"defaultSaveFunction",t=>"value"in t.Name?t.Name.value:null),Pt(this,"onBeforeFragmentsDispose",async t=>{const{key:e,value:i}=t,s=await i.getLocalIds(),n={[e]:new Set(s)};this.removeItems(n)}),e.add(t.uuid,this),this.setupEvents(),e.get(pi).list.onBeforeDelete.add(this.onBeforeFragmentsDispose)}setupEvents(){this.list.onBeforeDelete.add(({value:t})=>t.dispose())}getClassificationGroups(t){let e=this.list.get(t);return e||(e=new i.DataMap,this.list.set(t,e)),e}getModelItems(t,e,i){const{map:s}=this.getGroupData(t,e);let n=s[i];return n||(n=new Set,s[i]=n),n}getGroupData(t,e){const i=this.components.get(bi),s=this.getClassificationGroups(t);let n=s.get(e);return n||(n={map:{},get:()=>new Promise(t=>{if(n)if(n.query){const{name:e,config:s}=n.query,r=i.list.get(e);if(!r)throw new Error("Classifier: the query name associated with the group doesn't exist in the ItemsFinder component");r.test(s).then(e=>{if(!n)return void t({});const i=ri.join([e,n.map]);t(i)})}else t(n.map);else t({})})},s.set(e,n)),n}async aggregateItems(t,e,i){const s=(null==i?void 0:i.data)??void 0,n=(null==i?void 0:i.aggregationCallback)??this.defaultSaveFunction,r=this.components.get(pi),o=await this.components.get(bi).getItems([e],{modelIds:null==i?void 0:i.modelIds});for(const[e,i]of Object.entries(o)){const o=r.list.get(e);if(!o)continue;const a=(i,...s)=>{const n=this.getModelItems(t,i,e);for(const t of s)n.add(t)},l=await o.getItemsData([...i],s);for(const t of l)n(t,a)}}addGroupItems(t,e,i){const{map:s}=this.getGroupData(t,e);ri.add(s,i)}setGroupQuery(t,e,i){this.getGroupData(t,e).query=i}async find(t){const e=[];for(const[i,s]of Object.entries(t)){const t=[],n=this.list.get(i);if(!n)continue;for(const e of s){const i=n.get(e);if(!i)continue;const s=await i.get();t.push(s)}const r=ri.join(t);e.push(r)}return ri.intersect(e)}async aggregateItemRelations(t,e,i,s){const n=(null==s?void 0:s.attribute)??"Name",r={relations:{[i]:{attributes:!0,relations:!1}}};await this.aggregateItems(t,e,{modelIds:null==s?void 0:s.modelIds,data:r,aggregationCallback:(t,e)=>{if(null==t||!t[n])return;const s=t[n];if(!("value"in s))return;const r=t[i];if(Array.isArray(r))for(const t of r)"value"in t._localId&&e(s.value,t._localId.value)}})}async byIfcBuildingStorey(t){await this.aggregateItemRelations((null==t?void 0:t.classificationName)??"Storeys",{categories:[/BUILDINGSTOREY/]},"ContainsElements",{modelIds:null==t?void 0:t.modelIds})}async byCategory(t){const e=await this.components.get(bi).addFromCategories(null==t?void 0:t.modelIds);for(const i of e)this.setGroupQuery((null==t?void 0:t.classificationName)??"Categories",i,{name:i})}dispose(){this.list.clear(),this.components.get(pi).list.onBeforeDelete.remove(this.onBeforeFragmentsDispose),this.onDisposed.trigger()}removeItems(t,e){if(e&&e.classificationName){const i=this.list.get(e.classificationName);if(!i||e.groupName&&!i.get(e.groupName))return;for(const[,e]of i)ri.remove(e.map,t);return}for(const[,e]of this.list.entries())for(const[,i]of e)ri.remove(i.map,t)}async byModel(t){const e=this.components.get(pi),i=(null==t?void 0:t.classificationName)??"Models";for(const[s,n]of e.list){if(t&&t.modelIds&&!t.modelIds.some(t=>t.test(s)))continue;const e=await n.getItemsIdsWithGeometry(),r={[s]:new Set(e)};this.getGroupData(i,s),this.addGroupItems(i,s,r)}}};Pt(xi,"uuid","e25a7f3c-46c4-4a14-9d3d-5115f24ebeb7");let Si=xi;class Ei{constructor(t,e){Pt(this,"enabled",!0),Pt(this,"components"),Pt(this,"onDisposed",new At),Pt(this,"mouse"),Pt(this,"world"),Pt(this,"debugMode",!1),Pt(this,"colorToModelId",new Map),Pt(this,"modelIdToColor",new Map),Pt(this,"renderTarget"),Pt(this,"renderTargetSize",new o.Vector2),Pt(this,"debugCanvas"),Pt(this,"debugContainer"),Pt(this,"colorMaterials",new Map),Pt(this,"originalMaterials",new Map),Pt(this,"originalLodColors",new Map),Pt(this,"colorsNeedUpdate",!0);const i=e.renderer;if(!i)throw new Error("A renderer is needed for the FastModelPicker to work!");this.world=e,this.mouse=new di(i.three.domElement),this.components=t,this.setupRenderTarget(),this.setupFragmentListeners()}setupFragmentListeners(){const t=this.components.get(pi);t.list.onItemSet.add(()=>{this.colorsNeedUpdate=!0}),t.list.onItemDeleted.add(()=>{this.colorsNeedUpdate=!0})}setupRenderTarget(){const t=this.world.renderer.three.getSize(new o.Vector2);this.renderTargetSize.copy(t),this.renderTarget=new o.WebGLRenderTarget(t.x,t.y),this.renderTarget.texture.format=o.RGBAFormat,this.renderTarget.texture.type=o.UnsignedByteType,this.debugMode&&this.setupDebugCanvas(),this.world.renderer.onResize.add(t=>{this.renderTargetSize.copy(t),this.renderTarget.setSize(t.x,t.y),this.debugCanvas&&(this.debugCanvas.width=t.x,this.debugCanvas.height=t.y)})}setupDebugCanvas(){if(this.debugCanvas)return;const t=this.world.renderer.three.getSize(new o.Vector2);this.debugContainer=document.createElement("div"),this.debugContainer.style.position="fixed",this.debugContainer.style.top="10px",this.debugContainer.style.right="10px",this.debugContainer.style.width="300px",this.debugContainer.style.height="300px",this.debugContainer.style.border="2px solid #fff",this.debugContainer.style.backgroundColor="#000",this.debugContainer.style.zIndex="10000",this.debugContainer.style.pointerEvents="none",this.debugCanvas=document.createElement("canvas"),this.debugCanvas.width=t.x,this.debugCanvas.height=t.y,this.debugCanvas.style.width="100%",this.debugCanvas.style.height="100%",this.debugCanvas.style.imageRendering="pixelated",this.debugContainer.appendChild(this.debugCanvas),document.body.appendChild(this.debugContainer)}generateColorForModel(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e&=e;let i=Math.abs(e)%16777215;0===i&&(i=1);const s=i>>16&255||1,n=i>>8&255||1,r=255&i||1;return new o.Color(s/255,n/255,r/255)}colorToId(t){return Math.round(255*t.r)<<16|Math.round(255*t.g)<<8|Math.round(255*t.b)}assignColors(){const t=this.components.get(pi);if(t.initialized){if(!this.colorsNeedUpdate){const e=new Set(t.list.keys()),i=new Set(this.modelIdToColor.keys());(e.size!==i.size||[...e].some(t=>!i.has(t)))&&(this.colorsNeedUpdate=!0)}if(this.colorsNeedUpdate){this.colorToModelId.clear(),this.modelIdToColor.clear();for(const t of this.colorMaterials.values())t.dispose();this.colorMaterials.clear();for(const[e]of t.list){const t=this.generateColorForModel(e),i=this.colorToId(t);this.colorToModelId.set(i,e),this.modelIdToColor.set(e,t);const s=new o.MeshBasicMaterial({color:t,depthTest:!0,depthWrite:!0});this.colorMaterials.set(e,s)}this.colorsNeedUpdate=!1}}}applyColorMaterials(){const t=this.components.get(pi);if(t.initialized)for(const[e,i]of t.list){const t=this.colorMaterials.get(e);t&&i.object.traverse(e=>{if(e instanceof o.Mesh){if("isLODGeometry"in e.geometry){const i=e.material[0].uniforms.lodColor;return this.originalLodColors.has(i)||this.originalLodColors.set(i,i.value),void(i.value=t.color)}this.originalMaterials.has(e)||this.originalMaterials.set(e,e.material),e.material=t}})}}restoreOriginalMaterials(){for(const[t,e]of this.originalMaterials)t.material=e;for(const[t,e]of this.originalLodColors)t.value=e;this.originalMaterials.clear()}renderColorCoded(){if(!this.renderTarget||!this.world.renderer)throw new Error("Render target not initialized!");const t=this.world.renderer.three,e=this.world.scene.three,i=this.world.camera.three,s=t.getRenderTarget(),n=t.autoClear,r=new o.Color,a=t.getClearAlpha();t.getClearColor(r),this.applyColorMaterials(),t.setRenderTarget(this.renderTarget),t.autoClear=!0,t.setClearColor(0,1),t.clear(!0,!0,!1),t.render(e,i),t.setRenderTarget(s),t.autoClear=n,t.setClearColor(r,a),this.restoreOriginalMaterials(),this.debugMode&&this.debugCanvas&&this.updateDebugCanvas()}updateDebugCanvas(){if(!this.debugCanvas||!this.renderTarget||!this.world.renderer)return;const t=this.world.renderer.three,e=this.renderTargetSize,i=new Uint8Array(e.x*e.y*4);t.readRenderTargetPixels(this.renderTarget,0,0,e.x,e.y,i);const s=this.debugCanvas.getContext("2d");if(!s)return;const n=s.createImageData(e.x,e.y),r=4*e.x;for(let t=0;t<e.y;t++){const s=t*r,o=(e.y-1-t)*r;n.data.set(i.subarray(s,s+r),o)}s.putImageData(n,0,0)}async getModelAt(t){if(!this.renderTarget||!this.world.renderer)throw new Error("Render target not initialized!");const e=this.components.get(pi);if(!e.initialized||0===e.list.size)return null;this.assignColors(),this.renderColorCoded();const i=t||this.mouse.position,s=this.renderTargetSize,n=Math.floor(.5*(i.x+1)*s.x),r=Math.floor(.5*(i.y+1)*(s.y-1)),o=Math.max(0,Math.min(s.x-1,n)),a=Math.max(0,Math.min(s.y-1,r)),l=this.world.renderer.three,h=new Uint8Array(4);l.readRenderTargetPixels(this.renderTarget,o,a,1,1,h);const c=h[0]<<16|h[1]<<8|h[2];return this.colorToModelId.get(c)||null}setDebugMode(t){this.debugMode=t,t?this.setupDebugCanvas():this.removeDebugCanvas()}removeDebugCanvas(){this.debugContainer&&(this.debugContainer.remove(),this.debugContainer=void 0,this.debugCanvas=void 0)}dispose(){this.mouse.dispose(),this.removeDebugCanvas();for(const t of this.colorMaterials.values())t.dispose();this.colorMaterials.clear(),this.renderTarget&&this.renderTarget.dispose(),this.colorToModelId.clear(),this.modelIdToColor.clear(),this.originalMaterials.clear(),this.originalLodColors.clear(),this.onDisposed.trigger(),this.onDisposed.reset()}}const Ci=class t extends Ot{constructor(e){super(e),Pt(this,"enabled",!0),Pt(this,"list",new Map),Pt(this,"onDisposed",new At),e.add(t.uuid,this)}get(t){if(this.list.has(t.uuid))return this.list.get(t.uuid);const e=new Ei(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add(()=>{this.delete(t)}),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}};Pt(Ci,"uuid","4a82430c-7ff2-49ea-9401-60807502dad6");let Ti=Ci;class Pi{constructor(t,e){Pt(this,"enabled",!0),Pt(this,"components"),Pt(this,"onDisposed",new At),Pt(this,"mouse"),Pt(this,"three",new o.Raycaster),Pt(this,"world"),Pt(this,"useFastModelPicking",!1);const i=e.renderer;if(!i)throw new Error("A renderer is needed for the raycaster to work!");this.world=e,this.mouse=new di(i.three.domElement),this.components=t}dispose(){this.mouse.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}castRayToObjects(t=Array.from(this.world.meshes),e=this.mouse.position){if(!this.world)throw new Error("A world is needed to cast rays!");const i=this.world.camera.three;return this.three.setFromCamera(e,i),this.intersect(t)}async castRay(t){const e=null==t?void 0:t.snappingClasses,i=(null==t?void 0:t.items)??Array.from(this.world.meshes),s=(null==t?void 0:t.position)??this.mouse.position;if(!this.world)throw new Error("A world is needed to cast rays!");const n=this.world.camera.three,r=this.components.get(pi),o=this.world.renderer.three.domElement,a=this.mouse.rawPosition;let l=null;if(r.initialized){if(this.useFastModelPicking){const t=await this.components.get(Ti).get(this.world).getModelAt(s);if(t){const i=r.list.get(t);if(i)if(e&&e.length>0){const t=await i.raycastWithSnapping({camera:n,dom:o,mouse:a,snappingClasses:e});l=t&&t.length>0?t[0]:await i.raycast({camera:n,dom:o,mouse:a})}else l=await i.raycast({camera:n,dom:o,mouse:a})}}else l=await r.raycast({camera:n,dom:o,mouse:a,snappingClasses:e});if(0===i.length)return l}this.three.setFromCamera(s,n);const h=this.intersect(i);return l?h&&h.distance<l.distance?h:l:h}castRayFromVector(t,e,i=Array.from(this.world.meshes)){return this.three.set(t,e),this.intersect(i)}intersect(t=Array.from(this.world.meshes)){const e=this.three.intersectObjects(t),i=this.filterClippingPlanes(e);return i.length>0?i[0]:null}filterClippingPlanes(t){if(!this.world.renderer)throw new Error("Renderer not found!");const e=this.world.renderer.three;if(!e.clippingPlanes)return t;const i=e.clippingPlanes;return t.length<=0||!i||(null==i?void 0:i.length)<=0?t:t.filter(t=>i.every(e=>e.distanceToPoint(t.point)>0))}}const Ai=class t extends Ot{constructor(e){super(e),Pt(this,"enabled",!0),Pt(this,"list",new Map),Pt(this,"onDisposed",new At),e.add(t.uuid,this)}get(t){if(this.list.has(t.uuid))return this.list.get(t.uuid);const e=new Pi(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add(()=>{this.delete(t)}),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}};Pt(Ai,"uuid","d5d8bdf0-db25-4952-b951-b643af207ace");let Mi=Ai;class Oi extends Mt{constructor(){super(...arguments),Pt(this,"onCameraChanged",new At),Pt(this,"meshes",new Set),Pt(this,"onAfterUpdate",new At),Pt(this,"onBeforeUpdate",new At),Pt(this,"onDisposed",new At),Pt(this,"isDisposing",!1),Pt(this,"enabled",!0),Pt(this,"_dynamicAnchor",!1),Pt(this,"uuid",Bt.create()),Pt(this,"name"),Pt(this,"_scene"),Pt(this,"_camera"),Pt(this,"_renderer",null),Pt(this,"onPointerDown",async t=>{if(!this.camera.hasCameraControls())throw new Error("World: can't set dynamic anchor if the camera doesn't have controls.");const e=await this.components.get(Mi).get(this).castRay();e&&e.point&&0===t.button&&this.camera.controls.setOrbitPoint(e.point.x,e.point.y,e.point.z)}),Pt(this,"_defaultCamera")}set dynamicAnchor(t){var e;const i=null==(e=this.renderer)?void 0:e.three.domElement.parentElement;if(!i)throw new Error("World: the renderer must have a parentElement to set dynamic anchoring.");t?(this.camera.controls&&(this.camera.controls.minDistance=.01),i.addEventListener("pointerdown",this.onPointerDown)):i.removeEventListener("pointerdown",this.onPointerDown)}get dynamicAnchor(){return this._dynamicAnchor}get defaultCamera(){if(!this._defaultCamera)throw new Error("World: there is no default camera defined.");return this._defaultCamera}set defaultCamera(t){this._defaultCamera=t}get scene(){if(!this._scene)throw new Error("No scene initialized!");return this._scene}set scene(t){this._scene=t,t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"})}get camera(){if(!this._camera)throw new Error("No camera initialized!");return this._camera}set camera(t){this._camera||(this.defaultCamera=t),this._camera=t,t.currentWorld=this,this.onCameraChanged.trigger(t)}get renderer(){return this._renderer}set renderer(t){this._renderer=t,t&&(t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"}))}useDefaultCamera(){this.camera=this.defaultCamera}update(t){this.enabled&&(!this._scene||!this._camera||(this.scene.currentWorld=this,this.camera.currentWorld=this,this.renderer&&(this.renderer.currentWorld=this),this.onBeforeUpdate.trigger(),this.scene.isUpdateable()&&this.scene.update(t),this.camera.isUpdateable()&&this.camera.update(t),this.renderer&&this.renderer.update(t),this.onAfterUpdate.trigger()))}dispose(t=!0){if(this.enabled=!1,this.isDisposing=!0,this.scene.onWorldChanged.trigger({world:this,action:"removed"}),this.camera.onWorldChanged.trigger({world:this,action:"removed"}),this.renderer&&this.renderer.onWorldChanged.trigger({world:this,action:"removed"}),t){const t=this.components.get(Lt);this.scene.dispose(),this.camera.isDisposeable()&&this.camera.dispose(),this.renderer&&this.renderer.dispose();for(const e of this.meshes)t.destroy(e);this.meshes.clear()}this._scene=null,this._camera=null,this._renderer=null,this.components.get(zs).list.delete(this.uuid),this.onDisposed.trigger(),this.onDisposed.reset()}}var Di=(t=>(t[t.MANUAL=0]="MANUAL",t[t.AUTO=1]="AUTO",t))(Di||{});class zi extends It{constructor(t,e,i){super(t),Pt(this,"enabled",!0),Pt(this,"container"),Pt(this,"three"),Pt(this,"mode",1),Pt(this,"needsUpdate",!1),Pt(this,"_canvas"),Pt(this,"_parameters"),Pt(this,"_resizeObserver",null),Pt(this,"onContainerUpdated",new At),Pt(this,"_resizing",!1),Pt(this,"resize",t=>{if(this._resizing)return;this._resizing=!0,this.onContainerUpdated.trigger();const e=t?t.x:this.container.clientWidth,i=t?t.y:this.container.clientHeight;this.three.setSize(e,i),this.onResize.trigger(new o.Vector2(e,i)),this._resizing=!1}),Pt(this,"resizeEvent",()=>{this.resize()}),Pt(this,"onContextLost",t=>{t.preventDefault(),this.enabled=!1}),Pt(this,"onContextBack",()=>{this.three.setRenderTarget(null),this.three.dispose(),this.three=new o.WebGLRenderer({canvas:this._canvas,antialias:!0,alpha:!0,...this._parameters}),this.enabled=!0}),this.container=e,this._parameters=i,this.three=new o.WebGLRenderer({antialias:!0,alpha:!0,...i}),this.three.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.setupRenderer(),this.setupEvents(!0),this.resize(),this._canvas=this.three.domElement;const s=this.three.getContext(),{canvas:n}=s;n.addEventListener("webglcontextlost",this.onContextLost,!1),n.addEventListener("webglcontextrestored",this.onContextBack,!1)}update(){if(!this.enabled||!this.currentWorld||0===this.mode&&!this.needsUpdate)return;this.needsUpdate=!1,this.onBeforeUpdate.trigger(this);const t=this.currentWorld.scene.three,e=this.currentWorld.camera.three;this.three.render(t,e),this.onAfterUpdate.trigger(this)}dispose(){this.enabled=!1,this.setupEvents(!1),this.three.domElement.remove(),this.three.forceContextLoss(),this.three.dispose(),this.onResize.reset(),this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}getSize(){return new o.Vector2(this.three.domElement.clientWidth,this.three.domElement.clientHeight)}setupEvents(t){const e=this.three.domElement.parentElement;if(!e)throw new Error("This renderer needs to have an HTML container!");this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),window.removeEventListener("resize",this.resizeEvent),t&&(this._resizeObserver=new ResizeObserver(this.resizeEvent),this._resizeObserver.observe(e),window.addEventListener("resize",this.resizeEvent))}setupRenderer(){this.three.localClippingEnabled=!0,this.container&&this.container.appendChild(this.three.domElement),this.onContainerUpdated.trigger()}}
/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const Ii=1,ki=2,Li=4,Ni=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,SCREEN_PAN:4,OFFSET:8,DOLLY:16,ZOOM:32,TOUCH_ROTATE:64,TOUCH_TRUCK:128,TOUCH_SCREEN_PAN:256,TOUCH_OFFSET:512,TOUCH_DOLLY:1024,TOUCH_ZOOM:2048,TOUCH_DOLLY_TRUCK:4096,TOUCH_DOLLY_SCREEN_PAN:8192,TOUCH_DOLLY_OFFSET:16384,TOUCH_DOLLY_ROTATE:32768,TOUCH_ZOOM_TRUCK:65536,TOUCH_ZOOM_OFFSET:131072,TOUCH_ZOOM_SCREEN_PAN:262144,TOUCH_ZOOM_ROTATE:524288}),Bi=0,Ui=1,Ri=-1;function Fi(t){return t.isPerspectiveCamera}function Vi(t){return t.isOrthographicCamera}const ji=2*Math.PI,Hi=Math.PI/2,Wi=1e-5,Gi=Math.PI/180;function Zi(t,e,i){return Math.max(e,Math.min(i,t))}function Yi(t,e=Wi){return Math.abs(t)<e}function Xi(t,e,i=Wi){return Yi(t-e,i)}function qi(t,e){return Math.round(t/e)*e}function Qi(t){return isFinite(t)?t:t<0?-Number.MAX_VALUE:Number.MAX_VALUE}function Ki(t){return Math.abs(t)<Number.MAX_VALUE?t:t*(1/0)}function Ji(t,e,i,s,n=1/0,r){const o=2/(s=Math.max(1e-4,s)),a=o*r,l=1/(1+a+.48*a*a+.235*a*a*a);let h=t-e;const c=e,d=n*s;h=Zi(h,-d,d),e=t-h;const u=(i.value+o*h)*r;i.value=(i.value-o*u)*l;let p=e+(h+u)*l;return c-t>0==p>c&&(p=c,i.value=(p-c)/r),p}function $i(t,e,i,s,n=1/0,r,o){const a=2/(s=Math.max(1e-4,s)),l=a*r,h=1/(1+l+.48*l*l+.235*l*l*l);let c=e.x,d=e.y,u=e.z,p=t.x-c,f=t.y-d,m=t.z-u;const g=c,v=d,_=u,y=n*s,w=p*p+f*f+m*m;if(w>y*y){const t=Math.sqrt(w);p=p/t*y,f=f/t*y,m=m/t*y}c=t.x-p,d=t.y-f,u=t.z-m;const b=(i.x+a*p)*r,x=(i.y+a*f)*r,S=(i.z+a*m)*r;i.x=(i.x-a*b)*h,i.y=(i.y-a*x)*h,i.z=(i.z-a*S)*h,o.x=c+(p+b)*h,o.y=d+(f+x)*h,o.z=u+(m+S)*h;const E=g-t.x,C=v-t.y,T=_-t.z;return E*(o.x-g)+C*(o.y-v)+T*(o.z-_)>0&&(o.x=g,o.y=v,o.z=_,i.x=(o.x-g)/r,i.y=(o.y-v)/r,i.z=(o.z-_)/r),o}function ts(t,e){e.set(0,0),t.forEach(t=>{e.x+=t.clientX,e.y+=t.clientY}),e.x/=t.length,e.y/=t.length}function es(t,e){return!!Vi(t)&&(console.warn(`${e} is not supported in OrthographicCamera`),!0)}class is{constructor(){this._listeners={}}addEventListener(t,e){const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}hasEventListener(t,e){const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}removeEventListener(t,e){const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}removeAllEventListeners(t){t?Array.isArray(this._listeners[t])&&(this._listeners[t].length=0):this._listeners={}}dispatchEvent(t){const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,s=i.length;e<s;e++)i[e].call(this,t)}}}var ss;const ns=1/8,rs=/Mac/.test(null===(ss=null==globalThis?void 0:globalThis.navigator)||void 0===ss?void 0:ss.platform);let os,as,ls,hs,cs,ds,us,ps,fs,ms,gs,vs,_s,ys,ws,bs,xs,Ss,Es,Cs,Ts,Ps,As;class Ms extends is{static install(t){os=t.THREE,as=Object.freeze(new os.Vector3(0,0,0)),ls=Object.freeze(new os.Vector3(0,1,0)),hs=Object.freeze(new os.Vector3(0,0,1)),cs=new os.Vector2,ds=new os.Vector3,us=new os.Vector3,ps=new os.Vector3,fs=new os.Vector3,ms=new os.Vector3,gs=new os.Vector3,vs=new os.Vector3,_s=new os.Vector3,ys=new os.Vector3,ws=new os.Spherical,bs=new os.Spherical,xs=new os.Box3,Ss=new os.Box3,Es=new os.Sphere,Cs=new os.Quaternion,Ts=new os.Quaternion,Ps=new os.Matrix4,As=new os.Raycaster}static get ACTION(){return Ni}set verticalDragToForward(t){console.warn("camera-controls: `verticalDragToForward` was removed. Use `mouseButtons.left = CameraControls.ACTION.SCREEN_PAN` instead.")}constructor(t,e){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=Ni.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=Bi,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new os.Vector3,this._focalOffsetVelocity=new os.Vector3,this._zoomVelocity={value:0},this._truckInternal=(t,e,i,s)=>{let n,r;if(Fi(this._camera)){const i=ds.copy(this._camera.position).sub(this._target),s=this._camera.getEffectiveFOV()*Gi,o=i.length()*Math.tan(.5*s);n=this.truckSpeed*t*o/this._elementRect.height,r=this.truckSpeed*e*o/this._elementRect.height}else{if(!Vi(this._camera))return;{const i=this._camera;n=this.truckSpeed*t*(i.right-i.left)/i.zoom/this._elementRect.width,r=this.truckSpeed*e*(i.top-i.bottom)/i.zoom/this._elementRect.height}}s?(i?this.setFocalOffset(this._focalOffsetEnd.x+n,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(n,0,!0),this.forward(-r,!0)):i?this.setFocalOffset(this._focalOffsetEnd.x+n,this._focalOffsetEnd.y+r,this._focalOffsetEnd.z,!0):this.truck(n,r,!0)},this._rotateInternal=(t,e)=>{const i=ji*this.azimuthRotateSpeed*t/this._elementRect.height,s=ji*this.polarRotateSpeed*e/this._elementRect.height;this.rotate(i,s,!0)},this._dollyInternal=(t,e,i)=>{const s=Math.pow(.95,-t*this.dollySpeed),n=this._sphericalEnd.radius,r=this._sphericalEnd.radius*s,o=Zi(r,this.minDistance,this.maxDistance),a=o-r;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(r,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(a,!0),this._dollyToNoClamp(o,!0)):this._dollyToNoClamp(o,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?r:o)-n,this._dollyControlCoord.set(e,i)),this._lastDollyDirection=Math.sign(-t)},this._zoomInternal=(t,e,i)=>{const s=Math.pow(.95,t*this.dollySpeed),n=this._zoom,r=this._zoom*s;this.zoomTo(r,!0),this.dollyToCursor&&(this._changedZoom+=r-n,this._dollyControlCoord.set(e,i))},typeof os>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=t,this._yAxisUpSpace=(new os.Quaternion).setFromUnitVectors(this._camera.up,ls),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=Ni.NONE,this._target=new os.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new os.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=(new os.Spherical).setFromVector3(ds.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new os.Vector3,new os.Vector3,new os.Vector3,new os.Vector3],this._updateNearPlaneCorners(),this._boundary=new os.Box3(new os.Vector3(-1/0,-1/0,-1/0),new os.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new os.Vector2,this.mouseButtons={left:Ni.ROTATE,middle:Ni.DOLLY,right:Ni.TRUCK,wheel:Fi(this._camera)?Ni.DOLLY:Vi(this._camera)?Ni.ZOOM:Ni.NONE},this.touches={one:Ni.TOUCH_ROTATE,two:Fi(this._camera)?Ni.TOUCH_DOLLY_TRUCK:Vi(this._camera)?Ni.TOUCH_ZOOM_TRUCK:Ni.NONE,three:Ni.TOUCH_TRUCK};const i=new os.Vector2,s=new os.Vector2,n=new os.Vector2,r=t=>{if(!this._enabled||!this._domElement)return;if(0!==this._interactiveArea.left||0!==this._interactiveArea.top||1!==this._interactiveArea.width||1!==this._interactiveArea.height){const e=this._domElement.getBoundingClientRect(),i=t.clientX/e.width,s=t.clientY/e.height;if(i<this._interactiveArea.left||i>this._interactiveArea.right||s<this._interactiveArea.top||s>this._interactiveArea.bottom)return}const e="mouse"!==t.pointerType?null:(t.buttons&Ii)===Ii?Ii:(t.buttons&Li)===Li?Li:(t.buttons&ki)===ki?ki:null;if(null!==e){const t=this._findPointerByMouseButton(e);t&&this._disposePointer(t)}if((t.buttons&Ii)===Ii&&this._lockedPointer)return;const i={pointerId:t.pointerId,clientX:t.clientX,clientY:t.clientY,deltaX:0,deltaY:0,mouseButton:e};this._activePointers.push(i),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",a),this._isDragging=!0,d(t)},o=t=>{t.cancelable&&t.preventDefault();const e=t.pointerId,i=this._lockedPointer||this._findPointerById(e);if(i){if(i.clientX=t.clientX,i.clientY=t.clientY,i.deltaX=t.movementX,i.deltaY=t.movementY,this._state=0,"touch"===t.pointerType)switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(t.buttons&Ii)===Ii)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(t.buttons&Li)===Li&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(t.buttons&ki)===ki&&(this._state=this._state|this.mouseButtons.right);u()}},a=t=>{const e=this._findPointerById(t.pointerId);if(!e||e!==this._lockedPointer){if(e&&this._disposePointer(e),"touch"===t.pointerType)switch(this._activePointers.length){case 0:this._state=Ni.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else this._state=Ni.NONE;p()}};let l=-1;const h=t=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===Ni.NONE)return;if(0!==this._interactiveArea.left||0!==this._interactiveArea.top||1!==this._interactiveArea.width||1!==this._interactiveArea.height){const e=this._domElement.getBoundingClientRect(),i=t.clientX/e.width,s=t.clientY/e.height;if(i<this._interactiveArea.left||i>this._interactiveArea.right||s<this._interactiveArea.top||s>this._interactiveArea.bottom)return}if(t.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===Ni.ROTATE||this.mouseButtons.wheel===Ni.TRUCK){const t=performance.now();l-t<1e3&&this._getClientRect(this._elementRect),l=t}const e=rs?-1:-3,i=1===t.deltaMode||t.ctrlKey?t.deltaY/e:t.deltaY/(10*e),s=this.dollyToCursor?(t.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,n=this.dollyToCursor?(t.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case Ni.ROTATE:this._rotateInternal(t.deltaX,t.deltaY),this._isUserControllingRotate=!0;break;case Ni.TRUCK:this._truckInternal(t.deltaX,t.deltaY,!1,!1),this._isUserControllingTruck=!0;break;case Ni.SCREEN_PAN:this._truckInternal(t.deltaX,t.deltaY,!1,!0),this._isUserControllingTruck=!0;break;case Ni.OFFSET:this._truckInternal(t.deltaX,t.deltaY,!0,!1),this._isUserControllingOffset=!0;break;case Ni.DOLLY:this._dollyInternal(-i,s,n),this._isUserControllingDolly=!0;break;case Ni.ZOOM:this._zoomInternal(-i,s,n),this._isUserControllingZoom=!0}this.dispatchEvent({type:"control"})},c=t=>{if(this._domElement&&this._enabled){if(this.mouseButtons.right===Ms.ACTION.NONE){const e=t instanceof PointerEvent?t.pointerId:0,i=this._findPointerById(e);return i&&this._disposePointer(i),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),void this._domElement.ownerDocument.removeEventListener("pointerup",a)}t.preventDefault()}},d=t=>{if(this._enabled){if(ts(this._activePointers,cs),this._getClientRect(this._elementRect),i.copy(cs),s.copy(cs),this._activePointers.length>=2){const t=cs.x-this._activePointers[1].clientX,e=cs.y-this._activePointers[1].clientY,i=Math.sqrt(t*t+e*e);n.set(0,i);const r=.5*(this._activePointers[0].clientX+this._activePointers[1].clientX),o=.5*(this._activePointers[0].clientY+this._activePointers[1].clientY);s.set(r,o)}if(this._state=0,t)if("pointerType"in t&&"touch"===t.pointerType)switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else!this._lockedPointer&&(t.buttons&Ii)===Ii&&(this._state=this._state|this.mouseButtons.left),(t.buttons&Li)===Li&&(this._state=this._state|this.mouseButtons.middle),(t.buttons&ki)===ki&&(this._state=this._state|this.mouseButtons.right);else this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);((this._state&Ni.ROTATE)===Ni.ROTATE||(this._state&Ni.TOUCH_ROTATE)===Ni.TOUCH_ROTATE||(this._state&Ni.TOUCH_DOLLY_ROTATE)===Ni.TOUCH_DOLLY_ROTATE||(this._state&Ni.TOUCH_ZOOM_ROTATE)===Ni.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&Ni.TRUCK)===Ni.TRUCK||(this._state&Ni.SCREEN_PAN)===Ni.SCREEN_PAN||(this._state&Ni.TOUCH_TRUCK)===Ni.TOUCH_TRUCK||(this._state&Ni.TOUCH_SCREEN_PAN)===Ni.TOUCH_SCREEN_PAN||(this._state&Ni.TOUCH_DOLLY_TRUCK)===Ni.TOUCH_DOLLY_TRUCK||(this._state&Ni.TOUCH_DOLLY_SCREEN_PAN)===Ni.TOUCH_DOLLY_SCREEN_PAN||(this._state&Ni.TOUCH_ZOOM_TRUCK)===Ni.TOUCH_ZOOM_TRUCK||(this._state&Ni.TOUCH_ZOOM_SCREEN_PAN)===Ni.TOUCH_DOLLY_SCREEN_PAN)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&Ni.DOLLY)===Ni.DOLLY||(this._state&Ni.TOUCH_DOLLY)===Ni.TOUCH_DOLLY||(this._state&Ni.TOUCH_DOLLY_TRUCK)===Ni.TOUCH_DOLLY_TRUCK||(this._state&Ni.TOUCH_DOLLY_SCREEN_PAN)===Ni.TOUCH_DOLLY_SCREEN_PAN||(this._state&Ni.TOUCH_DOLLY_OFFSET)===Ni.TOUCH_DOLLY_OFFSET||(this._state&Ni.TOUCH_DOLLY_ROTATE)===Ni.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&Ni.ZOOM)===Ni.ZOOM||(this._state&Ni.TOUCH_ZOOM)===Ni.TOUCH_ZOOM||(this._state&Ni.TOUCH_ZOOM_TRUCK)===Ni.TOUCH_ZOOM_TRUCK||(this._state&Ni.TOUCH_ZOOM_SCREEN_PAN)===Ni.TOUCH_ZOOM_SCREEN_PAN||(this._state&Ni.TOUCH_ZOOM_OFFSET)===Ni.TOUCH_ZOOM_OFFSET||(this._state&Ni.TOUCH_ZOOM_ROTATE)===Ni.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&Ni.OFFSET)===Ni.OFFSET||(this._state&Ni.TOUCH_OFFSET)===Ni.TOUCH_OFFSET||(this._state&Ni.TOUCH_DOLLY_OFFSET)===Ni.TOUCH_DOLLY_OFFSET||(this._state&Ni.TOUCH_ZOOM_OFFSET)===Ni.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})}},u=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,ts(this._activePointers,cs);const t=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,e=t?-t.deltaX:s.x-cs.x,r=t?-t.deltaY:s.y-cs.y;if(s.copy(cs),((this._state&Ni.ROTATE)===Ni.ROTATE||(this._state&Ni.TOUCH_ROTATE)===Ni.TOUCH_ROTATE||(this._state&Ni.TOUCH_DOLLY_ROTATE)===Ni.TOUCH_DOLLY_ROTATE||(this._state&Ni.TOUCH_ZOOM_ROTATE)===Ni.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(e,r),this._isUserControllingRotate=!0),(this._state&Ni.DOLLY)===Ni.DOLLY||(this._state&Ni.ZOOM)===Ni.ZOOM){const t=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,e=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0,s=this.dollyDragInverted?-1:1;(this._state&Ni.DOLLY)===Ni.DOLLY?(this._dollyInternal(s*r*ns,t,e),this._isUserControllingDolly=!0):(this._zoomInternal(s*r*ns,t,e),this._isUserControllingZoom=!0)}if((this._state&Ni.TOUCH_DOLLY)===Ni.TOUCH_DOLLY||(this._state&Ni.TOUCH_ZOOM)===Ni.TOUCH_ZOOM||(this._state&Ni.TOUCH_DOLLY_TRUCK)===Ni.TOUCH_DOLLY_TRUCK||(this._state&Ni.TOUCH_ZOOM_TRUCK)===Ni.TOUCH_ZOOM_TRUCK||(this._state&Ni.TOUCH_DOLLY_SCREEN_PAN)===Ni.TOUCH_DOLLY_SCREEN_PAN||(this._state&Ni.TOUCH_ZOOM_SCREEN_PAN)===Ni.TOUCH_ZOOM_SCREEN_PAN||(this._state&Ni.TOUCH_DOLLY_OFFSET)===Ni.TOUCH_DOLLY_OFFSET||(this._state&Ni.TOUCH_ZOOM_OFFSET)===Ni.TOUCH_ZOOM_OFFSET||(this._state&Ni.TOUCH_DOLLY_ROTATE)===Ni.TOUCH_DOLLY_ROTATE||(this._state&Ni.TOUCH_ZOOM_ROTATE)===Ni.TOUCH_ZOOM_ROTATE){const t=cs.x-this._activePointers[1].clientX,e=cs.y-this._activePointers[1].clientY,i=Math.sqrt(t*t+e*e),r=n.y-i;n.set(0,i);const o=this.dollyToCursor?(s.x-this._elementRect.x)/this._elementRect.width*2-1:0,a=this.dollyToCursor?(s.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&Ni.TOUCH_DOLLY)===Ni.TOUCH_DOLLY||(this._state&Ni.TOUCH_DOLLY_ROTATE)===Ni.TOUCH_DOLLY_ROTATE||(this._state&Ni.TOUCH_DOLLY_TRUCK)===Ni.TOUCH_DOLLY_TRUCK||(this._state&Ni.TOUCH_DOLLY_SCREEN_PAN)===Ni.TOUCH_DOLLY_SCREEN_PAN||(this._state&Ni.TOUCH_DOLLY_OFFSET)===Ni.TOUCH_DOLLY_OFFSET?(this._dollyInternal(r*ns,o,a),this._isUserControllingDolly=!0):(this._zoomInternal(r*ns,o,a),this._isUserControllingZoom=!0)}((this._state&Ni.TRUCK)===Ni.TRUCK||(this._state&Ni.TOUCH_TRUCK)===Ni.TOUCH_TRUCK||(this._state&Ni.TOUCH_DOLLY_TRUCK)===Ni.TOUCH_DOLLY_TRUCK||(this._state&Ni.TOUCH_ZOOM_TRUCK)===Ni.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(e,r,!1,!1),this._isUserControllingTruck=!0),((this._state&Ni.SCREEN_PAN)===Ni.SCREEN_PAN||(this._state&Ni.TOUCH_SCREEN_PAN)===Ni.TOUCH_SCREEN_PAN||(this._state&Ni.TOUCH_DOLLY_SCREEN_PAN)===Ni.TOUCH_DOLLY_SCREEN_PAN||(this._state&Ni.TOUCH_ZOOM_SCREEN_PAN)===Ni.TOUCH_ZOOM_SCREEN_PAN)&&(this._truckInternal(e,r,!1,!0),this._isUserControllingTruck=!0),((this._state&Ni.OFFSET)===Ni.OFFSET||(this._state&Ni.TOUCH_OFFSET)===Ni.TOUCH_OFFSET||(this._state&Ni.TOUCH_DOLLY_OFFSET)===Ni.TOUCH_DOLLY_OFFSET||(this._state&Ni.TOUCH_ZOOM_OFFSET)===Ni.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(e,r,!0,!1),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},p=()=>{ts(this._activePointers,cs),s.copy(cs),this._dragNeedsUpdate=!1,(0===this._activePointers.length||1===this._activePointers.length&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),0===this._activePointers.length&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",f),this._domElement.ownerDocument.addEventListener("pointerlockerror",m),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",a),d())},this.unlockPointer=()=>{var t,e,i;null!==this._lockedPointer&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),null===(t=this._domElement)||void 0===t||t.ownerDocument.exitPointerLock(),null===(e=this._domElement)||void 0===e||e.ownerDocument.removeEventListener("pointerlockchange",f),null===(i=this._domElement)||void 0===i||i.ownerDocument.removeEventListener("pointerlockerror",m),this.cancel()};const f=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},m=()=>{this.unlockPointer()};this._addAllEventListeners=t=>{this._domElement=t,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",r),this._domElement.addEventListener("pointercancel",a),this._domElement.addEventListener("wheel",h,{passive:!1}),this._domElement.addEventListener("contextmenu",c)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",r),this._domElement.removeEventListener("pointercancel",a),this._domElement.removeEventListener("wheel",h,{passive:!1}),this._domElement.removeEventListener("contextmenu",c),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this._domElement.ownerDocument.removeEventListener("pointerlockchange",f),this._domElement.ownerDocument.removeEventListener("pointerlockerror",m))},this.cancel=()=>{this._state!==Ni.NONE&&(this._state=Ni.NONE,this._activePointers.length=0,p())},e&&this.connect(e),this.update(0)}get camera(){return this._camera}set camera(t){this._camera=t,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._domElement&&(t?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(t){this._spherical.radius===t&&this._sphericalEnd.radius===t||(this._spherical.radius=t,this._sphericalEnd.radius=t,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(t){this._spherical.theta===t&&this._sphericalEnd.theta===t||(this._spherical.theta=t,this._sphericalEnd.theta=t,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(t){this._spherical.phi===t&&this._sphericalEnd.phi===t||(this._spherical.phi=t,this._sphericalEnd.phi=t,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(t){this._boundaryEnclosesCamera=t,this._needsUpdate=!0}set interactiveArea(t){this._interactiveArea.width=Zi(t.width,0,1),this._interactiveArea.height=Zi(t.height,0,1),this._interactiveArea.x=Zi(t.x,0,1-this._interactiveArea.width),this._interactiveArea.y=Zi(t.y,0,1-this._interactiveArea.height)}addEventListener(t,e){super.addEventListener(t,e)}removeEventListener(t,e){super.removeEventListener(t,e)}rotate(t,e,i=!1){return this.rotateTo(this._sphericalEnd.theta+t,this._sphericalEnd.phi+e,i)}rotateAzimuthTo(t,e=!1){return this.rotateTo(t,this._sphericalEnd.phi,e)}rotatePolarTo(t,e=!1){return this.rotateTo(this._sphericalEnd.theta,t,e)}rotateTo(t,e,i=!1){this._isUserControllingRotate=!1;const s=Zi(t,this.minAzimuthAngle,this.maxAzimuthAngle),n=Zi(e,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=s,this._sphericalEnd.phi=n,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,i||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const r=!i||Xi(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Xi(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(r)}dolly(t,e=!1){return this.dollyTo(this._sphericalEnd.radius-t,e)}dollyTo(t,e=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=Bi,this._changedDolly=0,this._dollyToNoClamp(Zi(t,this.minDistance,this.maxDistance),e)}_dollyToNoClamp(t,e=!1){const i=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const e=this._collisionTest(),s=Xi(e,this._spherical.radius);if(!(i>t)&&s)return Promise.resolve();this._sphericalEnd.radius=Math.min(t,e)}else this._sphericalEnd.radius=t;this._needsUpdate=!0,e||(this._spherical.radius=this._sphericalEnd.radius);const s=!e||Xi(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(s)}dollyInFixed(t,e=!1){this._targetEnd.add(this._getCameraDirection(fs).multiplyScalar(t)),e||this._target.copy(this._targetEnd);const i=!e||Xi(this._target.x,this._targetEnd.x,this.restThreshold)&&Xi(this._target.y,this._targetEnd.y,this.restThreshold)&&Xi(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(i)}zoom(t,e=!1){return this.zoomTo(this._zoomEnd+t,e)}zoomTo(t,e=!1){this._isUserControllingZoom=!1,this._zoomEnd=Zi(t,this.minZoom,this.maxZoom),this._needsUpdate=!0,e||(this._zoom=this._zoomEnd);const i=!e||Xi(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(i)}pan(t,e,i=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(t,e,i)}truck(t,e,i=!1){this._camera.updateMatrix(),ms.setFromMatrixColumn(this._camera.matrix,0),gs.setFromMatrixColumn(this._camera.matrix,1),ms.multiplyScalar(t),gs.multiplyScalar(-e);const s=ds.copy(ms).add(gs),n=us.copy(this._targetEnd).add(s);return this.moveTo(n.x,n.y,n.z,i)}forward(t,e=!1){ds.setFromMatrixColumn(this._camera.matrix,0),ds.crossVectors(this._camera.up,ds),ds.multiplyScalar(t);const i=us.copy(this._targetEnd).add(ds);return this.moveTo(i.x,i.y,i.z,e)}elevate(t,e=!1){return ds.copy(this._camera.up).multiplyScalar(t),this.moveTo(this._targetEnd.x+ds.x,this._targetEnd.y+ds.y,this._targetEnd.z+ds.z,e)}moveTo(t,e,i,s=!1){this._isUserControllingTruck=!1;const n=ds.set(t,e,i).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,n,this.boundaryFriction),this._needsUpdate=!0,s||this._target.copy(this._targetEnd);const r=!s||Xi(this._target.x,this._targetEnd.x,this.restThreshold)&&Xi(this._target.y,this._targetEnd.y,this.restThreshold)&&Xi(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(r)}lookInDirectionOf(t,e,i,s=!1){const n=ds.set(t,e,i).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(n.x,n.y,n.z,s)}fitToBox(t,e,{cover:i=!1,paddingLeft:s=0,paddingRight:n=0,paddingBottom:r=0,paddingTop:o=0}={}){const a=[],l=t.isBox3?xs.copy(t):xs.setFromObject(t);l.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const h=qi(this._sphericalEnd.theta,Hi),c=qi(this._sphericalEnd.phi,Hi);a.push(this.rotateTo(h,c,e));const d=ds.setFromSpherical(this._sphericalEnd).normalize(),u=Cs.setFromUnitVectors(d,hs),p=Xi(Math.abs(d.y),1);p&&u.multiply(Ts.setFromAxisAngle(ls,h)),u.multiply(this._yAxisUpSpaceInverse);const f=Ss.makeEmpty();us.copy(l.min).applyQuaternion(u),f.expandByPoint(us),us.copy(l.min).setX(l.max.x).applyQuaternion(u),f.expandByPoint(us),us.copy(l.min).setY(l.max.y).applyQuaternion(u),f.expandByPoint(us),us.copy(l.max).setZ(l.min.z).applyQuaternion(u),f.expandByPoint(us),us.copy(l.min).setZ(l.max.z).applyQuaternion(u),f.expandByPoint(us),us.copy(l.max).setY(l.min.y).applyQuaternion(u),f.expandByPoint(us),us.copy(l.max).setX(l.min.x).applyQuaternion(u),f.expandByPoint(us),us.copy(l.max).applyQuaternion(u),f.expandByPoint(us),f.min.x-=s,f.min.y-=r,f.max.x+=n,f.max.y+=o,u.setFromUnitVectors(hs,d),p&&u.premultiply(Ts.invert()),u.premultiply(this._yAxisUpSpace);const m=f.getSize(ds),g=f.getCenter(us).applyQuaternion(u);if(Fi(this._camera)){const t=this.getDistanceToFitBox(m.x,m.y,m.z,i);a.push(this.moveTo(g.x,g.y,g.z,e)),a.push(this.dollyTo(t,e)),a.push(this.setFocalOffset(0,0,0,e))}else if(Vi(this._camera)){const t=this._camera,s=t.right-t.left,n=t.top-t.bottom,r=i?Math.max(s/m.x,n/m.y):Math.min(s/m.x,n/m.y);a.push(this.moveTo(g.x,g.y,g.z,e)),a.push(this.zoomTo(r,e)),a.push(this.setFocalOffset(0,0,0,e))}return Promise.all(a)}fitToSphere(t,e){const i=[],s="isObject3D"in t?Ms.createBoundingSphere(t,Es):Es.copy(t);if(i.push(this.moveTo(s.center.x,s.center.y,s.center.z,e)),Fi(this._camera)){const t=this.getDistanceToFitSphere(s.radius);i.push(this.dollyTo(t,e))}else if(Vi(this._camera)){const t=this._camera.right-this._camera.left,n=this._camera.top-this._camera.bottom,r=2*s.radius,o=Math.min(t/r,n/r);i.push(this.zoomTo(o,e))}return i.push(this.setFocalOffset(0,0,0,e)),Promise.all(i)}setLookAt(t,e,i,s,n,r,o=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Bi,this._changedDolly=0;const a=us.set(s,n,r),l=ds.set(t,e,i);this._targetEnd.copy(a),this._sphericalEnd.setFromVector3(l.sub(a).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,o||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const h=!o||Xi(this._target.x,this._targetEnd.x,this.restThreshold)&&Xi(this._target.y,this._targetEnd.y,this.restThreshold)&&Xi(this._target.z,this._targetEnd.z,this.restThreshold)&&Xi(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Xi(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Xi(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(h)}lerpLookAt(t,e,i,s,n,r,o,a,l,h,c,d,u,p=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Bi,this._changedDolly=0;const f=ds.set(s,n,r),m=us.set(t,e,i);ws.setFromVector3(m.sub(f).applyQuaternion(this._yAxisUpSpace));const g=ps.set(h,c,d),v=us.set(o,a,l);bs.setFromVector3(v.sub(g).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(f.lerp(g,u));const _=bs.theta-ws.theta,y=bs.phi-ws.phi,w=bs.radius-ws.radius;this._sphericalEnd.set(ws.radius+w*u,ws.phi+y*u,ws.theta+_*u),this.normalizeRotations(),this._needsUpdate=!0,p||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const b=!p||Xi(this._target.x,this._targetEnd.x,this.restThreshold)&&Xi(this._target.y,this._targetEnd.y,this.restThreshold)&&Xi(this._target.z,this._targetEnd.z,this.restThreshold)&&Xi(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Xi(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Xi(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(b)}setPosition(t,e,i,s=!1){return this.setLookAt(t,e,i,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,s)}setTarget(t,e,i,s=!1){const n=this.getPosition(ds),r=this.setLookAt(n.x,n.y,n.z,t,e,i,s);return this._sphericalEnd.phi=Zi(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),r}setFocalOffset(t,e,i,s=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(t,e,i),this._needsUpdate=!0,s||this._focalOffset.copy(this._focalOffsetEnd);const n=!s||Xi(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&Xi(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&Xi(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(n)}setOrbitPoint(t,e,i){this._camera.updateMatrixWorld(),ms.setFromMatrixColumn(this._camera.matrixWorldInverse,0),gs.setFromMatrixColumn(this._camera.matrixWorldInverse,1),vs.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const s=ds.set(t,e,i),n=s.distanceTo(this._camera.position),r=s.sub(this._camera.position);ms.multiplyScalar(r.x),gs.multiplyScalar(r.y),vs.multiplyScalar(r.z),ds.copy(ms).add(gs).add(vs),ds.z=ds.z+n,this.dollyTo(n,!1),this.setFocalOffset(-ds.x,ds.y,-ds.z,!1),this.moveTo(t,e,i,!1)}setBoundary(t){if(!t)return this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),void(this._needsUpdate=!0);this._boundary.copy(t),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(t,e,i,s){null!==t?(this._viewport=this._viewport||new os.Vector4,"number"==typeof t?this._viewport.set(t,e,i,s):this._viewport.copy(t)):this._viewport=null}getDistanceToFitBox(t,e,i,s=!1){if(es(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const n=t/e,r=this._camera.getEffectiveFOV()*Gi,o=this._camera.aspect;return.5*((s?n>o:n<o)?e:t/o)/Math.tan(.5*r)+.5*i}getDistanceToFitSphere(t){if(es(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const e=this._camera.getEffectiveFOV()*Gi,i=2*Math.atan(Math.tan(.5*e)*this._camera.aspect),s=1<this._camera.aspect?e:i;return t/Math.sin(.5*s)}getTarget(t,e=!0){return(t&&t.isVector3?t:new os.Vector3).copy(e?this._targetEnd:this._target)}getPosition(t,e=!0){return(t&&t.isVector3?t:new os.Vector3).setFromSpherical(e?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(e?this._targetEnd:this._target)}getSpherical(t,e=!0){return(t||new os.Spherical).copy(e?this._sphericalEnd:this._spherical)}getFocalOffset(t,e=!0){return(t&&t.isVector3?t:new os.Vector3).copy(e?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%ji,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=ji),this._spherical.theta+=ji*Math.round((this._sphericalEnd.theta-this._spherical.theta)/ji)}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(t=!1){if(!Xi(this._camera.up.x,this._cameraUp0.x)||!Xi(this._camera.up.y,this._cameraUp0.y)||!Xi(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const t=this.getPosition(ds);this.updateCameraUp(),this.setPosition(t.x,t.y,t.z)}const e=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,t),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,t),this.zoomTo(this._zoom0,t)];return Promise.all(e)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,ls),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const t=ds.subVectors(this._target,this._camera.position).normalize(),e=us.crossVectors(t,this._camera.up);this._camera.up.crossVectors(e,t).normalize(),this._camera.updateMatrixWorld();const i=this.getPosition(ds);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}update(t){const e=this._sphericalEnd.theta-this._spherical.theta,i=this._sphericalEnd.phi-this._spherical.phi,s=this._sphericalEnd.radius-this._spherical.radius,n=_s.subVectors(this._targetEnd,this._target),r=ys.subVectors(this._focalOffsetEnd,this._focalOffset),o=this._zoomEnd-this._zoom;if(Yi(e))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const e=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=Ji(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,e,1/0,t),this._needsUpdate=!0}if(Yi(i))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const e=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=Ji(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,e,1/0,t),this._needsUpdate=!0}if(Yi(s))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const e=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=Ji(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,e,this.maxSpeed,t),this._needsUpdate=!0}if(Yi(n.x)&&Yi(n.y)&&Yi(n.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const e=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;$i(this._target,this._targetEnd,this._targetVelocity,e,this.maxSpeed,t,this._target),this._needsUpdate=!0}if(Yi(r.x)&&Yi(r.y)&&Yi(r.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const e=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;$i(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,e,this.maxSpeed,t,this._focalOffset),this._needsUpdate=!0}if(Yi(o))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const e=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=Ji(this._zoom,this._zoomEnd,this._zoomVelocity,e,1/0,t)}if(this.dollyToCursor)if(Fi(this._camera)&&0!==this._changedDolly){const t=this._spherical.radius-this._lastDistance,e=this._camera,i=this._getCameraDirection(fs),s=ds.copy(i).cross(e.up).normalize();0===s.lengthSq()&&(s.x=1);const n=us.crossVectors(s,i),r=this._sphericalEnd.radius*Math.tan(e.getEffectiveFOV()*Gi*.5),o=(this._sphericalEnd.radius-t-this._sphericalEnd.radius)/this._sphericalEnd.radius,a=ps.copy(this._targetEnd).add(s.multiplyScalar(this._dollyControlCoord.x*r*e.aspect)).add(n.multiplyScalar(this._dollyControlCoord.y*r)),l=ds.copy(this._targetEnd).lerp(a,o),h=this._lastDollyDirection===Ui&&this._spherical.radius<=this.minDistance,c=this._lastDollyDirection===Ri&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(h||c)){this._sphericalEnd.radius-=t,this._spherical.radius-=t;const e=us.copy(i).multiplyScalar(-t);l.add(e)}this._boundary.clampPoint(l,l);const d=us.subVectors(l,this._targetEnd);this._targetEnd.copy(l),this._target.add(d),this._changedDolly-=t,Yi(this._changedDolly)&&(this._changedDolly=0)}else if(Vi(this._camera)&&0!==this._changedZoom){const t=this._zoom-this._lastZoom,e=this._camera,i=ds.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(e.near+e.far)/(e.near-e.far)).unproject(e),s=us.set(0,0,-1).applyQuaternion(e.quaternion),n=ps.copy(i).add(s.multiplyScalar(-i.dot(e.up))),r=-(this._zoom-t-this._zoom)/this._zoom,o=this._getCameraDirection(fs),a=this._targetEnd.dot(o),l=ds.copy(this._targetEnd).lerp(n,r),h=l.dot(o),c=o.multiplyScalar(h-a);l.sub(c),this._boundary.clampPoint(l,l);const d=us.subVectors(l,this._targetEnd);this._targetEnd.copy(l),this._target.add(d),this._changedZoom-=t,Yi(this._changedZoom)&&(this._changedZoom=0)}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const a=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,a),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!Yi(this._focalOffset.x)||!Yi(this._focalOffset.y)||!Yi(this._focalOffset.z))&&(ms.setFromMatrixColumn(this._camera.matrix,0),gs.setFromMatrixColumn(this._camera.matrix,1),vs.setFromMatrixColumn(this._camera.matrix,2),ms.multiplyScalar(this._focalOffset.x),gs.multiplyScalar(-this._focalOffset.y),vs.multiplyScalar(this._focalOffset.z),ds.copy(ms).add(gs).add(vs),this._camera.position.add(ds),this._camera.updateMatrixWorld()),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),ds.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const l=this._needsUpdate;return l&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):l?(this.dispatchEvent({type:"update"}),Yi(e,this.restThreshold)&&Yi(i,this.restThreshold)&&Yi(s,this.restThreshold)&&Yi(n.x,this.restThreshold)&&Yi(n.y,this.restThreshold)&&Yi(n.z,this.restThreshold)&&Yi(r.x,this.restThreshold)&&Yi(r.y,this.restThreshold)&&Yi(r.z,this.restThreshold)&&Yi(o,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!l&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=l,this._needsUpdate=!1,l}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:Qi(this.maxDistance),minZoom:this.minZoom,maxZoom:Qi(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:Qi(this.maxPolarAngle),minAzimuthAngle:Qi(this.minAzimuthAngle),maxAzimuthAngle:Qi(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,target:this._targetEnd.toArray(),position:ds.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(t,e=!1){const i=JSON.parse(t);this.enabled=i.enabled,this.minDistance=i.minDistance,this.maxDistance=Ki(i.maxDistance),this.minZoom=i.minZoom,this.maxZoom=Ki(i.maxZoom),this.minPolarAngle=i.minPolarAngle,this.maxPolarAngle=Ki(i.maxPolarAngle),this.minAzimuthAngle=Ki(i.minAzimuthAngle),this.maxAzimuthAngle=Ki(i.maxAzimuthAngle),this.smoothTime=i.smoothTime,this.draggingSmoothTime=i.draggingSmoothTime,this.dollySpeed=i.dollySpeed,this.truckSpeed=i.truckSpeed,this.dollyToCursor=i.dollyToCursor,this._target0.fromArray(i.target0),this._position0.fromArray(i.position0),this._zoom0=i.zoom0,this._focalOffset0.fromArray(i.focalOffset0),this.moveTo(i.target[0],i.target[1],i.target[2],e),ws.setFromVector3(ds.fromArray(i.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(ws.theta,ws.phi,e),this.dollyTo(ws.radius,e),this.zoomTo(i.zoom,e),this.setFocalOffset(i.focalOffset[0],i.focalOffset[1],i.focalOffset[2],e),this._needsUpdate=!0}connect(t){this._domElement?console.warn("camera-controls is already connected."):(t.setAttribute("data-camera-controls-version","2.10.1"),this._addAllEventListeners(t),this._getClientRect(this._elementRect))}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(t){return t.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(t){return this._getTargetDirection(t).negate()}_findPointerById(t){return this._activePointers.find(e=>e.pointerId===t)}_findPointerByMouseButton(t){return this._activePointers.find(e=>e.mouseButton===t)}_disposePointer(t){this._activePointers.splice(this._activePointers.indexOf(t),1)}_encloseToBoundary(t,e,i){const s=e.lengthSq();if(0===s)return t;const n=us.copy(e).add(t),r=this._boundary.clampPoint(n,ps).sub(n),o=r.lengthSq();if(0===o)return t.add(e);if(o===s)return t;if(0===i)return t.add(e).add(r);{const s=1+i*o/e.dot(r);return t.add(us.copy(e).multiplyScalar(s)).add(r.multiplyScalar(1-i))}}_updateNearPlaneCorners(){if(Fi(this._camera)){const t=this._camera,e=t.near,i=t.getEffectiveFOV()*Gi,s=Math.tan(.5*i)*e,n=s*t.aspect;this._nearPlaneCorners[0].set(-n,-s,0),this._nearPlaneCorners[1].set(n,-s,0),this._nearPlaneCorners[2].set(n,s,0),this._nearPlaneCorners[3].set(-n,s,0)}else if(Vi(this._camera)){const t=this._camera,e=1/t.zoom,i=t.left*e,s=t.right*e,n=t.top*e,r=t.bottom*e;this._nearPlaneCorners[0].set(i,n,0),this._nearPlaneCorners[1].set(s,n,0),this._nearPlaneCorners[2].set(s,r,0),this._nearPlaneCorners[3].set(i,r,0)}}_collisionTest(){let t=1/0;if(!(this.colliderMeshes.length>=1)||es(this._camera,"_collisionTest"))return t;const e=this._getTargetDirection(fs);Ps.lookAt(as,e,this._camera.up);for(let i=0;i<4;i++){const s=us.copy(this._nearPlaneCorners[i]);s.applyMatrix4(Ps);const n=ps.addVectors(this._target,s);As.set(n,e),As.far=this._spherical.radius+1;const r=As.intersectObjects(this.colliderMeshes);0!==r.length&&r[0].distance<t&&(t=r[0].distance)}return t}_getClientRect(t){if(!this._domElement)return;const e=this._domElement.getBoundingClientRect();return t.x=e.left,t.y=e.top,this._viewport?(t.x+=this._viewport.x,t.y+=e.height-this._viewport.w-this._viewport.y,t.width=this._viewport.z,t.height=this._viewport.w):(t.width=e.width,t.height=e.height),t}_createOnRestPromise(t){return t?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(t=>{const e=()=>{this.removeEventListener("rest",e),t()};this.addEventListener("rest",e)}))}_addAllEventListeners(t){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(t){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(t){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(t,e=new os.Sphere){const i=e,s=i.center;xs.makeEmpty(),t.traverseVisible(t=>{t.isMesh&&xs.expandByObject(t)}),xs.getCenter(s);let n=0;return t.traverseVisible(t=>{if(!t.isMesh)return;const e=t;if(!e.geometry)return;const i=e.geometry.clone();i.applyMatrix4(e.matrixWorld);const r=i.attributes.position;for(let t=0,e=r.count;t<e;t++)ds.fromBufferAttribute(r,t),n=Math.max(n,s.distanceToSquared(ds))}),i.radius=Math.sqrt(n),i}}class Os extends zt{constructor(t){super(t),Pt(this,"onBeforeUpdate",new At),Pt(this,"onAfterUpdate",new At),Pt(this,"onAspectUpdated",new At),Pt(this,"onDisposed",new At),Pt(this,"three"),Pt(this,"_allControls",new Map),Pt(this,"updateAspect",()=>{var t;if(this.currentWorld&&this.currentWorld.renderer){if(this.three instanceof o.OrthographicCamera)return void this.onAspectUpdated.trigger();if(null!=(t=this.currentWorld.renderer)&&t.isResizeable()){const t=this.currentWorld.renderer.getSize();this.three.aspect=t.width/t.height,this.three.updateProjectionMatrix(),this.onAspectUpdated.trigger()}}}),this.three=this.setupCamera(),this.setupEvents(!0),this.worlds.onItemSet.add(({value:t})=>{const e=this.newCameraControls();this._allControls.set(t.uuid,e)}),this.worlds.onBeforeDelete.add(({value:t})=>{const e=this._allControls.get(t.uuid);e&&(e.dispose(),this._allControls.delete(t.uuid))})}get controls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");const t=this._allControls.get(this.currentWorld.uuid);if(!t)throw new Error("Controls not found!");return t}get enabled(){return null!==this.currentWorld&&this.controls.enabled}set enabled(t){null!==this.currentWorld&&(this.controls.enabled=t)}set currentWorld(t){super.currentWorld=t,t&&(this.worlds.get(t.uuid)||this.worlds.set(t.uuid,t))}get currentWorld(){return this._currentWorld}dispose(){this.setupEvents(!1),this.onAspectUpdated.reset(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.three.removeFromParent(),this.onDisposed.trigger(),this.onDisposed.reset();for(const[t,e]of this._allControls)e.dispose();this.worlds.clear()}async fitToItems(t){const e=await this.getItemsBounding(t);await this.controls.fitToSphere(e,!0)}async setOrbitToItems(t){const e=await this.getItemsBounding(t);this.controls.setOrbitPoint(e.center.x,e.center.y,e.center.z)}update(t){this.enabled&&(this.onBeforeUpdate.trigger(this),this.controls.update(t),this.onAfterUpdate.trigger(this))}async getItemsBounding(t){const e=this.components.get(pi),i=this.components.get(_i);i.list.clear();const s=new o.Sphere;if(t)await i.addFromModelIdMap(t);else for(const[,t]of e.list)i.list.add(t.box);return i.get().getBoundingSphere(s),i.list.clear(),s}setupCamera(){const t=window.innerWidth/window.innerHeight,e=new o.PerspectiveCamera(60,t,1,1e3);return e.position.set(50,50,50),e.lookAt(new o.Vector3(0,0,0)),e}newCameraControls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");if(!this.currentWorld.renderer)throw new Error("This camera needs a renderer to work!");Ms.install({THREE:Os.getSubsetOfThree()});const{domElement:t}=this.currentWorld.renderer.three,e=new Ms(this.three,t);return e.smoothTime=.2,e.dollyToCursor=!0,e.infinityDolly=!0,e.minDistance=6,e}setupEvents(t){t?window.addEventListener("resize",this.updateAspect):window.removeEventListener("resize",this.updateAspect)}static getSubsetOfThree(){return{MOUSE:o.MOUSE,Vector2:o.Vector2,Vector3:o.Vector3,Vector4:o.Vector4,Quaternion:o.Quaternion,Matrix4:o.Matrix4,Spherical:o.Spherical,Box3:o.Box3,Sphere:o.Sphere,Raycaster:o.Raycaster,MathUtils:o.MathUtils}}}const Ds=class t extends Ot{constructor(e){super(e),Pt(this,"onAfterUpdate",new At),Pt(this,"onBeforeUpdate",new At),Pt(this,"onDisposed",new At),Pt(this,"list",new s),Pt(this,"enabled",!0),e.add(t.uuid,this)}create(){const t=new Oi(this.components),e=t.uuid;if(this.list.has(e))throw new Error("There is already a world with this name!");return this.list.set(e,t),t}delete(t){if(!this.list.has(t.uuid))throw new Error("The provided world is not found in the list!");this.list.delete(t.uuid),t.dispose()}dispose(){this.enabled=!1;for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}update(t){if(this.enabled)for(const[e,i]of this.list)i.update(t)}};Pt(Ds,"uuid","fdb61dc4-2ec1-4966-b83d-54ea795fad4a");let zs=Ds;class Is extends li{constructor(){super(...arguments),Pt(this,"_config",{visible:{value:!0,type:"Boolean"},color:{value:new o.Color,type:"Color"},primarySize:{type:"Number",interpolable:!0,value:1,min:0,max:1e3},secondarySize:{type:"Number",interpolable:!0,value:10,min:0,max:1e3},distance:{type:"Number",interpolable:!0,value:500,min:0,max:500}})}get visible(){return this._config.visible.value}set visible(t){this._config.visible.value=t,this._component.visible=t}get color(){return this._config.color.value}set color(t){this._config.color.value=t,this._component.material.uniforms.uColor.value=t,this._component.material.uniformsNeedUpdate=!0}get primarySize(){return this._config.primarySize.value}set primarySize(t){this._config.primarySize.value=t,this._component.material.uniforms.uSize1.value=t,this._component.material.uniformsNeedUpdate=!0}get secondarySize(){return this._config.secondarySize.value}set secondarySize(t){this._config.secondarySize.value=t,this._component.material.uniforms.uSize2.value=t,this._component.material.uniformsNeedUpdate=!0}get distance(){return this._config.distance.value}set distance(t){this._config.distance.value=t,this._component.material.uniforms.uDistance.value=t,this._component.material.uniformsNeedUpdate=!0}}class ks{constructor(t,e){Pt(this,"onDisposed",new At),Pt(this,"onSetup",new At),Pt(this,"isSetup",!1),Pt(this,"world"),Pt(this,"components"),Pt(this,"config"),Pt(this,"_defaultConfig",{visible:!0,color:new o.Color(12303291),primarySize:1,secondarySize:10,distance:500}),Pt(this,"three"),Pt(this,"_fade",3),Pt(this,"updateZoom",()=>{this.world.camera instanceof Os&&(this.material.uniforms.uZoom.value=this.world.camera.three.zoom)}),this.world=e;const{color:i,primarySize:s,secondarySize:n,distance:r}=this._defaultConfig;this.components=t,this.config=new Is(this,this.components,"Grid");const a=new o.PlaneGeometry(2,2,1,1),l=new o.ShaderMaterial({side:o.DoubleSide,uniforms:{uSize1:{value:s},uSize2:{value:n},uColor:{value:i},uDistance:{value:r},uFade:{value:this._fade},uZoom:{value:1}},transparent:!0,vertexShader:"\n            \n            varying vec3 worldPosition;\n            \n            uniform float uDistance;\n            \n            void main() {\n            \n                    vec3 pos = position.xzy * uDistance;\n                    pos.xz += cameraPosition.xz;\n                    \n                    worldPosition = pos;\n                    \n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n            \n            }\n            ",fragmentShader:"\n            \n            varying vec3 worldPosition;\n            \n            uniform float uZoom;\n            uniform float uFade;\n            uniform float uSize1;\n            uniform float uSize2;\n            uniform vec3 uColor;\n            uniform float uDistance;\n                \n                \n                \n                float getGrid(float size) {\n                \n                    vec2 r = worldPosition.xz / size;\n                    \n                    \n                    vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);\n                    float line = min(grid.x, grid.y);\n                    \n                \n                    return 1.0 - min(line, 1.0);\n                }\n                \n            void main() {\n            \n                    \n                    float d = 1.0 - min(distance(cameraPosition.xz, worldPosition.xz) / uDistance, 1.0);\n                    \n                    float g1 = getGrid(uSize1);\n                    float g2 = getGrid(uSize2);\n                    \n                    // Ortho camera fades the grid away when zooming out\n                    float minZoom = step(0.2, uZoom);\n                    float zoomFactor = pow(min(uZoom, 1.), 2.) * minZoom;\n                    \n                    gl_FragColor = vec4(uColor.rgb, mix(g2, g1, g1) * pow(d, uFade));\n                    gl_FragColor.a = mix(0.5 * gl_FragColor.a, gl_FragColor.a, g2) * zoomFactor;\n                    \n                    if ( gl_FragColor.a <= 0.0 ) discard;\n                    \n            \n            }\n            \n            ",extensions:{derivatives:!0}});this.three=new o.Mesh(a,l),this.three.frustumCulled=!1,e.scene.three.add(this.three),this.setupEvents(!0)}get visible(){return this.three.visible}set visible(t){this.three.visible=t,t?this.world.scene.three.add(this.three):this.three.removeFromParent()}get material(){return this.three.material}get fade(){return 3===this._fade}set fade(t){this._fade=t?3:0,this.material.uniforms.uFade.value=this._fade}setup(t){const e={...this._defaultConfig,...t};this.config.visible=!0,this.config.color=e.color,this.config.primarySize=e.primarySize,this.config.secondarySize=e.secondarySize,this.config.distance=e.distance,this.isSetup=!0,this.onSetup.trigger()}dispose(){this.setupEvents(!1),this.components.get(ci).list.delete(this.config.uuid),this.components.get(Lt).destroy(this.three),this.onDisposed.trigger(),this.onDisposed.reset(),this.world=null,this.components=null}setupEvents(t){if(this.world.isDisposing||!(this.world.camera instanceof Os))return;const e=this.world.camera.controls;t?e.addEventListener("update",this.updateZoom):e.removeEventListener("update",this.updateZoom)}}Pt(class t extends Ot{constructor(e){super(e),Pt(this,"list",new Map),Pt(this,"onDisposed",new At),Pt(this,"enabled",!0),e.add(t.uuid,this)}create(t){if(this.list.has(t.uuid))throw new Error("This world already has a grid!");const e=new ks(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add(()=>{this.delete(t)}),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger(),this.onDisposed.reset()}},"uuid","d1e814d5-b81c-4452-87a2-f039375e0489");const Ls=1.25,Ns=65535,Bs=Math.pow(2,-24),Us=Symbol("SKIP_GENERATION");function Rs(t){return function(t){return t.index?t.index.count:t.attributes.position.count}(t)/3}function Fs(t,e){if(!t.index){const i=t.attributes.position.count,s=function(t,e=ArrayBuffer){return t>65535?new Uint32Array(new e(4*t)):new Uint16Array(new e(2*t))}(i,e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);t.setIndex(new w(s,1));for(let t=0;t<i;t++)s[t]=t}}function Vs(t){const e=Rs(t),i=t.drawRange,s=i.start/3,n=(i.start+i.count)/3,r=Math.max(0,s),o=Math.min(e,n)-r;return[{offset:Math.floor(r),count:Math.floor(o)}]}function js(t){if(!t.groups||!t.groups.length)return Vs(t);const e=[],i=new Set,s=t.drawRange,n=s.start/3,r=(s.start+s.count)/3;for(const e of t.groups){const t=e.start/3,s=(e.start+e.count)/3;i.add(Math.max(n,t)),i.add(Math.min(r,s))}const o=Array.from(i.values()).sort((t,e)=>t-e);for(let t=0;t<o.length-1;t++){const i=o[t],s=o[t+1];e.push({offset:Math.floor(i),count:Math.floor(s-i)})}return e}function Hs(t,e,i){return i.min.x=e[t],i.min.y=e[t+1],i.min.z=e[t+2],i.max.x=e[t+3],i.max.y=e[t+4],i.max.z=e[t+5],i}function Ws(t){let e=-1,i=-1/0;for(let s=0;s<3;s++){const n=t[s+3]-t[s];n>i&&(i=n,e=s)}return e}function Gs(t,e){e.set(t)}function Zs(t,e,i){let s,n;for(let r=0;r<3;r++){const o=r+3;s=t[r],n=e[r],i[r]=s<n?s:n,s=t[o],n=e[o],i[o]=s>n?s:n}}function Ys(t,e,i){for(let s=0;s<3;s++){const n=e[t+2*s],r=e[t+2*s+1],o=n-r,a=n+r;o<i[s]&&(i[s]=o),a>i[s+3]&&(i[s+3]=a)}}function Xs(t){const e=t[3]-t[0],i=t[4]-t[1],s=t[5]-t[2];return 2*(e*i+i*s+s*e)}function qs(t,e,i,s,n=null){let r=1/0,o=1/0,a=1/0,l=-1/0,h=-1/0,c=-1/0,d=1/0,u=1/0,p=1/0,f=-1/0,m=-1/0,g=-1/0;const v=null!==n;for(let s=6*e,n=6*(e+i);s<n;s+=6){const e=t[s+0],i=t[s+1],n=e-i,_=e+i;n<r&&(r=n),_>l&&(l=_),v&&e<d&&(d=e),v&&e>f&&(f=e);const y=t[s+2],w=t[s+3],b=y-w,x=y+w;b<o&&(o=b),x>h&&(h=x),v&&y<u&&(u=y),v&&y>m&&(m=y);const S=t[s+4],E=t[s+5],C=S-E,T=S+E;C<a&&(a=C),T>c&&(c=T),v&&S<p&&(p=S),v&&S>g&&(g=S)}s[0]=r,s[1]=o,s[2]=a,s[3]=l,s[4]=h,s[5]=c,v&&(n[0]=d,n[1]=u,n[2]=p,n[3]=f,n[4]=m,n[5]=g)}const Qs=32,Ks=(t,e)=>t.candidate-e.candidate,Js=new Array(Qs).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),$s=new Float32Array(6);class tn{constructor(){}}function en(t,e,i,s,n,r){let o=s,a=s+n-1;const l=r.pos,h=2*r.axis;for(;;){for(;o<=a&&i[6*o+h]<l;)o++;for(;o<=a&&i[6*a+h]>=l;)a--;if(!(o<a))return o;for(let t=0;t<3;t++){let i=e[3*o+t];e[3*o+t]=e[3*a+t],e[3*a+t]=i}for(let t=0;t<6;t++){let e=i[6*o+t];i[6*o+t]=i[6*a+t],i[6*a+t]=e}o++,a--}}function sn(t,e,i,s,n,r){let o=s,a=s+n-1;const l=r.pos,h=2*r.axis;for(;;){for(;o<=a&&i[6*o+h]<l;)o++;for(;o<=a&&i[6*a+h]>=l;)a--;if(!(o<a))return o;{let e=t[o];t[o]=t[a],t[a]=e;for(let t=0;t<6;t++){let e=i[6*o+t];i[6*o+t]=i[6*a+t],i[6*a+t]=e}o++,a--}}}function nn(t,e){const i=t.geometry,s=i.index?i.index.array:null,n=e.maxDepth,r=e.verbose,o=e.maxLeafTris,a=e.strategy,l=e.onProgress,h=Rs(i),c=t._indirectBuffer;let d=!1;const u=new Float32Array(6),p=new Float32Array(6),f=function(t,e){!function(t){t[0]=t[1]=t[2]=1/0,t[3]=t[4]=t[5]=-1/0}(e);const i=t.attributes.position,s=t.index?t.index.array:null,n=Rs(t),r=new Float32Array(6*n),o=i.normalized,a=i.array,l=i.offset||0;let h=3;i.isInterleavedBufferAttribute&&(h=i.data.stride);const c=["getX","getY","getZ"];for(let t=0;t<n;t++){const n=3*t,d=6*t;let u=n+0,p=n+1,f=n+2;s&&(u=s[u],p=s[p],f=s[f]),o||(u=u*h+l,p=p*h+l,f=f*h+l);for(let t=0;t<3;t++){let s,n,l;o?(s=i[c[t]](u),n=i[c[t]](p),l=i[c[t]](f)):(s=a[u+t],n=a[p+t],l=a[f+t]);let h=s;n<h&&(h=n),l<h&&(h=l);let m=s;n>m&&(m=n),l>m&&(m=l);const g=(m-h)/2,v=2*t;r[d+v+0]=h+g,r[d+v+1]=g+(Math.abs(h)+g)*Bs,h<e[t]&&(e[t]=h),m>e[t+3]&&(e[t+3]=m)}}return r}(i,u),m=e.indirect?sn:en,g=[],v=e.indirect?Vs(i):js(i);if(1===v.length){const t=v[0],e=new tn;e.boundingData=u,function(t,e,i,s){let n=1/0,r=1/0,o=1/0,a=-1/0,l=-1/0,h=-1/0;for(let s=6*e,c=6*(e+i);s<c;s+=6){const e=t[s+0];e<n&&(n=e),e>a&&(a=e);const i=t[s+2];i<r&&(r=i),i>l&&(l=i);const c=t[s+4];c<o&&(o=c),c>h&&(h=c)}s[0]=n,s[1]=r,s[2]=o,s[3]=a,s[4]=l,s[5]=h}(f,t.offset,t.count,p),y(e,t.offset,t.count,p),g.push(e)}else for(let t of v){const e=new tn;e.boundingData=new Float32Array(6),qs(f,t.offset,t.count,e.boundingData,p),y(e,t.offset,t.count,p),g.push(e)}return g;function _(t){l&&l(t/h)}function y(t,e,l,h=null,u=0){if(!d&&u>=n&&(d=!0,r&&(console.warn(`MeshBVH: Max depth of ${n} reached when generating BVH. Consider increasing maxDepth.`),console.warn(i))),l<=o||u>=n)return _(e+l),t.offset=e,t.count=l,t;const g=function(t,e,i,s,n,r){let o=-1,a=0;if(0===r)o=Ws(e),-1!==o&&(a=(e[o]+e[o+3])/2);else if(1===r)o=Ws(t),-1!==o&&(a=function(t,e,i,s){let n=0;for(let r=e,o=e+i;r<o;r++)n+=t[6*r+2*s];return n/i}(i,s,n,o));else if(2===r){const r=Xs(t);let l=Ls*n;const h=6*s,c=6*(s+n);for(let t=0;t<3;t++){const s=e[t],d=(e[t+3]-s)/Qs;if(n<8){const e=[...Js];e.length=n;let s=0;for(let n=h;n<c;n+=6,s++){const r=e[s];r.candidate=i[n+2*t],r.count=0;const{bounds:o,leftCacheBounds:a,rightCacheBounds:l}=r;for(let t=0;t<3;t++)l[t]=1/0,l[t+3]=-1/0,a[t]=1/0,a[t+3]=-1/0,o[t]=1/0,o[t+3]=-1/0;Ys(n,i,o)}e.sort(Ks);let d=n;for(let t=0;t<d;t++){const i=e[t];for(;t+1<d&&e[t+1].candidate===i.candidate;)e.splice(t+1,1),d--}for(let s=h;s<c;s+=6){const n=i[s+2*t];for(let t=0;t<d;t++){const r=e[t];n>=r.candidate?Ys(s,i,r.rightCacheBounds):(Ys(s,i,r.leftCacheBounds),r.count++)}}for(let i=0;i<d;i++){const s=e[i],h=s.count,c=n-s.count,d=s.leftCacheBounds,u=s.rightCacheBounds;let p=0;0!==h&&(p=Xs(d)/r);let f=0;0!==c&&(f=Xs(u)/r);const m=1+Ls*(p*h+f*c);m<l&&(o=t,l=m,a=s.candidate)}}else{for(let t=0;t<Qs;t++){const e=Js[t];e.count=0,e.candidate=s+d+t*d;const i=e.bounds;for(let t=0;t<3;t++)i[t]=1/0,i[t+3]=-1/0}for(let e=h;e<c;e+=6){let n=~~((i[e+2*t]-s)/d);n>=Qs&&(n=31);const r=Js[n];r.count++,Ys(e,i,r.bounds)}const e=Js[31];Gs(e.bounds,e.rightCacheBounds);for(let t=30;t>=0;t--){const e=Js[t],i=Js[t+1];Zs(e.bounds,i.rightCacheBounds,e.rightCacheBounds)}let u=0;for(let e=0;e<31;e++){const i=Js[e],s=i.count,h=i.bounds,c=Js[e+1].rightCacheBounds;0!==s&&(0===u?Gs(h,$s):Zs(h,$s,$s)),u+=s;let d=0,p=0;0!==u&&(d=Xs($s)/r);const f=n-u;0!==f&&(p=Xs(c)/r);const m=1+Ls*(d*u+p*f);m<l&&(o=t,l=m,a=i.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${r} used.`);return{axis:o,pos:a}}(t.boundingData,h,f,e,l,a);if(-1===g.axis)return _(e+l),t.offset=e,t.count=l,t;const v=m(c,s,f,e,l,g);if(v===e||v===e+l)_(e+l),t.offset=e,t.count=l;else{t.splitAxis=g.axis;const i=new tn,s=e,n=v-e;t.left=i,i.boundingData=new Float32Array(6),qs(f,s,n,i.boundingData,p),y(i,s,n,p,u+1);const r=new tn,o=v,a=l-n;t.right=r,r.boundingData=new Float32Array(6),qs(f,o,a,r.boundingData,p),y(r,o,a,p,u+1)}return t}}function rn(t,e){const i=t.geometry;e.indirect&&(t._indirectBuffer=function(t,e){const i=(t.index?t.index.count:t.attributes.position.count)/3,s=i>65536,n=s?4:2,r=e?new SharedArrayBuffer(i*n):new ArrayBuffer(i*n),o=s?new Uint32Array(r):new Uint16Array(r);for(let t=0,e=o.length;t<e;t++)o[t]=t;return o}(i,e.useSharedArrayBuffer),function(t){if(0===t.groups.length)return!1;const e=Rs(t),i=js(t).sort((t,e)=>t.offset-e.offset),s=i[i.length-1];s.count=Math.min(e-s.offset,s.count);let n=0;return i.forEach(({count:t})=>n+=t),e!==n}(i)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),t._indirectBuffer||Fs(i,e);const s=nn(t,e);let n,r,o;const a=[],l=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let t=0;t<s.length;t++){const e=s[t];const i=new l(32*h(e));n=new Float32Array(i),r=new Uint32Array(i),o=new Uint16Array(i),c(0,e),a.push(i)}return void(t._roots=a);function h(t){return t.count?1:1+h(t.left)+h(t.right)}function c(t,e){const i=t/4,s=t/2,a=!!e.count,l=e.boundingData;for(let t=0;t<6;t++)n[i+t]=l[t];if(a){const n=e.offset,a=e.count;return r[i+6]=n,o[s+14]=a,o[s+15]=Ns,t+32}{const s=e.left,n=e.right,o=e.splitAxis;let a;if(a=c(t+32,s),a/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return r[i+6]=a/4,a=c(a,n),r[i+7]=o,a}}}class on{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let i=1/0,s=-1/0;for(let n=0,r=t.length;n<r;n++){const r=t[n][e];i=r<i?r:i,s=r>s?r:s}this.min=i,this.max=s}setFromPoints(t,e){let i=1/0,s=-1/0;for(let n=0,r=e.length;n<r;n++){const r=e[n],o=t.dot(r);i=o<i?o:i,s=o>s?o:s}this.min=i,this.max=s}isSeparated(t){return this.min>t.max||t.min>this.max}}on.prototype.setFromBox=function(){const t=new a;return function(e,i){const s=i.min,n=i.max;let r=1/0,o=-1/0;for(let i=0;i<=1;i++)for(let a=0;a<=1;a++)for(let l=0;l<=1;l++){t.x=s.x*i+n.x*(1-i),t.y=s.y*a+n.y*(1-a),t.z=s.z*l+n.z*(1-l);const h=e.dot(t);r=Math.min(h,r),o=Math.max(h,o)}this.min=r,this.max=o}}();const an=function(){const t=new a,e=new a,i=new a;return function(s,n,r){const o=s.start,a=t,l=n.start,h=e;i.subVectors(o,l),t.subVectors(s.end,s.start),e.subVectors(n.end,n.start);const c=i.dot(h),d=h.dot(a),u=h.dot(h),p=i.dot(a),f=a.dot(a)*u-d*d;let m,g;m=0!==f?(c*d-p*u)/f:0,g=(c+m*d)/u,r.x=m,r.y=g}}(),ln=function(){const t=new l,e=new a,i=new a;return function(s,n,r,o){an(s,n,t);let a=t.x,l=t.y;if(a>=0&&a<=1&&l>=0&&l<=1)return s.at(a,r),void n.at(l,o);if(a>=0&&a<=1)return l<0?n.at(0,o):n.at(1,o),void s.closestPointToPoint(o,!0,r);if(l>=0&&l<=1)return a<0?s.at(0,r):s.at(1,r),void n.closestPointToPoint(r,!0,o);{let t,h;t=a<0?s.start:s.end,h=l<0?n.start:n.end;const c=e,d=i;return s.closestPointToPoint(h,!0,e),n.closestPointToPoint(t,!0,i),c.distanceToSquared(h)<=d.distanceToSquared(t)?(r.copy(c),void o.copy(h)):(r.copy(t),void o.copy(d))}}}(),hn=function(){const t=new a,e=new a,i=new h,s=new c;return function(n,r){const{radius:o,center:a}=n,{a:l,b:h,c:c}=r;if(s.start=l,s.end=h,s.closestPointToPoint(a,!0,t).distanceTo(a)<=o||(s.start=l,s.end=c,s.closestPointToPoint(a,!0,t).distanceTo(a)<=o)||(s.start=h,s.end=c,s.closestPointToPoint(a,!0,t).distanceTo(a)<=o))return!0;const d=r.getPlane(i);if(Math.abs(d.distanceToPoint(a))<=o){const t=d.projectPoint(a,e);if(r.containsPoint(t))return!0}return!1}}();function cn(t){return Math.abs(t)<1e-15}class dn extends v{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new a),this.satBounds=new Array(4).fill().map(()=>new on),this.points=[this.a,this.b,this.c],this.sphere=new _,this.plane=new h,this.needsUpdate=!0}intersectsSphere(t){return hn(t,this)}update(){const t=this.a,e=this.b,i=this.c,s=this.points,n=this.satAxes,r=this.satBounds,o=n[0],a=r[0];this.getNormal(o),a.setFromPoints(o,s);const l=n[1],h=r[1];l.subVectors(t,e),h.setFromPoints(l,s);const c=n[2],d=r[2];c.subVectors(e,i),d.setFromPoints(c,s);const u=n[3],p=r[3];u.subVectors(i,t),p.setFromPoints(u,s),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,t),this.needsUpdate=!1}}dn.prototype.closestPointToSegment=function(){const t=new a,e=new a,i=new c;return function(s,n=null,r=null){const{start:o,end:a}=s,l=this.points;let h,c=1/0;for(let o=0;o<3;o++){const a=(o+1)%3;i.start.copy(l[o]),i.end.copy(l[a]),ln(i,s,t,e),h=t.distanceToSquared(e),h<c&&(c=h,n&&n.copy(t),r&&r.copy(e))}return this.closestPointToPoint(o,t),h=o.distanceToSquared(t),h<c&&(c=h,n&&n.copy(t),r&&r.copy(o)),this.closestPointToPoint(a,t),h=a.distanceToSquared(t),h<c&&(c=h,n&&n.copy(t),r&&r.copy(a)),Math.sqrt(c)}}(),dn.prototype.intersectsTriangle=function(){const t=new dn,e=new Array(3),i=new Array(3),s=new on,n=new on,r=new a,o=new a,l=new a,h=new a,d=new a,u=new c,p=new c,f=new c,m=new a;function g(t,e,i){const s=t.points;let n=0,r=-1;for(let t=0;t<3;t++){const{start:a,end:l}=u;a.copy(s[t]),l.copy(s[(t+1)%3]),u.delta(o);const h=cn(e.distanceToPoint(a));if(cn(e.normal.dot(o))&&h){i.copy(u),n=2;break}const c=e.intersectLine(u,m);if(!c&&h&&m.copy(a),(c||h)&&!cn(m.distanceTo(l))){if(n<=1)(1===n?i.start:i.end).copy(m),h&&(r=n);else if(n>=2){(1===r?i.start:i.end).copy(m),n=2;break}if(n++,2===n&&-1===r)break}}return n}return function(o,a=null,c=!1){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(t.copy(o),t.update(),o=t);const u=this.plane,m=o.plane;if(Math.abs(u.normal.dot(m.normal))>1-1e-10){const t=this.satBounds,l=this.satAxes;i[0]=o.a,i[1]=o.b,i[2]=o.c;for(let e=0;e<4;e++){const n=t[e],r=l[e];if(s.setFromPoints(r,i),n.isSeparated(s))return!1}const h=o.satBounds,d=o.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let t=0;t<4;t++){const i=h[t],n=d[t];if(s.setFromPoints(n,e),i.isSeparated(s))return!1}for(let t=0;t<4;t++){const o=l[t];for(let t=0;t<4;t++){const a=d[t];if(r.crossVectors(o,a),s.setFromPoints(r,e),n.setFromPoints(r,i),s.isSeparated(n))return!1}}return a&&(c||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),a.start.set(0,0,0),a.end.set(0,0,0)),!0}{const t=g(this,m,p);if(1===t&&o.containsPoint(p.end))return a&&(a.start.copy(p.end),a.end.copy(p.end)),!0;if(2!==t)return!1;const e=g(o,u,f);if(1===e&&this.containsPoint(f.end))return a&&(a.start.copy(f.end),a.end.copy(f.end)),!0;if(2!==e)return!1;if(p.delta(l),f.delta(h),l.dot(h)<0){let t=f.start;f.start=f.end,f.end=t}const i=p.start.dot(l),s=p.end.dot(l),n=f.start.dot(l),r=f.end.dot(l);return(i===r||n===s||s<n!==i<r)&&(a&&(d.subVectors(p.start,f.start),d.dot(l)>0?a.start.copy(p.start):a.start.copy(f.start),d.subVectors(p.end,f.end),d.dot(l)<0?a.end.copy(p.end):a.end.copy(f.end)),!0)}}}(),dn.prototype.distanceToPoint=function(){const t=new a;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),dn.prototype.distanceToTriangle=function(){const t=new a,e=new a,i=["a","b","c"],s=new c,n=new c;return function(r,o=null,a=null){const l=o||a?s:null;if(this.intersectsTriangle(r,l))return(o||a)&&(o&&l.getCenter(o),a&&l.getCenter(a)),0;let h=1/0;for(let e=0;e<3;e++){let s;const n=i[e],l=r[n];this.closestPointToPoint(l,t),s=l.distanceToSquared(t),s<h&&(h=s,o&&o.copy(t),a&&a.copy(l));const c=this[n];r.closestPointToPoint(c,t),s=c.distanceToSquared(t),s<h&&(h=s,o&&o.copy(c),a&&a.copy(t))}for(let l=0;l<3;l++){const c=i[l],d=i[(l+1)%3];s.set(this[c],this[d]);for(let l=0;l<3;l++){const c=i[l],d=i[(l+1)%3];n.set(r[c],r[d]),ln(s,n,t,e);const u=t.distanceToSquared(e);u<h&&(h=u,o&&o.copy(t),a&&a.copy(e))}}return Math.sqrt(h)}}();class un{constructor(t,e,i){this.isOrientedBox=!0,this.min=new a,this.max=new a,this.matrix=new g,this.invMatrix=new g,this.points=new Array(8).fill().map(()=>new a),this.satAxes=new Array(3).fill().map(()=>new a),this.satBounds=new Array(3).fill().map(()=>new on),this.alignedSatBounds=new Array(3).fill().map(()=>new on),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),i&&this.matrix.copy(i)}set(t,e,i){this.min.copy(t),this.max.copy(e),this.matrix.copy(i),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}un.prototype.update=function(){return function(){const t=this.matrix,e=this.min,i=this.max,s=this.points;for(let n=0;n<=1;n++)for(let r=0;r<=1;r++)for(let o=0;o<=1;o++){const a=s[1*n|2*r|4*o];a.x=n?i.x:e.x,a.y=r?i.y:e.y,a.z=o?i.z:e.z,a.applyMatrix4(t)}const n=this.satBounds,r=this.satAxes,o=s[0];for(let t=0;t<3;t++){const e=r[t],i=n[t],a=s[1<<t];e.subVectors(o,a),i.setFromPoints(e,s)}const a=this.alignedSatBounds;a[0].setFromPointsField(s,"x"),a[1].setFromPointsField(s,"y"),a[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}(),un.prototype.intersectsBox=function(){const t=new on;return function(e){this.needsUpdate&&this.update();const i=e.min,s=e.max,n=this.satBounds,r=this.satAxes,o=this.alignedSatBounds;if(t.min=i.x,t.max=s.x,o[0].isSeparated(t)||(t.min=i.y,t.max=s.y,o[1].isSeparated(t))||(t.min=i.z,t.max=s.z,o[2].isSeparated(t)))return!1;for(let i=0;i<3;i++){const s=r[i],o=n[i];if(t.setFromBox(s,e),o.isSeparated(t))return!1}return!0}}(),un.prototype.intersectsTriangle=function(){const t=new dn,e=new Array(3),i=new on,s=new on,n=new a;return function(r){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(t.copy(r),t.update(),r=t);const o=this.satBounds,a=this.satAxes;e[0]=r.a,e[1]=r.b,e[2]=r.c;for(let t=0;t<3;t++){const s=o[t],n=a[t];if(i.setFromPoints(n,e),s.isSeparated(i))return!1}const l=r.satBounds,h=r.satAxes,c=this.points;for(let t=0;t<3;t++){const e=l[t],s=h[t];if(i.setFromPoints(s,c),e.isSeparated(i))return!1}for(let t=0;t<3;t++){const r=a[t];for(let t=0;t<4;t++){const o=h[t];if(n.crossVectors(r,o),i.setFromPoints(n,e),s.setFromPoints(n,c),i.isSeparated(s))return!1}}return!0}}(),un.prototype.closestPointToPoint=function(){return function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e}}(),un.prototype.distanceToPoint=function(){const t=new a;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),un.prototype.distanceToBox=function(){const t=["x","y","z"],e=new Array(12).fill().map(()=>new c),i=new Array(12).fill().map(()=>new c),s=new a,n=new a;return function(r,o=0,a=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(r))return(a||l)&&(r.getCenter(n),this.closestPointToPoint(n,s),r.closestPointToPoint(s,n),a&&a.copy(s),l&&l.copy(n)),0;const h=o*o,c=r.min,d=r.max,u=this.points;let p=1/0;for(let t=0;t<8;t++){const e=u[t];n.copy(e).clamp(c,d);const i=e.distanceToSquared(n);if(i<p&&(p=i,a&&a.copy(e),l&&l.copy(n),i<h))return Math.sqrt(i)}let f=0;for(let s=0;s<3;s++)for(let n=0;n<=1;n++)for(let r=0;r<=1;r++){const o=(s+1)%3,a=(s+2)%3,l=1<<s|n<<o|r<<a,h=u[n<<o|r<<a],p=u[l];e[f].set(h,p);const m=t[s],g=t[o],v=t[a],_=i[f],y=_.start,w=_.end;y[m]=c[m],y[g]=n?c[g]:d[g],y[v]=r?c[v]:d[g],w[m]=d[m],w[g]=n?c[g]:d[g],w[v]=r?c[v]:d[g],f++}for(let t=0;t<=1;t++)for(let e=0;e<=1;e++)for(let i=0;i<=1;i++){n.x=t?d.x:c.x,n.y=e?d.y:c.y,n.z=i?d.z:c.z,this.closestPointToPoint(n,s);const r=n.distanceToSquared(s);if(r<p&&(p=r,a&&a.copy(s),l&&l.copy(n),r<h))return Math.sqrt(r)}for(let t=0;t<12;t++){const r=e[t];for(let t=0;t<12;t++){const e=i[t];ln(r,e,s,n);const o=s.distanceToSquared(n);if(o<p&&(p=o,a&&a.copy(s),l&&l.copy(n),o<h))return Math.sqrt(o)}}return Math.sqrt(p)}}();class pn{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return 0===t.length?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class fn extends pn{constructor(){super(()=>new dn)}}const mn=new fn;function gn(t,e){return 65535===e[t+15]}function vn(t,e){return e[t+6]}function _n(t,e){return e[t+14]}function yn(t){return t+8}function wn(t,e){return e[t+6]}function bn(t,e){return e[t+7]}const xn=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=i=>{e&&t.push(e),e=i,this.float32Array=new Float32Array(i),this.uint16Array=new Uint16Array(i),this.uint32Array=new Uint32Array(i)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==t.length&&this.setBuffer(t.pop())}}};let Sn,En;const Cn=[],Tn=new pn(()=>new d);function Pn(t,e,i,s,n,r){Sn=Tn.getPrimitive(),En=Tn.getPrimitive(),Cn.push(Sn,En),xn.setBuffer(t._roots[e]);const o=An(0,t.geometry,i,s,n,r);xn.clearBuffer(),Tn.releasePrimitive(Sn),Tn.releasePrimitive(En),Cn.pop(),Cn.pop();const a=Cn.length;return a>0&&(En=Cn[a-1],Sn=Cn[a-2]),o}function An(t,e,i,s,n=null,r=0,o=0){const{float32Array:a,uint16Array:l,uint32Array:h}=xn;let c=2*t;if(gn(c,l)){const e=vn(t,h),i=_n(c,l);return Hs(t,a,Sn),s(e,i,!1,o,r+t,Sn)}{let c=function(t){const{uint16Array:e,uint32Array:i}=xn;let s=2*t;for(;!gn(s,e);)s=2*(t=yn(t));return vn(t,i)},d=function(t){const{uint16Array:e,uint32Array:i}=xn;let s=2*t;for(;!gn(s,e);)s=2*(t=wn(t,i));return vn(t,i)+_n(s,e)};const u=yn(t),p=wn(t,h);let f,m,g,v,_=u,y=p;if(n&&(g=Sn,v=En,Hs(_,a,g),Hs(y,a,v),f=n(g),m=n(v),m<f)){_=p,y=u;const t=f;f=m,m=t,g=v}g||(g=Sn,Hs(_,a,g));const w=i(g,gn(2*_,l),f,o+1,r+_);let b;if(2===w){const t=c(_);b=s(t,d(_)-t,!0,o+1,r+_,g)}else b=w&&An(_,e,i,s,n,r,o+1);if(b)return!0;v=En,Hs(y,a,v);const x=i(v,gn(2*y,l),m,o+1,r+y);let S;if(2===x){const t=c(y);S=s(t,d(y)-t,!0,o+1,r+y,v)}else S=x&&An(y,e,i,s,n,r,o+1);return!!S}}const Mn=new a,On=new a;const Dn=new a,zn=new a,In=new a,kn=new l,Ln=new l,Nn=new l,Bn=new a,Un=new a,Rn=new a,Fn=new a;function Vn(t,e,i,s,n,r,o,h,c){Dn.fromBufferAttribute(e,r),zn.fromBufferAttribute(e,o),In.fromBufferAttribute(e,h);const d=function(t,e,i,s,n,r){let o;return o=r===N?t.intersectTriangle(s,i,e,!0,n):t.intersectTriangle(e,i,s,r!==L,n),null===o?null:{distance:t.origin.distanceTo(n),point:n.clone()}}(t,Dn,zn,In,Fn,c);if(d){s&&(kn.fromBufferAttribute(s,r),Ln.fromBufferAttribute(s,o),Nn.fromBufferAttribute(s,h),d.uv=v.getInterpolation(Fn,Dn,zn,In,kn,Ln,Nn,new l)),n&&(kn.fromBufferAttribute(n,r),Ln.fromBufferAttribute(n,o),Nn.fromBufferAttribute(n,h),d.uv1=v.getInterpolation(Fn,Dn,zn,In,kn,Ln,Nn,new l)),i&&(Bn.fromBufferAttribute(i,r),Un.fromBufferAttribute(i,o),Rn.fromBufferAttribute(i,h),d.normal=v.getInterpolation(Fn,Dn,zn,In,Bn,Un,Rn,new a),d.normal.dot(t.direction)>0&&d.normal.multiplyScalar(-1));const e={a:r,b:o,c:h,normal:new a,materialIndex:0};v.getNormal(Dn,zn,In,e.normal),d.face=e,d.faceIndex=r}return d}function jn(t,e,i,s,n){const r=3*s;let o=r+0,a=r+1,l=r+2;const h=t.index;t.index&&(o=h.getX(o),a=h.getX(a),l=h.getX(l));const{position:c,normal:d,uv:u,uv1:p}=t.attributes,f=Vn(i,c,d,u,p,o,a,l,e);return f?(f.faceIndex=s,n&&n.push(f),f):null}function Hn(t,e,i,s){const n=t.a,r=t.b,o=t.c;let a=e,l=e+1,h=e+2;i&&(a=i.getX(a),l=i.getX(l),h=i.getX(h)),n.x=s.getX(a),n.y=s.getY(a),n.z=s.getZ(a),r.x=s.getX(l),r.y=s.getY(l),r.z=s.getZ(l),o.x=s.getX(h),o.y=s.getY(h),o.z=s.getZ(h)}function Wn(t,e,i,s,n,r,o){const{geometry:a}=i,{index:l}=a,h=a.attributes.position;for(let i=t,a=e+t;i<a;i++){let t;if(t=i,Hn(o,3*t,l,h),o.needsUpdate=!0,s(o,t,n,r))return!0}return!1}function Gn(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const i=t.geometry,s=i.index?i.index.array:null,n=i.attributes.position;let r,o,a,l,h=0;const c=t._roots;for(let t=0,e=c.length;t<e;t++)r=c[t],o=new Uint32Array(r),a=new Uint16Array(r),l=new Float32Array(r),d(0,h),h+=r.byteLength;function d(t,i,r=!1){const h=2*t;if(a[h+15]===Ns){const e=o[t+6];let i=1/0,r=1/0,c=1/0,d=-1/0,u=-1/0,p=-1/0;for(let t=3*e,o=3*(e+a[h+14]);t<o;t++){let e=s[t];const o=n.getX(e),a=n.getY(e),l=n.getZ(e);o<i&&(i=o),o>d&&(d=o),a<r&&(r=a),a>u&&(u=a),l<c&&(c=l),l>p&&(p=l)}return(l[t+0]!==i||l[t+1]!==r||l[t+2]!==c||l[t+3]!==d||l[t+4]!==u||l[t+5]!==p)&&(l[t+0]=i,l[t+1]=r,l[t+2]=c,l[t+3]=d,l[t+4]=u,l[t+5]=p,!0)}{const s=t+8,n=o[t+6],a=s+i,h=n+i;let c=r,u=!1,p=!1;e?c||(u=e.has(a),p=e.has(h),c=!u&&!p):(u=!0,p=!0);const f=c||p;let m=!1;(c||u)&&(m=d(s,i,c));let g=!1;f&&(g=d(n,i,c));const v=m||g;if(v)for(let e=0;e<3;e++){const i=s+e,r=n+e,o=l[i],a=l[i+3],h=l[r],c=l[r+3];l[t+e]=o<h?o:h,l[t+e+3]=a>c?a:c}return v}}}const Zn=new d;function Yn(t,e,i,s){return Hs(t,e,Zn),i.intersectBox(Zn,s)}function Xn(t,e,i,s,n,r,o){const{geometry:a}=i,{index:l}=a,h=a.attributes.position;for(let a=t,c=e+t;a<c;a++){let t;if(t=i.resolveTriangleIndex(a),Hn(o,3*t,l,h),o.needsUpdate=!0,s(o,t,n,r))return!0}return!1}const qn=new a;function Qn(t,e,i,s,n){xn.setBuffer(t._roots[e]),Kn(0,t,i,s,n),xn.clearBuffer()}function Kn(t,e,i,s,n){const{float32Array:r,uint16Array:o,uint32Array:a}=xn,l=2*t;if(gn(l,o)){!function(t,e,i,s,n,r){const{geometry:o,_indirectBuffer:a}=t;for(let t=s,a=s+n;t<a;t++)jn(o,e,i,t,r)}(e,i,s,vn(t,a),_n(l,o),n)}else{const o=yn(t);Yn(o,r,s,qn)&&Kn(o,e,i,s,n);const l=wn(t,a);Yn(l,r,s,qn)&&Kn(l,e,i,s,n)}}const Jn=new a,$n=["x","y","z"];function tr(t,e,i,s){xn.setBuffer(t._roots[e]);const n=er(0,t,i,s);return xn.clearBuffer(),n}function er(t,e,i,s){const{float32Array:n,uint16Array:r,uint32Array:o}=xn;let a=2*t;if(gn(a,r)){return function(t,e,i,s,n){const{geometry:r,_indirectBuffer:o}=t;let a=1/0,l=null;for(let t=s,o=s+n;t<o;t++){let s;s=jn(r,e,i,t),s&&s.distance<a&&(l=s,a=s.distance)}return l}(e,i,s,vn(t,o),_n(a,r))}{const r=bn(t,o),a=$n[r],l=s.direction[a]>=0;let h,c;l?(h=yn(t),c=wn(t,o)):(h=wn(t,o),c=yn(t));const d=Yn(h,n,s,Jn)?er(h,e,i,s):null;if(d){const t=d.point[a];if(l?t<=n[c+r]:t>=n[c+r+3])return d}const u=Yn(c,n,s,Jn)?er(c,e,i,s):null;return d&&u?d.distance<=u.distance?d:u:d||u||null}}const ir=new d,sr=new dn,nr=new dn,rr=new g,or=new un,ar=new un;function lr(t,e,i,s){xn.setBuffer(t._roots[e]);const n=hr(0,t,i,s);return xn.clearBuffer(),n}function hr(t,e,i,s,n=null){const{float32Array:r,uint16Array:o,uint32Array:a}=xn;let l=2*t;if(null===n&&(i.boundingBox||i.computeBoundingBox(),or.set(i.boundingBox.min,i.boundingBox.max,s),n=or),!gn(l,o)){const o=t+8,l=a[t+6];return Hs(o,r,ir),!!(n.intersectsBox(ir)&&hr(o,e,i,s,n)||(Hs(l,r,ir),n.intersectsBox(ir)&&hr(l,e,i,s,n)))}{const n=e.geometry,h=n.index,c=n.attributes.position,d=i.index,u=i.attributes.position,p=vn(t,a),f=_n(l,o);if(rr.copy(s).invert(),i.boundsTree)return Hs(t,r,ar),ar.matrix.copy(rr),ar.needsUpdate=!0,i.boundsTree.shapecast({intersectsBounds:t=>ar.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(s),t.b.applyMatrix4(s),t.c.applyMatrix4(s),t.needsUpdate=!0;for(let e=3*p,i=3*(f+p);e<i;e+=3)if(Hn(nr,e,h,c),nr.needsUpdate=!0,t.intersectsTriangle(nr))return!0;return!1}});for(let t=3*p,e=3*(f+p);t<e;t+=3){Hn(sr,t,h,c),sr.a.applyMatrix4(rr),sr.b.applyMatrix4(rr),sr.c.applyMatrix4(rr),sr.needsUpdate=!0;for(let t=0,e=d.count;t<e;t+=3)if(Hn(nr,t,d,u),nr.needsUpdate=!0,sr.intersectsTriangle(nr))return!0}}}const cr=new g,dr=new un,ur=new un,pr=new a,fr=new a,mr=new a,gr=new a;function vr(t,e,i,s={},n={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),dr.set(e.boundingBox.min,e.boundingBox.max,i),dr.needsUpdate=!0;const a=t.geometry,l=a.attributes.position,h=a.index,c=e.attributes.position,d=e.index,u=mn.getPrimitive(),p=mn.getPrimitive();let f=pr,m=fr,g=null,v=null;n&&(g=mr,v=gr);let _=1/0,y=null,w=null;return cr.copy(i).invert(),ur.matrix.copy(cr),t.shapecast({boundsTraverseOrder:t=>dr.distanceToBox(t),intersectsBounds:(t,e,i)=>i<_&&i<o&&(e&&(ur.min.copy(t.min),ur.max.copy(t.max),ur.needsUpdate=!0),!0),intersectsRange:(t,s)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:t=>ur.distanceToBox(t),intersectsBounds:(t,e,i)=>i<_&&i<o,intersectsRange:(e,n)=>{for(let o=e,a=e+n;o<a;o++){Hn(p,3*o,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=t,i=t+s;e<i;e++){Hn(u,3*e,h,l),u.needsUpdate=!0;const t=u.distanceToTriangle(p,f,g);if(t<_&&(m.copy(f),v&&v.copy(g),_=t,y=e,w=o),t<r)return!0}}}});for(let n=0,o=Rs(e);n<o;n++){Hn(p,3*n,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=t,i=t+s;e<i;e++){Hn(u,3*e,h,l),u.needsUpdate=!0;const t=u.distanceToTriangle(p,f,g);if(t<_&&(m.copy(f),v&&v.copy(g),_=t,y=e,w=n),t<r)return!0}}}}),mn.releasePrimitive(u),mn.releasePrimitive(p),_===1/0?null:(s.point?s.point.copy(m):s.point=m.clone(),s.distance=_,s.faceIndex=y,n&&(n.point?n.point.copy(v):n.point=v.clone(),n.point.applyMatrix4(cr),m.applyMatrix4(cr),n.distance=m.sub(n.point).length(),n.faceIndex=w),s)}function _r(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const i=t.geometry,s=i.index?i.index.array:null,n=i.attributes.position;let r,o,a,l,h=0;const c=t._roots;for(let t=0,e=c.length;t<e;t++)r=c[t],o=new Uint32Array(r),a=new Uint16Array(r),l=new Float32Array(r),d(0,h),h+=r.byteLength;function d(i,r,h=!1){const c=2*i;if(a[c+15]===Ns){const e=o[i+6];let r=1/0,h=1/0,d=1/0,u=-1/0,p=-1/0,f=-1/0;for(let i=e,o=e+a[c+14];i<o;i++){const e=3*t.resolveTriangleIndex(i);for(let t=0;t<3;t++){let i=e+t;i=s?s[i]:i;const o=n.getX(i),a=n.getY(i),l=n.getZ(i);o<r&&(r=o),o>u&&(u=o),a<h&&(h=a),a>p&&(p=a),l<d&&(d=l),l>f&&(f=l)}}return(l[i+0]!==r||l[i+1]!==h||l[i+2]!==d||l[i+3]!==u||l[i+4]!==p||l[i+5]!==f)&&(l[i+0]=r,l[i+1]=h,l[i+2]=d,l[i+3]=u,l[i+4]=p,l[i+5]=f,!0)}{const t=i+8,s=o[i+6],n=t+r,a=s+r;let c=h,u=!1,p=!1;e?c||(u=e.has(n),p=e.has(a),c=!u&&!p):(u=!0,p=!0);const f=c||p;let m=!1;(c||u)&&(m=d(t,r,c));let g=!1;f&&(g=d(s,r,c));const v=m||g;if(v)for(let e=0;e<3;e++){const n=t+e,r=s+e,o=l[n],a=l[n+3],h=l[r],c=l[r+3];l[i+e]=o<h?o:h,l[i+e+3]=a>c?a:c}return v}}}const yr=new a;function wr(t,e,i,s,n){xn.setBuffer(t._roots[e]),br(0,t,i,s,n),xn.clearBuffer()}function br(t,e,i,s,n){const{float32Array:r,uint16Array:o,uint32Array:a}=xn,l=2*t;if(gn(l,o)){!function(t,e,i,s,n,r){const{geometry:o,_indirectBuffer:a}=t;for(let t=s,l=s+n;t<l;t++)jn(o,e,i,a?a[t]:t,r)}(e,i,s,vn(t,a),_n(l,o),n)}else{const o=yn(t);Yn(o,r,s,yr)&&br(o,e,i,s,n);const l=wn(t,a);Yn(l,r,s,yr)&&br(l,e,i,s,n)}}const xr=new a,Sr=["x","y","z"];function Er(t,e,i,s){xn.setBuffer(t._roots[e]);const n=Cr(0,t,i,s);return xn.clearBuffer(),n}function Cr(t,e,i,s){const{float32Array:n,uint16Array:r,uint32Array:o}=xn;let a=2*t;if(gn(a,r)){return function(t,e,i,s,n){const{geometry:r,_indirectBuffer:o}=t;let a=1/0,l=null;for(let t=s,h=s+n;t<h;t++){let s;s=jn(r,e,i,o?o[t]:t),s&&s.distance<a&&(l=s,a=s.distance)}return l}(e,i,s,vn(t,o),_n(a,r))}{const r=bn(t,o),a=Sr[r],l=s.direction[a]>=0;let h,c;l?(h=yn(t),c=wn(t,o)):(h=wn(t,o),c=yn(t));const d=Yn(h,n,s,xr)?Cr(h,e,i,s):null;if(d){const t=d.point[a];if(l?t<=n[c+r]:t>=n[c+r+3])return d}const u=Yn(c,n,s,xr)?Cr(c,e,i,s):null;return d&&u?d.distance<=u.distance?d:u:d||u||null}}const Tr=new d,Pr=new dn,Ar=new dn,Mr=new g,Or=new un,Dr=new un;function zr(t,e,i,s){xn.setBuffer(t._roots[e]);const n=Ir(0,t,i,s);return xn.clearBuffer(),n}function Ir(t,e,i,s,n=null){const{float32Array:r,uint16Array:o,uint32Array:a}=xn;let l=2*t;if(null===n&&(i.boundingBox||i.computeBoundingBox(),Or.set(i.boundingBox.min,i.boundingBox.max,s),n=Or),!gn(l,o)){const o=t+8,l=a[t+6];return Hs(o,r,Tr),!!(n.intersectsBox(Tr)&&Ir(o,e,i,s,n)||(Hs(l,r,Tr),n.intersectsBox(Tr)&&Ir(l,e,i,s,n)))}{const n=e.geometry,h=n.index,c=n.attributes.position,d=i.index,u=i.attributes.position,p=vn(t,a),f=_n(l,o);if(Mr.copy(s).invert(),i.boundsTree)return Hs(t,r,Dr),Dr.matrix.copy(Mr),Dr.needsUpdate=!0,i.boundsTree.shapecast({intersectsBounds:t=>Dr.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(s),t.b.applyMatrix4(s),t.c.applyMatrix4(s),t.needsUpdate=!0;for(let i=p,s=f+p;i<s;i++)if(Hn(Ar,3*e.resolveTriangleIndex(i),h,c),Ar.needsUpdate=!0,t.intersectsTriangle(Ar))return!0;return!1}});for(let t=p,i=f+p;t<i;t++){const i=e.resolveTriangleIndex(t);Hn(Pr,3*i,h,c),Pr.a.applyMatrix4(Mr),Pr.b.applyMatrix4(Mr),Pr.c.applyMatrix4(Mr),Pr.needsUpdate=!0;for(let t=0,e=d.count;t<e;t+=3)if(Hn(Ar,t,d,u),Ar.needsUpdate=!0,Pr.intersectsTriangle(Ar))return!0}}}const kr=new g,Lr=new un,Nr=new un,Br=new a,Ur=new a,Rr=new a,Fr=new a;function Vr(t,e,i,s={},n={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),Lr.set(e.boundingBox.min,e.boundingBox.max,i),Lr.needsUpdate=!0;const a=t.geometry,l=a.attributes.position,h=a.index,c=e.attributes.position,d=e.index,u=mn.getPrimitive(),p=mn.getPrimitive();let f=Br,m=Ur,g=null,v=null;n&&(g=Rr,v=Fr);let _=1/0,y=null,w=null;return kr.copy(i).invert(),Nr.matrix.copy(kr),t.shapecast({boundsTraverseOrder:t=>Lr.distanceToBox(t),intersectsBounds:(t,e,i)=>i<_&&i<o&&(e&&(Nr.min.copy(t.min),Nr.max.copy(t.max),Nr.needsUpdate=!0),!0),intersectsRange:(s,n)=>{if(e.boundsTree){const a=e.boundsTree;return a.shapecast({boundsTraverseOrder:t=>Nr.distanceToBox(t),intersectsBounds:(t,e,i)=>i<_&&i<o,intersectsRange:(e,o)=>{for(let b=e,x=e+o;b<x;b++){const e=a.resolveTriangleIndex(b);Hn(p,3*e,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=s,i=s+n;e<i;e++){const i=t.resolveTriangleIndex(e);Hn(u,3*i,h,l),u.needsUpdate=!0;const s=u.distanceToTriangle(p,f,g);if(s<_&&(m.copy(f),v&&v.copy(g),_=s,y=e,w=b),s<r)return!0}}}})}for(let o=0,a=Rs(e);o<a;o++){Hn(p,3*o,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=s,i=s+n;e<i;e++){const i=t.resolveTriangleIndex(e);Hn(u,3*i,h,l),u.needsUpdate=!0;const s=u.distanceToTriangle(p,f,g);if(s<_&&(m.copy(f),v&&v.copy(g),_=s,y=e,w=o),s<r)return!0}}}}),mn.releasePrimitive(u),mn.releasePrimitive(p),_===1/0?null:(s.point?s.point.copy(m):s.point=m.clone(),s.distance=_,s.faceIndex=y,n&&(n.point?n.point.copy(v):n.point=v.clone(),n.point.applyMatrix4(kr),m.applyMatrix4(kr),n.distance=m.sub(n.point).length(),n.faceIndex=w),s)}const jr=new xn.constructor,Hr=new xn.constructor,Wr=new pn(()=>new d),Gr=new d,Zr=new d,Yr=new d,Xr=new d;let qr=!1;function Qr(t,e,i,s,n,r=0,o=0,a=0,l=0,h=null,c=!1){let d,u;c?(d=Hr,u=jr):(d=jr,u=Hr);const p=d.float32Array,f=d.uint32Array,m=d.uint16Array,g=u.float32Array,v=u.uint32Array,_=u.uint16Array,y=2*e,w=gn(2*t,m),b=gn(y,_);let x=!1;if(b&&w)x=c?n(vn(e,v),_n(2*e,_),vn(t,f),_n(2*t,m),l,o+e,a,r+t):n(vn(t,f),_n(2*t,m),vn(e,v),_n(2*e,_),a,r+t,l,o+e);else if(b){const h=Wr.getPrimitive();Hs(e,g,h),h.applyMatrix4(i);const d=yn(t),u=wn(t,f);Hs(d,p,Gr),Hs(u,p,Zr);const m=h.intersectsBox(Gr),v=h.intersectsBox(Zr);x=m&&Qr(e,d,s,i,n,o,r,l,a+1,h,!c)||v&&Qr(e,u,s,i,n,o,r,l,a+1,h,!c),Wr.releasePrimitive(h)}else{const d=yn(e),u=wn(e,v);Hs(d,g,Yr),Hs(u,g,Xr);const m=h.intersectsBox(Yr),_=h.intersectsBox(Xr);if(m&&_)x=Qr(t,d,i,s,n,r,o,a,l+1,h,c)||Qr(t,u,i,s,n,r,o,a,l+1,h,c);else if(m)if(w)x=Qr(t,d,i,s,n,r,o,a,l+1,h,c);else{const e=Wr.getPrimitive();e.copy(Yr).applyMatrix4(i);const h=yn(t),u=wn(t,f);Hs(h,p,Gr),Hs(u,p,Zr);const m=e.intersectsBox(Gr),g=e.intersectsBox(Zr);x=m&&Qr(d,h,s,i,n,o,r,l,a+1,e,!c)||g&&Qr(d,u,s,i,n,o,r,l,a+1,e,!c),Wr.releasePrimitive(e)}else if(_)if(w)x=Qr(t,u,i,s,n,r,o,a,l+1,h,c);else{const e=Wr.getPrimitive();e.copy(Xr).applyMatrix4(i);const h=yn(t),d=wn(t,f);Hs(h,p,Gr),Hs(d,p,Zr);const m=e.intersectsBox(Gr),g=e.intersectsBox(Zr);x=m&&Qr(u,h,s,i,n,o,r,l,a+1,e,!c)||g&&Qr(u,d,s,i,n,o,r,l,a+1,e,!c),Wr.releasePrimitive(e)}}return x}const Kr=new un,Jr=new d;class $r{static serialize(t,e={}){e={cloneBuffers:!0,...e};const i=t.geometry,s=t._roots,n=t._indirectBuffer,r=i.getIndex();let o;return o=e.cloneBuffers?{roots:s.map(t=>t.slice()),index:r.array.slice(),indirectBuffer:n?n.slice():null}:{roots:s,index:r.array,indirectBuffer:n},o}static deserialize(t,e,i={}){i={setIndex:!0,indirect:!!t.indirectBuffer,...i};const{index:s,roots:n,indirectBuffer:r}=t,o=new $r(e,{...i,[Us]:!0});if(o._roots=n,o._indirectBuffer=r||null,i.setIndex){const i=e.getIndex();if(null===i){const i=new w(t.index,1,!1);e.setIndex(i)}else i.array!==s&&(i.array.set(s),i.needsUpdate=!0)}return o}get indirect(){return!!this._indirectBuffer}constructor(t,e={}){if(!t.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((e=Object.assign({strategy:0,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[Us]:!1},e)).useSharedArrayBuffer&&!(typeof SharedArrayBuffer<"u"))throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=t,this._roots=null,this._indirectBuffer=null,e[Us]||(rn(this,e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new d)));const{_indirectBuffer:i}=this;this.resolveTriangleIndex=e.indirect?t=>i[t]:t=>t}refit(t=null){return(this.indirect?_r:Gn)(this,t)}traverse(t,e=0){const i=this._roots[e],s=new Uint32Array(i),n=new Uint16Array(i);!function e(r,o=0){const a=2*r,l=n[a+15]===Ns;if(l){const e=s[r+6],h=n[a+14];t(o,l,new Float32Array(i,4*r,6),e,h)}else{const n=r+8,a=s[r+6],h=s[r+7];t(o,l,new Float32Array(i,4*r,6),h)||(e(n,o+1),e(a,o+1))}}(0)}raycast(t,e=b){const i=this._roots,s=this.geometry,n=[],r=e.isMaterial,o=Array.isArray(e),a=s.groups,l=r?e.side:e,h=this.indirect?wr:Qn;for(let s=0,r=i.length;s<r;s++){const i=o?e[a[s].materialIndex].side:l,r=n.length;if(h(this,s,i,t,n),o){const t=a[s].materialIndex;for(let e=r,i=n.length;e<i;e++)n[e].face.materialIndex=t}}return n}raycastFirst(t,e=b){const i=this._roots,s=this.geometry,n=e.isMaterial,r=Array.isArray(e);let o=null;const a=s.groups,l=n?e.side:e,h=this.indirect?Er:tr;for(let s=0,n=i.length;s<n;s++){const i=h(this,s,r?e[a[s].materialIndex].side:l,t);null!=i&&(null==o||i.distance<o.distance)&&(o=i,r&&(i.face.materialIndex=a[s].materialIndex))}return o}intersectsGeometry(t,e){let i=!1;const s=this._roots,n=this.indirect?zr:lr;for(let r=0,o=s.length;r<o&&(i=n(this,r,t,e),!i);r++);return i}shapecast(t){const e=mn.getPrimitive(),i=this.indirect?Xn:Wn;let{boundsTraverseOrder:s,intersectsBounds:n,intersectsRange:r,intersectsTriangle:o}=t;if(r&&o){const t=r;r=(s,n,r,a,l)=>!!t(s,n,r,a,l)||i(s,n,this,o,r,a,e)}else r||(r=o?(t,s,n,r)=>i(t,s,this,o,n,r,e):(t,e,i)=>i);let a=!1,l=0;const h=this._roots;for(let t=0,e=h.length;t<e;t++){const e=h[t];if(a=Pn(this,t,n,r,s,l),a)break;l+=e.byteLength}return mn.releasePrimitive(e),a}bvhcast(t,e,i){let{intersectsRanges:s,intersectsTriangles:n}=i;const r=mn.getPrimitive(),o=this.geometry.index,a=this.geometry.attributes.position,l=this.indirect?t=>{const e=this.resolveTriangleIndex(t);Hn(r,3*e,o,a)}:t=>{Hn(r,3*t,o,a)},h=mn.getPrimitive(),c=t.geometry.index,d=t.geometry.attributes.position,u=t.indirect?e=>{const i=t.resolveTriangleIndex(e);Hn(h,3*i,c,d)}:t=>{Hn(h,3*t,c,d)};if(n){const t=(t,i,s,o,a,c,d,p)=>{for(let f=s,m=s+o;f<m;f++){u(f),h.a.applyMatrix4(e),h.b.applyMatrix4(e),h.c.applyMatrix4(e),h.needsUpdate=!0;for(let e=t,s=t+i;e<s;e++)if(l(e),r.needsUpdate=!0,n(r,h,e,f,a,c,d,p))return!0}return!1};if(s){const e=s;s=function(i,s,n,r,o,a,l,h){return!!e(i,s,n,r,o,a,l,h)||t(i,s,n,r,o,a,l,h)}}else s=t}return function(t,e,i,s){if(qr)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");qr=!0;const n=t._roots,r=e._roots;let o,a=0,l=0;const h=(new g).copy(i).invert();for(let t=0,e=n.length;t<e;t++){jr.setBuffer(n[t]),l=0;const e=Wr.getPrimitive();Hs(0,jr.float32Array,e),e.applyMatrix4(h);for(let n=0,c=r.length;n<c&&(Hr.setBuffer(r[t]),o=Qr(0,0,i,h,s,a,l,0,0,e),Hr.clearBuffer(),l+=r[n].length,!o);n++);if(Wr.releasePrimitive(e),jr.clearBuffer(),a+=n[t].length,o)break}return qr=!1,o}(this,t,e,s)}intersectsBox(t,e){return Kr.set(t.min,t.max,e),Kr.needsUpdate=!0,this.shapecast({intersectsBounds:t=>Kr.intersectsBox(t),intersectsTriangle:t=>Kr.intersectsTriangle(t)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,i={},s={},n=0,r=1/0){return(this.indirect?Vr:vr)(this,t,e,i,s,n,r)}closestPointToPoint(t,e={},i=0,s=1/0){return function(t,e,i={},s=0,n=1/0){const r=s*s,o=n*n;let a=1/0,l=null;if(t.shapecast({boundsTraverseOrder:t=>(Mn.copy(e).clamp(t.min,t.max),Mn.distanceToSquared(e)),intersectsBounds:(t,e,i)=>i<a&&i<o,intersectsTriangle:(t,i)=>{t.closestPointToPoint(e,Mn);const s=e.distanceToSquared(Mn);return s<a&&(On.copy(Mn),a=s,l=i),s<r}}),a===1/0)return null;const h=Math.sqrt(a);return i.point?i.point.copy(On):i.point=On.clone(),i.distance=h,i.faceIndex=l,i}(this,t,e,i,s)}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach(e=>{Hs(0,new Float32Array(e),Jr),t.union(Jr)}),t}}function to(t,e,i){return null===t||(t.point.applyMatrix4(e.matrixWorld),t.distance=t.point.distanceTo(i.ray.origin),t.object=e,t.distance<i.near||t.distance>i.far)?null:t}const eo=new y,io=new g,so=u.prototype.raycast;function no(t,e){if(this.geometry.boundsTree){if(void 0===this.material)return;io.copy(this.matrixWorld).invert(),eo.copy(t.ray).applyMatrix4(io);const i=this.geometry.boundsTree;if(!0===t.firstHitOnly){const s=to(i.raycastFirst(eo,this.material),this,t);s&&e.push(s)}else{const s=i.raycast(eo,this.material);for(let i=0,n=s.length;i<n;i++){const n=to(s[i],this,t);n&&e.push(n)}}}else so.call(this,t,e)}function ro(t){return this.boundsTree=new $r(this,t),this.boundsTree}function oo(){this.boundsTree=null}const ao=class t{constructor(){Pt(this,"onDisposed",new At),Pt(this,"list",new s),Pt(this,"enabled",!1),Pt(this,"_clock"),Pt(this,"onInit",new At),Pt(this,"update",()=>{if(!this.enabled)return;const t=this._clock.getDelta();for(const[e,i]of this.list)i.enabled&&i.isUpdateable()&&i.update(t);requestAnimationFrame(this.update)}),this._clock=new o.Clock,t.setupBVH()}add(t,e){if(this.list.has(t))throw new Error("You're trying to add a component that already exists in the components instance. Use Components.get() instead.");Bt.validate(t),this.list.set(t,e)}get(t){var e;const i=t.uuid;if(!this.list.has(i)){const s=new t(this);return null!=(e=s.isDisposeable)&&e.call(s)&&s.onDisposed.add(()=>this.list.delete(i)),this.list.has(i)||this.add(i,s),s}return this.list.get(i)}init(){this.enabled=!0;for(const[t,e]of this.list.entries())e.enabled=!0;this._clock.start(),this.update(),this.onInit.trigger()}dispose(){let t;this.enabled=!1;for(const[e,i]of this.list)i.enabled=!1,e!==pi.uuid?i.isDisposeable()&&i.dispose():t=i;null==t||t.dispose(),this._clock.stop(),this.onDisposed.trigger()}static setupBVH(){o.BufferGeometry.prototype.computeBoundsTree=ro,o.BufferGeometry.prototype.disposeBoundsTree=oo,o.Mesh.prototype.raycast=no}};Pt(ao,"release","2.4.3");let lo=ao;class ho{constructor(t){Pt(this,"enabled",!1),Pt(this,"id","FirstPerson"),this.camera=t}set(t){if(this.enabled=t,t){if("Perspective"!==this.camera.projection.current)return void this.camera.set("Orbit");this.setupFirstPersonCamera()}}setupFirstPersonCamera(){const t=this.camera.controls,e=new o.Vector3;t.distance--,t.getPosition(e),t.minDistance=1,t.maxDistance=1,t.distance=1,t.moveTo(e.x,e.y,e.z),t.truckSpeed=50,t.mouseButtons.wheel=Ms.ACTION.DOLLY,t.touches.two=Ms.ACTION.TOUCH_ZOOM_TRUCK}}class co{constructor(t){Pt(this,"enabled",!0),Pt(this,"id","Orbit"),this.camera=t,this.activateOrbitControls()}set(t){this.enabled=t,t&&this.activateOrbitControls()}activateOrbitControls(){const t=this.camera.controls;t.minDistance=1,t.maxDistance=300;const e=new o.Vector3;t.getPosition(e);const i=e.length();t.distance=i,t.truckSpeed=2;const{rotation:s}=this.camera.three,n=new o.Vector3(0,0,-1).applyEuler(s),r=e.addScaledVector(n,i);t.moveTo(r.x,r.y,r.z)}}class uo{constructor(t){Pt(this,"enabled",!1),Pt(this,"id","Plan"),Pt(this,"mouseAction1"),Pt(this,"mouseAction2"),Pt(this,"mouseInitialized",!1),Pt(this,"defaultAzimuthSpeed"),Pt(this,"defaultPolarSpeed"),this.camera=t,this.defaultAzimuthSpeed=t.controls.azimuthRotateSpeed,this.defaultPolarSpeed=t.controls.polarRotateSpeed}set(t){this.enabled=t;const e=this.camera.controls;e.azimuthRotateSpeed=t?0:this.defaultAzimuthSpeed,e.polarRotateSpeed=t?0:this.defaultPolarSpeed,this.mouseInitialized||(this.mouseAction1=e.touches.one,this.mouseAction2=e.touches.two,this.mouseInitialized=!0),t?(e.mouseButtons.left=Ms.ACTION.TRUCK,e.touches.one=Ms.ACTION.TOUCH_TRUCK,e.touches.two=Ms.ACTION.TOUCH_ZOOM):(e.mouseButtons.left=Ms.ACTION.ROTATE,e.touches.one=this.mouseAction1,e.touches.two=this.mouseAction2)}}class po{constructor(t){Pt(this,"onChanged",new At),Pt(this,"current","Perspective"),Pt(this,"camera"),Pt(this,"matchOrthoDistanceEnabled",!1),Pt(this,"_component"),Pt(this,"_previousDistance",-1),this._component=t,this.camera=t.three}async set(t){this.current!==t&&("Orthographic"===t?this.setOrthoCamera():await this.setPerspectiveCamera(),this.onChanged.trigger(this.camera))}async toggle(){const t="Perspective"===this.current?"Orthographic":"Perspective";await this.set(t)}setOrthoCamera(){if(null===this._component.mode||"FirstPerson"===this._component.mode.id)return;this._previousDistance=this._component.controls.distance,this._component.controls.distance=200;const t=this.getPerspectiveDims();if(!t)return;const{width:e,height:i}=t;this.setupOrthoCamera(i,e),this.camera=this._component.threeOrtho,this.current="Orthographic"}getPerspectiveDims(){const t=this._component.currentWorld;if(!t||!t.renderer)return null;const e=new o.Vector3;this._component.threePersp.getWorldDirection(e);const i=new o.Vector3;this._component.controls.getTarget(i);const s=i.clone().sub(this._component.threePersp.position).dot(e),n=t.renderer.getSize(),r=n.x/n.y,a=this._component.threePersp,l=2*s*Math.atan(a.fov*(Math.PI/180)/2);return{width:l*r,height:l}}setupOrthoCamera(t,e){this._component.controls.mouseButtons.wheel=Ms.ACTION.ZOOM,this._component.controls.mouseButtons.middle=Ms.ACTION.ZOOM;const i=this._component.threePersp,s=this._component.threeOrtho;s.zoom=1,s.left=e/-2,s.right=e/2,s.top=t/2,s.bottom=t/-2,s.updateProjectionMatrix(),s.position.copy(i.position),s.quaternion.copy(i.quaternion),this._component.controls.camera=s}getDistance(){const t=this._component.threePersp,e=this._component.threeOrtho;return(e.top-e.bottom)/e.zoom/(2*Math.atan(t.fov*(Math.PI/180)/2))}async setPerspectiveCamera(){this._component.controls.mouseButtons.wheel=Ms.ACTION.DOLLY,this._component.controls.mouseButtons.middle=Ms.ACTION.DOLLY;const t=this._component.threePersp,e=this._component.threeOrtho;t.position.copy(e.position),t.quaternion.copy(e.quaternion),this._component.controls.mouseButtons.wheel=Ms.ACTION.DOLLY,this.matchOrthoDistanceEnabled?this._component.controls.distance=this.getDistance():this._component.controls.distance=this._previousDistance,await this._component.controls.zoomTo(1),t.updateProjectionMatrix(),this._component.controls.camera=t,this.camera=t,this.current="Perspective"}}class fo extends Os{constructor(t){super(t),Pt(this,"projection"),Pt(this,"threeOrtho"),Pt(this,"threePersp"),Pt(this,"_userInputButtons",{}),Pt(this,"_frustumSize",50),Pt(this,"_navigationModes",new Map),Pt(this,"_mode",null),Pt(this,"previousSize",null),this.threePersp=this.three,this.threeOrtho=this.newOrthoCamera(),this.projection=new po(this),this.onAspectUpdated.add(()=>{this.setOrthoPerspCameraAspect()}),this.projection.onChanged.add(t=>{this.three=t,this.updateAspect()}),this.worlds.onItemSet.add(()=>{this._navigationModes.clear(),this._navigationModes.set("Orbit",new co(this)),this._navigationModes.set("FirstPerson",new ho(this)),this._navigationModes.set("Plan",new uo(this)),this._mode=this._navigationModes.get("Orbit"),this.mode.set(!0,{preventTargetAdjustment:!0}),this.currentWorld&&this.currentWorld.renderer&&(this.previousSize=this.currentWorld.renderer.getSize().clone())}),this.worlds.onItemDeleted.add(()=>{this._navigationModes.clear()})}get mode(){if(!this._mode)throw new Error("Mode not found, camera not initialized");return this._mode}dispose(){super.dispose(),this.threeOrtho.removeFromParent()}set(t){if(null!==this.mode&&this.mode.id!==t){if(this.mode.set(!1),!this._navigationModes.has(t))throw new Error("The specified mode does not exist!");this._mode=this._navigationModes.get(t),this.mode.set(!0)}}async fit(t,e=1.5){if(!this.enabled)return;const i=Number.MAX_VALUE,s=Number.MIN_VALUE,n=new o.Vector3(i,i,i),r=new o.Vector3(s,s,s);for(const e of t){const t=(new o.Box3).setFromObject(e);t.min.x<n.x&&(n.x=t.min.x),t.min.y<n.y&&(n.y=t.min.y),t.min.z<n.z&&(n.z=t.min.z),t.max.x>r.x&&(r.x=t.max.x),t.max.y>r.y&&(r.y=t.max.y),t.max.z>r.z&&(r.z=t.max.z)}const a=new o.Box3(n,r),l=this.components.get(pi);if(l.initialized)for(const[,t]of l.list){const e=t.box;e.min.x<n.x&&(n.x=e.min.x),e.min.y<n.y&&(n.y=e.min.y),e.min.z<n.z&&(n.z=e.min.z),e.max.x>r.x&&(r.x=e.max.x),e.max.y>r.y&&(r.y=e.max.y),e.max.z>r.z&&(r.z=e.max.z)}const h=new o.Vector3;a.getSize(h);const c=new o.Vector3;a.getCenter(c);const d=Math.max(h.x,h.y,h.z)*e,u=new o.Sphere(c,d);await this.controls.fitToSphere(u,!0)}setUserInput(t){t?this.enableUserInput():this.disableUserInput()}addCustomNavigationMode(t){this._navigationModes.set(t.id,t)}disableUserInput(){this._userInputButtons.left=this.controls.mouseButtons.left,this._userInputButtons.right=this.controls.mouseButtons.right,this._userInputButtons.middle=this.controls.mouseButtons.middle,this._userInputButtons.wheel=this.controls.mouseButtons.wheel,this.controls.mouseButtons.left=0,this.controls.mouseButtons.right=0,this.controls.mouseButtons.middle=0,this.controls.mouseButtons.wheel=0}enableUserInput(){0!==Object.keys(this._userInputButtons).length&&(this.controls.mouseButtons.left=this._userInputButtons.left,this.controls.mouseButtons.right=this._userInputButtons.right,this.controls.mouseButtons.middle=this._userInputButtons.middle,this.controls.mouseButtons.wheel=this._userInputButtons.wheel)}newOrthoCamera(){const t=window.innerWidth/window.innerHeight;return new o.OrthographicCamera(this._frustumSize*t/-2,this._frustumSize*t/2,this._frustumSize/2,this._frustumSize/-2,.1,1e3)}setOrthoPerspCameraAspect(){if(!this.currentWorld||!this.currentWorld.renderer||!this.previousSize)return;const t=this.currentWorld.renderer.getSize(),e=this.threeOrtho.top,i=this.threeOrtho.right,s=e*(t.y/this.previousSize.y),n=i*(t.x/this.previousSize.x);this.threeOrtho.left=-n,this.threeOrtho.right=n,this.threeOrtho.top=s,this.threeOrtho.bottom=-s,this.threeOrtho.updateProjectionMatrix(),this.previousSize.copy(t)}}function mo(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var go={exports:{}};
/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/const vo=Rt(go.exports=function t(e,i,s){function n(o,a){if(!i[o]){if(!e[o]){if(!a&&mo)return mo(o);if(r)return r(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var h=i[o]={exports:{}};e[o][0].call(h.exports,function(t){return n(e[o][1][t]||t)},h,h.exports,t,e,i,s)}return i[o].exports}for(var r=mo,o=0;o<s.length;o++)n(s[o]);return n}({1:[function(t,e,i){var s=t("./utils"),n=t("./support"),r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.encode=function(t){for(var e,i,n,o,a,l,h,c=[],d=0,u=t.length,p=u,f="string"!==s.getTypeOf(t);d<t.length;)p=u-d,n=f?(e=t[d++],i=d<u?t[d++]:0,d<u?t[d++]:0):(e=t.charCodeAt(d++),i=d<u?t.charCodeAt(d++):0,d<u?t.charCodeAt(d++):0),o=e>>2,a=(3&e)<<4|i>>4,l=1<p?(15&i)<<2|n>>6:64,h=2<p?63&n:64,c.push(r.charAt(o)+r.charAt(a)+r.charAt(l)+r.charAt(h));return c.join("")},i.decode=function(t){var e,i,s,o,a,l,h=0,c=0,d="data:";if(t.substr(0,d.length)===d)throw new Error("Invalid base64 input, it looks like a data url.");var u,p=3*(t=t.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(t.charAt(t.length-1)===r.charAt(64)&&p--,t.charAt(t.length-2)===r.charAt(64)&&p--,p%1!=0)throw new Error("Invalid base64 input, bad content length.");for(u=n.uint8array?new Uint8Array(0|p):new Array(0|p);h<t.length;)e=r.indexOf(t.charAt(h++))<<2|(o=r.indexOf(t.charAt(h++)))>>4,i=(15&o)<<4|(a=r.indexOf(t.charAt(h++)))>>2,s=(3&a)<<6|(l=r.indexOf(t.charAt(h++))),u[c++]=e,64!==a&&(u[c++]=i),64!==l&&(u[c++]=s);return u}},{"./support":30,"./utils":32}],2:[function(t,e,i){var s=t("./external"),n=t("./stream/DataWorker"),r=t("./stream/Crc32Probe"),o=t("./stream/DataLengthProbe");function a(t,e,i,s,n){this.compressedSize=t,this.uncompressedSize=e,this.crc32=i,this.compression=s,this.compressedContent=n}a.prototype={getContentWorker:function(){var t=new n(s.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new o("data_length")),e=this;return t.on("end",function(){if(this.streamInfo.data_length!==e.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),t},getCompressedWorker:function(){return new n(s.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},a.createWorkerFrom=function(t,e,i){return t.pipe(new r).pipe(new o("uncompressedSize")).pipe(e.compressWorker(i)).pipe(new o("compressedSize")).withStreamInfo("compression",e)},e.exports=a},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,e,i){var s=t("./stream/GenericWorker");i.STORE={magic:"\0\0",compressWorker:function(){return new s("STORE compression")},uncompressWorker:function(){return new s("STORE decompression")}},i.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,e,i){var s=t("./utils"),n=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var s=0;s<8;s++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();e.exports=function(t,e){return void 0!==t&&t.length?"string"!==s.getTypeOf(t)?function(t,e,i,s){var r=n,o=s+i;t^=-1;for(var a=s;a<o;a++)t=t>>>8^r[255&(t^e[a])];return-1^t}(0|e,t,t.length,0):function(t,e,i,s){var r=n,o=s+i;t^=-1;for(var a=s;a<o;a++)t=t>>>8^r[255&(t^e.charCodeAt(a))];return-1^t}(0|e,t,t.length,0):0}},{"./utils":32}],5:[function(t,e,i){i.base64=!1,i.binary=!1,i.dir=!1,i.createFolders=!0,i.date=null,i.compression=null,i.compressionOptions=null,i.comment=null,i.unixPermissions=null,i.dosPermissions=null},{}],6:[function(t,e,i){var s=null;s=typeof Promise<"u"?Promise:t("lie"),e.exports={Promise:s}},{lie:37}],7:[function(t,e,i){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",n=t("pako"),r=t("./utils"),o=t("./stream/GenericWorker"),a=s?"uint8array":"array";function l(t,e){o.call(this,"FlateWorker/"+t),this._pako=null,this._pakoAction=t,this._pakoOptions=e,this.meta={}}i.magic="\b\0",r.inherits(l,o),l.prototype.processChunk=function(t){this.meta=t.meta,null===this._pako&&this._createPako(),this._pako.push(r.transformTo(a,t.data),!1)},l.prototype.flush=function(){o.prototype.flush.call(this),null===this._pako&&this._createPako(),this._pako.push([],!0)},l.prototype.cleanUp=function(){o.prototype.cleanUp.call(this),this._pako=null},l.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var t=this;this._pako.onData=function(e){t.push({data:e,meta:t.meta})}},i.compressWorker=function(t){return new l("Deflate",t)},i.uncompressWorker=function(){return new l("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,e,i){function s(t,e){var i,s="";for(i=0;i<e;i++)s+=String.fromCharCode(255&t),t>>>=8;return s}function n(t,e,i,n,o,c){var d,u,p=t.file,f=t.compression,m=c!==a.utf8encode,g=r.transformTo("string",c(p.name)),v=r.transformTo("string",a.utf8encode(p.name)),_=p.comment,y=r.transformTo("string",c(_)),w=r.transformTo("string",a.utf8encode(_)),b=v.length!==p.name.length,x=w.length!==_.length,S="",E="",C="",T=p.dir,P=p.date,A={crc32:0,compressedSize:0,uncompressedSize:0};e&&!i||(A.crc32=t.crc32,A.compressedSize=t.compressedSize,A.uncompressedSize=t.uncompressedSize);var M=0;e&&(M|=8),m||!b&&!x||(M|=2048);var O,D,z,I=0,k=0;T&&(I|=16),"UNIX"===o?(k=798,I|=(O=p.unixPermissions,D=T,z=O,O||(z=D?16893:33204),(65535&z)<<16)):(k=20,I|=function(t){return 63&(t||0)}(p.dosPermissions)),d=P.getUTCHours(),d<<=6,d|=P.getUTCMinutes(),d<<=5,d|=P.getUTCSeconds()/2,u=P.getUTCFullYear()-1980,u<<=4,u|=P.getUTCMonth()+1,u<<=5,u|=P.getUTCDate(),b&&(E=s(1,1)+s(l(g),4)+v,S+="up"+s(E.length,2)+E),x&&(C=s(1,1)+s(l(y),4)+w,S+="uc"+s(C.length,2)+C);var L="";return L+="\n\0",L+=s(M,2),L+=f.magic,L+=s(d,2),L+=s(u,2),L+=s(A.crc32,4),L+=s(A.compressedSize,4),L+=s(A.uncompressedSize,4),L+=s(g.length,2),L+=s(S.length,2),{fileRecord:h.LOCAL_FILE_HEADER+L+g+S,dirRecord:h.CENTRAL_FILE_HEADER+s(k,2)+L+s(y.length,2)+"\0\0\0\0"+s(I,4)+s(n,4)+g+S+y}}var r=t("../utils"),o=t("../stream/GenericWorker"),a=t("../utf8"),l=t("../crc32"),h=t("../signature");function c(t,e,i,s){o.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=e,this.zipPlatform=i,this.encodeFileName=s,this.streamFiles=t,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}r.inherits(c,o),c.prototype.push=function(t){var e=t.meta.percent||0,i=this.entriesCount,s=this._sources.length;this.accumulate?this.contentBuffer.push(t):(this.bytesWritten+=t.data.length,o.prototype.push.call(this,{data:t.data,meta:{currentFile:this.currentFile,percent:i?(e+100*(i-s-1))/i:100}}))},c.prototype.openedSource=function(t){this.currentSourceOffset=this.bytesWritten,this.currentFile=t.file.name;var e=this.streamFiles&&!t.file.dir;if(e){var i=n(t,e,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:i.fileRecord,meta:{percent:0}})}else this.accumulate=!0},c.prototype.closedSource=function(t){this.accumulate=!1;var e,i=this.streamFiles&&!t.file.dir,r=n(t,i,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(r.dirRecord),i)this.push({data:(e=t,h.DATA_DESCRIPTOR+s(e.crc32,4)+s(e.compressedSize,4)+s(e.uncompressedSize,4)),meta:{percent:100}});else for(this.push({data:r.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},c.prototype.flush=function(){for(var t=this.bytesWritten,e=0;e<this.dirRecords.length;e++)this.push({data:this.dirRecords[e],meta:{percent:100}});var i,n,o,a,l,c,d=this.bytesWritten-t,u=(i=this.dirRecords.length,n=d,o=t,a=this.zipComment,l=this.encodeFileName,c=r.transformTo("string",l(a)),h.CENTRAL_DIRECTORY_END+"\0\0\0\0"+s(i,2)+s(i,2)+s(n,4)+s(o,4)+s(c.length,2)+c);this.push({data:u,meta:{percent:100}})},c.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},c.prototype.registerPrevious=function(t){this._sources.push(t);var e=this;return t.on("data",function(t){e.processChunk(t)}),t.on("end",function(){e.closedSource(e.previous.streamInfo),e._sources.length?e.prepareNextSource():e.end()}),t.on("error",function(t){e.error(t)}),this},c.prototype.resume=function(){return!!o.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},c.prototype.error=function(t){var e=this._sources;if(!o.prototype.error.call(this,t))return!1;for(var i=0;i<e.length;i++)try{e[i].error(t)}catch{}return!0},c.prototype.lock=function(){o.prototype.lock.call(this);for(var t=this._sources,e=0;e<t.length;e++)t[e].lock()},e.exports=c},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,e,i){var s=t("../compressions"),n=t("./ZipFileWorker");i.generateWorker=function(t,e,i){var r=new n(e.streamFiles,i,e.platform,e.encodeFileName),o=0;try{t.forEach(function(t,i){o++;var n=function(t,e){var i=t||e,n=s[i];if(!n)throw new Error(i+" is not a valid compression method !");return n}(i.options.compression,e.compression),a=i.options.compressionOptions||e.compressionOptions||{},l=i.dir,h=i.date;i._compressWorker(n,a).withStreamInfo("file",{name:t,dir:l,date:h,comment:i.comment||"",unixPermissions:i.unixPermissions,dosPermissions:i.dosPermissions}).pipe(r)}),r.entriesCount=o}catch(t){r.error(t)}return r}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,e,i){function s(){if(!(this instanceof s))return new s;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var t=new s;for(var e in this)"function"!=typeof this[e]&&(t[e]=this[e]);return t}}(s.prototype=t("./object")).loadAsync=t("./load"),s.support=t("./support"),s.defaults=t("./defaults"),s.version="3.10.1",s.loadAsync=function(t,e){return(new s).loadAsync(t,e)},s.external=t("./external"),e.exports=s},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,e,i){var s=t("./utils"),n=t("./external"),r=t("./utf8"),o=t("./zipEntries"),a=t("./stream/Crc32Probe"),l=t("./nodejsUtils");function h(t){return new n.Promise(function(e,i){var s=t.decompressed.getContentWorker().pipe(new a);s.on("error",function(t){i(t)}).on("end",function(){s.streamInfo.crc32!==t.decompressed.crc32?i(new Error("Corrupted zip : CRC32 mismatch")):e()}).resume()})}e.exports=function(t,e){var i=this;return e=s.extend(e||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:r.utf8decode}),l.isNode&&l.isStream(t)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):s.prepareContent("the loaded zip file",t,!0,e.optimizedBinaryString,e.base64).then(function(t){var i=new o(e);return i.load(t),i}).then(function(t){var i=[n.Promise.resolve(t)],s=t.files;if(e.checkCRC32)for(var r=0;r<s.length;r++)i.push(h(s[r]));return n.Promise.all(i)}).then(function(t){for(var n=t.shift(),r=n.files,o=0;o<r.length;o++){var a=r[o],l=a.fileNameStr,h=s.resolve(a.fileNameStr);i.file(h,a.decompressed,{binary:!0,optimizedBinaryString:!0,date:a.date,dir:a.dir,comment:a.fileCommentStr.length?a.fileCommentStr:null,unixPermissions:a.unixPermissions,dosPermissions:a.dosPermissions,createFolders:e.createFolders}),a.dir||(i.file(h).unsafeOriginalName=l)}return n.zipComment.length&&(i.comment=n.zipComment),i})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,e,i){var s=t("../utils"),n=t("../stream/GenericWorker");function r(t,e){n.call(this,"Nodejs stream input adapter for "+t),this._upstreamEnded=!1,this._bindStream(e)}s.inherits(r,n),r.prototype._bindStream=function(t){var e=this;(this._stream=t).pause(),t.on("data",function(t){e.push({data:t,meta:{percent:0}})}).on("error",function(t){e.isPaused?this.generatedError=t:e.error(t)}).on("end",function(){e.isPaused?e._upstreamEnded=!0:e.end()})},r.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},r.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},e.exports=r},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,e,i){var s=t("readable-stream").Readable;function n(t,e,i){s.call(this,e),this._helper=t;var n=this;t.on("data",function(t,e){n.push(t)||n._helper.pause(),i&&i(e)}).on("error",function(t){n.emit("error",t)}).on("end",function(){n.push(null)})}t("../utils").inherits(n,s),n.prototype._read=function(){this._helper.resume()},e.exports=n},{"../utils":32,"readable-stream":16}],14:[function(t,e,i){e.exports={isNode:typeof Buffer<"u",newBufferFrom:function(t,e){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,e);if("number"==typeof t)throw new Error('The "data" argument must not be a number');return new Buffer(t,e)},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var e=new Buffer(t);return e.fill(0),e},isBuffer:function(t){return Buffer.isBuffer(t)},isStream:function(t){return t&&"function"==typeof t.on&&"function"==typeof t.pause&&"function"==typeof t.resume}}},{}],15:[function(t,e,i){function s(t,e,i){var s,n=r.getTypeOf(e),a=r.extend(i||{},l);a.date=a.date||new Date,null!==a.compression&&(a.compression=a.compression.toUpperCase()),"string"==typeof a.unixPermissions&&(a.unixPermissions=parseInt(a.unixPermissions,8)),a.unixPermissions&&16384&a.unixPermissions&&(a.dir=!0),a.dosPermissions&&16&a.dosPermissions&&(a.dir=!0),a.dir&&(t=m(t)),a.createFolders&&(s=f(t))&&g.call(this,s,!0);var d="string"===n&&!1===a.binary&&!1===a.base64;i&&void 0!==i.binary||(a.binary=!d),(e instanceof h&&0===e.uncompressedSize||a.dir||!e||0===e.length)&&(a.base64=!1,a.binary=!0,e="",a.compression="STORE",n="string");var v=null;v=e instanceof h||e instanceof o?e:u.isNode&&u.isStream(e)?new p(t,e):r.prepareContent(t,e,a.binary,a.optimizedBinaryString,a.base64);var _=new c(t,v,a);this.files[t]=_}var n=t("./utf8"),r=t("./utils"),o=t("./stream/GenericWorker"),a=t("./stream/StreamHelper"),l=t("./defaults"),h=t("./compressedObject"),c=t("./zipObject"),d=t("./generate"),u=t("./nodejsUtils"),p=t("./nodejs/NodejsStreamInputAdapter"),f=function(t){"/"===t.slice(-1)&&(t=t.substring(0,t.length-1));var e=t.lastIndexOf("/");return 0<e?t.substring(0,e):""},m=function(t){return"/"!==t.slice(-1)&&(t+="/"),t},g=function(t,e){return e=void 0!==e?e:l.createFolders,t=m(t),this.files[t]||s.call(this,t,null,{dir:!0,createFolders:e}),this.files[t]};function v(t){return"[object RegExp]"===Object.prototype.toString.call(t)}var _={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(t){var e,i,s;for(e in this.files)s=this.files[e],(i=e.slice(this.root.length,e.length))&&e.slice(0,this.root.length)===this.root&&t(i,s)},filter:function(t){var e=[];return this.forEach(function(i,s){t(i,s)&&e.push(s)}),e},file:function(t,e,i){if(1!==arguments.length)return t=this.root+t,s.call(this,t,e,i),this;if(v(t)){var n=t;return this.filter(function(t,e){return!e.dir&&n.test(t)})}var r=this.files[this.root+t];return r&&!r.dir?r:null},folder:function(t){if(!t)return this;if(v(t))return this.filter(function(e,i){return i.dir&&t.test(e)});var e=this.root+t,i=g.call(this,e),s=this.clone();return s.root=i.name,s},remove:function(t){t=this.root+t;var e=this.files[t];if(e||("/"!==t.slice(-1)&&(t+="/"),e=this.files[t]),e&&!e.dir)delete this.files[t];else for(var i=this.filter(function(e,i){return i.name.slice(0,t.length)===t}),s=0;s<i.length;s++)delete this.files[i[s].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(t){var e,i={};try{if((i=r.extend(t||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=i.type.toLowerCase(),i.compression=i.compression.toUpperCase(),"binarystring"===i.type&&(i.type="string"),!i.type)throw new Error("No output type specified.");r.checkSupport(i.type),"darwin"!==i.platform&&"freebsd"!==i.platform&&"linux"!==i.platform&&"sunos"!==i.platform||(i.platform="UNIX"),"win32"===i.platform&&(i.platform="DOS");var s=i.comment||this.comment||"";e=d.generateWorker(this,i,s)}catch(t){(e=new o("error")).error(t)}return new a(e,i.type||"string",i.mimeType)},generateAsync:function(t,e){return this.generateInternalStream(t).accumulate(e)},generateNodeStream:function(t,e){return(t=t||{}).type||(t.type="nodebuffer"),this.generateInternalStream(t).toNodejsStream(e)}};e.exports=_},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,e,i){e.exports=t("stream")},{stream:void 0}],17:[function(t,e,i){var s=t("./DataReader");function n(t){s.call(this,t);for(var e=0;e<this.data.length;e++)t[e]=255&t[e]}t("../utils").inherits(n,s),n.prototype.byteAt=function(t){return this.data[this.zero+t]},n.prototype.lastIndexOfSignature=function(t){for(var e=t.charCodeAt(0),i=t.charCodeAt(1),s=t.charCodeAt(2),n=t.charCodeAt(3),r=this.length-4;0<=r;--r)if(this.data[r]===e&&this.data[r+1]===i&&this.data[r+2]===s&&this.data[r+3]===n)return r-this.zero;return-1},n.prototype.readAndCheckSignature=function(t){var e=t.charCodeAt(0),i=t.charCodeAt(1),s=t.charCodeAt(2),n=t.charCodeAt(3),r=this.readData(4);return e===r[0]&&i===r[1]&&s===r[2]&&n===r[3]},n.prototype.readData=function(t){if(this.checkOffset(t),0===t)return[];var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./DataReader":18}],18:[function(t,e,i){var s=t("../utils");function n(t){this.data=t,this.length=t.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(t){this.checkIndex(this.index+t)},checkIndex:function(t){if(this.length<this.zero+t||t<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+t+"). Corrupted zip ?")},setIndex:function(t){this.checkIndex(t),this.index=t},skip:function(t){this.setIndex(this.index+t)},byteAt:function(){},readInt:function(t){var e,i=0;for(this.checkOffset(t),e=this.index+t-1;e>=this.index;e--)i=(i<<8)+this.byteAt(e);return this.index+=t,i},readString:function(t){return s.transformTo("string",this.readData(t))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var t=this.readInt(4);return new Date(Date.UTC(1980+(t>>25&127),(t>>21&15)-1,t>>16&31,t>>11&31,t>>5&63,(31&t)<<1))}},e.exports=n},{"../utils":32}],19:[function(t,e,i){var s=t("./Uint8ArrayReader");function n(t){s.call(this,t)}t("../utils").inherits(n,s),n.prototype.readData=function(t){this.checkOffset(t);var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,e,i){var s=t("./DataReader");function n(t){s.call(this,t)}t("../utils").inherits(n,s),n.prototype.byteAt=function(t){return this.data.charCodeAt(this.zero+t)},n.prototype.lastIndexOfSignature=function(t){return this.data.lastIndexOf(t)-this.zero},n.prototype.readAndCheckSignature=function(t){return t===this.readData(4)},n.prototype.readData=function(t){this.checkOffset(t);var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./DataReader":18}],21:[function(t,e,i){var s=t("./ArrayReader");function n(t){s.call(this,t)}t("../utils").inherits(n,s),n.prototype.readData=function(t){if(this.checkOffset(t),0===t)return new Uint8Array(0);var e=this.data.subarray(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(t,e,i){var s=t("../utils"),n=t("../support"),r=t("./ArrayReader"),o=t("./StringReader"),a=t("./NodeBufferReader"),l=t("./Uint8ArrayReader");e.exports=function(t){var e=s.getTypeOf(t);return s.checkSupport(e),"string"!==e||n.uint8array?"nodebuffer"===e?new a(t):n.uint8array?new l(s.transformTo("uint8array",t)):new r(s.transformTo("array",t)):new o(t)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,e,i){i.LOCAL_FILE_HEADER="PK",i.CENTRAL_FILE_HEADER="PK",i.CENTRAL_DIRECTORY_END="PK",i.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",i.ZIP64_CENTRAL_DIRECTORY_END="PK",i.DATA_DESCRIPTOR="PK\b"},{}],24:[function(t,e,i){var s=t("./GenericWorker"),n=t("../utils");function r(t){s.call(this,"ConvertWorker to "+t),this.destType=t}n.inherits(r,s),r.prototype.processChunk=function(t){this.push({data:n.transformTo(this.destType,t.data),meta:t.meta})},e.exports=r},{"../utils":32,"./GenericWorker":28}],25:[function(t,e,i){var s=t("./GenericWorker"),n=t("../crc32");function r(){s.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(r,s),r.prototype.processChunk=function(t){this.streamInfo.crc32=n(t.data,this.streamInfo.crc32||0),this.push(t)},e.exports=r},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,e,i){var s=t("../utils"),n=t("./GenericWorker");function r(t){n.call(this,"DataLengthProbe for "+t),this.propName=t,this.withStreamInfo(t,0)}s.inherits(r,n),r.prototype.processChunk=function(t){if(t){var e=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=e+t.data.length}n.prototype.processChunk.call(this,t)},e.exports=r},{"../utils":32,"./GenericWorker":28}],27:[function(t,e,i){var s=t("../utils"),n=t("./GenericWorker");function r(t){n.call(this,"DataWorker");var e=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,t.then(function(t){e.dataIsReady=!0,e.data=t,e.max=t&&t.length||0,e.type=s.getTypeOf(t),e.isPaused||e._tickAndRepeat()},function(t){e.error(t)})}s.inherits(r,n),r.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},r.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,s.delay(this._tickAndRepeat,[],this)),!0)},r.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(s.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},r.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var t=null,e=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":t=this.data.substring(this.index,e);break;case"uint8array":t=this.data.subarray(this.index,e);break;case"array":case"nodebuffer":t=this.data.slice(this.index,e)}return this.index=e,this.push({data:t,meta:{percent:this.max?this.index/this.max*100:0}})},e.exports=r},{"../utils":32,"./GenericWorker":28}],28:[function(t,e,i){function s(t){this.name=t||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}s.prototype={push:function(t){this.emit("data",t)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(t){this.emit("error",t)}return!0},error:function(t){return!this.isFinished&&(this.isPaused?this.generatedError=t:(this.isFinished=!0,this.emit("error",t),this.previous&&this.previous.error(t),this.cleanUp()),!0)},on:function(t,e){return this._listeners[t].push(e),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(t,e){if(this._listeners[t])for(var i=0;i<this._listeners[t].length;i++)this._listeners[t][i].call(this,e)},pipe:function(t){return t.registerPrevious(this)},registerPrevious:function(t){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=t.streamInfo,this.mergeStreamInfo(),this.previous=t;var e=this;return t.on("data",function(t){e.processChunk(t)}),t.on("end",function(){e.end()}),t.on("error",function(t){e.error(t)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var t=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),t=!0),this.previous&&this.previous.resume(),!t},flush:function(){},processChunk:function(t){this.push(t)},withStreamInfo:function(t,e){return this.extraStreamInfo[t]=e,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var t in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,t)&&(this.streamInfo[t]=this.extraStreamInfo[t])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var t="Worker "+this.name;return this.previous?this.previous+" -> "+t:t}},e.exports=s},{}],29:[function(t,e,i){var s=t("../utils"),n=t("./ConvertWorker"),r=t("./GenericWorker"),o=t("../base64"),a=t("../support"),l=t("../external"),h=null;if(a.nodestream)try{h=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function c(t,e){return new l.Promise(function(i,n){var r=[],a=t._internalType,l=t._outputType,h=t._mimeType;t.on("data",function(t,i){r.push(t),e&&e(i)}).on("error",function(t){r=[],n(t)}).on("end",function(){try{var t=function(t,e,i){switch(t){case"blob":return s.newBlob(s.transformTo("arraybuffer",e),i);case"base64":return o.encode(e);default:return s.transformTo(t,e)}}(l,function(t,e){var i,s=0,n=null,r=0;for(i=0;i<e.length;i++)r+=e[i].length;switch(t){case"string":return e.join("");case"array":return Array.prototype.concat.apply([],e);case"uint8array":for(n=new Uint8Array(r),i=0;i<e.length;i++)n.set(e[i],s),s+=e[i].length;return n;case"nodebuffer":return Buffer.concat(e);default:throw new Error("concat : unsupported type '"+t+"'")}}(a,r),h);i(t)}catch(t){n(t)}r=[]}).resume()})}function d(t,e,i){var o=e;switch(e){case"blob":case"arraybuffer":o="uint8array";break;case"base64":o="string"}try{this._internalType=o,this._outputType=e,this._mimeType=i,s.checkSupport(o),this._worker=t.pipe(new n(o)),t.lock()}catch(t){this._worker=new r("error"),this._worker.error(t)}}d.prototype={accumulate:function(t){return c(this,t)},on:function(t,e){var i=this;return"data"===t?this._worker.on(t,function(t){e.call(i,t.data,t.meta)}):this._worker.on(t,function(){s.delay(e,arguments,i)}),this},resume:function(){return s.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(t){if(s.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new h(this,{objectMode:"nodebuffer"!==this._outputType},t)}},e.exports=d},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,e,i){if(i.base64=!0,i.array=!0,i.string=!0,i.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",i.nodebuffer=typeof Buffer<"u",i.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")i.blob=!1;else{var s=new ArrayBuffer(0);try{i.blob=0===new Blob([s],{type:"application/zip"}).size}catch{try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(s),i.blob=0===n.getBlob("application/zip").size}catch{i.blob=!1}}}try{i.nodestream=!!t("readable-stream").Readable}catch{i.nodestream=!1}},{"readable-stream":16}],31:[function(t,e,i){for(var s=t("./utils"),n=t("./support"),r=t("./nodejsUtils"),o=t("./stream/GenericWorker"),a=new Array(256),l=0;l<256;l++)a[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function h(){o.call(this,"utf-8 decode"),this.leftOver=null}function c(){o.call(this,"utf-8 encode")}a[254]=a[254]=1,i.utf8encode=function(t){return n.nodebuffer?r.newBufferFrom(t,"utf-8"):function(t){var e,i,s,r,o,a=t.length,l=0;for(r=0;r<a;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(s=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(s-56320),r++),l+=i<128?1:i<2048?2:i<65536?3:4;for(e=n.uint8array?new Uint8Array(l):new Array(l),r=o=0;o<l;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(s=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(s-56320),r++),i<128?e[o++]=i:(i<2048?e[o++]=192|i>>>6:(i<65536?e[o++]=224|i>>>12:(e[o++]=240|i>>>18,e[o++]=128|i>>>12&63),e[o++]=128|i>>>6&63),e[o++]=128|63&i);return e}(t)},i.utf8decode=function(t){return n.nodebuffer?s.transformTo("nodebuffer",t).toString("utf-8"):function(t){var e,i,n,r,o=t.length,l=new Array(2*o);for(e=i=0;e<o;)if((n=t[e++])<128)l[i++]=n;else if(4<(r=a[n]))l[i++]=65533,e+=r-1;else{for(n&=2===r?31:3===r?15:7;1<r&&e<o;)n=n<<6|63&t[e++],r--;1<r?l[i++]=65533:n<65536?l[i++]=n:(n-=65536,l[i++]=55296|n>>10&1023,l[i++]=56320|1023&n)}return l.length!==i&&(l.subarray?l=l.subarray(0,i):l.length=i),s.applyFromCharCode(l)}(t=s.transformTo(n.uint8array?"uint8array":"array",t))},s.inherits(h,o),h.prototype.processChunk=function(t){var e=s.transformTo(n.uint8array?"uint8array":"array",t.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var r=e;(e=new Uint8Array(r.length+this.leftOver.length)).set(this.leftOver,0),e.set(r,this.leftOver.length)}else e=this.leftOver.concat(e);this.leftOver=null}var o=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;0<=i&&128==(192&t[i]);)i--;return i<0||0===i?e:i+a[t[i]]>e?i:e}(e),l=e;o!==e.length&&(n.uint8array?(l=e.subarray(0,o),this.leftOver=e.subarray(o,e.length)):(l=e.slice(0,o),this.leftOver=e.slice(o,e.length))),this.push({data:i.utf8decode(l),meta:t.meta})},h.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:i.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},i.Utf8DecodeWorker=h,s.inherits(c,o),c.prototype.processChunk=function(t){this.push({data:i.utf8encode(t.data),meta:t.meta})},i.Utf8EncodeWorker=c},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,e,i){var s=t("./support"),n=t("./base64"),r=t("./nodejsUtils"),o=t("./external");function a(t){return t}function l(t,e){for(var i=0;i<t.length;++i)e[i]=255&t.charCodeAt(i);return e}t("setimmediate"),i.newBlob=function(t,e){i.checkSupport("blob");try{return new Blob([t],{type:e})}catch{try{var s=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return s.append(t),s.getBlob(e)}catch{throw new Error("Bug : can't construct the Blob.")}}};var h={stringifyByChunk:function(t,e,i){var s=[],n=0,r=t.length;if(r<=i)return String.fromCharCode.apply(null,t);for(;n<r;)"array"===e||"nodebuffer"===e?s.push(String.fromCharCode.apply(null,t.slice(n,Math.min(n+i,r)))):s.push(String.fromCharCode.apply(null,t.subarray(n,Math.min(n+i,r)))),n+=i;return s.join("")},stringifyByChar:function(t){for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return e},applyCanBeUsed:{uint8array:function(){try{return s.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch{return!1}}(),nodebuffer:function(){try{return s.nodebuffer&&1===String.fromCharCode.apply(null,r.allocBuffer(1)).length}catch{return!1}}()}};function c(t){var e=65536,s=i.getTypeOf(t),n=!0;if("uint8array"===s?n=h.applyCanBeUsed.uint8array:"nodebuffer"===s&&(n=h.applyCanBeUsed.nodebuffer),n)for(;1<e;)try{return h.stringifyByChunk(t,s,e)}catch{e=Math.floor(e/2)}return h.stringifyByChar(t)}function d(t,e){for(var i=0;i<t.length;i++)e[i]=t[i];return e}i.applyFromCharCode=c;var u={};u.string={string:a,array:function(t){return l(t,new Array(t.length))},arraybuffer:function(t){return u.string.uint8array(t).buffer},uint8array:function(t){return l(t,new Uint8Array(t.length))},nodebuffer:function(t){return l(t,r.allocBuffer(t.length))}},u.array={string:c,array:a,arraybuffer:function(t){return new Uint8Array(t).buffer},uint8array:function(t){return new Uint8Array(t)},nodebuffer:function(t){return r.newBufferFrom(t)}},u.arraybuffer={string:function(t){return c(new Uint8Array(t))},array:function(t){return d(new Uint8Array(t),new Array(t.byteLength))},arraybuffer:a,uint8array:function(t){return new Uint8Array(t)},nodebuffer:function(t){return r.newBufferFrom(new Uint8Array(t))}},u.uint8array={string:c,array:function(t){return d(t,new Array(t.length))},arraybuffer:function(t){return t.buffer},uint8array:a,nodebuffer:function(t){return r.newBufferFrom(t)}},u.nodebuffer={string:c,array:function(t){return d(t,new Array(t.length))},arraybuffer:function(t){return u.nodebuffer.uint8array(t).buffer},uint8array:function(t){return d(t,new Uint8Array(t.length))},nodebuffer:a},i.transformTo=function(t,e){if(e=e||"",!t)return e;i.checkSupport(t);var s=i.getTypeOf(e);return u[s][t](e)},i.resolve=function(t){for(var e=t.split("/"),i=[],s=0;s<e.length;s++){var n=e[s];"."===n||""===n&&0!==s&&s!==e.length-1||(".."===n?i.pop():i.push(n))}return i.join("/")},i.getTypeOf=function(t){return"string"==typeof t?"string":"[object Array]"===Object.prototype.toString.call(t)?"array":s.nodebuffer&&r.isBuffer(t)?"nodebuffer":s.uint8array&&t instanceof Uint8Array?"uint8array":s.arraybuffer&&t instanceof ArrayBuffer?"arraybuffer":void 0},i.checkSupport=function(t){if(!s[t.toLowerCase()])throw new Error(t+" is not supported by this platform")},i.MAX_VALUE_16BITS=65535,i.MAX_VALUE_32BITS=-1,i.pretty=function(t){var e,i,s="";for(i=0;i<(t||"").length;i++)s+="\\x"+((e=t.charCodeAt(i))<16?"0":"")+e.toString(16).toUpperCase();return s},i.delay=function(t,e,i){setImmediate(function(){t.apply(i||null,e||[])})},i.inherits=function(t,e){function i(){}i.prototype=e.prototype,t.prototype=new i},i.extend=function(){var t,e,i={};for(t=0;t<arguments.length;t++)for(e in arguments[t])Object.prototype.hasOwnProperty.call(arguments[t],e)&&void 0===i[e]&&(i[e]=arguments[t][e]);return i},i.prepareContent=function(t,e,r,a,h){return o.Promise.resolve(e).then(function(t){return s.blob&&(t instanceof Blob||-1!==["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(t)))&&typeof FileReader<"u"?new o.Promise(function(e,i){var s=new FileReader;s.onload=function(t){e(t.target.result)},s.onerror=function(t){i(t.target.error)},s.readAsArrayBuffer(t)}):t}).then(function(e){var c,d=i.getTypeOf(e);return d?("arraybuffer"===d?e=i.transformTo("uint8array",e):"string"===d&&(h?e=n.decode(e):r&&!0!==a&&(e=l(c=e,s.uint8array?new Uint8Array(c.length):new Array(c.length)))),e):o.Promise.reject(new Error("Can't read the data of '"+t+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,e,i){var s=t("./reader/readerFor"),n=t("./utils"),r=t("./signature"),o=t("./zipEntry"),a=t("./support");function l(t){this.files=[],this.loadOptions=t}l.prototype={checkSignature:function(t){if(!this.reader.readAndCheckSignature(t)){this.reader.index-=4;var e=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(e)+", expected "+n.pretty(t)+")")}},isSignature:function(t,e){var i=this.reader.index;this.reader.setIndex(t);var s=this.reader.readString(4)===e;return this.reader.setIndex(i),s},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var t=this.reader.readData(this.zipCommentLength),e=a.uint8array?"uint8array":"array",i=n.transformTo(e,t);this.zipComment=this.loadOptions.decodeFileName(i)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var t,e,i,s=this.zip64EndOfCentralSize-44;0<s;)t=this.reader.readInt(2),e=this.reader.readInt(4),i=this.reader.readData(e),this.zip64ExtensibleData[t]={id:t,length:e,value:i}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var t,e;for(t=0;t<this.files.length;t++)e=this.files[t],this.reader.setIndex(e.localHeaderOffset),this.checkSignature(r.LOCAL_FILE_HEADER),e.readLocalPart(this.reader),e.handleUTF8(),e.processAttributes()},readCentralDir:function(){var t;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(r.CENTRAL_FILE_HEADER);)(t=new o({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(t);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var t=this.reader.lastIndexOfSignature(r.CENTRAL_DIRECTORY_END);if(t<0)throw this.isSignature(0,r.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(t);var e=t;if(this.checkSignature(r.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(t=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(t),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,r.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var i=this.centralDirOffset+this.centralDirSize;this.zip64&&(i+=20,i+=12+this.zip64EndOfCentralSize);var s=e-i;if(0<s)this.isSignature(e,r.CENTRAL_FILE_HEADER)||(this.reader.zero=s);else if(s<0)throw new Error("Corrupted zip: missing "+Math.abs(s)+" bytes.")},prepareReader:function(t){this.reader=s(t)},load:function(t){this.prepareReader(t),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},e.exports=l},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,e,i){var s=t("./reader/readerFor"),n=t("./utils"),r=t("./compressedObject"),o=t("./crc32"),a=t("./utf8"),l=t("./compressions"),h=t("./support");function c(t,e){this.options=t,this.loadOptions=e}c.prototype={isEncrypted:function(){return!(1&~this.bitFlag)},useUTF8:function(){return!(2048&~this.bitFlag)},readLocalPart:function(t){var e,i;if(t.skip(22),this.fileNameLength=t.readInt(2),i=t.readInt(2),this.fileName=t.readData(this.fileNameLength),t.skip(i),-1===this.compressedSize||-1===this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(null===(e=function(t){for(var e in l)if(Object.prototype.hasOwnProperty.call(l,e)&&l[e].magic===t)return l[e];return null}(this.compressionMethod)))throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new r(this.compressedSize,this.uncompressedSize,this.crc32,e,t.readData(this.compressedSize))},readCentralPart:function(t){this.versionMadeBy=t.readInt(2),t.skip(2),this.bitFlag=t.readInt(2),this.compressionMethod=t.readString(2),this.date=t.readDate(),this.crc32=t.readInt(4),this.compressedSize=t.readInt(4),this.uncompressedSize=t.readInt(4);var e=t.readInt(2);if(this.extraFieldsLength=t.readInt(2),this.fileCommentLength=t.readInt(2),this.diskNumberStart=t.readInt(2),this.internalFileAttributes=t.readInt(2),this.externalFileAttributes=t.readInt(4),this.localHeaderOffset=t.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");t.skip(e),this.readExtraFields(t),this.parseZIP64ExtraField(t),this.fileComment=t.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var t=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),0==t&&(this.dosPermissions=63&this.externalFileAttributes),3==t&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var t=s(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=t.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=t.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=t.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=t.readInt(4))}},readExtraFields:function(t){var e,i,s,n=t.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});t.index+4<n;)e=t.readInt(2),i=t.readInt(2),s=t.readData(i),this.extraFields[e]={id:e,length:i,value:s};t.setIndex(n)},handleUTF8:function(){var t=h.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=a.utf8decode(this.fileName),this.fileCommentStr=a.utf8decode(this.fileComment);else{var e=this.findExtraFieldUnicodePath();if(null!==e)this.fileNameStr=e;else{var i=n.transformTo(t,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(i)}var s=this.findExtraFieldUnicodeComment();if(null!==s)this.fileCommentStr=s;else{var r=n.transformTo(t,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(r)}}},findExtraFieldUnicodePath:function(){var t=this.extraFields[28789];if(t){var e=s(t.value);return 1!==e.readInt(1)||o(this.fileName)!==e.readInt(4)?null:a.utf8decode(e.readData(t.length-5))}return null},findExtraFieldUnicodeComment:function(){var t=this.extraFields[25461];if(t){var e=s(t.value);return 1!==e.readInt(1)||o(this.fileComment)!==e.readInt(4)?null:a.utf8decode(e.readData(t.length-5))}return null}},e.exports=c},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,e,i){function s(t,e,i){this.name=t,this.dir=i.dir,this.date=i.date,this.comment=i.comment,this.unixPermissions=i.unixPermissions,this.dosPermissions=i.dosPermissions,this._data=e,this._dataBinary=i.binary,this.options={compression:i.compression,compressionOptions:i.compressionOptions}}var n=t("./stream/StreamHelper"),r=t("./stream/DataWorker"),o=t("./utf8"),a=t("./compressedObject"),l=t("./stream/GenericWorker");s.prototype={internalStream:function(t){var e=null,i="string";try{if(!t)throw new Error("No output type specified.");var s="string"===(i=t.toLowerCase())||"text"===i;"binarystring"!==i&&"text"!==i||(i="string"),e=this._decompressWorker();var r=!this._dataBinary;r&&!s&&(e=e.pipe(new o.Utf8EncodeWorker)),!r&&s&&(e=e.pipe(new o.Utf8DecodeWorker))}catch(t){(e=new l("error")).error(t)}return new n(e,i,"")},async:function(t,e){return this.internalStream(t).accumulate(e)},nodeStream:function(t,e){return this.internalStream(t||"nodebuffer").toNodejsStream(e)},_compressWorker:function(t,e){if(this._data instanceof a&&this._data.compression.magic===t.magic)return this._data.getCompressedWorker();var i=this._decompressWorker();return this._dataBinary||(i=i.pipe(new o.Utf8EncodeWorker)),a.createWorkerFrom(i,t,e)},_decompressWorker:function(){return this._data instanceof a?this._data.getContentWorker():this._data instanceof l?this._data:new r(this._data)}};for(var h=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],c=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},d=0;d<h.length;d++)s.prototype[h[d]]=c;e.exports=s},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,e,i){(function(t){var i,s,n=t.MutationObserver||t.WebKitMutationObserver;if(n){var r=0,o=new n(c),a=t.document.createTextNode("");o.observe(a,{characterData:!0}),i=function(){a.data=r=++r%2}}else if(t.setImmediate||void 0===t.MessageChannel)i="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var e=t.document.createElement("script");e.onreadystatechange=function(){c(),e.onreadystatechange=null,e.parentNode.removeChild(e),e=null},t.document.documentElement.appendChild(e)}:function(){setTimeout(c,0)};else{var l=new t.MessageChannel;l.port1.onmessage=c,i=function(){l.port2.postMessage(0)}}var h=[];function c(){var t,e;s=!0;for(var i=h.length;i;){for(e=h,h=[],t=-1;++t<i;)e[t]();i=h.length}s=!1}e.exports=function(t){1!==h.push(t)||s||i()}}).call(this,typeof Ut<"u"?Ut:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,e,i){var s=t("immediate");function n(){}var r={},o=["REJECTED"],a=["FULFILLED"],l=["PENDING"];function h(t){if("function"!=typeof t)throw new TypeError("resolver must be a function");this.state=l,this.queue=[],this.outcome=void 0,t!==n&&p(this,t)}function c(t,e,i){this.promise=t,"function"==typeof e&&(this.onFulfilled=e,this.callFulfilled=this.otherCallFulfilled),"function"==typeof i&&(this.onRejected=i,this.callRejected=this.otherCallRejected)}function d(t,e,i){s(function(){var s;try{s=e(i)}catch(e){return r.reject(t,e)}s===t?r.reject(t,new TypeError("Cannot resolve promise with itself")):r.resolve(t,s)})}function u(t){var e=t&&t.then;if(t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof e)return function(){e.apply(t,arguments)}}function p(t,e){var i=!1;function s(e){i||(i=!0,r.reject(t,e))}function n(e){i||(i=!0,r.resolve(t,e))}var o=f(function(){e(n,s)});"error"===o.status&&s(o.value)}function f(t,e){var i={};try{i.value=t(e),i.status="success"}catch(t){i.status="error",i.value=t}return i}(e.exports=h).prototype.finally=function(t){if("function"!=typeof t)return this;var e=this.constructor;return this.then(function(i){return e.resolve(t()).then(function(){return i})},function(i){return e.resolve(t()).then(function(){throw i})})},h.prototype.catch=function(t){return this.then(null,t)},h.prototype.then=function(t,e){if("function"!=typeof t&&this.state===a||"function"!=typeof e&&this.state===o)return this;var i=new this.constructor(n);return this.state!==l?d(i,this.state===a?t:e,this.outcome):this.queue.push(new c(i,t,e)),i},c.prototype.callFulfilled=function(t){r.resolve(this.promise,t)},c.prototype.otherCallFulfilled=function(t){d(this.promise,this.onFulfilled,t)},c.prototype.callRejected=function(t){r.reject(this.promise,t)},c.prototype.otherCallRejected=function(t){d(this.promise,this.onRejected,t)},r.resolve=function(t,e){var i=f(u,e);if("error"===i.status)return r.reject(t,i.value);var s=i.value;if(s)p(t,s);else{t.state=a,t.outcome=e;for(var n=-1,o=t.queue.length;++n<o;)t.queue[n].callFulfilled(e)}return t},r.reject=function(t,e){t.state=o,t.outcome=e;for(var i=-1,s=t.queue.length;++i<s;)t.queue[i].callRejected(e);return t},h.resolve=function(t){return t instanceof this?t:r.resolve(new this(n),t)},h.reject=function(t){var e=new this(n);return r.reject(e,t)},h.all=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var i=t.length,s=!1;if(!i)return this.resolve([]);for(var o=new Array(i),a=0,l=-1,h=new this(n);++l<i;)c(t[l],l);return h;function c(t,n){e.resolve(t).then(function(t){o[n]=t,++a!==i||s||(s=!0,r.resolve(h,o))},function(t){s||(s=!0,r.reject(h,t))})}},h.race=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var i,s=t.length,o=!1;if(!s)return this.resolve([]);for(var a=-1,l=new this(n);++a<s;)i=t[a],e.resolve(i).then(function(t){o||(o=!0,r.resolve(l,t))},function(t){o||(o=!0,r.reject(l,t))});return l}},{immediate:36}],38:[function(t,e,i){var s={};(0,t("./lib/utils/common").assign)(s,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),e.exports=s},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,e,i){var s=t("./zlib/deflate"),n=t("./utils/common"),r=t("./utils/strings"),o=t("./zlib/messages"),a=t("./zlib/zstream"),l=Object.prototype.toString,h=0,c=-1,d=0,u=8;function p(t){if(!(this instanceof p))return new p(t);this.options=n.assign({level:c,method:u,chunkSize:16384,windowBits:15,memLevel:8,strategy:d,to:""},t||{});var e=this.options;e.raw&&0<e.windowBits?e.windowBits=-e.windowBits:e.gzip&&0<e.windowBits&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var i=s.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(i!==h)throw new Error(o[i]);if(e.header&&s.deflateSetHeader(this.strm,e.header),e.dictionary){var f;if(f="string"==typeof e.dictionary?r.string2buf(e.dictionary):"[object ArrayBuffer]"===l.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,(i=s.deflateSetDictionary(this.strm,f))!==h)throw new Error(o[i]);this._dict_set=!0}}function f(t,e){var i=new p(e);if(i.push(t,!0),i.err)throw i.msg||o[i.err];return i.result}p.prototype.push=function(t,e){var i,o,a=this.strm,c=this.options.chunkSize;if(this.ended)return!1;o=e===~~e?e:!0===e?4:0,"string"==typeof t?a.input=r.string2buf(t):"[object ArrayBuffer]"===l.call(t)?a.input=new Uint8Array(t):a.input=t,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new n.Buf8(c),a.next_out=0,a.avail_out=c),1!==(i=s.deflate(a,o))&&i!==h)return this.onEnd(i),!(this.ended=!0);0!==a.avail_out&&(0!==a.avail_in||4!==o&&2!==o)||("string"===this.options.to?this.onData(r.buf2binstring(n.shrinkBuf(a.output,a.next_out))):this.onData(n.shrinkBuf(a.output,a.next_out)))}while((0<a.avail_in||0===a.avail_out)&&1!==i);return 4===o?(i=s.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===h):2!==o||(this.onEnd(h),!(a.avail_out=0))},p.prototype.onData=function(t){this.chunks.push(t)},p.prototype.onEnd=function(t){t===h&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Deflate=p,i.deflate=f,i.deflateRaw=function(t,e){return(e=e||{}).raw=!0,f(t,e)},i.gzip=function(t,e){return(e=e||{}).gzip=!0,f(t,e)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,e,i){var s=t("./zlib/inflate"),n=t("./utils/common"),r=t("./utils/strings"),o=t("./zlib/constants"),a=t("./zlib/messages"),l=t("./zlib/zstream"),h=t("./zlib/gzheader"),c=Object.prototype.toString;function d(t){if(!(this instanceof d))return new d(t);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&0<=e.windowBits&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(0<=e.windowBits&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),15<e.windowBits&&e.windowBits<48&&!(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var i=s.inflateInit2(this.strm,e.windowBits);if(i!==o.Z_OK)throw new Error(a[i]);this.header=new h,s.inflateGetHeader(this.strm,this.header)}function u(t,e){var i=new d(e);if(i.push(t,!0),i.err)throw i.msg||a[i.err];return i.result}d.prototype.push=function(t,e){var i,a,l,h,d,u,p=this.strm,f=this.options.chunkSize,m=this.options.dictionary,g=!1;if(this.ended)return!1;a=e===~~e?e:!0===e?o.Z_FINISH:o.Z_NO_FLUSH,"string"==typeof t?p.input=r.binstring2buf(t):"[object ArrayBuffer]"===c.call(t)?p.input=new Uint8Array(t):p.input=t,p.next_in=0,p.avail_in=p.input.length;do{if(0===p.avail_out&&(p.output=new n.Buf8(f),p.next_out=0,p.avail_out=f),(i=s.inflate(p,o.Z_NO_FLUSH))===o.Z_NEED_DICT&&m&&(u="string"==typeof m?r.string2buf(m):"[object ArrayBuffer]"===c.call(m)?new Uint8Array(m):m,i=s.inflateSetDictionary(this.strm,u)),i===o.Z_BUF_ERROR&&!0===g&&(i=o.Z_OK,g=!1),i!==o.Z_STREAM_END&&i!==o.Z_OK)return this.onEnd(i),!(this.ended=!0);p.next_out&&(0!==p.avail_out&&i!==o.Z_STREAM_END&&(0!==p.avail_in||a!==o.Z_FINISH&&a!==o.Z_SYNC_FLUSH)||("string"===this.options.to?(l=r.utf8border(p.output,p.next_out),h=p.next_out-l,d=r.buf2string(p.output,l),p.next_out=h,p.avail_out=f-h,h&&n.arraySet(p.output,p.output,l,h,0),this.onData(d)):this.onData(n.shrinkBuf(p.output,p.next_out)))),0===p.avail_in&&0===p.avail_out&&(g=!0)}while((0<p.avail_in||0===p.avail_out)&&i!==o.Z_STREAM_END);return i===o.Z_STREAM_END&&(a=o.Z_FINISH),a===o.Z_FINISH?(i=s.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===o.Z_OK):a!==o.Z_SYNC_FLUSH||(this.onEnd(o.Z_OK),!(p.avail_out=0))},d.prototype.onData=function(t){this.chunks.push(t)},d.prototype.onEnd=function(t){t===o.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Inflate=d,i.inflate=u,i.inflateRaw=function(t,e){return(e=e||{}).raw=!0,u(t,e)},i.ungzip=u},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,e,i){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";i.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var i=e.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s])}}return t},i.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)};var n={arraySet:function(t,e,i,s,n){if(e.subarray&&t.subarray)t.set(e.subarray(i,i+s),n);else for(var r=0;r<s;r++)t[n+r]=e[i+r]},flattenChunks:function(t){var e,i,s,n,r,o;for(e=s=0,i=t.length;e<i;e++)s+=t[e].length;for(o=new Uint8Array(s),e=n=0,i=t.length;e<i;e++)r=t[e],o.set(r,n),n+=r.length;return o}},r={arraySet:function(t,e,i,s,n){for(var r=0;r<s;r++)t[n+r]=e[i+r]},flattenChunks:function(t){return[].concat.apply([],t)}};i.setTyped=function(t){t?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,n)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,r))},i.setTyped(s)},{}],42:[function(t,e,i){var s=t("./common"),n=!0,r=!0;try{String.fromCharCode.apply(null,[0])}catch{n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{r=!1}for(var o=new s.Buf8(256),a=0;a<256;a++)o[a]=252<=a?6:248<=a?5:240<=a?4:224<=a?3:192<=a?2:1;function l(t,e){if(e<65537&&(t.subarray&&r||!t.subarray&&n))return String.fromCharCode.apply(null,s.shrinkBuf(t,e));for(var i="",o=0;o<e;o++)i+=String.fromCharCode(t[o]);return i}o[254]=o[254]=1,i.string2buf=function(t){var e,i,n,r,o,a=t.length,l=0;for(r=0;r<a;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(n=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),l+=i<128?1:i<2048?2:i<65536?3:4;for(e=new s.Buf8(l),r=o=0;o<l;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(n=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),i<128?e[o++]=i:(i<2048?e[o++]=192|i>>>6:(i<65536?e[o++]=224|i>>>12:(e[o++]=240|i>>>18,e[o++]=128|i>>>12&63),e[o++]=128|i>>>6&63),e[o++]=128|63&i);return e},i.buf2binstring=function(t){return l(t,t.length)},i.binstring2buf=function(t){for(var e=new s.Buf8(t.length),i=0,n=e.length;i<n;i++)e[i]=t.charCodeAt(i);return e},i.buf2string=function(t,e){var i,s,n,r,a=e||t.length,h=new Array(2*a);for(i=s=0;i<a;)if((n=t[i++])<128)h[s++]=n;else if(4<(r=o[n]))h[s++]=65533,i+=r-1;else{for(n&=2===r?31:3===r?15:7;1<r&&i<a;)n=n<<6|63&t[i++],r--;1<r?h[s++]=65533:n<65536?h[s++]=n:(n-=65536,h[s++]=55296|n>>10&1023,h[s++]=56320|1023&n)}return l(h,s)},i.utf8border=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;0<=i&&128==(192&t[i]);)i--;return i<0||0===i?e:i+o[t[i]]>e?i:e}},{"./common":41}],43:[function(t,e,i){e.exports=function(t,e,i,s){for(var n=65535&t,r=t>>>16&65535,o=0;0!==i;){for(i-=o=2e3<i?2e3:i;r=r+(n=n+e[s++]|0)|0,--o;);n%=65521,r%=65521}return n|r<<16}},{}],44:[function(t,e,i){e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,e,i){var s=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var s=0;s<8;s++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();e.exports=function(t,e,i,n){var r=s,o=n+i;t^=-1;for(var a=n;a<o;a++)t=t>>>8^r[255&(t^e[a])];return-1^t}},{}],46:[function(t,e,i){var s,n=t("../utils/common"),r=t("./trees"),o=t("./adler32"),a=t("./crc32"),l=t("./messages"),h=0,c=4,d=0,u=-2,p=-1,f=4,m=2,g=8,v=9,_=286,y=30,w=19,b=2*_+1,x=15,S=3,E=258,C=E+S+1,T=42,P=113,A=1,M=2,O=3,D=4;function z(t,e){return t.msg=l[e],e}function I(t){return(t<<1)-(4<t?9:0)}function k(t){for(var e=t.length;0<=--e;)t[e]=0}function L(t){var e=t.state,i=e.pending;i>t.avail_out&&(i=t.avail_out),0!==i&&(n.arraySet(t.output,e.pending_buf,e.pending_out,i,t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,0===e.pending&&(e.pending_out=0))}function N(t,e){r._tr_flush_block(t,0<=t.block_start?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,L(t.strm)}function B(t,e){t.pending_buf[t.pending++]=e}function U(t,e){t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e}function R(t,e){var i,s,n=t.max_chain_length,r=t.strstart,o=t.prev_length,a=t.nice_match,l=t.strstart>t.w_size-C?t.strstart-(t.w_size-C):0,h=t.window,c=t.w_mask,d=t.prev,u=t.strstart+E,p=h[r+o-1],f=h[r+o];t.prev_length>=t.good_match&&(n>>=2),a>t.lookahead&&(a=t.lookahead);do{if(h[(i=e)+o]===f&&h[i+o-1]===p&&h[i]===h[r]&&h[++i]===h[r+1]){r+=2,i++;do{}while(h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&r<u);if(s=E-(u-r),r=u-E,o<s){if(t.match_start=e,a<=(o=s))break;p=h[r+o-1],f=h[r+o]}}}while((e=d[e&c])>l&&0!=--n);return o<=t.lookahead?o:t.lookahead}function F(t){var e,i,s,r,l,h,c,d,u,p,f=t.w_size;do{if(r=t.window_size-t.lookahead-t.strstart,t.strstart>=f+(f-C)){for(n.arraySet(t.window,t.window,f,f,0),t.match_start-=f,t.strstart-=f,t.block_start-=f,e=i=t.hash_size;s=t.head[--e],t.head[e]=f<=s?s-f:0,--i;);for(e=i=f;s=t.prev[--e],t.prev[e]=f<=s?s-f:0,--i;);r+=f}if(0===t.strm.avail_in)break;if(h=t.strm,c=t.window,d=t.strstart+t.lookahead,p=void 0,(u=r)<(p=h.avail_in)&&(p=u),i=0===p?0:(h.avail_in-=p,n.arraySet(c,h.input,h.next_in,p,d),1===h.state.wrap?h.adler=o(h.adler,c,p,d):2===h.state.wrap&&(h.adler=a(h.adler,c,p,d)),h.next_in+=p,h.total_in+=p,p),t.lookahead+=i,t.lookahead+t.insert>=S)for(l=t.strstart-t.insert,t.ins_h=t.window[l],t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+S-1])&t.hash_mask,t.prev[l&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=l,l++,t.insert--,!(t.lookahead+t.insert<S)););}while(t.lookahead<C&&0!==t.strm.avail_in)}function V(t,e){for(var i,s;;){if(t.lookahead<C){if(F(t),t.lookahead<C&&e===h)return A;if(0===t.lookahead)break}if(i=0,t.lookahead>=S&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+S-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==i&&t.strstart-i<=t.w_size-C&&(t.match_length=R(t,i)),t.match_length>=S)if(s=r._tr_tally(t,t.strstart-t.match_start,t.match_length-S),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=S){for(t.match_length--;t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+S-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart,0!=--t.match_length;);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;else s=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(s&&(N(t,!1),0===t.strm.avail_out))return A}return t.insert=t.strstart<S-1?t.strstart:S-1,e===c?(N(t,!0),0===t.strm.avail_out?O:D):t.last_lit&&(N(t,!1),0===t.strm.avail_out)?A:M}function j(t,e){for(var i,s,n;;){if(t.lookahead<C){if(F(t),t.lookahead<C&&e===h)return A;if(0===t.lookahead)break}if(i=0,t.lookahead>=S&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+S-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=S-1,0!==i&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-C&&(t.match_length=R(t,i),t.match_length<=5&&(1===t.strategy||t.match_length===S&&4096<t.strstart-t.match_start)&&(t.match_length=S-1)),t.prev_length>=S&&t.match_length<=t.prev_length){for(n=t.strstart+t.lookahead-S,s=r._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-S),t.lookahead-=t.prev_length-1,t.prev_length-=2;++t.strstart<=n&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+S-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!=--t.prev_length;);if(t.match_available=0,t.match_length=S-1,t.strstart++,s&&(N(t,!1),0===t.strm.avail_out))return A}else if(t.match_available){if((s=r._tr_tally(t,0,t.window[t.strstart-1]))&&N(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return A}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(s=r._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<S-1?t.strstart:S-1,e===c?(N(t,!0),0===t.strm.avail_out?O:D):t.last_lit&&(N(t,!1),0===t.strm.avail_out)?A:M}function H(t,e,i,s,n){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=s,this.func=n}function W(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=g,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*b),this.dyn_dtree=new n.Buf16(2*(2*y+1)),this.bl_tree=new n.Buf16(2*(2*w+1)),k(this.dyn_ltree),k(this.dyn_dtree),k(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(x+1),this.heap=new n.Buf16(2*_+1),k(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*_+1),k(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function G(t){var e;return t&&t.state?(t.total_in=t.total_out=0,t.data_type=m,(e=t.state).pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?T:P,t.adler=2===e.wrap?0:1,e.last_flush=h,r._tr_init(e),d):z(t,u)}function Z(t){var e,i=G(t);return i===d&&((e=t.state).window_size=2*e.w_size,k(e.head),e.max_lazy_match=s[e.level].max_lazy,e.good_match=s[e.level].good_length,e.nice_match=s[e.level].nice_length,e.max_chain_length=s[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=S-1,e.match_available=0,e.ins_h=0),i}function Y(t,e,i,s,r,o){if(!t)return u;var a=1;if(e===p&&(e=6),s<0?(a=0,s=-s):15<s&&(a=2,s-=16),r<1||v<r||i!==g||s<8||15<s||e<0||9<e||o<0||f<o)return z(t,u);8===s&&(s=9);var l=new W;return(t.state=l).strm=t,l.wrap=a,l.gzhead=null,l.w_bits=s,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=r+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+S-1)/S),l.window=new n.Buf8(2*l.w_size),l.head=new n.Buf16(l.hash_size),l.prev=new n.Buf16(l.w_size),l.lit_bufsize=1<<r+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new n.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=e,l.strategy=o,l.method=i,Z(t)}s=[new H(0,0,0,0,function(t,e){var i=65535;for(i>t.pending_buf_size-5&&(i=t.pending_buf_size-5);;){if(t.lookahead<=1){if(F(t),0===t.lookahead&&e===h)return A;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;var s=t.block_start+i;if((0===t.strstart||t.strstart>=s)&&(t.lookahead=t.strstart-s,t.strstart=s,N(t,!1),0===t.strm.avail_out)||t.strstart-t.block_start>=t.w_size-C&&(N(t,!1),0===t.strm.avail_out))return A}return t.insert=0,e===c?(N(t,!0),0===t.strm.avail_out?O:D):(t.strstart>t.block_start&&(N(t,!1),t.strm.avail_out),A)}),new H(4,4,8,4,V),new H(4,5,16,8,V),new H(4,6,32,32,V),new H(4,4,16,16,j),new H(8,16,32,32,j),new H(8,16,128,128,j),new H(8,32,128,256,j),new H(32,128,258,1024,j),new H(32,258,258,4096,j)],i.deflateInit=function(t,e){return Y(t,e,g,15,8,0)},i.deflateInit2=Y,i.deflateReset=Z,i.deflateResetKeep=G,i.deflateSetHeader=function(t,e){return t&&t.state?2!==t.state.wrap?u:(t.state.gzhead=e,d):u},i.deflate=function(t,e){var i,n,o,l;if(!t||!t.state||5<e||e<0)return t?z(t,u):u;if(n=t.state,!t.output||!t.input&&0!==t.avail_in||666===n.status&&e!==c)return z(t,0===t.avail_out?-5:u);if(n.strm=t,i=n.last_flush,n.last_flush=e,n.status===T)if(2===n.wrap)t.adler=0,B(n,31),B(n,139),B(n,8),n.gzhead?(B(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),B(n,255&n.gzhead.time),B(n,n.gzhead.time>>8&255),B(n,n.gzhead.time>>16&255),B(n,n.gzhead.time>>24&255),B(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),B(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(B(n,255&n.gzhead.extra.length),B(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=a(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69):(B(n,0),B(n,0),B(n,0),B(n,0),B(n,0),B(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),B(n,3),n.status=P);else{var p=g+(n.w_bits-8<<4)<<8;p|=(2<=n.strategy||n.level<2?0:n.level<6?1:6===n.level?2:3)<<6,0!==n.strstart&&(p|=32),p+=31-p%31,n.status=P,U(n,p),0!==n.strstart&&(U(n,t.adler>>>16),U(n,65535&t.adler)),t.adler=1}if(69===n.status)if(n.gzhead.extra){for(o=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),L(t),o=n.pending,n.pending!==n.pending_buf_size));)B(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=73)}else n.status=73;if(73===n.status)if(n.gzhead.name){o=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),L(t),o=n.pending,n.pending===n.pending_buf_size)){l=1;break}l=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,B(n,l)}while(0!==l);n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),0===l&&(n.gzindex=0,n.status=91)}else n.status=91;if(91===n.status)if(n.gzhead.comment){o=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),L(t),o=n.pending,n.pending===n.pending_buf_size)){l=1;break}l=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,B(n,l)}while(0!==l);n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),0===l&&(n.status=103)}else n.status=103;if(103===n.status&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&L(t),n.pending+2<=n.pending_buf_size&&(B(n,255&t.adler),B(n,t.adler>>8&255),t.adler=0,n.status=P)):n.status=P),0!==n.pending){if(L(t),0===t.avail_out)return n.last_flush=-1,d}else if(0===t.avail_in&&I(e)<=I(i)&&e!==c)return z(t,-5);if(666===n.status&&0!==t.avail_in)return z(t,-5);if(0!==t.avail_in||0!==n.lookahead||e!==h&&666!==n.status){var f=2===n.strategy?function(t,e){for(var i;;){if(0===t.lookahead&&(F(t),0===t.lookahead)){if(e===h)return A;break}if(t.match_length=0,i=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,i&&(N(t,!1),0===t.strm.avail_out))return A}return t.insert=0,e===c?(N(t,!0),0===t.strm.avail_out?O:D):t.last_lit&&(N(t,!1),0===t.strm.avail_out)?A:M}(n,e):3===n.strategy?function(t,e){for(var i,s,n,o,a=t.window;;){if(t.lookahead<=E){if(F(t),t.lookahead<=E&&e===h)return A;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=S&&0<t.strstart&&(s=a[n=t.strstart-1])===a[++n]&&s===a[++n]&&s===a[++n]){o=t.strstart+E;do{}while(s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&n<o);t.match_length=E-(o-n),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=S?(i=r._tr_tally(t,1,t.match_length-S),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(i=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),i&&(N(t,!1),0===t.strm.avail_out))return A}return t.insert=0,e===c?(N(t,!0),0===t.strm.avail_out?O:D):t.last_lit&&(N(t,!1),0===t.strm.avail_out)?A:M}(n,e):s[n.level].func(n,e);if(f!==O&&f!==D||(n.status=666),f===A||f===O)return 0===t.avail_out&&(n.last_flush=-1),d;if(f===M&&(1===e?r._tr_align(n):5!==e&&(r._tr_stored_block(n,0,0,!1),3===e&&(k(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),L(t),0===t.avail_out))return n.last_flush=-1,d}return e!==c?d:n.wrap<=0?1:(2===n.wrap?(B(n,255&t.adler),B(n,t.adler>>8&255),B(n,t.adler>>16&255),B(n,t.adler>>24&255),B(n,255&t.total_in),B(n,t.total_in>>8&255),B(n,t.total_in>>16&255),B(n,t.total_in>>24&255)):(U(n,t.adler>>>16),U(n,65535&t.adler)),L(t),0<n.wrap&&(n.wrap=-n.wrap),0!==n.pending?d:1)},i.deflateEnd=function(t){var e;return t&&t.state?(e=t.state.status)!==T&&69!==e&&73!==e&&91!==e&&103!==e&&e!==P&&666!==e?z(t,u):(t.state=null,e===P?z(t,-3):d):u},i.deflateSetDictionary=function(t,e){var i,s,r,a,l,h,c,p,f=e.length;if(!t||!t.state||2===(a=(i=t.state).wrap)||1===a&&i.status!==T||i.lookahead)return u;for(1===a&&(t.adler=o(t.adler,e,f,0)),i.wrap=0,f>=i.w_size&&(0===a&&(k(i.head),i.strstart=0,i.block_start=0,i.insert=0),p=new n.Buf8(i.w_size),n.arraySet(p,e,f-i.w_size,i.w_size,0),e=p,f=i.w_size),l=t.avail_in,h=t.next_in,c=t.input,t.avail_in=f,t.next_in=0,t.input=e,F(i);i.lookahead>=S;){for(s=i.strstart,r=i.lookahead-(S-1);i.ins_h=(i.ins_h<<i.hash_shift^i.window[s+S-1])&i.hash_mask,i.prev[s&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=s,s++,--r;);i.strstart=s,i.lookahead=S-1,F(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=S-1,i.match_available=0,t.next_in=h,t.input=c,t.avail_in=l,i.wrap=a,d},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,e,i){e.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,e,i){e.exports=function(t,e){var i,s,n,r,o,a,l,h,c,d,u,p,f,m,g,v,_,y,w,b,x,S,E,C,T;i=t.state,s=t.next_in,C=t.input,n=s+(t.avail_in-5),r=t.next_out,T=t.output,o=r-(e-t.avail_out),a=r+(t.avail_out-257),l=i.dmax,h=i.wsize,c=i.whave,d=i.wnext,u=i.window,p=i.hold,f=i.bits,m=i.lencode,g=i.distcode,v=(1<<i.lenbits)-1,_=(1<<i.distbits)-1;t:do{f<15&&(p+=C[s++]<<f,f+=8,p+=C[s++]<<f,f+=8),y=m[p&v];e:for(;;){if(p>>>=w=y>>>24,f-=w,0==(w=y>>>16&255))T[r++]=65535&y;else{if(!(16&w)){if(!(64&w)){y=m[(65535&y)+(p&(1<<w)-1)];continue e}if(32&w){i.mode=12;break t}t.msg="invalid literal/length code",i.mode=30;break t}b=65535&y,(w&=15)&&(f<w&&(p+=C[s++]<<f,f+=8),b+=p&(1<<w)-1,p>>>=w,f-=w),f<15&&(p+=C[s++]<<f,f+=8,p+=C[s++]<<f,f+=8),y=g[p&_];i:for(;;){if(p>>>=w=y>>>24,f-=w,!(16&(w=y>>>16&255))){if(!(64&w)){y=g[(65535&y)+(p&(1<<w)-1)];continue i}t.msg="invalid distance code",i.mode=30;break t}if(x=65535&y,f<(w&=15)&&(p+=C[s++]<<f,(f+=8)<w&&(p+=C[s++]<<f,f+=8)),l<(x+=p&(1<<w)-1)){t.msg="invalid distance too far back",i.mode=30;break t}if(p>>>=w,f-=w,(w=r-o)<x){if(c<(w=x-w)&&i.sane){t.msg="invalid distance too far back",i.mode=30;break t}if(E=u,(S=0)===d){if(S+=h-w,w<b){for(b-=w;T[r++]=u[S++],--w;);S=r-x,E=T}}else if(d<w){if(S+=h+d-w,(w-=d)<b){for(b-=w;T[r++]=u[S++],--w;);if(S=0,d<b){for(b-=w=d;T[r++]=u[S++],--w;);S=r-x,E=T}}}else if(S+=d-w,w<b){for(b-=w;T[r++]=u[S++],--w;);S=r-x,E=T}for(;2<b;)T[r++]=E[S++],T[r++]=E[S++],T[r++]=E[S++],b-=3;b&&(T[r++]=E[S++],1<b&&(T[r++]=E[S++]))}else{for(S=r-x;T[r++]=T[S++],T[r++]=T[S++],T[r++]=T[S++],2<(b-=3););b&&(T[r++]=T[S++],1<b&&(T[r++]=T[S++]))}break}}break}}while(s<n&&r<a);s-=b=f>>3,p&=(1<<(f-=b<<3))-1,t.next_in=s,t.next_out=r,t.avail_in=s<n?n-s+5:5-(s-n),t.avail_out=r<a?a-r+257:257-(r-a),i.hold=p,i.bits=f}},{}],49:[function(t,e,i){var s=t("../utils/common"),n=t("./adler32"),r=t("./crc32"),o=t("./inffast"),a=t("./inftrees"),l=1,h=2,c=0,d=-2,u=1,p=852,f=592;function m(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function g(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function v(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=u,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new s.Buf32(p),e.distcode=e.distdyn=new s.Buf32(f),e.sane=1,e.back=-1,c):d}function _(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,v(t)):d}function y(t,e){var i,s;return t&&t.state?(s=t.state,e<0?(i=0,e=-e):(i=1+(e>>4),e<48&&(e&=15)),e&&(e<8||15<e)?d:(null!==s.window&&s.wbits!==e&&(s.window=null),s.wrap=i,s.wbits=e,_(t))):d}function w(t,e){var i,s;return t?(s=new g,(t.state=s).window=null,(i=y(t,e))!==c&&(t.state=null),i):d}var b,x,S=!0;function E(t){if(S){var e;for(b=new s.Buf32(512),x=new s.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(a(l,t.lens,0,288,b,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;a(h,t.lens,0,32,x,0,t.work,{bits:5}),S=!1}t.lencode=b,t.lenbits=9,t.distcode=x,t.distbits=5}function C(t,e,i,n){var r,o=t.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new s.Buf8(o.wsize)),n>=o.wsize?(s.arraySet(o.window,e,i-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):(n<(r=o.wsize-o.wnext)&&(r=n),s.arraySet(o.window,e,i-n,r,o.wnext),(n-=r)?(s.arraySet(o.window,e,i-n,n,0),o.wnext=n,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0}i.inflateReset=_,i.inflateReset2=y,i.inflateResetKeep=v,i.inflateInit=function(t){return w(t,15)},i.inflateInit2=w,i.inflate=function(t,e){var i,p,f,g,v,_,y,w,b,x,S,T,P,A,M,O,D,z,I,k,L,N,B,U,R=0,F=new s.Buf8(4),V=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return d;12===(i=t.state).mode&&(i.mode=13),v=t.next_out,f=t.output,y=t.avail_out,g=t.next_in,p=t.input,_=t.avail_in,w=i.hold,b=i.bits,x=_,S=y,N=c;t:for(;;)switch(i.mode){case u:if(0===i.wrap){i.mode=13;break}for(;b<16;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}if(2&i.wrap&&35615===w){F[i.check=0]=255&w,F[1]=w>>>8&255,i.check=r(i.check,F,2,0),b=w=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&w)<<8)+(w>>8))%31){t.msg="incorrect header check",i.mode=30;break}if(8!=(15&w)){t.msg="unknown compression method",i.mode=30;break}if(b-=4,L=8+(15&(w>>>=4)),0===i.wbits)i.wbits=L;else if(L>i.wbits){t.msg="invalid window size",i.mode=30;break}i.dmax=1<<L,t.adler=i.check=1,i.mode=512&w?10:12,b=w=0;break;case 2:for(;b<16;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}if(i.flags=w,8!=(255&i.flags)){t.msg="unknown compression method",i.mode=30;break}if(57344&i.flags){t.msg="unknown header flags set",i.mode=30;break}i.head&&(i.head.text=w>>8&1),512&i.flags&&(F[0]=255&w,F[1]=w>>>8&255,i.check=r(i.check,F,2,0)),b=w=0,i.mode=3;case 3:for(;b<32;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}i.head&&(i.head.time=w),512&i.flags&&(F[0]=255&w,F[1]=w>>>8&255,F[2]=w>>>16&255,F[3]=w>>>24&255,i.check=r(i.check,F,4,0)),b=w=0,i.mode=4;case 4:for(;b<16;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}i.head&&(i.head.xflags=255&w,i.head.os=w>>8),512&i.flags&&(F[0]=255&w,F[1]=w>>>8&255,i.check=r(i.check,F,2,0)),b=w=0,i.mode=5;case 5:if(1024&i.flags){for(;b<16;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}i.length=w,i.head&&(i.head.extra_len=w),512&i.flags&&(F[0]=255&w,F[1]=w>>>8&255,i.check=r(i.check,F,2,0)),b=w=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&(_<(T=i.length)&&(T=_),T&&(i.head&&(L=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),s.arraySet(i.head.extra,p,g,T,L)),512&i.flags&&(i.check=r(i.check,p,T,g)),_-=T,g+=T,i.length-=T),i.length))break t;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===_)break t;for(T=0;L=p[g+T++],i.head&&L&&i.length<65536&&(i.head.name+=String.fromCharCode(L)),L&&T<_;);if(512&i.flags&&(i.check=r(i.check,p,T,g)),_-=T,g+=T,L)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===_)break t;for(T=0;L=p[g+T++],i.head&&L&&i.length<65536&&(i.head.comment+=String.fromCharCode(L)),L&&T<_;);if(512&i.flags&&(i.check=r(i.check,p,T,g)),_-=T,g+=T,L)break t}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;b<16;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}if(w!==(65535&i.check)){t.msg="header crc mismatch",i.mode=30;break}b=w=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=12;break;case 10:for(;b<32;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}t.adler=i.check=m(w),b=w=0,i.mode=11;case 11:if(0===i.havedict)return t.next_out=v,t.avail_out=y,t.next_in=g,t.avail_in=_,i.hold=w,i.bits=b,2;t.adler=i.check=1,i.mode=12;case 12:if(5===e||6===e)break t;case 13:if(i.last){w>>>=7&b,b-=7&b,i.mode=27;break}for(;b<3;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}switch(i.last=1&w,b-=1,3&(w>>>=1)){case 0:i.mode=14;break;case 1:if(E(i),i.mode=20,6!==e)break;w>>>=2,b-=2;break t;case 2:i.mode=17;break;case 3:t.msg="invalid block type",i.mode=30}w>>>=2,b-=2;break;case 14:for(w>>>=7&b,b-=7&b;b<32;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}if((65535&w)!=(w>>>16^65535)){t.msg="invalid stored block lengths",i.mode=30;break}if(i.length=65535&w,b=w=0,i.mode=15,6===e)break t;case 15:i.mode=16;case 16:if(T=i.length){if(_<T&&(T=_),y<T&&(T=y),0===T)break t;s.arraySet(f,p,g,T,v),_-=T,g+=T,y-=T,v+=T,i.length-=T;break}i.mode=12;break;case 17:for(;b<14;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}if(i.nlen=257+(31&w),w>>>=5,b-=5,i.ndist=1+(31&w),w>>>=5,b-=5,i.ncode=4+(15&w),w>>>=4,b-=4,286<i.nlen||30<i.ndist){t.msg="too many length or distance symbols",i.mode=30;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;b<3;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}i.lens[V[i.have++]]=7&w,w>>>=3,b-=3}for(;i.have<19;)i.lens[V[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,B={bits:i.lenbits},N=a(0,i.lens,0,19,i.lencode,0,i.work,B),i.lenbits=B.bits,N){t.msg="invalid code lengths set",i.mode=30;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;O=(R=i.lencode[w&(1<<i.lenbits)-1])>>>16&255,D=65535&R,!((M=R>>>24)<=b);){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}if(D<16)w>>>=M,b-=M,i.lens[i.have++]=D;else{if(16===D){for(U=M+2;b<U;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}if(w>>>=M,b-=M,0===i.have){t.msg="invalid bit length repeat",i.mode=30;break}L=i.lens[i.have-1],T=3+(3&w),w>>>=2,b-=2}else if(17===D){for(U=M+3;b<U;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}b-=M,L=0,T=3+(7&(w>>>=M)),w>>>=3,b-=3}else{for(U=M+7;b<U;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}b-=M,L=0,T=11+(127&(w>>>=M)),w>>>=7,b-=7}if(i.have+T>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=30;break}for(;T--;)i.lens[i.have++]=L}}if(30===i.mode)break;if(0===i.lens[256]){t.msg="invalid code -- missing end-of-block",i.mode=30;break}if(i.lenbits=9,B={bits:i.lenbits},N=a(l,i.lens,0,i.nlen,i.lencode,0,i.work,B),i.lenbits=B.bits,N){t.msg="invalid literal/lengths set",i.mode=30;break}if(i.distbits=6,i.distcode=i.distdyn,B={bits:i.distbits},N=a(h,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,B),i.distbits=B.bits,N){t.msg="invalid distances set",i.mode=30;break}if(i.mode=20,6===e)break t;case 20:i.mode=21;case 21:if(6<=_&&258<=y){t.next_out=v,t.avail_out=y,t.next_in=g,t.avail_in=_,i.hold=w,i.bits=b,o(t,S),v=t.next_out,f=t.output,y=t.avail_out,g=t.next_in,p=t.input,_=t.avail_in,w=i.hold,b=i.bits,12===i.mode&&(i.back=-1);break}for(i.back=0;O=(R=i.lencode[w&(1<<i.lenbits)-1])>>>16&255,D=65535&R,!((M=R>>>24)<=b);){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}if(O&&!(240&O)){for(z=M,I=O,k=D;O=(R=i.lencode[k+((w&(1<<z+I)-1)>>z)])>>>16&255,D=65535&R,!(z+(M=R>>>24)<=b);){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}w>>>=z,b-=z,i.back+=z}if(w>>>=M,b-=M,i.back+=M,i.length=D,0===O){i.mode=26;break}if(32&O){i.back=-1,i.mode=12;break}if(64&O){t.msg="invalid literal/length code",i.mode=30;break}i.extra=15&O,i.mode=22;case 22:if(i.extra){for(U=i.extra;b<U;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}i.length+=w&(1<<i.extra)-1,w>>>=i.extra,b-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;O=(R=i.distcode[w&(1<<i.distbits)-1])>>>16&255,D=65535&R,!((M=R>>>24)<=b);){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}if(!(240&O)){for(z=M,I=O,k=D;O=(R=i.distcode[k+((w&(1<<z+I)-1)>>z)])>>>16&255,D=65535&R,!(z+(M=R>>>24)<=b);){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}w>>>=z,b-=z,i.back+=z}if(w>>>=M,b-=M,i.back+=M,64&O){t.msg="invalid distance code",i.mode=30;break}i.offset=D,i.extra=15&O,i.mode=24;case 24:if(i.extra){for(U=i.extra;b<U;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}i.offset+=w&(1<<i.extra)-1,w>>>=i.extra,b-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=30;break}i.mode=25;case 25:if(0===y)break t;if(T=S-y,i.offset>T){if((T=i.offset-T)>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=30;break}P=T>i.wnext?(T-=i.wnext,i.wsize-T):i.wnext-T,T>i.length&&(T=i.length),A=i.window}else A=f,P=v-i.offset,T=i.length;for(y<T&&(T=y),y-=T,i.length-=T;f[v++]=A[P++],--T;);0===i.length&&(i.mode=21);break;case 26:if(0===y)break t;f[v++]=i.length,y--,i.mode=21;break;case 27:if(i.wrap){for(;b<32;){if(0===_)break t;_--,w|=p[g++]<<b,b+=8}if(S-=y,t.total_out+=S,i.total+=S,S&&(t.adler=i.check=i.flags?r(i.check,f,S,v-S):n(i.check,f,S,v-S)),S=y,(i.flags?w:m(w))!==i.check){t.msg="incorrect data check",i.mode=30;break}b=w=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;b<32;){if(0===_)break t;_--,w+=p[g++]<<b,b+=8}if(w!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=30;break}b=w=0}i.mode=29;case 29:N=1;break t;case 30:N=-3;break t;case 31:return-4;default:return d}return t.next_out=v,t.avail_out=y,t.next_in=g,t.avail_in=_,i.hold=w,i.bits=b,(i.wsize||S!==t.avail_out&&i.mode<30&&(i.mode<27||4!==e))&&C(t,t.output,t.next_out,S-t.avail_out)?(i.mode=31,-4):(x-=t.avail_in,S-=t.avail_out,t.total_in+=x,t.total_out+=S,i.total+=S,i.wrap&&S&&(t.adler=i.check=i.flags?r(i.check,f,S,t.next_out-S):n(i.check,f,S,t.next_out-S)),t.data_type=i.bits+(i.last?64:0)+(12===i.mode?128:0)+(20===i.mode||15===i.mode?256:0),(0==x&&0===S||4===e)&&N===c&&(N=-5),N)},i.inflateEnd=function(t){if(!t||!t.state)return d;var e=t.state;return e.window&&(e.window=null),t.state=null,c},i.inflateGetHeader=function(t,e){var i;return t&&t.state&&2&(i=t.state).wrap?((i.head=e).done=!1,c):d},i.inflateSetDictionary=function(t,e){var i,s=e.length;return t&&t.state?0!==(i=t.state).wrap&&11!==i.mode?d:11===i.mode&&n(1,e,s,0)!==i.check?-3:C(t,e,s,s)?(i.mode=31,-4):(i.havedict=1,c):d},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,e,i){var s=t("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],a=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(t,e,i,l,h,c,d,u){var p,f,m,g,v,_,y,w,b,x=u.bits,S=0,E=0,C=0,T=0,P=0,A=0,M=0,O=0,D=0,z=0,I=null,k=0,L=new s.Buf16(16),N=new s.Buf16(16),B=null,U=0;for(S=0;S<=15;S++)L[S]=0;for(E=0;E<l;E++)L[e[i+E]]++;for(P=x,T=15;1<=T&&0===L[T];T--);if(T<P&&(P=T),0===T)return h[c++]=20971520,h[c++]=20971520,u.bits=1,0;for(C=1;C<T&&0===L[C];C++);for(P<C&&(P=C),S=O=1;S<=15;S++)if(O<<=1,(O-=L[S])<0)return-1;if(0<O&&(0===t||1!==T))return-1;for(N[1]=0,S=1;S<15;S++)N[S+1]=N[S]+L[S];for(E=0;E<l;E++)0!==e[i+E]&&(d[N[e[i+E]]++]=E);if(_=0===t?(I=B=d,19):1===t?(I=n,k-=257,B=r,U-=257,256):(I=o,B=a,-1),S=C,v=c,M=E=z=0,m=-1,g=(D=1<<(A=P))-1,1===t&&852<D||2===t&&592<D)return 1;for(;;){for(y=S-M,b=d[E]<_?(w=0,d[E]):d[E]>_?(w=B[U+d[E]],I[k+d[E]]):(w=96,0),p=1<<S-M,C=f=1<<A;h[v+(z>>M)+(f-=p)]=y<<24|w<<16|b,0!==f;);for(p=1<<S-1;z&p;)p>>=1;if(0!==p?(z&=p-1,z+=p):z=0,E++,0==--L[S]){if(S===T)break;S=e[i+d[E]]}if(P<S&&(z&g)!==m){for(0===M&&(M=P),v+=C,O=1<<(A=S-M);A+M<T&&!((O-=L[A+M])<=0);)A++,O<<=1;if(D+=1<<A,1===t&&852<D||2===t&&592<D)return 1;h[m=z&g]=P<<24|A<<16|v-c}}return 0!==z&&(h[v+z]=S-M<<24|64<<16),u.bits=P,0}},{"../utils/common":41}],51:[function(t,e,i){e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,e,i){var s=t("../utils/common"),n=0,r=1;function o(t){for(var e=t.length;0<=--e;)t[e]=0}var a=0,l=29,h=256,c=h+1+l,d=30,u=19,p=2*c+1,f=15,m=16,g=7,v=256,_=16,y=17,w=18,b=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],x=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],S=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],E=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],C=new Array(2*(c+2));o(C);var T=new Array(2*d);o(T);var P=new Array(512);o(P);var A=new Array(256);o(A);var M=new Array(l);o(M);var O,D,z,I=new Array(d);function k(t,e,i,s,n){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=s,this.max_length=n,this.has_stree=t&&t.length}function L(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}function N(t){return t<256?P[t]:P[256+(t>>>7)]}function B(t,e){t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255}function U(t,e,i){t.bi_valid>m-i?(t.bi_buf|=e<<t.bi_valid&65535,B(t,t.bi_buf),t.bi_buf=e>>m-t.bi_valid,t.bi_valid+=i-m):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)}function R(t,e,i){U(t,i[2*e],i[2*e+1])}function F(t,e){for(var i=0;i|=1&t,t>>>=1,i<<=1,0<--e;);return i>>>1}function V(t,e,i){var s,n,r=new Array(f+1),o=0;for(s=1;s<=f;s++)r[s]=o=o+i[s-1]<<1;for(n=0;n<=e;n++){var a=t[2*n+1];0!==a&&(t[2*n]=F(r[a]++,a))}}function j(t){var e;for(e=0;e<c;e++)t.dyn_ltree[2*e]=0;for(e=0;e<d;e++)t.dyn_dtree[2*e]=0;for(e=0;e<u;e++)t.bl_tree[2*e]=0;t.dyn_ltree[2*v]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0}function H(t){8<t.bi_valid?B(t,t.bi_buf):0<t.bi_valid&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0}function W(t,e,i,s){var n=2*e,r=2*i;return t[n]<t[r]||t[n]===t[r]&&s[e]<=s[i]}function G(t,e,i){for(var s=t.heap[i],n=i<<1;n<=t.heap_len&&(n<t.heap_len&&W(e,t.heap[n+1],t.heap[n],t.depth)&&n++,!W(e,s,t.heap[n],t.depth));)t.heap[i]=t.heap[n],i=n,n<<=1;t.heap[i]=s}function Z(t,e,i){var s,n,r,o,a=0;if(0!==t.last_lit)for(;s=t.pending_buf[t.d_buf+2*a]<<8|t.pending_buf[t.d_buf+2*a+1],n=t.pending_buf[t.l_buf+a],a++,0===s?R(t,n,e):(R(t,(r=A[n])+h+1,e),0!==(o=b[r])&&U(t,n-=M[r],o),R(t,r=N(--s),i),0!==(o=x[r])&&U(t,s-=I[r],o)),a<t.last_lit;);R(t,v,e)}function Y(t,e){var i,s,n,r=e.dyn_tree,o=e.stat_desc.static_tree,a=e.stat_desc.has_stree,l=e.stat_desc.elems,h=-1;for(t.heap_len=0,t.heap_max=p,i=0;i<l;i++)0!==r[2*i]?(t.heap[++t.heap_len]=h=i,t.depth[i]=0):r[2*i+1]=0;for(;t.heap_len<2;)r[2*(n=t.heap[++t.heap_len]=h<2?++h:0)]=1,t.depth[n]=0,t.opt_len--,a&&(t.static_len-=o[2*n+1]);for(e.max_code=h,i=t.heap_len>>1;1<=i;i--)G(t,r,i);for(n=l;i=t.heap[1],t.heap[1]=t.heap[t.heap_len--],G(t,r,1),s=t.heap[1],t.heap[--t.heap_max]=i,t.heap[--t.heap_max]=s,r[2*n]=r[2*i]+r[2*s],t.depth[n]=(t.depth[i]>=t.depth[s]?t.depth[i]:t.depth[s])+1,r[2*i+1]=r[2*s+1]=n,t.heap[1]=n++,G(t,r,1),2<=t.heap_len;);t.heap[--t.heap_max]=t.heap[1],function(t,e){var i,s,n,r,o,a,l=e.dyn_tree,h=e.max_code,c=e.stat_desc.static_tree,d=e.stat_desc.has_stree,u=e.stat_desc.extra_bits,m=e.stat_desc.extra_base,g=e.stat_desc.max_length,v=0;for(r=0;r<=f;r++)t.bl_count[r]=0;for(l[2*t.heap[t.heap_max]+1]=0,i=t.heap_max+1;i<p;i++)g<(r=l[2*l[2*(s=t.heap[i])+1]+1]+1)&&(r=g,v++),l[2*s+1]=r,h<s||(t.bl_count[r]++,o=0,m<=s&&(o=u[s-m]),a=l[2*s],t.opt_len+=a*(r+o),d&&(t.static_len+=a*(c[2*s+1]+o)));if(0!==v){do{for(r=g-1;0===t.bl_count[r];)r--;t.bl_count[r]--,t.bl_count[r+1]+=2,t.bl_count[g]--,v-=2}while(0<v);for(r=g;0!==r;r--)for(s=t.bl_count[r];0!==s;)h<(n=t.heap[--i])||(l[2*n+1]!==r&&(t.opt_len+=(r-l[2*n+1])*l[2*n],l[2*n+1]=r),s--)}}(t,e),V(r,h,t.bl_count)}function X(t,e,i){var s,n,r=-1,o=e[1],a=0,l=7,h=4;for(0===o&&(l=138,h=3),e[2*(i+1)+1]=65535,s=0;s<=i;s++)n=o,o=e[2*(s+1)+1],++a<l&&n===o||(a<h?t.bl_tree[2*n]+=a:0!==n?(n!==r&&t.bl_tree[2*n]++,t.bl_tree[2*_]++):a<=10?t.bl_tree[2*y]++:t.bl_tree[2*w]++,r=n,h=(a=0)===o?(l=138,3):n===o?(l=6,3):(l=7,4))}function q(t,e,i){var s,n,r=-1,o=e[1],a=0,l=7,h=4;for(0===o&&(l=138,h=3),s=0;s<=i;s++)if(n=o,o=e[2*(s+1)+1],!(++a<l&&n===o)){if(a<h)for(;R(t,n,t.bl_tree),0!=--a;);else 0!==n?(n!==r&&(R(t,n,t.bl_tree),a--),R(t,_,t.bl_tree),U(t,a-3,2)):a<=10?(R(t,y,t.bl_tree),U(t,a-3,3)):(R(t,w,t.bl_tree),U(t,a-11,7));r=n,h=(a=0)===o?(l=138,3):n===o?(l=6,3):(l=7,4)}}o(I);var Q=!1;function K(t,e,i,n){var r,o,l;U(t,(a<<1)+(n?1:0),3),o=e,l=i,H(r=t),B(r,l),B(r,~l),s.arraySet(r.pending_buf,r.window,o,l,r.pending),r.pending+=l}i._tr_init=function(t){Q||(function(){var t,e,i,s,n,r=new Array(f+1);for(s=i=0;s<l-1;s++)for(M[s]=i,t=0;t<1<<b[s];t++)A[i++]=s;for(A[i-1]=s,s=n=0;s<16;s++)for(I[s]=n,t=0;t<1<<x[s];t++)P[n++]=s;for(n>>=7;s<d;s++)for(I[s]=n<<7,t=0;t<1<<x[s]-7;t++)P[256+n++]=s;for(e=0;e<=f;e++)r[e]=0;for(t=0;t<=143;)C[2*t+1]=8,t++,r[8]++;for(;t<=255;)C[2*t+1]=9,t++,r[9]++;for(;t<=279;)C[2*t+1]=7,t++,r[7]++;for(;t<=287;)C[2*t+1]=8,t++,r[8]++;for(V(C,c+1,r),t=0;t<d;t++)T[2*t+1]=5,T[2*t]=F(t,5);O=new k(C,b,h+1,c,f),D=new k(T,x,0,d,f),z=new k(new Array(0),S,0,u,g)}(),Q=!0),t.l_desc=new L(t.dyn_ltree,O),t.d_desc=new L(t.dyn_dtree,D),t.bl_desc=new L(t.bl_tree,z),t.bi_buf=0,t.bi_valid=0,j(t)},i._tr_stored_block=K,i._tr_flush_block=function(t,e,i,s){var o,a,l=0;0<t.level?(2===t.strm.data_type&&(t.strm.data_type=function(t){var e,i=4093624447;for(e=0;e<=31;e++,i>>>=1)if(1&i&&0!==t.dyn_ltree[2*e])return n;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return r;for(e=32;e<h;e++)if(0!==t.dyn_ltree[2*e])return r;return n}(t)),Y(t,t.l_desc),Y(t,t.d_desc),l=function(t){var e;for(X(t,t.dyn_ltree,t.l_desc.max_code),X(t,t.dyn_dtree,t.d_desc.max_code),Y(t,t.bl_desc),e=u-1;3<=e&&0===t.bl_tree[2*E[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e}(t),o=t.opt_len+3+7>>>3,(a=t.static_len+3+7>>>3)<=o&&(o=a)):o=a=i+5,i+4<=o&&-1!==e?K(t,e,i,s):4===t.strategy||a===o?(U(t,2+(s?1:0),3),Z(t,C,T)):(U(t,4+(s?1:0),3),function(t,e,i,s){var n;for(U(t,e-257,5),U(t,i-1,5),U(t,s-4,4),n=0;n<s;n++)U(t,t.bl_tree[2*E[n]+1],3);q(t,t.dyn_ltree,e-1),q(t,t.dyn_dtree,i-1)}(t,t.l_desc.max_code+1,t.d_desc.max_code+1,l+1),Z(t,t.dyn_ltree,t.dyn_dtree)),j(t),s&&H(t)},i._tr_tally=function(t,e,i){return t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&i,t.last_lit++,0===e?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(A[i]+h+1)]++,t.dyn_dtree[2*N(e)]++),t.last_lit===t.lit_bufsize-1},i._tr_align=function(t){var e;U(t,2,3),R(t,v,C),16===(e=t).bi_valid?(B(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):8<=e.bi_valid&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}},{"../utils/common":41}],53:[function(t,e,i){e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,e,i){(function(t){!function(t,e){if(!t.setImmediate){var i,s,n,r,o=1,a={},l=!1,h=t.document,c=Object.getPrototypeOf&&Object.getPrototypeOf(t);c=c&&c.setTimeout?c:t,i="[object process]"==={}.toString.call(t.process)?function(t){process.nextTick(function(){u(t)})}:function(){if(t.postMessage&&!t.importScripts){var e=!0,i=t.onmessage;return t.onmessage=function(){e=!1},t.postMessage("","*"),t.onmessage=i,e}}()?(r="setImmediate$"+Math.random()+"$",t.addEventListener?t.addEventListener("message",p,!1):t.attachEvent("onmessage",p),function(e){t.postMessage(r+e,"*")}):t.MessageChannel?((n=new MessageChannel).port1.onmessage=function(t){u(t.data)},function(t){n.port2.postMessage(t)}):h&&"onreadystatechange"in h.createElement("script")?(s=h.documentElement,function(t){var e=h.createElement("script");e.onreadystatechange=function(){u(t),e.onreadystatechange=null,s.removeChild(e),e=null},s.appendChild(e)}):function(t){setTimeout(u,0,t)},c.setImmediate=function(t){"function"!=typeof t&&(t=new Function(""+t));for(var e=new Array(arguments.length-1),s=0;s<e.length;s++)e[s]=arguments[s+1];var n={callback:t,args:e};return a[o]=n,i(o),o++},c.clearImmediate=d}function d(t){delete a[t]}function u(t){if(l)setTimeout(u,0,t);else{var i=a[t];if(i){l=!0;try{!function(t){var i=t.callback,s=t.args;switch(s.length){case 0:i();break;case 1:i(s[0]);break;case 2:i(s[0],s[1]);break;case 3:i(s[0],s[1],s[2]);break;default:i.apply(e,s)}}(i)}finally{d(t),l=!1}}}}function p(e){e.source===t&&"string"==typeof e.data&&0===e.data.indexOf(r)&&u(+e.data.slice(r.length))}}(typeof self>"u"?void 0===t?this:t:self)}).call(this,typeof Ut<"u"?Ut:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10));class _o{constructor(t,e){Pt(this,"date",new Date),Pt(this,"author"),Pt(this,"guid",Bt.create()),Pt(this,"viewpoint"),Pt(this,"modifiedAuthor"),Pt(this,"modifiedDate"),Pt(this,"topic"),Pt(this,"_components"),Pt(this,"_comment",""),this._components=t,this._comment=e;const i=this._components.get(So);this.author=i.config.author}set comment(t){var e;const i=this._components.get(So);this._comment=t,this.modifiedDate=new Date,this.modifiedAuthor=i.config.author,null==(e=this.topic)||e.comments.set(this.guid,this)}get comment(){return this._comment}toJSON(){var t,e;const i={guid:this.guid,date:this.date.toISOString(),author:this.author,comment:this.comment,topic_guid:null==(t=this.topic)?void 0:t.guid,viewpoint_guid:this.viewpoint,modified_date:null==(e=this.modifiedDate)?void 0:e.toISOString(),modified_author:this.modifiedAuthor};for(const[t,e]of Object.entries(i))void 0===e&&delete i[t];return i}}const yo=class t{constructor(e){Pt(this,"guid",Bt.create()),Pt(this,"title",t.default.title),Pt(this,"creationDate",new Date),Pt(this,"creationAuthor",""),Pt(this,"viewpoints",new n),Pt(this,"relatedTopics",new n),Pt(this,"comments",new s),Pt(this,"documentReferences",new n),Pt(this,"customData",{}),Pt(this,"description"),Pt(this,"serverAssignedId"),Pt(this,"dueDate"),Pt(this,"modifiedAuthor"),Pt(this,"modifiedDate"),Pt(this,"index"),Pt(this,"_type",t.default.type),Pt(this,"_status",t.default.status),Pt(this,"_priority",t.default.priority),Pt(this,"_stage",t.default.stage),Pt(this,"_assignedTo",t.default.assignedTo),Pt(this,"_labels",t.default.labels??new Set),Pt(this,"_components"),this._components=e;const i=e.get(So);this.creationAuthor=i.config.author,this.relatedTopics.guard=t=>t!==this.guid}set type(t){const e=this._components.get(So),{strict:i,types:s}=e.config;(!i||s.has(t))&&(this._type=t)}get type(){return this._type}set status(t){const e=this._components.get(So),{strict:i,statuses:s}=e.config;(!i||s.has(t))&&(this._status=t)}get status(){return this._status}set priority(t){const e=this._components.get(So);if(t){const{strict:i,priorities:s}=e.config;if(i&&!s.has(t))return;this._priority=t}else this._priority=t}get priority(){return this._priority}set stage(t){const e=this._components.get(So);if(t){const{strict:i,stages:s}=e.config;if(i&&!s.has(t))return;this._stage=t}else this._stage=t}get stage(){return this._stage}set assignedTo(t){const e=this._components.get(So);if(t){const{strict:i,users:s}=e.config;if(i&&!s.has(t))return;this._assignedTo=t}else this._assignedTo=t}get assignedTo(){return this._assignedTo}set labels(t){const e=this._components.get(So),{strict:i,labels:s}=e.config;if(i){const e=new Set;for(const n of t)(!i||s.has(n))&&e.add(n);this._labels=e}else this._labels=t}get labels(){return this._labels}get _managerVersion(){return this._components.get(So).config.version}set(t){const e=t,i=this;for(const s in t){if("guid"===s)continue;const t=e[s];s in this&&(i[s]=t)}return this._components.get(So).list.set(this.guid,this),this}createComment(t,e){const i=new _o(this._components,t);return i.viewpoint=e,i.topic=this,this.comments.set(i.guid,i),i}createLabelTags(){const t=[...this.labels];if(this._components.get(So).config.exportCustomDataAsLabels)for(const e in this.customData){const i=this.customData[e];"string"==typeof i&&t.push(i)}return t}createCommentTags(){return[...this.comments.values()].map(t=>{var e;return{$Guid:t.guid,Date:t.date.toISOString(),Author:t.author,Comment:t.comment,ModifiedAuthor:t.modifiedAuthor,ModifiedDate:null==(e=t.modifiedDate)?void 0:e.toISOString(),Viewpoint:t.viewpoint?{$Guid:t.viewpoint}:void 0}})}createViewpointTags(){const t=this._components.get(ca);return[...this.viewpoints].map(e=>t.list.get(e)).filter(t=>t).map(e=>{const i={$Guid:e.guid,Viewpoint:`${e.title??e.guid}.bcfv`};if(t.snapshots.get(e.snapshot)){const s=t.getSnapshotExtension(e.snapshot);i.Snapshot=`${e.snapshot}.${s}`}return i})}createRelatedTopicTags(){return[...this.relatedTopics].map(t=>({$Guid:t}))}createDocumentReferencesTag(t=this._managerVersion){const e=[];if("3"!==t&&"2.1"!==t)return e;const i=this._components.get(So);for(const s of this.documentReferences){const n=i.documents.get(s);if(!n)continue;let r={$Guid:Bt.create(),Description:n.description};"2.1"===t&&(r={...r,$isExternal:"external"===n.type||void 0,ReferencedDocument:"external"===n.type?n.url:`../${n.fileName}`}),"3"===t&&(r={...r,DocumentGuid:"internal"===n.type?s:void 0,Url:"external"===n.type?n.url:void 0}),Object.keys(r).length>0&&e.push(r)}return e}toJSON(){var t,e;const i={guid:this.guid,server_assigned_id:this.serverAssignedId,topic_type:this.type,topic_status:this.status,title:this.title,priority:this.priority,index:this.index,labels:[...this.labels],creation_date:this.creationDate.toISOString(),creation_author:this.creationAuthor,modified_date:null==(t=this.modifiedDate)?void 0:t.toISOString(),modified_author:this.modifiedAuthor,assigned_to:this.assignedTo,stage:this.stage,description:this.description,due_date:null==(e=this.dueDate)?void 0:e.toISOString(),comments:[...this.comments].map(([t,e])=>e.toJSON()),relatedTopics:[...this.relatedTopics].map(t=>({related_topic_guid:t}))},s=this._components.get(ca);for(const t of this.viewpoints){const e=s.list.get(t);e&&(i.viewpoints||(i.viewpoints=[]),i.viewpoints.push(e.toJSON()))}const n=this._components.get(So);for(const t of this.documentReferences){const e=n.documents.get(t);e&&(i.document_references||(i.document_references=[]),"external"===e.type?i.document_references.push({guid:Bt.create(),description:e.description,url:e.url}):i.document_references.push({guid:Bt.create(),description:e.description,document_guid:t}))}for(const[t,e]of Object.entries(i))(void 0===e||Array.isArray(e)&&0===e.length)&&delete i[t];return i}serialize(){var t,e;const i=this._managerVersion,s={$Guid:this.guid,$TopicType:this.type,$TopicStatus:this.status,$ServerAssignedId:this.serverAssignedId,Title:this.title,CreationAuthor:this.creationAuthor,CreationDate:this.creationDate.toISOString(),Priority:this.priority,Index:"2.1"===i?this.index:void 0,ModifiedDate:null==(t=this.modifiedDate)?void 0:t.toISOString(),ModifiedAuthor:this.modifiedAuthor,DueDate:null==(e=this.dueDate)?void 0:e.toISOString(),AssignedTo:this.assignedTo,Description:this.description,Stage:this.stage,DocumentReferences:"3"===i?{DocumentReference:this.createDocumentReferencesTag(i)}:void 0,RelatedTopics:"3"===i?{RelatedTopic:this.createRelatedTopicTags()}:void 0,RelatedTopic:"2.1"===i?this.createRelatedTopicTags():void 0,Labels:"3"===i?{Label:this.createLabelTags()}:void 0,Viewpoints:"3"===i?{ViewPoint:this.createViewpointTags()}:void 0,Comments:"3"===i?{Comment:this.createCommentTags()}:void 0};"2.1"===i&&(s.Labels=this.createLabelTags(),s.DocumentReference=this.createDocumentReferencesTag(i));const n={Markup:{Topic:s}};return"2.1"===i&&(n.Markup.Viewpoints=this.createViewpointTags(),n.Markup.Comment=this.createCommentTags()),`<?xml version="1.0" encoding="UTF-8"?>\n    ${ni.builder.build(n)}`}};Pt(yo,"default",{title:"BCF Topic",type:"Issue",status:"Active"});let wo=yo;class bo extends li{constructor(){super(...arguments),Pt(this,"_config",{version:{type:"Select",options:new Set(["2.1","3"]),multiple:!1,value:""},author:{type:"Text",value:""},types:{type:"TextSet",value:new Set},statuses:{type:"TextSet",value:new Set},priorities:{type:"TextSet",value:new Set},labels:{type:"TextSet",value:new Set},stages:{type:"TextSet",value:new Set},users:{type:"TextSet",value:new Set},includeSelectionTag:{type:"Boolean",value:!1},updateExtensionsOnImport:{type:"Boolean",value:!1},strict:{type:"Boolean",value:!1},includeAllExtensionsOnExport:{type:"Boolean",value:!1},fallbackVersionOnImport:{type:"Select",multiple:!1,options:new Set(["2.1","3"]),value:""},ignoreIncompleteTopicsOnImport:{type:"Boolean",value:!1},exportCustomDataAsLabels:{type:"Boolean",value:!1}})}get version(){return this._config.version.value}set version(t){this._config.version.value=t}get author(){return this._config.author.value}set author(t){this._config.author.value=t}get types(){return this._config.types.value}set types(t){this._config.types.value=t}get statuses(){return this._config.statuses.value}set statuses(t){this._config.statuses.value=t}get priorities(){return this._config.priorities.value}set priorities(t){this._config.priorities.value=t}get labels(){return this._config.labels.value}set labels(t){this._config.labels.value=t}get stages(){return this._config.stages.value}set stages(t){this._config.stages.value=t}get users(){return this._config.users.value}set users(t){this._config.users.value=t}get includeSelectionTag(){return this._config.includeSelectionTag.value}set includeSelectionTag(t){this._config.includeSelectionTag.value=t}get updateExtensionsOnImport(){return this._config.updateExtensionsOnImport.value}set updateExtensionsOnImport(t){this._config.updateExtensionsOnImport.value=t}get strict(){return this._config.strict.value}set strict(t){this._config.strict.value=t}get includeAllExtensionsOnExport(){return this._config.includeAllExtensionsOnExport.value}set includeAllExtensionsOnExport(t){this._config.includeAllExtensionsOnExport.value=t}get fallbackVersionOnImport(){return this._config.fallbackVersionOnImport.value}set fallbackVersionOnImport(t){this._config.fallbackVersionOnImport.value=t}get ignoreIncompleteTopicsOnImport(){return this._config.ignoreIncompleteTopicsOnImport.value}set ignoreIncompleteTopicsOnImport(t){this._config.ignoreIncompleteTopicsOnImport.value=t}get exportCustomDataAsLabels(){return this._config.exportCustomDataAsLabels.value}set exportCustomDataAsLabels(t){this._config.exportCustomDataAsLabels.value=t}}const xo=class t extends Ot{constructor(){super(...arguments),Pt(this,"enabled",!1),Pt(this,"_defaultConfig",{author:"jhon.doe@example.com",version:"2.1",types:new Set(["Clash","Failure","Fault","Inquiry","Issue","Remark","Request"]),statuses:new Set(["Active","In Progress","Done","In Review","Closed"]),priorities:new Set(["On hold","Minor","Normal","Major","Critical"]),labels:new Set,stages:new Set,users:new Set,includeSelectionTag:!1,updateExtensionsOnImport:!0,strict:!1,includeAllExtensionsOnExport:!0,fallbackVersionOnImport:"2.1",ignoreIncompleteTopicsOnImport:!1,exportCustomDataAsLabels:!1}),Pt(this,"config",new bo(this,this.components,"BCF Topics",t.uuid)),Pt(this,"list",new s),Pt(this,"documents",new s),Pt(this,"onSetup",new At),Pt(this,"isSetup",!1),Pt(this,"onBCFImported",new At),Pt(this,"onDisposed",new At)}setup(t){if(this.isSetup)return;const e={...this._defaultConfig,...t};this.config.version=e.version,this.config.author=e.author,this.config.types=e.types,this.config.statuses=e.statuses,this.config.priorities=e.priorities,this.config.labels=e.labels,this.config.stages=e.stages,this.config.users=e.users,this.config.includeSelectionTag=e.includeSelectionTag,this.config.updateExtensionsOnImport=e.updateExtensionsOnImport,this.config.strict=e.strict,this.config.includeAllExtensionsOnExport=e.includeAllExtensionsOnExport,this.config.fallbackVersionOnImport=e.fallbackVersionOnImport||"",this.config.ignoreIncompleteTopicsOnImport=e.ignoreIncompleteTopicsOnImport,this.isSetup=!0,this.enabled=!0,this.onSetup.trigger()}create(t){const e=new wo(this.components);return t?(e.guid=t.guid??e.guid,e.set(t)):this.list.set(e.guid,e),e}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}get usedTypes(){const t=[...this.list].map(([t,e])=>e.type);return new Set(t)}get usedStatuses(){const t=[...this.list].map(([t,e])=>e.status);return new Set(t)}get usedPriorities(){const t=[...this.list].map(([t,e])=>e.priority).filter(t=>t);return new Set(t)}get usedStages(){const t=[...this.list].map(([t,e])=>e.stage).filter(t=>t);return new Set(t)}get usedUsers(){const t=[];for(const[e,i]of this.list){t.push(i.creationAuthor),i.assignedTo&&t.push(i.assignedTo),i.modifiedAuthor&&t.push(i.modifiedAuthor);for(const[e,s]of i.comments)t.push(s.author),s.modifiedAuthor&&t.push(s.modifiedAuthor)}return new Set(t)}get usedLabels(){const t=[];for(const[e,i]of this.list)t.push(...i.labels);return new Set(t)}updateExtensions(){for(const[t,e]of this.list){for(const t of e.labels)this.config.labels.add(t);this.config.types.add(e.type),e.priority&&this.config.priorities.add(e.priority),e.stage&&this.config.stages.add(e.stage),this.config.statuses.add(e.status),this.config.users.add(e.creationAuthor),e.assignedTo&&this.config.users.add(e.assignedTo),e.modifiedAuthor&&this.config.users.add(e.modifiedAuthor);for(const[t,i]of e.comments)this.config.users.add(i.author),i.modifiedAuthor&&this.config.users.add(i.modifiedAuthor)}}updateViewpointReferences(){const t=this.components.get(ca);for(const[e,i]of this.list)for(const e of i.viewpoints)t.list.has(e)||i.viewpoints.delete(e)}async export(t=this.list.values()){const e=new vo;e.file("bcf.version",`<?xml version="1.0" encoding="UTF-8"?>\n    <Version VersionId="${this.config.version}" xsi:noNamespaceSchemaLocation="https://raw.githubusercontent.com/buildingSMART/BCF-XML/release_3_0/Schemas/version.xsd"\n    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n    </Version>`);for(const[t,i]of this.documents.entries())"external"!==i.type&&e.file("2.1"===this.config.version?i.fileName:`documents/${t}`,i.data);if("3"===this.config.version){const t=[];for(const[e,i]of this.documents.entries()){const{type:s,description:n}=i;"external"!==s&&t.push(`<Document Guid="${e}">\n        <Filename>${i.fileName}</Filename>\n        ${n?`<Description>${n}</Description>`:""}\n      </Document>`)}t.length>0&&e.file("documents.xml",`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n  <DocumentInfo xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="documents.xsd">\n    <Documents>\n      ${t.join("\n")}\n    </Documents>\n  </DocumentInfo>`)}e.file("bcf.extensions",this.serializeExtensions());const i=this.components.get(ca);for(const s of t){const t=e.folder(s.guid);t.file("markup.bcf",s.serialize());for(const e of s.viewpoints){const s=i.list.get(e);if(!s)continue;const n=s.title??s.guid;t.file(`${n}.bcfv`,await s.serialize());const r=i.snapshots.get(s.snapshot);if(!r)continue;const o=r?s.snapshot:s.guid,a=i.getSnapshotExtension(s.snapshot);t.file(`${o}.${a}`,r,{binary:!0})}}return await e.generateAsync({type:"blob"})}serializeExtensions(){const t=[...this.config.types].map(t=>`<TopicType>${t}</TopicType>`).join("\n"),e=[...this.config.statuses].map(t=>`<TopicStatus>${t}</TopicStatus>`).join("\n"),i=[...this.config.priorities].map(t=>`<Priority>${t}</Priority>`).join("\n"),s=[...this.config.labels].map(t=>`<TopicLabel>${t}</TopicLabel>`).join("\n"),n=[...this.config.stages].map(t=>`<Stage>${t}</Stage>`).join("\n"),r=[...this.config.users].map(t=>`<User>${t}</User>`).join("\n");return`\n      <?xml version="1.0" encoding="UTF-8"?>\n      <Extensions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="your-schema-location.xsd">\n        ${0!==t.length?`<TopicTypes>\n${t}\n</TopicTypes>`:""}\n        ${0!==e.length?`<TopicStatuses>\n${e}\n</TopicStatuses>`:""}\n        ${0!==i.length?`<Priorities>\n${i}\n</Priorities>`:""}\n        ${0!==s.length?`<TopicLabels>\n${s}\n</TopicLabels>`:""}\n        ${0!==n.length?`<Stages>\n${n}\n</Stages>`:""}\n        ${0!==r.length?`<Users>\n${r}\n</Users>`:""}\n      </Extensions>\n    `}processMarkupComment(t){const{Guid:e,Date:i,Author:s,Comment:n,Viewpoint:r}=t;if(!(e&&i&&s&&(_o||r)))return null;const o=new _o(this.components,n??"");return o.guid=e,o.date=new Date(i),o.author=s,o.viewpoint=null==r?void 0:r.Guid,o.modifiedAuthor=t.ModifiedAuthor,o.modifiedDate=t.ModifiedDate?new Date(t.ModifiedDate):void 0,o}getMarkupComments(t,e){var i;let s;if("2.1"===e&&(s=t.Comment),"3"===e&&(s=null==(i=t.Topic.Comments)?void 0:i.Comment),!s)return[];s=Array.isArray(s)?s:[s];const n=s.map(t=>this.processMarkupComment(t)).filter(t=>t);return Array.isArray(n)?n:[n]}getMarkupLabels(t,e){var i;let s;return"2.1"===e&&(s=t.Topic.Labels),"3"===e&&(s=null==(i=t.Topic.Labels)?void 0:i.Label),s?Array.isArray(s)?s:[s]:[]}getMarkupViewpoints(t,e){var i;let s;return"2.1"===e&&(s=t.Viewpoints),"3"===e&&(s=null==(i=t.Topic.Viewpoints)?void 0:i.ViewPoint),s?(s=Array.isArray(s)?s:[s],s):[]}getMarkupRelatedTopics(t,e){var i;let s;return"2.1"===e&&(s=t.Topic.RelatedTopic),"3"===e&&(s=null==(i=t.Topic.RelatedTopics)?void 0:i.RelatedTopic),s?(Array.isArray(s)?s:[s]).map(t=>t.Guid):[]}getMarkupDocumentReferences(t,e){var i;let s;return"2.1"===e&&(s=t.Topic.DocumentReference),"3"===e&&(s=null==(i=t.Topic.DocumentReferences)?void 0:i.DocumentReference),s?Array.isArray(s)?s:[s]:[]}async load(e){var i,s,n;const{fallbackVersionOnImport:r,ignoreIncompleteTopicsOnImport:a,updateExtensionsOnImport:l}=this.config,h=new vo;await h.loadAsync(e);const c=Object.values(h.files);let d=r;const u=c.find(t=>t.name.endsWith(".version"));if(u){const e=await u.async("string"),i=t.xmlParser.parse(e).Version.VersionId;d=String(i)}if(!d||"2.1"!==d&&"3"!==d)throw new Error(`BCFTopics: ${d} is not supported.`);const p=c.find(t=>t.name.endsWith(".extensions"));if(l&&p){((t,e)=>{if(""===e.trim())return;const i=So.xmlParser.parse(e).Extensions;if(!i)return;const{Priorities:s,TopicStatuses:n,TopicTypes:r,Users:o}=i;if(s&&s.Priority){const e=Array.isArray(s.Priority)?s.Priority:[s.Priority];for(const i of e)t.config.priorities.add(i)}if(n&&n.TopicStatus){const e=Array.isArray(n.TopicStatus)?n.TopicStatus:[n.TopicStatus];for(const i of e)t.config.statuses.add(i)}if(r&&r.TopicType){const e=Array.isArray(r.TopicType)?r.TopicType:[r.TopicType];for(const i of e)t.config.types.add(i)}if(o&&o.User){const e=Array.isArray(o.User)?o.User:[o.User];for(const i of e)t.config.users.add(i)}})(this,await p.async("string"))}const f=[],m=this.components.get(ca),g=c.filter(t=>t.name.endsWith(".bcfv"));for(const e of g){const s=await e.async("string"),n=t.xmlParser.parse(s).VisualizationInfo;if(!n){console.warn("Missing VisualizationInfo in Viewpoint");continue}const r={},{Guid:a,ClippingPlanes:l,Components:h,OrthogonalCamera:c,PerspectiveCamera:u}=n;if(a&&(r.guid=a),h){const t={selection:[],coloring:[],visibility:{default_visibility:!1,exceptions:[],view_setup_hints:{spaces_visible:!1,space_boundaries_visible:!1,openings_visible:!1}}};r.components=t;const{Selection:e,Visibility:s}=h;if(e&&e.Component){const i=Array.isArray(e.Component)?e.Component:[e.Component];t.selection=i.map(t=>t.IfcGuid?{ifc_guid:t.IfcGuid}:null).filter(t=>null!==t)}if(s&&"DefaultVisibility"in s&&(t.visibility.default_visibility=s.DefaultVisibility),s&&s.Exceptions&&"Component"in s.Exceptions){const{Component:e}=s.Exceptions,i=Array.isArray(e)?e:[e];t.visibility.exceptions=i.map(t=>t.IfcGuid?{ifc_guid:t.IfcGuid}:null).filter(t=>null!==t)}let n;"2.1"===d&&(n=h.ViewSetupHints),"3"===d&&(n=null==(i=h.Visibility)?void 0:i.ViewSetupHints),n&&("OpeningsVisible"in n&&(t.visibility.view_setup_hints.openings_visible=n.OpeningsVisible),"SpacesVisible"in n&&(t.visibility.view_setup_hints.spaces_visible=n.SpacesVisible),"SpaceBoundariesVisible"in n&&(t.visibility.view_setup_hints.space_boundaries_visible=n.SpaceBoundariesVisible));const{Coloring:o}=h;if(o&&o.Color){const e=Array.isArray(o.Color)?o.Color:[o.Color];for(const i of e){const{Color:e,Component:s}=i;if(6!==e.length&&8!==e.length)continue;const n=6===e.length?e:e.slice(2),r=(Array.isArray(s)?s:[s]).map(t=>t.IfcGuid?{ifc_guid:t.IfcGuid}:null).filter(t=>null!==t);t.coloring.push({color:n,components:r})}}}if(c||u){const t=n.PerspectiveCamera??n.OrthogonalCamera,{CameraViewPoint:e,CameraDirection:i}=t,s=new o.Vector3(Number(e.X),Number(e.Z),Number(-e.Y)),a=new o.Vector3(Number(i.X),Number(i.Z),Number(-i.Y)),l={camera_view_point:{x:s.x,y:s.y,z:s.z},camera_direction:{x:a.x,y:a.y,z:a.z},aspect_ratio:"AspectRatio"in t?t.AspectRatio:1,camera_up_vector:{x:0,y:0,z:0}};"ViewToWorldScale"in t&&(r.orthogonal_camera={...l,view_to_world_scale:t.ViewToWorldScale}),"FieldOfView"in t&&(r.perspective_camera={...l,field_of_view:t.FieldOfView})}if(l){const t=(Array.isArray(l.ClippingPlane)?l.ClippingPlane:[l.ClippingPlane]).map(({Location:t,Direction:e})=>({location:{x:t.x,y:t.y,z:t.z},direction:{x:e.x,y:e.y,z:e.z}}));r.clipping_planes=t}const p=new aa(this.components,r);f.push(p)}const v={},_=[],y=c.filter(t=>t.name.endsWith(".bcf"));for(const e of y){const i=await e.async("string"),r=t.xmlParser.parse(i).Markup,o=r.Topic,{Guid:l,TopicType:h,TopicStatus:u,Title:p,CreationDate:f,CreationAuthor:g}=o;if(a&&!(l&&h&&u&&p&&f&&g))continue;const y=new wo(this.components);y.guid=l??y.guid;const w=this.getMarkupRelatedTopics(r,d);v[y.guid]=new Set(w),y.type=h??y.type,y.status=u??y.status,y.title=p??y.title,y.creationDate=f?new Date(f):y.creationDate,y.creationAuthor=g??y.creationAuthor,y.serverAssignedId=o.ServerAssignedId,y.priority=o.Priority,y.index=o.Index,y.modifiedDate=o.ModifiedDate?new Date(o.ModifiedDate):void 0,y.modifiedAuthor=o.ModifiedAuthor,y.dueDate=o.DueDate?new Date(o.DueDate):void 0,y.assignedTo=o.AssignedTo,y.description=o.Description,y.stage=o.Stage;const b=this.getMarkupLabels(r,d);for(const t of b)y.labels.add(t);const x=this.getMarkupComments(r,d);for(const t of x)y.comments.set(t.guid,t);const S=this.getMarkupViewpoints(r,d);for(const t of S){if(!t||!t.Guid)continue;const e=m.list.get(t.Guid);if(!e)continue;y.viewpoints.add(e.guid);const i=`${y.guid}/${t.Snapshot}`,s=c.find(({name:t})=>t===i);if(s){const t=await s.async("arraybuffer"),i=new Uint8Array(t);m.snapshots.set(e.guid,i),e.snapshot=e.guid??null}}const E=this.getMarkupDocumentReferences(r,d),C=c.find(t=>"documents.xml"===t.name);let T=[];const P=await(null==C?void 0:C.async("string"));if(P){const t=null==(n=null==(s=ni.parser.parse(P).DocumentInfo)?void 0:s.Documents)?void 0:n.Document;T=Array.isArray(t)?t:[t]}for(const t of E){const{Description:e,DocumentGuid:i,Url:s,isExternal:n,ReferencedDocument:r}=t;if(i&&T.length>0){const t=T.find(({Guid:t})=>t===i),e=c.find(t=>t.name.endsWith(i)),s=await(null==e?void 0:e.async("uint8array"));if(!t||!s)continue;const{Description:n,Filename:r}=t;this.documents.set(i,{type:"internal",fileName:r,description:n,data:s}),y.documentReferences.add(i)}if(s){const t=this.documents.add({type:"external",url:s,description:e});y.documentReferences.add(t)}if(r){let t=null;if(n)t=this.documents.add({type:"external",url:r,description:e});else{const i=r.split("/"),s=i[i.length-1],n=c.find(t=>t.name.endsWith(s)),o=await(null==n?void 0:n.async("uint8array"));if(!o)continue;t=this.documents.add({type:"internal",fileName:s,data:o,description:e})}y.documentReferences.add(t)}}this.list.set(y.guid,y),_.push(y)}for(const t in v){const e=this.list.get(t);if(!e)continue;const i=v[t];for(const t of i)e.relatedTopics.add(t)}return this.onBCFImported.trigger(_),{viewpoints:f,topics:_}}};Pt(xo,"uuid","de977976-e4f6-4e4f-a01a-204727839802"),Pt(xo,"xmlParser",new si.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let So=xo;const Eo=new p,Co=new a,To=new a,Po=new f,Ao={X:new a(1,0,0),Y:new a(0,1,0),Z:new a(0,0,1)},Mo={type:"change"},Oo={type:"mouseDown",mode:null},Do={type:"mouseUp",mode:null},zo={type:"objectChange"};class Io extends x{constructor(t,e=null){super(void 0,e);const i=new ta(this);this._root=i;const s=new ea;this._gizmo=s,i.add(s);const n=new ia;this._plane=n,i.add(n);const r=this;function o(t,e){let i=e;Object.defineProperty(r,t,{get:function(){return void 0!==i?i:e},set:function(e){i!==e&&(i=e,n[t]=e,s[t]=e,r.dispatchEvent({type:t+"-changed",value:e}),r.dispatchEvent(Mo))}}),r[t]=e,n[t]=e,s[t]=e}o("camera",t),o("object",void 0),o("enabled",!0),o("axis",null),o("mode","translate"),o("translationSnap",null),o("rotationSnap",null),o("scaleSnap",null),o("space","world"),o("size",1),o("dragging",!1),o("showX",!0),o("showY",!0),o("showZ",!0),o("minX",-1/0),o("maxX",1/0),o("minY",-1/0),o("maxY",1/0),o("minZ",-1/0),o("maxZ",1/0);const l=new a,h=new a,c=new f,d=new f,u=new a,p=new f,m=new a,g=new a,v=new a,_=new a;o("worldPosition",l),o("worldPositionStart",h),o("worldQuaternion",c),o("worldQuaternionStart",d),o("cameraPosition",u),o("cameraQuaternion",p),o("pointStart",m),o("pointEnd",g),o("rotationAxis",v),o("rotationAngle",0),o("eye",_),this._offset=new a,this._startNorm=new a,this._endNorm=new a,this._cameraScale=new a,this._parentPosition=new a,this._parentQuaternion=new f,this._parentQuaternionInv=new f,this._parentScale=new a,this._worldScaleStart=new a,this._worldQuaternionInv=new f,this._worldScale=new a,this._positionStart=new a,this._quaternionStart=new f,this._scaleStart=new a,this._getPointer=ko.bind(this),this._onPointerDown=No.bind(this),this._onPointerHover=Lo.bind(this),this._onPointerMove=Bo.bind(this),this._onPointerUp=Uo.bind(this),null!==e&&this.connect(e)}connect(t){super.connect(t),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(t){if(void 0===this.object||!0===this.dragging)return;null!==t&&Eo.setFromCamera(t,this.camera);const e=Ro(this._gizmo.picker[this.mode],Eo);this.axis=e?e.object.name:null}pointerDown(t){if(void 0!==this.object&&!0!==this.dragging&&(null==t||0===t.button)&&null!==this.axis){null!==t&&Eo.setFromCamera(t,this.camera);const e=Ro(this._plane,Eo,!0);e&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(e.point).sub(this.worldPositionStart)),this.dragging=!0,Oo.mode=this.mode,this.dispatchEvent(Oo)}}pointerMove(t){const e=this.axis,i=this.mode,s=this.object;let n=this.space;if("scale"===i?n="local":("E"===e||"XYZE"===e||"XYZ"===e)&&(n="world"),void 0===s||null===e||!1===this.dragging||null!==t&&-1!==t.button)return;null!==t&&Eo.setFromCamera(t,this.camera);const r=Ro(this._plane,Eo,!0);if(r){if(this.pointEnd.copy(r.point).sub(this.worldPositionStart),"translate"===i)this._offset.copy(this.pointEnd).sub(this.pointStart),"local"===n&&"XYZ"!==e&&this._offset.applyQuaternion(this._worldQuaternionInv),-1===e.indexOf("X")&&(this._offset.x=0),-1===e.indexOf("Y")&&(this._offset.y=0),-1===e.indexOf("Z")&&(this._offset.z=0),"local"===n&&"XYZ"!==e?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),s.position.copy(this._offset).add(this._positionStart),this.translationSnap&&("local"===n&&(s.position.applyQuaternion(Po.copy(this._quaternionStart).invert()),-1!==e.search("X")&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(this._quaternionStart)),"world"===n&&(s.parent&&s.position.add(Co.setFromMatrixPosition(s.parent.matrixWorld)),-1!==e.search("X")&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(Co.setFromMatrixPosition(s.parent.matrixWorld)))),s.position.x=Math.max(this.minX,Math.min(this.maxX,s.position.x)),s.position.y=Math.max(this.minY,Math.min(this.maxY,s.position.y)),s.position.z=Math.max(this.minZ,Math.min(this.maxZ,s.position.z));else if("scale"===i){if(-1!==e.search("XYZ")){let t=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(t*=-1),To.set(t,t,t)}else Co.copy(this.pointStart),To.copy(this.pointEnd),Co.applyQuaternion(this._worldQuaternionInv),To.applyQuaternion(this._worldQuaternionInv),To.divide(Co),-1===e.search("X")&&(To.x=1),-1===e.search("Y")&&(To.y=1),-1===e.search("Z")&&(To.z=1);s.scale.copy(this._scaleStart).multiply(To),this.scaleSnap&&(-1!==e.search("X")&&(s.scale.x=Math.round(s.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Y")&&(s.scale.y=Math.round(s.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Z")&&(s.scale.z=Math.round(s.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===i){this._offset.copy(this.pointEnd).sub(this.pointStart);const t=20/this.worldPosition.distanceTo(Co.setFromMatrixPosition(this.camera.matrixWorld));let i=!1;"XYZE"===e?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(Co.copy(this.rotationAxis).cross(this.eye))*t):("X"===e||"Y"===e||"Z"===e)&&(this.rotationAxis.copy(Ao[e]),Co.copy(Ao[e]),"local"===n&&Co.applyQuaternion(this.worldQuaternion),Co.cross(this.eye),0===Co.length()?i=!0:this.rotationAngle=this._offset.dot(Co.normalize())*t),("E"===e||i)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),"local"===n&&"E"!==e&&"XYZE"!==e?(s.quaternion.copy(this._quaternionStart),s.quaternion.multiply(Po.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),s.quaternion.copy(Po.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),s.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(Mo),this.dispatchEvent(zo)}}pointerUp(t){null!==t&&0!==t.button||(this.dragging&&null!==this.axis&&(Do.mode=this.mode,this.dispatchEvent(Do)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(t){return this.object=t,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(Mo),this.dispatchEvent(zo),this.pointStart.copy(this.pointEnd))}getRaycaster(){return Eo}getMode(){return this.mode}setMode(t){this.mode=t}setTranslationSnap(t){this.translationSnap=t}setRotationSnap(t){this.rotationSnap=t}setScaleSnap(t){this.scaleSnap=t}setSize(t){this.size=t}setSpace(t){this.space=t}}function ko(t){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:t.button};{const e=this.domElement.getBoundingClientRect();return{x:(t.clientX-e.left)/e.width*2-1,y:-(t.clientY-e.top)/e.height*2+1,button:t.button}}}function Lo(t){if(this.enabled)switch(t.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(t))}}function No(t){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(t.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(t)),this.pointerDown(this._getPointer(t)))}function Bo(t){this.enabled&&this.pointerMove(this._getPointer(t))}function Uo(t){this.enabled&&(this.domElement.releasePointerCapture(t.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(t)))}function Ro(t,e,i){const s=e.intersectObject(t,!0);for(let t=0;t<s.length;t++)if(s[t].object.visible||i)return s[t];return!1}const Fo=new m,Vo=new a(0,1,0),jo=new a(0,0,0),Ho=new g,Wo=new f,Go=new f,Zo=new a,Yo=new g,Xo=new a(1,0,0),qo=new a(0,1,0),Qo=new a(0,0,1),Ko=new a,Jo=new a,$o=new a;class ta extends S{constructor(t){super(),this.isTransformControlsRoot=!0,this.controls=t,this.visible=!1}updateMatrixWorld(t){const e=this.controls;void 0!==e.object&&(e.object.updateMatrixWorld(),null===e.object.parent?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):e.object.parent.matrixWorld.decompose(e._parentPosition,e._parentQuaternion,e._parentScale),e.object.matrixWorld.decompose(e.worldPosition,e.worldQuaternion,e._worldScale),e._parentQuaternionInv.copy(e._parentQuaternion).invert(),e._worldQuaternionInv.copy(e.worldQuaternion).invert()),e.camera.updateMatrixWorld(),e.camera.matrixWorld.decompose(e.cameraPosition,e.cameraQuaternion,e._cameraScale),e.camera.isOrthographicCamera?e.camera.getWorldDirection(e.eye).negate():e.eye.copy(e.cameraPosition).sub(e.worldPosition).normalize(),super.updateMatrixWorld(t)}dispose(){this.traverse(function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})}}class ea extends S{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const t=new E({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),e=new C({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),i=t.clone();i.opacity=.15;const s=e.clone();s.opacity=.5;const n=t.clone();n.color.setHex(16711680);const r=t.clone();r.color.setHex(65280);const o=t.clone();o.color.setHex(255);const a=t.clone();a.color.setHex(16711680),a.opacity=.5;const l=t.clone();l.color.setHex(65280),l.opacity=.5;const h=t.clone();h.color.setHex(255),h.opacity=.5;const c=t.clone();c.opacity=.25;const d=t.clone();d.color.setHex(16776960),d.opacity=.25,t.clone().color.setHex(16776960);const p=t.clone();p.color.setHex(7895160);const f=new T(0,.04,.1,12);f.translate(0,.05,0);const m=new P(.08,.08,.08);m.translate(0,.04,0);const g=new A;g.setAttribute("position",new M([0,0,0,1,0,0],3));const v=new T(.0075,.0075,.5,3);function _(t,e){const i=new z(t,.0075,3,64,e*Math.PI*2);return i.rotateY(Math.PI/2),i.rotateX(Math.PI/2),i}v.translate(0,.25,0);const y={X:[[new u(f,n),[.5,0,0],[0,0,-Math.PI/2]],[new u(f,n),[-.5,0,0],[0,0,Math.PI/2]],[new u(v,n),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new u(f,r),[0,.5,0]],[new u(f,r),[0,-.5,0],[Math.PI,0,0]],[new u(v,r)]],Z:[[new u(f,o),[0,0,.5],[Math.PI/2,0,0]],[new u(f,o),[0,0,-.5],[-Math.PI/2,0,0]],[new u(v,o),null,[Math.PI/2,0,0]]],XYZ:[[new u(new O(.1,0),c.clone()),[0,0,0]]],XY:[[new u(new P(.15,.15,.01),h.clone()),[.15,.15,0]]],YZ:[[new u(new P(.15,.15,.01),a.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new u(new P(.15,.15,.01),l.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},w={X:[[new u(new T(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new u(new T(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new u(new T(.2,0,.6,4),i),[0,.3,0]],[new u(new T(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new u(new T(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new u(new T(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new u(new O(.2,0),i)]],XY:[[new u(new P(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new u(new P(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new u(new P(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]]},b={START:[[new u(new O(.01,2),s),null,null,null,"helper"]],END:[[new u(new O(.01,2),s),null,null,null,"helper"]],DELTA:[[new D(function(){const t=new A;return t.setAttribute("position",new M([0,0,0,1,1,1],3)),t}(),s),null,null,null,"helper"]],X:[[new D(g,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new D(g,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new D(g,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},x={XYZE:[[new u(_(.5,1),p),null,[0,Math.PI/2,0]]],X:[[new u(_(.5,.5),n)]],Y:[[new u(_(.5,.5),r),null,[0,0,-Math.PI/2]]],Z:[[new u(_(.5,.5),o),null,[0,Math.PI/2,0]]],E:[[new u(_(.75,1),d),null,[0,Math.PI/2,0]]]},k={AXIS:[[new D(g,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},L={XYZE:[[new u(new I(.25,10,8),i)]],X:[[new u(new z(.5,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new u(new z(.5,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new u(new z(.5,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new u(new z(.75,.1,2,24),i)]]},N={X:[[new u(m,n),[.5,0,0],[0,0,-Math.PI/2]],[new u(v,n),[0,0,0],[0,0,-Math.PI/2]],[new u(m,n),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new u(m,r),[0,.5,0]],[new u(v,r)],[new u(m,r),[0,-.5,0],[0,0,Math.PI]]],Z:[[new u(m,o),[0,0,.5],[Math.PI/2,0,0]],[new u(v,o),[0,0,0],[Math.PI/2,0,0]],[new u(m,o),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new u(new P(.15,.15,.01),h),[.15,.15,0]]],YZ:[[new u(new P(.15,.15,.01),a),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new u(new P(.15,.15,.01),l),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new u(new P(.1,.1,.1),c.clone())]]},B={X:[[new u(new T(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new u(new T(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new u(new T(.2,0,.6,4),i),[0,.3,0]],[new u(new T(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new u(new T(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new u(new T(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new u(new P(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new u(new P(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new u(new P(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new u(new P(.2,.2,.2),i),[0,0,0]]]},U={X:[[new D(g,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new D(g,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new D(g,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function R(t){const e=new S;for(const i in t)for(let s=t[i].length;s--;){const n=t[i][s][0].clone(),r=t[i][s][1],o=t[i][s][2],a=t[i][s][3],l=t[i][s][4];n.name=i,n.tag=l,r&&n.position.set(r[0],r[1],r[2]),o&&n.rotation.set(o[0],o[1],o[2]),a&&n.scale.set(a[0],a[1],a[2]),n.updateMatrix();const h=n.geometry.clone();h.applyMatrix4(n.matrix),n.geometry=h,n.renderOrder=1/0,n.position.set(0,0,0),n.rotation.set(0,0,0),n.scale.set(1,1,1),e.add(n)}return e}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=R(y)),this.add(this.gizmo.rotate=R(x)),this.add(this.gizmo.scale=R(N)),this.add(this.picker.translate=R(w)),this.add(this.picker.rotate=R(L)),this.add(this.picker.scale=R(B)),this.add(this.helper.translate=R(b)),this.add(this.helper.rotate=R(k)),this.add(this.helper.scale=R(U)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(t){const e="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:Go;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;let i=[];i=i.concat(this.picker[this.mode].children),i=i.concat(this.gizmo[this.mode].children),i=i.concat(this.helper[this.mode].children);for(let t=0;t<i.length;t++){const s=i[t];let n;s.visible=!0,s.rotation.set(0,0,0),s.position.copy(this.worldPosition),(n=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),s.scale.set(1,1,1).multiplyScalar(n*this.size/4),"helper"!==s.tag)?(s.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode?("X"===s.name&&Math.abs(Vo.copy(Xo).applyQuaternion(e).dot(this.eye))>.99&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"Y"===s.name&&Math.abs(Vo.copy(qo).applyQuaternion(e).dot(this.eye))>.99&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"Z"===s.name&&Math.abs(Vo.copy(Qo).applyQuaternion(e).dot(this.eye))>.99&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"XY"===s.name&&Math.abs(Vo.copy(Qo).applyQuaternion(e).dot(this.eye))<.2&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"YZ"===s.name&&Math.abs(Vo.copy(Xo).applyQuaternion(e).dot(this.eye))<.2&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"XZ"===s.name&&Math.abs(Vo.copy(qo).applyQuaternion(e).dot(this.eye))<.2&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1)):"rotate"===this.mode&&(Wo.copy(e),Vo.copy(this.eye).applyQuaternion(Po.copy(e).invert()),-1!==s.name.search("E")&&s.quaternion.setFromRotationMatrix(Ho.lookAt(this.eye,jo,qo)),"X"===s.name&&(Po.setFromAxisAngle(Xo,Math.atan2(-Vo.y,Vo.z)),Po.multiplyQuaternions(Wo,Po),s.quaternion.copy(Po)),"Y"===s.name&&(Po.setFromAxisAngle(qo,Math.atan2(Vo.x,Vo.z)),Po.multiplyQuaternions(Wo,Po),s.quaternion.copy(Po)),"Z"===s.name&&(Po.setFromAxisAngle(Qo,Math.atan2(Vo.y,Vo.x)),Po.multiplyQuaternions(Wo,Po),s.quaternion.copy(Po))),s.visible=s.visible&&(-1===s.name.indexOf("X")||this.showX),s.visible=s.visible&&(-1===s.name.indexOf("Y")||this.showY),s.visible=s.visible&&(-1===s.name.indexOf("Z")||this.showZ),s.visible=s.visible&&(-1===s.name.indexOf("E")||this.showX&&this.showY&&this.showZ),s.material._color=s.material._color||s.material.color.clone(),s.material._opacity=s.material._opacity||s.material.opacity,s.material.color.copy(s.material._color),s.material.opacity=s.material._opacity,this.enabled&&this.axis&&(s.name===this.axis||this.axis.split("").some(function(t){return s.name===t}))&&(s.material.color.setHex(16776960),s.material.opacity=1)):(s.visible=!1,"AXIS"===s.name?(s.visible=!!this.axis,"X"===this.axis&&(Po.setFromEuler(Fo.set(0,0,0)),s.quaternion.copy(e).multiply(Po),Math.abs(Vo.copy(Xo).applyQuaternion(e).dot(this.eye))>.9&&(s.visible=!1)),"Y"===this.axis&&(Po.setFromEuler(Fo.set(0,0,Math.PI/2)),s.quaternion.copy(e).multiply(Po),Math.abs(Vo.copy(qo).applyQuaternion(e).dot(this.eye))>.9&&(s.visible=!1)),"Z"===this.axis&&(Po.setFromEuler(Fo.set(0,Math.PI/2,0)),s.quaternion.copy(e).multiply(Po),Math.abs(Vo.copy(Qo).applyQuaternion(e).dot(this.eye))>.9&&(s.visible=!1)),"XYZE"===this.axis&&(Po.setFromEuler(Fo.set(0,Math.PI/2,0)),Vo.copy(this.rotationAxis),s.quaternion.setFromRotationMatrix(Ho.lookAt(jo,Vo,qo)),s.quaternion.multiply(Po),s.visible=this.dragging),"E"===this.axis&&(s.visible=!1)):"START"===s.name?(s.position.copy(this.worldPositionStart),s.visible=this.dragging):"END"===s.name?(s.position.copy(this.worldPosition),s.visible=this.dragging):"DELTA"===s.name?(s.position.copy(this.worldPositionStart),s.quaternion.copy(this.worldQuaternionStart),Co.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),Co.applyQuaternion(this.worldQuaternionStart.clone().invert()),s.scale.copy(Co),s.visible=this.dragging):(s.quaternion.copy(e),this.dragging?s.position.copy(this.worldPositionStart):s.position.copy(this.worldPosition),this.axis&&(s.visible=-1!==this.axis.search(s.name))))}super.updateMatrixWorld(t)}}class ia extends u{constructor(){super(new k(1e5,1e5,2,2),new E({visible:!1,wireframe:!0,side:L,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(t){let e=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(e="local"),Ko.copy(Xo).applyQuaternion("local"===e?this.worldQuaternion:Go),Jo.copy(qo).applyQuaternion("local"===e?this.worldQuaternion:Go),$o.copy(Qo).applyQuaternion("local"===e?this.worldQuaternion:Go),Vo.copy(Jo),this.mode){case"translate":case"scale":switch(this.axis){case"X":Vo.copy(this.eye).cross(Ko),Zo.copy(Ko).cross(Vo);break;case"Y":Vo.copy(this.eye).cross(Jo),Zo.copy(Jo).cross(Vo);break;case"Z":Vo.copy(this.eye).cross($o),Zo.copy($o).cross(Vo);break;case"XY":Zo.copy($o);break;case"YZ":Zo.copy(Ko);break;case"XZ":Vo.copy($o),Zo.copy(Jo);break;case"XYZ":case"E":Zo.set(0,0,0)}break;default:Zo.set(0,0,0)}0===Zo.length()?this.quaternion.copy(this.cameraQuaternion):(Yo.lookAt(Co.set(0,0,0),Zo,Vo),this.quaternion.setFromRotationMatrix(Yo)),super.updateMatrixWorld(t)}}class sa{constructor(t,e,i,s,n,r=5,a=!0){if(Pt(this,"onDraggingStarted",new At),Pt(this,"onDraggingEnded",new At),Pt(this,"onDisposed",new At),Pt(this,"normal"),Pt(this,"origin"),Pt(this,"three",new o.Plane),Pt(this,"components"),Pt(this,"world"),Pt(this,"type","default"),Pt(this,"_title","Clipping Plane"),Pt(this,"_helper"),Pt(this,"_visible",!0),Pt(this,"_enabled",!0),Pt(this,"_controlsActive",!1),Pt(this,"_arrowBoundBox",new o.Mesh),Pt(this,"_planeMesh"),Pt(this,"_controls"),Pt(this,"_hiddenMaterial",new o.MeshBasicMaterial({visible:!1})),Pt(this,"_visibilityBeforeDisabled",!0),Pt(this,"notifyManager",()=>{const t=this.components.get(oa),e=t.list.getKey(this);e&&t.list.set(e,this)}),Pt(this,"update",()=>{this._enabled&&this.three.setFromNormalAndCoplanarPoint(this.normal,this._helper.position)}),Pt(this,"changeDrag",t=>{this._visible=!t.value,this.preventCameraMovement(),this.notifyDraggingChanged(t)}),this.components=t,this.world=e,!e.renderer)throw new Error("The given world must have a renderer!");this.normal=s,this.origin=i,e.renderer.setPlane(!0,this.three),this._planeMesh=sa.newPlaneMesh(r,n),this._helper=this.newHelper(),this._controls=this.newTransformControls(),this.three.setFromNormalAndCoplanarPoint(s,i),a&&this.toggleControls(!0)}set title(t){this._title=t,this.notifyManager()}get title(){return this._title}get enabled(){return this._enabled}set enabled(t){if(!this.world.isDisposing){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");this._enabled=t,t?this.visible=this._visibilityBeforeDisabled:(this._visibilityBeforeDisabled=this.visible,this.visible=!1),this.world.renderer.setPlane(t,this.three),this.notifyManager()}}get visible(){return this._visible}set visible(t){this._visible=t,this._controls.getHelper().visible=t,this._helper.visible=t,this.toggleControls(t),this.notifyManager()}get meshes(){return[this._planeMesh,this._arrowBoundBox]}get planeMaterial(){return this._planeMesh.material}set planeMaterial(t){this._planeMesh.material=t}get size(){return this._planeMesh.scale.x}set size(t){this._planeMesh.scale.set(t,t,t)}get helper(){return this._helper}get controls(){return this._controls}setFromNormalAndCoplanarPoint(t,e){this.reset(),this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(e),this._helper.position.copy(e),this._helper.updateMatrix(),this.update()}dispose(){this._enabled=!1,this.onDraggingStarted.reset(),this.onDraggingEnded.reset(),this._helper.removeFromParent(),this.world.renderer&&this.world.renderer.setPlane(!1,this.three),this._arrowBoundBox.removeFromParent(),this._arrowBoundBox.geometry.dispose(),this._planeMesh.geometry.dispose(),this._controls.getHelper().removeFromParent(),this._controls.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}reset(){const t=new o.Vector3(1,0,0),e=new o.Vector3;this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(e),this._helper.position.copy(e),this._helper.updateMatrix()}toggleControls(t){if(t){if(this._controlsActive)return;this._controls.addEventListener("change",this.update),this._controls.addEventListener("dragging-changed",this.changeDrag)}else this._controls.removeEventListener("change",this.update),this._controls.removeEventListener("dragging-changed",this.changeDrag);this._controlsActive=t}newTransformControls(){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");const t=this.world.camera.three,e=this.world.renderer.three.domElement,i=new Io(t,e);return this.initializeControls(i),this.world.scene.three.add(i.getHelper()),i}initializeControls(t){t.attach(this._helper),t.showX=!1,t.showY=!1,t.setSpace("local"),this.createArrowBoundingBox(),t.getHelper().children[0].children[0].add(this._arrowBoundBox)}createArrowBoundingBox(){this._arrowBoundBox.geometry=new o.CylinderGeometry(.18,.18,1.2),this._arrowBoundBox.material=this._hiddenMaterial,this._arrowBoundBox.rotateX(Math.PI/2),this._arrowBoundBox.updateMatrix(),this._arrowBoundBox.geometry.applyMatrix4(this._arrowBoundBox.matrix)}notifyDraggingChanged(t){t.value?this.onDraggingStarted.trigger():this.onDraggingEnded.trigger()}preventCameraMovement(){this.world.camera.enabled=this._visible}newHelper(){const t=new o.Object3D;return t.lookAt(this.normal),t.position.copy(this.origin),this._planeMesh.position.z+=.01,t.add(this._planeMesh),this.world.scene.three.add(t),t}static newPlaneMesh(t,e){const i=new o.PlaneGeometry(1),s=new o.Mesh(i,e);return s.scale.set(t,t,t),s}}class na extends li{constructor(){super(...arguments),Pt(this,"_config",{enabled:{value:!0,type:"Boolean"},visible:{value:!0,type:"Boolean"},color:{value:new o.Color,type:"Color"},opacity:{type:"Number",interpolable:!0,value:1,min:0,max:1},size:{type:"Number",interpolable:!0,value:2,min:0,max:100}})}get enabled(){return this._config.enabled.value}set enabled(t){this._config.enabled.value=t,this._component.enabled=t}get visible(){return this._config.visible.value}set visible(t){this._config.visible.value=t,this._component.visible=t}get color(){return this._config.color.value}set color(t){this._config.color.value=t,this._component.material.color.copy(t)}get opacity(){return this._config.opacity.value}set opacity(t){this._config.opacity.value=t,this._component.material.opacity=t}get size(){return this._config.size.value}set size(t){this._config.size.value=t,this._component.size=t}}const ra=class t extends Ot{constructor(e){super(e),Pt(this,"onSetup",new At),Pt(this,"onBeforeDrag",new At),Pt(this,"onAfterDrag",new At),Pt(this,"onBeforeCreate",new At),Pt(this,"onBeforeCancel",new At),Pt(this,"onAfterCancel",new At),Pt(this,"onBeforeDelete",new At),Pt(this,"onAfterCreate",new At),Pt(this,"onAfterDelete",new At),Pt(this,"onDisposed",new At),Pt(this,"isSetup",!1),Pt(this,"orthogonalY",!1),Pt(this,"toleranceOrthogonalY",.7),Pt(this,"Type",sa),Pt(this,"list",new i.DataMap),Pt(this,"config",new na(this,this.components,"Clipper",t.uuid)),Pt(this,"_defaultConfig",{color:new o.Color(12255487),opacity:.2,size:2}),Pt(this,"_material",new o.MeshBasicMaterial({color:12255487,side:o.DoubleSide,transparent:!0,opacity:.2})),Pt(this,"_size",5),Pt(this,"_enabled",!1),Pt(this,"_visible",!0),Pt(this,"onStateChanged",new At),Pt(this,"_onStartDragging",()=>{this.onBeforeDrag.trigger()}),Pt(this,"_onEndDragging",()=>{this.onAfterDrag.trigger()}),this.components.add(t.uuid,this),this.setEvents()}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.onStateChanged.trigger(["enabled"])}get visible(){return this._visible}set visible(t){this._visible=t;for(const[e,i]of this.list)i.visible=t;this.onStateChanged.trigger(["visibility"])}get material(){return this._material}set material(t){this._material=t;for(const[e,i]of this.list)i.planeMaterial=t;this.onStateChanged.trigger(["material"])}get size(){return this._size}set size(t){this._size=t;for(const[e,i]of this.list)i.size=t;this.onStateChanged.trigger(["size"])}setEvents(){this.list.onBeforeDelete.add(({value:t})=>{if(!t.world.renderer)throw new Error("Renderer not found for this plane's world!");t.world.renderer.setPlane(!1,t.three),t.dispose(),this.updateMaterialsAndPlanes(),this.onAfterDelete.trigger(t)})}dispose(){this._enabled=!1,this.components.get(ci).list.delete(this.config.uuid),this.list.clear(),this._material.dispose(),this.onBeforeCreate.reset(),this.onBeforeCancel.reset(),this.onBeforeDelete.reset(),this.onBeforeDrag.reset(),this.onAfterCreate.reset(),this.onAfterCancel.reset(),this.onAfterDelete.reset(),this.onAfterDrag.reset(),this.onDisposed.trigger(t.uuid),this.onDisposed.reset()}async create(t){const e=await this.components.get(Mi).get(t).castRay();return e?this.createPlaneFromIntersection(t,e):null}createFromNormalAndCoplanarPoint(t,e,i){const s=this.newPlane(t,i,e);return this.updateMaterialsAndPlanes(),s}async delete(t,e){if(!e){const i=await this.pickPlane(t);if(!i)return;e=this.list.getKey(i)}e&&this.list.delete(e)}deleteAll(t){for(const[e,i]of this.list)(!t||t.has(i.type))&&this.list.delete(e)}setup(t){const e={...this._defaultConfig,...t};this.config.color=e.color,this.config.opacity=e.opacity,this.config.size=e.size,this.isSetup=!0,this.onSetup.trigger()}async pickPlane(t){const e=this.components.get(Mi).get(t),i=this.getAllPlaneMeshes(),s=await e.castRay({items:i});if(s){const t=s.object;return[...this.list.values()].find(e=>e.meshes.includes(t))}}getAllPlaneMeshes(){const t=[];for(const[e,i]of this.list)t.push(...i.meshes);return t}createPlaneFromIntersection(t,e){var i;if(!t.renderer)throw new Error("The given world must have a renderer!");const s=e.point.distanceTo(new o.Vector3(0,0,0)),n=e.normal||(null==(i=e.face)?void 0:i.normal);if(!s||!n)return null;const r=this.getWorldNormal(e,n),a=this.newPlane(t,e.point,r.negate()),l=this.list.get(a);return l.visible=this._visible,l.size=this._size,t.renderer.setPlane(!0,l.three),this.updateMaterialsAndPlanes(),l}getWorldNormal(t,e){const i=t.object;let s=t.object.matrixWorld.clone();if(i instanceof o.InstancedMesh&&void 0!==t.instanceId){const e=new o.Matrix4;i.getMatrixAt(t.instanceId,e),s=e.multiply(s)}const n=(new o.Matrix3).getNormalMatrix(s),r=e.clone().applyMatrix3(n).normalize();return this.normalizePlaneDirectionY(r),r}normalizePlaneDirectionY(t){this.orthogonalY&&(t.y>this.toleranceOrthogonalY&&(t.x=0,t.y=1,t.z=0),t.y<-this.toleranceOrthogonalY&&(t.x=0,t.y=-1,t.z=0))}newPlane(t,e,i){const s=new this.Type(this.components,t,e,i,this._material);s.onDraggingStarted.add(this._onStartDragging),s.onDraggingEnded.add(this._onEndDragging);const n=Bt.create();return this.list.set(n,s),this.onAfterCreate.trigger(s),n}updateMaterialsAndPlanes(){const t=this.components.get(zs);for(const[e,i]of t.list){if(!i.renderer)continue;i.renderer.updateClippingPlanes();const{clippingPlanes:t}=i.renderer;for(const e of i.meshes)if(e.material)if(Array.isArray(e.material))for(const i of e.material)i.clippingPlanes=t;else e.material.clippingPlanes=t}}};Pt(ra,"uuid","66290bc5-18c4-4cd1-9379-2e17a0617611");let oa=ra;class aa{constructor(t,e){Pt(this,"title"),Pt(this,"guid",Bt.create()),Pt(this,"clippingPlanes",new i.DataSet),Pt(this,"camera",{aspect_ratio:1,field_of_view:60,camera_direction:{x:0,y:0,z:0},camera_view_point:{x:0,y:0,z:0},camera_up_vector:{x:0,y:1,z:0}}),Pt(this,"customData",{}),Pt(this,"exceptionComponents",new i.DataSet),Pt(this,"selectionComponents",new i.DataSet),Pt(this,"componentColors",new i.DataMap),Pt(this,"spacesVisible",!1),Pt(this,"spaceBoundariesVisible",!1),Pt(this,"openingsVisible",!1),Pt(this,"defaultVisibility",!0),Pt(this,"snapshot",this.guid),Pt(this,"_components"),Pt(this,"_world",null),Pt(this,"notifyUpdate",()=>{this._components.get(ca).list.set(this.guid,this)}),this._components=t,e&&(this.guid=e.guid??this.guid,this.set(e)),this.setEvents()}async getSelectionMap(){return await this._components.get(pi).guidsToModelIdMap([...this.selectionComponents])}async getExceptionMap(){return await this._components.get(pi).guidsToModelIdMap([...this.exceptionComponents])}get projection(){return"field_of_view"in this.camera?"Perspective":"Orthographic"}get position(){const t=this._components.get(pi),{camera_view_point:e}=this.camera,{x:i,y:s,z:n}=e,r=new o.Vector3(i,s,n);return t.applyBaseCoordinateSystem(r,new o.Matrix4),r}set position(t){const e=t.clone(),i=this._components.get(pi);t.clone().applyMatrix4(i.baseCoordinationMatrix.clone().invert()),this.camera.camera_view_point={x:e.x,y:e.y,z:e.z}}get direction(){const{camera_direction:t}=this.camera,{x:e,y:i,z:s}=t;return new o.Vector3(e,i,s)}set world(t){this._world=t}get world(){return this._world}get _managerVersion(){return this._components.get(So).config.version}get topics(){return[...this._components.get(So).list.values()].filter(t=>t.viewpoints.has(this.guid))}setEvents(){this.selectionComponents.onUpdated.add(this.notifyUpdate),this.exceptionComponents.onUpdated.add(this.notifyUpdate),this.clippingPlanes.onUpdated.add(this.notifyUpdate),this.componentColors.onItemSet.add(this.notifyUpdate),this.componentColors.onItemDeleted.add(this.notifyUpdate),this.componentColors.onItemUpdated.add(this.notifyUpdate),this.componentColors.onCleared.add(this.notifyUpdate)}set(t){this.title=t.title;const{components:e,perspective_camera:i,orthogonal_camera:s,clipping_planes:n}=t;if(e){const{selection:t,visibility:i,coloring:s}=e;if(t){this.selectionComponents.clear();for(const{ifc_guid:e}of t)e&&this.selectionComponents.add(e)}if(i){const{default_visibility:t,exceptions:e,view_setup_hints:s}=i;if(void 0!==t&&(this.defaultVisibility=t),e){this.exceptionComponents.clear();for(const{ifc_guid:t}of e)t&&this.exceptionComponents.add(t)}if(s){const{spaces_visible:t,space_boundaries_visible:e,openings_visible:i}=s;void 0!==t&&(this.spacesVisible=t),void 0!==e&&(this.spaceBoundariesVisible=e),void 0!==i&&(this.openingsVisible=i)}}if(s){this.componentColors.clear();for(const t of s){const{color:e,components:i}=t,s=i.map(t=>t.ifc_guid).filter(t=>null!==t);this.componentColors.set(e,s)}}}if((i||s)&&(this.camera=i??s),n&&this.world){const t=this._components.get(oa);for(const e of n){const{location:i,direction:s}=e,n=new o.Vector3(i.x,i.z,-i.y),r=new o.Vector3(s.x,s.z,-s.y),a=t.createFromNormalAndCoplanarPoint(this.world,r,n);this.clippingPlanes.add(a),t.list.get(a).enabled=!1,t.list.get(a).visible=!1}}this.notifyUpdate()}async go(t){if(!this.world)return;const{camera:e}=this.world;if(!(e instanceof fo))throw new Error("Viewpoint: the world's camera component must be of type OrthoPerspectiveCamera to switch between perspective and orthographic projections.");const{transition:i,applyClippings:s,applyVisibility:n,clippingsVisibility:r}={transition:!0,applyClippings:!0,applyVisibility:!0,clippingsVisibility:!0,...t};e.projection.set(this.projection);const a=new o.Vector3(this.camera.camera_view_point.x,this.camera.camera_view_point.y,this.camera.camera_view_point.z),l=new o.Vector3(this.camera.camera_direction.x,this.camera.camera_direction.y,this.camera.camera_direction.z);if(a.equals(new o.Vector3)&&l.equals(new o.Vector3))return;const h=this.position,c=this.direction,d={x:h.x+80*c.x,y:h.y+80*c.y,z:h.z+80*c.z},u=[];s&&this.setClippingState(!0),n&&u.push(this.applyVisibility()),this.setClippingVisibility(r),u.push(e.controls.setLookAt(h.x,h.y,h.z,d.x,d.y,d.z,i)),await Promise.all(u)}async updateCamera(t=!0){return new Promise(e=>{if(!this.world)return void e(!1);const{camera:i,renderer:s}=this.world;if(!s)throw new Error("Viewpoint: the world needs to have a renderer!");if(!i.hasCameraControls())throw new Error("Viewpoint: world's camera need camera controls!");const n=new o.Vector3;i.controls.getPosition(n);const r=i.three,a=new o.Vector3(0,0,-1).applyEuler(r.rotation),{width:l,height:h}=s.getSize();let c=l/h;Number.isNaN(c)&&(c=1);const d=this._components.get(pi);n.applyMatrix4(d.baseCoordinationMatrix.clone().invert());const u={aspect_ratio:c,camera_view_point:{x:n.x,y:n.y,z:n.z},camera_direction:{x:a.x,y:a.y,z:a.z},camera_up_vector:{x:0,y:1,z:0}};if(r instanceof o.PerspectiveCamera?this.camera={...u,field_of_view:r.fov}:r instanceof o.OrthographicCamera&&(this.camera={...u,view_to_world_scale:r.top-r.bottom}),t){const t=this._components.get(ca),n=s.three.domElement;s.three.render(this.world.scene.three,i.three),n.toBlob(async i=>{if(i){const e=await i.arrayBuffer(),s=new Uint8Array(e);t.snapshots.set(this.guid,s)}this.notifyUpdate(),e(!0)})}else this.notifyUpdate(),e(!0)})}takeSnapshot(){return new Promise(t=>{if(!this.world)return void t(!1);const{camera:e,renderer:i}=this.world;if(!i)throw new Error("Viewpoint: the world needs to have a renderer!");const s=this._components.get(ca),n=i.three.domElement;i.three.render(this.world.scene.three,e.three),n.toBlob(async e=>{if(e){const t=await e.arrayBuffer(),i=new Uint8Array(t);s.snapshots.set(this.guid,i)}this.notifyUpdate(),t(!0)})})}updateClippingPlanes(){this.clippingPlanes.clear();const t=this._components.get(oa);for(const[e,i]of t.list)i.enabled&&this.clippingPlanes.add(e)}async applyVisibility(){const t=this._components.get(gi);t.set(this.defaultVisibility);const e=await this.getExceptionMap();t.set(!this.defaultVisibility,e);const i=await this.getSelectionMap();t.set(!0,i)}async setColorizationState(t){const e=this._components.get(pi),s=[];if(t)for(const[t,n]of this.componentColors){const r=`#${t}`,a=await e.guidsToModelIdMap(n);for(const[t,n]of Object.entries(a)){const a=e.list.get(t);a&&s.push(a.highlight([...n],{customId:r,color:new o.Color(r),renderedFaces:i.RenderedFaces.ONE,opacity:1,transparent:!1}))}}else for(const[t,i]of this.componentColors){const t=await e.guidsToModelIdMap(i);for(const[i,n]of Object.entries(t)){const t=e.list.get(i);t&&s.push(t.resetHighlight([...n]))}}s.push(e.core.update(!0)),await Promise.all(s)}setClippingState(t){const e=this._components.get(oa);for(const[i,s]of e.list)s.enabled=t&&this.clippingPlanes.has(i)}setClippingVisibility(t){const e=this._components.get(oa);for(const i of this.clippingPlanes){const s=e.list.get(i);s&&(s.visible=t)}}async createComponentTags(t){var e;const i=this._components.get(pi);let s="";if(this._components.get(So).config.includeSelectionTag){const n="selection"===t?await this.getSelectionMap():await this.getExceptionMap();for(const t in n){const r=i.list.get(t);if(!r)continue;const o=n[t];for(const t of o){const i=r.getItem(t),n=await i.getGuid();if(!n)continue;const o=null==(e=await i.getAttributes())?void 0:e.getValue("Tag");let a=null;o&&(a=`AuthoringToolId="${o}"`),s+=`\n<Component IfcGuid="${n}" ${a??""} />`}}}else s=[...this.selectionComponents].map(t=>`<Component IfcGuid="${t}" />`).join("\n");return s}createColorTags(){let t="";for(const[e,i]of this.componentColors.entries()){t+=`<Color Color="${e}">\n${i.map(t=>`\n<Component IfcGuid="${t}" />`).join("\n")}\n</Color>`}return 0!==t.length?`<Coloring>\n${t}\n</Coloring>`:"<Coloring />"}toJSON(){const t=this._components.get(oa),e={guid:this.guid,components:{selection:[...this.selectionComponents].map(t=>({ifc_guid:t,authoring_tool_id:null})),coloring:[...this.componentColors].map(([t,e])=>({color:t,components:e.map(t=>({ifc_guid:t,authoring_tool_id:null}))})),visibility:{default_visibility:this.defaultVisibility,exceptions:[...this.exceptionComponents].map(t=>({ifc_guid:t,authoring_tool_id:null})),view_setup_hints:{spaces_visible:this.spacesVisible,space_boundaries_visible:this.spaceBoundariesVisible,openings_visible:this.openingsVisible}}},clipping_planes:[...this.clippingPlanes].map(e=>{const i=t.list.get(e);if(!i)return null;const s=i._controls.worldPosition??i.origin,{normal:n}=i;return{location:{x:s.x,y:-s.z,z:s.y},direction:{x:n.x,y:-n.z,z:n.y}}}).filter(t=>null!==t)};"field_of_view"in this.camera?e.perspective_camera=this.camera:e.orthogonal_camera=this.camera;const i=this._components.get(ca),s=i.snapshots.get(this.snapshot);if(s){const t=s.toString(),n=btoa(t),r=i.getSnapshotExtension(this.snapshot);e.snapshot={snapshot_type:r,snapshot_data:n}}return e}async serialize(t=this._managerVersion){const e=this._components.get(pi),i=this.position;i.applyMatrix4(e.baseCoordinationMatrix.clone().invert());const s=this.direction;s.normalize();const n=(new o.Matrix4).makeRotationX(Math.PI/2),r=s.clone().applyMatrix4(n);r.normalize();const a=`<CameraViewPoint>\n      <X>${i.x}</X>\n      <Y>${-i.z}</Y>\n      <Z>${i.y}</Z>\n    </CameraViewPoint>`,l=`<CameraDirection>\n      <X>${s.x}</X>\n      <Y>${-s.z}</Y>\n      <Z>${s.y}</Z>\n    </CameraDirection>`,h=`<CameraUpVector>\n      <X>${r.x}</X>\n      <Y>${-r.z}</Y>\n      <Z>${r.y}</Z>\n    </CameraUpVector>`,c=`<AspectRatio>${this.camera.aspect_ratio}</AspectRatio>`;let d="";"view_to_world_scale"in this.camera?d=`<OrthogonalCamera>\n        ${a}\n        ${l}\n        ${h}\n        ${c}\n        <ViewToWorldScale>${this.camera.view_to_world_scale}</ViewToWorldScale>\n      </OrthogonalCamera>`:"field_of_view"in this.camera&&(d=`<PerspectiveCamera>\n        ${a}\n        ${l}\n        ${h}\n        ${c}\n        <FieldOfView>${this.camera.field_of_view}</FieldOfView>\n      </PerspectiveCamera>`);const u=`<ViewSetupHints SpacesVisible="${this.spacesVisible??!1}" SpaceBoundariesVisible="${this.spaceBoundariesVisible??!1}" OpeningsVisible="${this.openingsVisible??!1}" />`,p=(await this.createComponentTags("selection")).trim(),f=(await this.createComponentTags("exception")).trim(),m=this.createColorTags();return`<?xml version="1.0" encoding="UTF-8"?>\n    <VisualizationInfo Guid="${this.guid}">\n      <Components>\n        ${"2.1"===t?u:""}\n        ${0!==p.length?`<Selection>${p}</Selection>`:""}\n        <Visibility DefaultVisibility="${this.defaultVisibility}">\n          ${"3"===t?u:""}\n          ${0!==f.length?`<Exceptions>${f}</Exceptions>`:""}\n        </Visibility>\n        ${m}\n      </Components>\n      ${d}\n    </VisualizationInfo>`}}class la extends li{constructor(){super(...arguments),Pt(this,"_config",{overwriteColors:{value:!1,type:"Boolean"}})}get overwriteColors(){return this._config.overwriteColors.value}set overwriteColors(t){this._config.overwriteColors.value=t}}const ha=class t extends Ot{constructor(e){super(e),Pt(this,"enabled",!0),Pt(this,"world",null),Pt(this,"list",new s),Pt(this,"snapshots",new s),Pt(this,"isSetup",!1),Pt(this,"onSetup",new At),Pt(this,"config",new la(this,this.components,"Viewpoints",t.uuid)),Pt(this,"onDisposed",new At),e.add(t.uuid,this)}create(t){const e=new aa(this.components,t);return e.world=this.world,t||this.list.set(e.guid,e),e}getSnapshotExtension(t){let e="jpeg";const i=this.snapshots.get(t);if(!i)return e;const s=i.subarray(0,4);let n="";for(let t=0;t<s.length;t++)n+=s[t].toString(16);return n.startsWith("89504e47")&&(e="png"),n.startsWith("ffd8ffe")&&(e="jpeg"),e}setup(){}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}};Pt(ha,"uuid","ee867824-a796-408d-8aa0-4e5962a83c66");let ca=ha;class da{constructor(t,e){Pt(this,"_components"),Pt(this,"_cameraOffset",10),Pt(this,"_planeHelper"),Pt(this,"_farPlaneHelper"),Pt(this,"_cameraHelper"),Pt(this,"onStateChanged",new At),Pt(this,"onUpdated",new At),Pt(this,"onDisposed",new At),Pt(this,"camera"),Pt(this,"plane",new o.Plane),Pt(this,"farPlane",new o.Plane),Pt(this,"id",Bt.create()),Pt(this,"_open",!1),Pt(this,"_range",pa.defaultRange),Pt(this,"_world",null),Pt(this,"_helpersVisible",!1),Pt(this,"_planesEnabled",!1),this._components=t,this.camera=new fo(this._components);const{threeOrtho:i}=this.camera;if(null!=e&&e.id&&(this.id=e.id),null!=e&&e.normal&&null!=e&&e.point){const{normal:t,point:i}=e;this.plane.setFromNormalAndCoplanarPoint(t,i)}this._cameraHelper=new o.CameraHelper(i),this._planeHelper=new o.PlaneHelper(this.plane,50),this._farPlaneHelper=new o.PlaneHelper(this.farPlane,50),this.farPlaneHelperColor=new o.Color("blue"),this.update()}get _planeNormalOpposite(){return this.plane.normal.clone().negate()}get _planePosition(){return this.plane.normal.clone().multiplyScalar(-this.plane.constant)}get _cameraPosition(){return this._planePosition.addScaledVector(this._planeNormalOpposite,this._cameraOffset)}set open(t){this._open=t,this.onStateChanged.trigger(["open"])}get open(){return this._open}set planeHelperColor(t){!Array.isArray(this._planeHelper.material)&&"color"in this._planeHelper.material&&this._planeHelper.material.color instanceof o.Color&&(this._planeHelper.material.color=t)}set farPlaneHelperColor(t){!Array.isArray(this._farPlaneHelper.material)&&"color"in this._farPlaneHelper.material&&this._farPlaneHelper.material.color instanceof o.Color&&(this._farPlaneHelper.material.color=t)}set range(t){this._range=t,this.update()}get range(){return this._range}set distance(t){this.plane.constant=t,this.update()}get distance(){return this.plane.constant}set world(t){this._world=t,this.camera.currentWorld=t,t&&(this.camera.projection.set("Orthographic"),this.camera.set("Plan"),this.camera.controls.dollySpeed=6,this.camera.controls.restThreshold=.005,this.update())}get world(){return this._world}set helpersVisible(t){if(!t)return this._helpersVisible=t,this._planeHelper.removeFromParent(),this._farPlaneHelper.removeFromParent(),void this._cameraHelper.removeFromParent();this.world&&(this._helpersVisible=t,this.world.scene.three.add(this._planeHelper,this._farPlaneHelper))}get helpersVisible(){return this._helpersVisible}set planesEnabled(t){const{world:e}=this;if(!e)return;const{renderer:i}=e;i&&(i.setPlane(t,this.plane),i.setPlane(t,this.farPlane),this._planesEnabled=t)}get planesEnabled(){return this._planesEnabled}dispose(){this.helpersVisible=!1;const t=this._components.get(Lt);t.destroy(this._planeHelper),t.destroy(this._farPlaneHelper),t.destroy(this._cameraHelper),this.camera.dispose(),this.onDisposed.trigger()}update(){if(this.world){const t=this._cameraPosition,e=this._planePosition;this.camera.controls.setLookAt(t.x,t.y,t.z,e.x,e.y,e.z,!1)}this.farPlane.normal.copy(this._planeNormalOpposite),this.farPlane.constant=this.range-this.plane.constant,this.onUpdated.trigger()}flip(){this.plane.normal.negate(),this.update()}}const ua=class t extends Ot{constructor(e){super(e),Pt(this,"list",new s),Pt(this,"enabled",!0),Pt(this,"world",null),Pt(this,"_fragmentsUpdateEvent",()=>{this.components.get(pi).core.update(!0)}),e.add(t.uuid,this),this.setupEvents()}get hasOpenViews(){return[...this.list.values()].some(t=>t.open)}setupEvents(){this.list.onBeforeDelete.add(({key:t,value:e})=>{e.open&&this.close(t),e.dispose()})}create(t,e,i){const s=new da(this.components,{id:null==i?void 0:i.id,normal:t,point:e});return s.world=(null==i?void 0:i.world)??this.world,this.list.set(s.id,s),s}createFromPlane(t,e){const i=new da(this.components,{id:null==e?void 0:e.id});return i.plane.copy(t),i.update(),i.world=(null==e?void 0:e.world)??this.world,this.list.set(i.id,i),i}async createFromIfcStoreys(t){const e=[],i=this.components.get(pi),s=void 0===(null==t?void 0:t.offset)?.25:t.offset;for(const[n,r]of i.list){if(t&&t.modelIds&&!t.modelIds.some(t=>t.test(n)))continue;const i=Object.values(await r.getItemsOfCategories([/BUILDINGSTOREY/])).flat();if(0===i.length)continue;const a=await r.getItemsData(i),[,l]=await r.getCoordinates(),h=new o.Vector3(0,-1,0);for(const i of a){if(!("value"in i.Name)||!("value"in i.Elevation))continue;const{value:n}=i.Name;if(null!=t&&t.storeyNames&&!t.storeyNames.some(t=>t.test(n)))continue;const r=i.Elevation.value+l+s,a=new o.Plane(h,r),c=this.createFromPlane(a,{id:n,world:null==t?void 0:t.world});e.push(c)}}return e}createElevations(t){const e=[],i=this.components.get(pi),s=void 0!==(null==t?void 0:t.combine)&&t.combine,n=(null==t?void 0:t.namingCallback)??(t=>({front:""+(s?"Front":`${t}: Front`),back:""+(s?"Back":`${t}: Back`),left:""+(s?"Left":`${t}: Left`),right:""+(s?"Right":`${t}: Right`)}));let r=[];for(const[e,s]of i.list)t&&t.modelIds&&!t.modelIds.some(t=>t.test(e))||r.push({id:e,box:s.box});if(s){const t=this.components.get(_i);t.list.clear(),t.list.add(...r.map(t=>t.box)),r=[{id:"combined",box:t.get()}]}for(const{id:i,box:s}of r){const{min:r,max:a}=s,l=Math.abs(a.x-r.x),h=Math.abs(a.z-r.z),c=new o.Vector3;s.getCenter(c);const d=new o.Plane(new o.Vector3(0,0,-1),a.z),u=new o.Plane(new o.Vector3(0,0,1),-r.z),p=new o.Plane(new o.Vector3(-1,0,0),a.x),f=new o.Plane(new o.Vector3(1,0,0),-r.x),{front:m,back:g,left:v,right:_}=n(i),y=this.createFromPlane(d,{id:m,world:null==t?void 0:t.world});y.range=h;const w=this.createFromPlane(u,{id:g,world:null==t?void 0:t.world});w.range=h;const b=this.createFromPlane(p,{id:v,world:null==t?void 0:t.world});b.range=l;const x=this.createFromPlane(f,{id:_,world:null==t?void 0:t.world});x.range=l,e.push(y,w,b,x)}return e}open(t){const e=this.list.get(t);if(!e)throw new Error(`Views: the view with id ${t} doesn't exist.`);if(e.open)return;const{world:i}=e;if(!i)throw new Error(`Views: no world found for view with id ${t}.`);const{renderer:s}=i;if(!s)throw new Error(`Views: no renderer found for world with id ${i.uuid}.`);for(const[,t]of this.list)t.world===i&&this.close(t.id);s.setPlane(!0,e.plane),s.setPlane(!0,e.farPlane),e.camera.controls.addEventListener("rest",this._fragmentsUpdateEvent),i.camera=e.camera,e.open=!0}close(t){let e;if(e=t?this.list.get(t):[...this.list.values()].find(t=>t.open),t&&!e)throw new Error(`Views: the view with id ${t} doesn't exist.`);if(!e||!e.open)return;const{world:i}=e;if(!i)throw new Error(`Views: no world found for view with id ${t}.`);const{renderer:s}=i;if(!s)throw new Error(`Views: no renderer found for world with id ${i.uuid}.`);s.setPlane(!1,e.plane),s.setPlane(!1,e.farPlane),e.camera.controls.removeEventListener("rest",this._fragmentsUpdateEvent),i.useDefaultCamera(),e.open=!1}};Pt(ua,"uuid","fb22f1f5-6598-4664-a11d-de8963ae420f"),Pt(ua,"defaultRange",15);let pa=ua;class fa{constructor(t){Pt(this,"cardinality","required"),Pt(this,"instructions"),Pt(this,"evalRequirement",(t,e,i,s)=>{const n={parameter:i,currentValue:t,requiredValue:e,pass:!1};s&&this.addCheckResult(n,s);let r=!1;if("simple"===e.type&&(r=t===e.parameter),"enumeration"===e.type&&(r=e.parameter.includes(t)),"pattern"===e.type&&(r=new RegExp(e.parameter).test(String(t))),"length"===e.type){const{min:i,length:s,max:n}=e.parameter;void 0!==s&&(r=String(t).length===s),void 0!==i&&(r=String(t).length>=i),void 0!==n&&(r=String(t).length<=n)}if("bounds"===e.type&&"number"==typeof t){const{min:i,minInclusive:s,max:n,maxInclusive:o}=e.parameter;let a=!0,l=!0;void 0!==i&&(a=s?t>=i:t>i),void 0!==n&&(l=o?t<=n:t<n),r=a&&l}return"prohibited"===this.cardinality&&(r=!r),"optional"===this.cardinality&&(r=!0),n.pass=r,n.pass}),this._components=t}addCheckResult(t,e){const i=e.findIndex(({parameter:e})=>e===t.parameter);-1!==i?e[i]=t:e.push(t)}getItemChecks(t,e,s,n){if(!("value"in s._localId)||"number"!=typeof s._localId.value)return null;let r=t.get(e);r||(r=new i.DataMap,t.set(e,r));let o=r.get(s._localId.value);if(o&&n&&!o.pass)return null;if(!o){const t=[];o={guid:Array.isArray(s._guid)?void 0:s._guid.value,pass:!1,checks:t},Object.defineProperty(o,"pass",{get:()=>t.every(({pass:t})=>t)}),r.set(s._localId.value,o)}const a=[],l={facetType:this.facetType,cardinality:this.cardinality,checks:a,pass:!1};return Object.defineProperty(l,"pass",{get:()=>a.every(({pass:t})=>t)}),o.checks.push(l),l.checks}}const ma=(t,e)=>{let i="";if(!e)return i;if("simple"===e.type&&(i=`<simpleValue>${e.parameter}</simpleValue>`),"enumeration"===e.type&&(i=`<xs:restriction base="xs:string">\n    ${e.parameter.map(t=>`<xs:enumeration value="${t}" />`).join("\n")}\n    </xs:restriction>`),"pattern"===e.type&&(i=`<xs:restriction base="xs:string">\n      <xs:pattern value="${e.parameter}" />\n    </xs:restriction>`),"bounds"===e.type){const{min:t,minInclusive:s,max:n,maxInclusive:r}=e.parameter;let o="";void 0!==t&&(o=`<xs:min${s?"Inclusive":"Exclusive"} value="${t}">`);let a="";void 0!==n&&(a=`<xs:max${r?"Inclusive":"Exclusive"} value="${n}">`),i=`<xs:restriction base="xs:double">\n      ${o}\n      ${a}\n    </xs:restriction>`}if("length"===e.type){const{length:t,min:s,max:n}=e.parameter;let r="";void 0!==t&&void 0===s&&void 0===n&&(r=`<xs:length value="${t}" />`);let o="";void 0!==s&&void 0===t&&(o=`<xs:minLength value="${s}" />`);let a="";void 0!==n&&void 0===t&&(a=`<xs:maxLength value="${n}" />`),i=`<xs:restriction base="xs:string">\n      ${r}\n      ${o}\n      ${a}\n    </xs:restriction>`}return`<${t[0].toLowerCase()+t.slice(1)}>\n    ${i}\n  </${t[0].toLowerCase()+t.slice(1)}>`};class ga extends fa{constructor(t,e){super(t),Pt(this,"facetType","Attribute"),Pt(this,"name"),Pt(this,"value"),this.name=e}serialize(t){const e=ma("Name",this.name),i=ma("Value",this.value);let s="";return"requirement"===t&&(s+=`cardinality="${this.cardinality}"`,s+=this.instructions?`instructions="${this.instructions}"`:""),`<attribute ${s}>\n  ${e}\n  ${i}\n</attribute>`}async getEntities(){}async test(t,e,i={skipIfFails:!0}){const s=this._components.get(pi);for(const[n,r]of Object.entries(t)){const t=s.list.get(n);if(!t)continue;const o=await t.getItemsData([...r]);for(const t of o){const s=this.getItemChecks(e,n,t,i.skipIfFails);if(!s)continue;const r=Object.keys(t).filter(e=>{const i=this.evalRequirement(e,this.name,"Name");if(!i)return!1;const s=t[e];return!!Array.isArray(s)||(null===s||null===s.value?"optional"===this.cardinality||"prohibited"===this.cardinality:!(Array.isArray(s.value)&&0===s.value.length||"string"==typeof s.value&&""===s.value.trim())&&i)}),o=r.length>0;if(s.push({parameter:"Name",currentValue:o?r[0]:null,requiredValue:this.name,pass:"prohibited"===this.cardinality?!o:o}),this.value)if(r[0]){const e=t[r[0]];Array.isArray(e)||Array.isArray(e.value)?s.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:"prohibited"===this.cardinality}):this.evalRequirement(e.value,this.value,"Value",s)}else s.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:"prohibited"===this.cardinality})}}}}class va extends fa{constructor(t,e){super(t),Pt(this,"facetType","Classification"),Pt(this,"system"),Pt(this,"value"),Pt(this,"uri"),this.system=e}serialize(t){const e=ma("System",this.system),i=ma("Value",this.value);let s="";return"requirement"===t&&(s+=`cardinality="${this.cardinality}"`,s+=this.uri?`uri=${this.uri}`:"",s+=this.instructions?`instructions="${this.instructions}"`:""),`<classification ${s}>\n  ${e}\n  ${i}\n</classification>`}async getEntities(t,e){}async test(t,e){}}class _a extends fa{constructor(t,e){super(t),Pt(this,"facetType","Entity"),Pt(this,"name"),Pt(this,"predefinedType"),this.name=e}serialize(t){const e=ma("Name",this.name),i=ma("Name",this.predefinedType);let s="";return"requirement"===t&&(s+=`cardinality="${this.cardinality}"`,s+=this.instructions?`instructions="${this.instructions}"`:""),`<entity ${s}>\n  ${e}\n  ${i}\n</entity>`}async getEntities(t,e){const i=this._components.get(pi),s=new Map;for(const[e,n]of i.list){if(!t.find(t=>t.test(e)))continue;const i=await n.getCategories();for(const t of i){if(!await this.evalName(t))continue;let i=s.get(e);i||(i=[],s.set(e,i)),i.push(t)}}const n={};if(await Promise.all(Array.from(s.entries()).map(async([t,e])=>{const s=i.list.get(t);if(!s)return;const r=e.map(t=>new RegExp(`^${t}$`)),o=await s.getItemsOfCategories(r),a=Object.values(o).flat();n[t]=new Set(a)})),this.predefinedType)for(const[t,s]of Object.entries(n)){const n=i.list.get(t);if(!n)continue;const r=await n.getItemsData([...s]);for(const i of r)"value"in i._localId&&await this.evalPredefinedType(t,i)&&ri.append(e,t,i._localId.value)}else ri.add(e,n)}async test(t,e,i){const s=this._components.get(pi);for(const[n,r]of Object.entries(t)){const t=s.list.get(n);if(!t)continue;const o=await t.getItemsData([...r]);for(const t of o){if(!("value"in t._category))continue;const s=this.getItemChecks(e,n,t,i.skipIfFails);s&&(await this.evalName(t._category.value,s),await this.evalPredefinedType(n,t,s))}}}async evalName(t,e){return this.evalRequirement(t,this.name,"Name",e)}async evalPredefinedType(t,e,i){if(!this.predefinedType||!("value"in e.PredefinedType))return null;const s="string"==typeof this.predefinedType.parameter&&"USERDEFINED"===this.predefinedType.parameter;let n=e.PredefinedType.value;if("USERDEFINED"===n&&!s){const t=Object.keys(e).find(t=>/^((?!Predefined).)*Type$/.test(t));if(t){const i=e[t];"value"in i&&(n=i.value)}else n="USERDEFINED"}if(!n){const i=this._components.get(pi).list.get(t);if(i&&"value"in e._localId){const[t]=await i.getItemsData([e._localId.value],{relations:{IsTypedBy:{attributes:!0,relations:!1}}});if(Array.isArray(t.IsTypedBy)){const e=t.IsTypedBy[0];if(e&&"value"in e.PredefinedType&&(n=e.PredefinedType.value,"USERDEFINED"===n&&!s)){const t=Object.keys(e).find(t=>/^((?!Predefined).)*Type$/.test(t));if(t){const i=e[t];"value"in i&&(n=i.value)}else n="USERDEFINED"}}}}return this.evalRequirement(n,this.predefinedType,"PredefinedType",i)}}class ya extends fa{constructor(t,e,i){super(t),Pt(this,"facetType","Property"),Pt(this,"propertySet"),Pt(this,"baseName"),Pt(this,"value"),Pt(this,"dataType"),Pt(this,"uri"),Pt(this,"_unsupportedTypes",["IFCCOMPLEXPROPERTY","IFCPHYSICALCOMPLEXQUANTITY"]),this.propertySet=e,this.baseName=i}serialize(t){const e=ma("PropertySet",this.propertySet),i=ma("BaseName",this.baseName),s=ma("Value",this.value),n=this.dataType?`dataType=${this.dataType}`:"";let r="";return"requirement"===t&&(r+=`cardinality="${this.cardinality}"`,r+=this.uri?`uri=${this.uri}`:"",r+=this.instructions?`instructions="${this.instructions}"`:""),`<property ${n} ${r}>\n  ${e}\n  ${i}\n  ${s}\n</property>`}async getEntities(t,e){const i=this._components.get(pi);for(const[s,n]of i.list){if(!t.find(t=>t.test(s)))continue;const i=await n.getItemsOfCategories([/PROPERTYSET/,/ELEMENTQUANTITY/]),r=Object.values(i).flat();if(0===r.length)continue;const o=await n.getItemsData(r,{relations:{HasProperties:{attributes:!0,relations:!1},DefinesOcurrence:{attributes:!0,relations:!1}}});for(const t of o){if(!("value"in t._localId&&"value"in t._category&&"value"in t.Name&&Array.isArray(t.DefinesOcurrence)&&this.evalRequirement(t.Name.value,this.propertySet,"PropertySet")))continue;let i;if("IFCPROPERTYSET"===t._category.value&&(i="HasProperties"),"IFCELEMENTQUANTITY"===t._category.value&&(i="Quantities"),!i)continue;const n=t[i];if(Array.isArray(n))for(const i of n){const n=Object.keys(i),r=n.find(t=>/Name/.test(t));if(!r||!("value"in i[r]))continue;const o=i[r];if(!("value"in o)||!this.evalRequirement(o.value,this.baseName,"BaseName"))continue;if(this.value){const t=n.find(t=>/Value/.test(t));if(!t)continue;const e=i[t];if(!("value"in e)||!this.evalRequirement(e.value,this.value,"Value"))continue}const a=t.DefinesOcurrence.map(t=>"value"in t._localId&&"number"==typeof t._localId.value?t._localId.value:null).filter(t=>null!==t);ri.append(e,s,...a)}}}}async test(t,e,i={skipIfFails:!0}){const s=this._components.get(pi);for(const[n,r]of Object.entries(t)){const t=s.list.get(n);if(!t)continue;const o=await t.getItemsData([...r],{relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1},HasPropertySets:{attributes:!0,relations:!0},DefinesOcurrence:{attributes:!1,relations:!1}}});for(const t of o){const s=this.getItemChecks(e,n,t,i.skipIfFails);if(!s)continue;const r=(await this.getPsets(t)).filter(t=>!(!("value"in t.Name)||!this.evalRequirement(t.Name.value,this.propertySet,"PropertySet"))&&(s.push({currentValue:t.Name.value,parameter:"PropertySet",pass:!0,requiredValue:this.propertySet}),!0));if(0!==r.length)for(const t of r){const e=this.getPropertyListName(t);if(!e)continue;const i=t[e];if(!Array.isArray(i)){s.push({currentValue:null,parameter:"BaseName",pass:!1,requiredValue:this.baseName});continue}const n=i.filter(t=>!(!("value"in t._category)||!("value"in t.Name)||this._unsupportedTypes.includes(t._category.value)||!this.evalRequirement(t.Name.value,this.baseName,"BaseName"))&&(s.push({currentValue:t.Name.value,parameter:"BaseName",pass:!0,requiredValue:this.baseName}),!0));if(0!==n.length)for(const t of n)this.evalValue(t,s),this.evalDataType(t,s),this.evalURI();else s.push({currentValue:null,parameter:"BaseName",pass:!1,requiredValue:this.baseName})}else s.push({currentValue:null,parameter:"PropertySet",pass:!1,requiredValue:this.propertySet})}}}getPropertyListName(t){let e;return"value"in t._category&&("IFCPROPERTYSET"===t._category.value&&(e="HasProperties"),"IFCELEMENTQUANTITY"===t._category.value&&(e="Quantities")),e}getValueKey(t){return Object.keys(t).find(t=>/Value/.test(t)||/Values/.test(t))}getTypePsets(t){if(!Array.isArray(t.IsTypedBy))return[];const[e]=t.IsTypedBy;return e&&Array.isArray(e.HasPropertySets)?e.HasPropertySets:[]}async getPsets(t){const e=this.getTypePsets(t);if(!Array.isArray(t.IsDefinedBy))return e;const i=[];for(const s of t.IsDefinedBy){if(!("value"in s.Name))continue;const t=s.Name.value,n=this.getPropertyListName(s);if(!t||!n)continue;const r=e.find(e=>"value"in e.Name&&e.Name.value===t);if(r&&Array.isArray(r.HasProperties)&&Array.isArray(s.HasProperties))for(const t of r.HasProperties){if(!("value"in t.Name))continue;const e=t.Name.value;s.HasProperties.find(t=>"value"in t.Name&&t.Name.value===e)||s.HasProperties.push(t)}i.push(s)}return i}evalValue(t,e){const i=this.getValueKey(t),s=t[i];if(!("value"in s))return!1;if(this.value){if(!i)return null==e||e.push({parameter:"Value",currentValue:null,pass:!1,requiredValue:this.value}),!1;const t=structuredClone(this.value);return"IFCLABEL"===s.type&&"simple"===t.type&&(t.parameter=String(t.parameter)),this.evalRequirement(s.value,t,"Value",e)}return!i||"string"!=typeof s.value||""!==s.value.trim()||(null==e||e.push({parameter:"Value",currentValue:"",pass:!1,requiredValue:this.value}),!1)}evalDataType(t,e){if(!this.dataType)return!0;const i=this.getValueKey(t);if(!i||!("value"in t[i]))return null==e||e.push({parameter:"DataType",currentValue:null,pass:!1,requiredValue:this.dataType}),!1;const s=t[i];return this.evalRequirement(s.type??null,{type:"simple",parameter:this.dataType},"DataType",e)}evalURI(){return!0}}class wa extends fa{constructor(){super(...arguments),Pt(this,"_ifcMaterialEntities",[/^IFCMATERIALLAYERSETUSAGE$/,/^IFCMATERIALCONSTITUENTSET$/,/^IFCMATERIAL$/,/^IFCMATERIALLIST$/]),Pt(this,"facetType","Material"),Pt(this,"value"),Pt(this,"uri")}serialize(t){if(!this.value||!this.uri)return"<material />";const e=ma("Value",this.value);let i="";return"requirement"===t&&(i+=`cardinality="${this.cardinality}"`,i+=this.uri?`uri=${this.uri}`:"",i+=this.instructions?`instructions="${this.instructions}"`:""),`<material ${i}>\n  ${e}\n</material>`}async getEntities(t,e){const i=this._components.get(pi);for(const[s,n]of i.list){if(!t.find(t=>t.test(s)))continue;const i=await n.getItemsOfCategories(this._ifcMaterialEntities),r=Object.values(i).flat();if(0===r.length)continue;const o=await n.getItemsData(r,{relations:{AssociatedTo:{attributes:!0,relations:!1},MaterialConstituents:{attributes:!0,relations:!0},ForLayerSet:{attributes:!0,relations:!0},MaterialLayers:{attributes:!0,relations:!0},Materials:{attributes:!0,relations:!1}}});for(const t of o){if(!("value"in t._localId&&"value"in t._category&&Array.isArray(t.AssociatedTo)&&this.hasValidMaterial(t)))continue;const i=t.AssociatedTo.map(t=>"value"in t._localId&&t._localId.value?t._localId.value:null).filter(t=>null!==t);ri.append(e,s,...i)}}}async test(t,e,i={skipIfFails:!0}){const s=this._components.get(pi);for(const[n,r]of Object.entries(t)){const t=s.list.get(n);if(!t)continue;const o=await t.getItemsData([[...r][0]],{relations:{AssociatedTo:{attributes:!1,relations:!1},HasAssociations:{attributes:!0,relations:!0},MaterialConstituents:{attributes:!0,relations:!0},ForLayerSet:{attributes:!0,relations:!0},MaterialLayers:{attributes:!0,relations:!0},Materials:{attributes:!0,relations:!1}}});for(const t of o){const s=this.getItemChecks(e,n,t,i.skipIfFails);if(s){if(!Array.isArray(t.HasAssociations)){s.push({parameter:null,currentValue:null,requiredValue:this.value,pass:!1});continue}for(const e of t.HasAssociations)if(this._ifcMaterialEntities.some(t=>"value"in e._category&&t.test(e._category.value))&&this.hasValidMaterial(e,s))break}}}}hasValidMaterial(t,e){let i=!1;if("value"in t._category&&"IFCMATERIAL"===t._category.value)this.evalValue(t,e)&&(i=!0);else for(const[s,n]of Object.entries(t))if(["ForLayerSet","MaterialLayers","Material","MaterialConstituents","Materials"].includes(s)&&Array.isArray(n))for(const t of n)if("value"in t._category&&"IFCMATERIAL"===t._category.value){if(this.evalValue(t,e)){i=!0;break}}else if(this.hasValidMaterial(t)){i=!0;break}return i}evalValue(t,e){if(!this.value)return null==e||e.push({parameter:null,currentValue:t.Name&&"value"in t.Name?t.Name.value:null,pass:!0}),!0;if(!("value"in t._category)||"IFCMATERIAL"!==t._category.value)return null;let i=!1;return t.Name&&"value"in t.Name&&(i=this.evalRequirement(t.Name.value,this.value,"Value",e)),i||(t.Category&&"value"in t.Category&&(i=this.evalRequirement(t.Category.value,this.value,"Value",e)),i)}}class ba extends fa{constructor(t,e){super(t),Pt(this,"facetType","PartOf"),Pt(this,"_entityFacet"),Pt(this,"_entity"),Pt(this,"relation"),Pt(this,"cardinality","required"),this._entity=e,this._entityFacet=new _a(t,e.name),this._entityFacet.predefinedType=e.predefinedType}set entity(t){this._entity=t;const{name:e,predefinedType:i}=t;this._entityFacet=new _a(this._components,e),this._entityFacet.predefinedType=i}get entity(){return this._entity}serialize(){return""}async getEntities(t,e){}async test(t){}}class xa{constructor(t,e,s){Pt(this,"name"),Pt(this,"ifcVersion",new Set),Pt(this,"identifier",Bt.create()),Pt(this,"description"),Pt(this,"instructions"),Pt(this,"requirementsDescription"),Pt(this,"applicability",new i.DataSet),Pt(this,"requirements",new i.DataSet),Pt(this,"components"),this.components=t,this.name=e;for(const t of s)this.ifcVersion.add(t)}set(t){const e=t,i=this;for(const s in t){if("identifier"===s)continue;const t=e[s];s in this&&(i[s]=t)}return this.components.get(Da).list.set(this.identifier,this),this}async test(t,e={skipIfFails:!0}){const s=new i.DataMap;if(0===this.requirements.size)return s;const n={},r=[];for(const e of this.applicability)r.push(e.getEntities(t,n));await Promise.all(r);const o=[];for(const t of this.requirements)o.push(t.test(n,s,e));return await Promise.all(o),s}serialize(){const t=`name="${this.name}"`,e=this.identifier?`identifier="${this.identifier}"`:"",i=this.description?`description="${this.description}"`:"",s=this.instructions?`instructions="${this.instructions}"`:"";return`<specification ifcVersion="${[...this.ifcVersion].join(" ")}" ${t} ${e} ${i} ${s}>\n      <applicability minOccurs="1" maxOccurs="unbounded">\n        ${[...this.applicability].map(t=>t.serialize("applicability")).join("\n")}\n      </applicability>\n      <requirements>\n        ${[...this.requirements].map(t=>t.serialize("requirement")).join("\n")}\n      </requirements>\n    </specification>`}}const Sa=t=>{if(!t)return;const e={};if("simpleValue"in t&&(e.type="simple",e.parameter=t.simpleValue),"restriction"in t){const i=t.restriction,s=Object.keys(i);if("pattern"in i&&(e.type="pattern",e.parameter=i.pattern.value),"enumeration"in i){e.type="enumeration";const t=i.enumeration.map(({value:t})=>i.base.includes("string")?String(t):i.base.includes("integer")||i.base.includes("double")?Number(t):t);e.parameter=t}if(s.some(t=>["minInclusive","minExclusive","maxInclusive","maxExclusive"].includes(t))){e.type="bounds";const t={},n=s.find(t=>t.includes("min")),r=s.find(t=>t.includes("max"));n&&(t.minInclusive="minInclusive"===n,t.min=i[n].value),r&&(t.maxInclusive="maxInclusive"===r,t.max=i[r].value),e.parameter=t}if(s.some(t=>["minLength","length","maxLength"].includes(t))){e.type="length";const t={};void 0!==i.length&&(t.length=i.length.value),void 0!==i.minLength&&(t.min=i.minLength.value),void 0!==i.maxLength&&(t.max=i.maxLength.value),e.parameter=t}}return void 0!==e.parameter?e:void 0},Ea=(t,e)=>{const i=[];for(const s of e){const e=s.name,n=Sa(e);if(!n)continue;const r=new _a(t,n);s.cardinality&&(r.cardinality=s.cardinality),r.predefinedType=Sa(s.predefinedType),r.instructions=s.instructions,i.push(r)}return i},Ca=(t,e)=>{const i=[];for(const s of e){const e=s.name,n=Sa(e);if(!n)continue;const r=new ga(t,n);s.cardinality&&(r.cardinality=s.cardinality),r.value=Sa(s.value),r.instructions=s.instructions,i.push(r)}return i},Ta=(t,e)=>{const i=[];for(const s of e){const e=new wa(t);s.cardinality&&(e.cardinality=s.cardinality);const n=Sa(s.value);"enumeration"===(null==n?void 0:n.type)&&Array.isArray(n.parameter)&&(n.parameter=n.parameter.map(String)),e.value=n,e.uri=s.uri,e.instructions=s.instructions,i.push(e)}return i},Pa=(t,e)=>{const i=[];for(const s of e){const e=s.propertySet,n=s.baseName,r=Sa(e),o=Sa(n);if(!o||!r)continue;const a=new ya(t,r,o);s.cardinality&&(a.cardinality=s.cardinality);const l=Sa(s.value);a.value=l,a.dataType=s.dataType,a.uri=s.uri,a.instructions=s.instructions,i.push(a)}return i},Aa=(t,e)=>{const i=[];for(const s of e){const e=s.system,n=Sa(e);if(!n)continue;const r=new va(t,n);s.cardinality&&(r.cardinality=s.cardinality);const o=Sa(s.value);"simple"===(null==o?void 0:o.type)&&(o.parameter=String(o.parameter)),"enumeration"===(null==o?void 0:o.type)&&Array.isArray(o.parameter)&&(o.parameter=o.parameter.map(String)),r.value=o,r.uri=s.uri,r.instructions=s.instructions,i.push(r)}return i},Ma=(t,e)=>{const i=[];for(const s of e){const e=Sa(s.entity.name);if(!e)continue;const n=Sa(s.entity.predefinedType),r=new ba(t,{name:e,predefinedType:n});r.relation=s.relation,s.cardinality&&(r.cardinality=s.cardinality),r.instructions=s.instructions,i.push(r)}return i},Oa=class t extends Ot{constructor(e){super(e),Pt(this,"enabled",!0),Pt(this,"IDSInfo"),Pt(this,"list",new s),e.add(t.uuid,this)}getModelIdMap(t){const e={},i={};for(const[s,n]of t){const t=[...n].filter(([,t])=>t.pass).map(([t])=>t);ri.append(e,s,...t);const r=[...n].filter(([,t])=>!t.pass).map(([t])=>t);ri.append(i,s,...r)}return{pass:e,fail:i}}create(t,e,i){const s=new xa(this.components,t,e);return i&&(s.identifier=i),this.list.set(s.identifier,s),s}load(e){const i=[],s=t.xmlParser.parse(e).ids,{specifications:n,info:r}=s;if(this.IDSInfo={...r},n&&n.specification){const t=Array.isArray(n.specification)?n.specification:[n.specification];for(const e of t){const{name:t,ifcVersion:s,description:n,instructions:r,identifier:o}=e;if(!t||!s)continue;const a=[],l=[],{applicability:h,requirements:c}=e;if(h){const{maxOccurs:t,...e}=h,i=Array.isArray(e)?e:[e];for(const t of i)for(const e in t){const i=Array.isArray(t[e])?t[e]:[t[e]];if("entity"===e){const t=Ea(this.components,i);a.push(...t)}if("attribute"===e){const t=Ca(this.components,i);a.push(...t)}if("material"===e){const t=Ta(this.components,i);a.push(...t)}if("classification"===e){const t=Aa(this.components,i);a.push(...t)}if("property"===e){const t=Pa(this.components,i);a.push(...t)}if("partOf"===e){const t=Ma(this.components,i);a.push(...t)}}}let d;if(c){const{maxOccurs:t,...e}=c;d=c.description;const i=Array.isArray(e)?e:[e];for(const t of i)for(const e in t){const i=Array.isArray(t[e])?t[e]:[t[e]];if("entity"===e){const t=Ea(this.components,i);l.push(...t)}if("attribute"===e){const t=Ca(this.components,i);l.push(...t)}if("material"===e){const t=Ta(this.components,i);l.push(...t)}if("classification"===e){const t=Aa(this.components,i);l.push(...t)}if("property"===e){const t=Pa(this.components,i);l.push(...t)}if("partOf"===e){const t=Ma(this.components,i);l.push(...t)}}}const u=this.create(t,s.split(/\s+/),o);u.description=n,u.instructions=r,u.requirementsDescription=d,u.applicability.add(...a),u.requirements.add(...l),i.push(u)}}return i}export(t,e=this.list.values()){const i=e??this.list;return`<ids xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://standards.buildingsmart.org/IDS http://standards.buildingsmart.org/IDS/1.0/ids.xsd" xmlns:ids="http://standards.buildingsmart.org/IDS">\n  \x3c!-- Made with That Open Engine ${lo.release} (https://github.com/thatopen/engine_components) --\x3e\n  <info>\n    <title>${t.title}</title>\n    ${t.copyright?`<copyright>${t.copyright}</copyright>`:""}\n    ${t.version?`<version>${t.version}</version>`:""}\n    ${t.description?`<description>${t.description}</description>`:""}\n    ${t.author?`<author>${t.author}</author>`:""}\n    ${t.date?`<date>${t.date.toISOString().split("T")[0]}</date>`:""}\n    ${t.purpose?`<purpose>${t.purpose}</purpose>`:""}\n    ${t.milestone?`<milestone>${t.milestone}</milestone>`:""}\n  </info>\n  <specifications>\n    ${[...i].map(t=>t.serialize()).join("\n")}\n  </specifications>\n</ids>`}};Pt(Oa,"uuid","9f0b9f78-9b2e-481a-b766-2fbfd01f342c"),Pt(Oa,"xmlParser",new si.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let Da=Oa;const za=class t extends Ot{constructor(e){super(e),Pt(this,"enabled",!0),e.add(t.uuid,this)}static distanceFromPointToLine(t,e,i,s=!1){const n=new o.Line3,r=new o.Vector3;return n.set(e,i),n.closestPointToPoint(t,s,r),r.distanceTo(t)}round(t){t.x=Math.trunc(1e3*t.x)/1e3,t.y=Math.trunc(1e3*t.y)/1e3,t.z=Math.trunc(1e3*t.z)/1e3}async getVolumeFromFragments(t){return console.warn("getVolumeFromFragments is deprecated. Use getItemsVolume instead."),this.getItemsVolume(t)}async getItemsVolume(t){let e=0;const i=this.components.get(pi);for(const[s,n]of Object.entries(t)){const t=i.list.get(s);t&&(e+=await t.getItemsVolume([...n]))}return e}static convertUnits(t,e,i,s=2){const n={m:1,cm:.01,mm:.001,km:1e3,m2:1,cm2:1e-4,mm2:1e-6,km2:1e6,m3:1,cm3:1e-6,mm3:1e-9,km3:1e9};if(!n[e]||!n[i])throw new Error("Invalid units provided for conversion.");if(!Number.isInteger(s)||s<0||s>5)throw new Error("Precision must be an integer between 0 and 5.");const r=t*(n[e]/n[i]),o=10**s;return Math.round(r*o)/o}};Pt(za,"uuid","267ca032-672f-4cb0-afa9-d24e904f39d6");let Ia=za;const ka=class t extends Ot{constructor(i){super(i),e(this,"enabled",!0),e(this,"inputs",["OBC","BUI"]),e(this,"_requestEventID","thatOpenCompanyComponentRequested"),e(this,"_createEventID","thatOpenCompanyComponentCreated"),i.add(t.uuid,this)}async import(t){return new Promise(e=>{const i=document.createElement("script"),s=`\n        function loader() {\n          const { ${this.inputs} } = window.ThatOpenCompany;\n        \n          ${t}\n        \n          const onComponentRequested = () => {\n            window.removeEventListener("${this._requestEventID}", onComponentRequested);\n            const event = new CustomEvent("${this._createEventID}", { detail: main });\n            window.dispatchEvent(event);\n          };\n          \n          window.addEventListener("${this._requestEventID}", onComponentRequested);\n        }\n        \n        loader();\n      `,n=t=>{window.removeEventListener(this._createEventID,n);const{componentDefinition:s}=t.detail;let r=null;if(s){const t=s;r=this.components.get(t)}i.remove(),e(r)};i.addEventListener("load",()=>{window.addEventListener(this._createEventID,n),window.dispatchEvent(new Event(this._requestEventID))}),i.src=URL.createObjectURL(new File([s],"temp.js")),document.head.appendChild(i)})}};e(ka,"uuid","74c0c370-1af8-4ca9-900a-4a4196c0f2f5");let La=ka;class Na extends S{constructor(t=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=t,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.center=new l(.5,.5),this.addEventListener("removed",function(){this.traverse(function(t){t.element instanceof t.element.ownerDocument.defaultView.Element&&null!==t.element.parentNode&&t.element.remove()})})}copy(t,e){return super.copy(t,e),this.element=t.element.cloneNode(!0),this.center=t.center,this}}const Ba=new a,Ua=new g,Ra=new g,Fa=new a,Va=new a;class ja{constructor(t={}){const e=this;let i,s,n,r;const o={objects:new WeakMap},a=void 0!==t.element?t.element:document.createElement("div");function l(t){t.isCSS2DObject&&(t.element.style.display="none");for(let e=0,i=t.children.length;e<i;e++)l(t.children[e])}function h(t,i,s){if(!1!==t.visible){if(t.isCSS2DObject){Ba.setFromMatrixPosition(t.matrixWorld),Ba.applyMatrix4(Ra);const l=Ba.z>=-1&&Ba.z<=1&&!0===t.layers.test(s.layers),h=t.element;h.style.display=!0===l?"":"none",!0===l&&(t.onBeforeRender(e,i,s),h.style.transform="translate("+-100*t.center.x+"%,"+-100*t.center.y+"%)translate("+(Ba.x*n+n)+"px,"+(-Ba.y*r+r)+"px)",h.parentNode!==a&&a.appendChild(h),t.onAfterRender(e,i,s));const d={distanceToCameraSquared:c(s,t)};o.objects.set(t,d)}for(let e=0,n=t.children.length;e<n;e++)h(t.children[e],i,s)}else l(t)}function c(t,e){return Fa.setFromMatrixPosition(t.matrixWorld),Va.setFromMatrixPosition(e.matrixWorld),Fa.distanceToSquared(Va)}a.style.overflow="hidden",this.domElement=a,this.getSize=function(){return{width:i,height:s}},this.render=function(t,e){!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),null===e.parent&&!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),Ua.copy(e.matrixWorldInverse),Ra.multiplyMatrices(e.projectionMatrix,Ua),h(t,t,e),function(t){const e=function(t){const e=[];return t.traverseVisible(function(t){t.isCSS2DObject&&e.push(t)}),e}(t).sort(function(t,e){if(t.renderOrder!==e.renderOrder)return e.renderOrder-t.renderOrder;return o.objects.get(t).distanceToCameraSquared-o.objects.get(e).distanceToCameraSquared}),i=e.length;for(let t=0,s=e.length;t<s;t++)e[t].element.style.zIndex=i-t}(t)},this.setSize=function(t,e){i=t,s=e,n=i/2,r=s/2,a.style.width=t+"px",a.style.height=e+"px"}}}class Ha{constructor(t,i,s){let n;if(e(this,"three"),e(this,"world"),e(this,"wasVisible",!0),e(this,"onDisposed",new At),this.world=t,i)n=i;else{n=document.createElement("div");const t="6px";n.style.color="white",n.style.height=t,n.style.width=t,n.style.borderRadius="50%",n.style.border="2px solid rgb(122, 75, 209)",n.style.zIndex="-20"}this.three=new Na(n),(s||t.scene.three).add(this.three),this.visible=!0}set visible(t){this.three.visible=t,this.wasVisible=t}get visible(){return this.three.visible}toggleVisibility(){this.visible=!this.visible}notDisplay(){this.visible=!1}dispose(){this.three.removeFromParent(),this.three.element.remove(),this.onDisposed.trigger(),this.onDisposed.reset()}}class Wa extends zi{constructor(t,i,s){super(t,i,s),e(this,"three2D",new ja),this.onAfterUpdate.add(()=>{if(this.onBeforeUpdate.trigger(this),!this.enabled||!this.currentWorld)return;const t=this.currentWorld.scene.three,e=this.currentWorld.camera.three;t instanceof o.Scene&&this.three2D.render(t,e)}),this.onDisposed.add(()=>{this.three2D.domElement.remove()}),this.onResize.add(({x:t,y:e})=>{this.three2D.setSize(t,e)}),this.setupHtmlRenderer(),this.resize()}setupHtmlRenderer(){this.three2D.domElement.style.position="absolute",this.three2D.domElement.style.top="0px",this.three2D.domElement.style.pointerEvents="none",this.container&&(this.container.appendChild(this.three2D.domElement),this.container.style.position="relative")}}const Ga=class t extends Ot{constructor(i){super(i),e(this,"onDisposed",new At),e(this,"enabled",!0),e(this,"threshold",50),e(this,"autoCluster",!0),e(this,"clusterElementStyles",{...t.DEFAULT_CLUSTER_STYLES}),e(this,"list",new Map),e(this,"clusterLabels",new Set),e(this,"currentKeys",new Set),e(this,"_color","white"),e(this,"_markerKey",0),e(this,"_clusterKey",0),e(this,"_worldEvents",new Map),e(this,"_setupWorlds",new Set),e(this,"clusterElementFactory",()=>{const t=document.createElement("div");return t.style.color="#000000",t.style.background="#FFFFFF",t.style.fontSize="1.2rem",t.style.fontWeight="500",t.style.borderRadius="50%",t.style.padding="5px 11px",t.style.textAlign="center",t.addEventListener("pointerover",()=>{t.style.background=this.clusterElementStyles.hoverBackgroundColor||"#BCF124"}),t.addEventListener("pointerout",()=>{t.style.background=this.clusterElementStyles.backgroundColor||"#FFFFFF"}),t}),i.add(t.uuid,this)}get color(){return this._color}set color(t){this._color=t;for(const[e,i]of this.list)for(const[e,s]of i)s.label.three.element.style.color=t}create(t,e,i,s=!1){this.setupEvents(t,!0);const n=this._markerKey.toString(),r=this.getWorldMarkerList(t);if(r.has(n))return null;const o=document.createElement("span");o.append(e);const a=new Ha(t,o);return a.three.position.copy(i),r.set(n,{key:n,label:a,merged:!1,static:s}),this._markerKey++,n}delete(t){for(const[e,i]of this.list){const e=i.get(t);e&&e.label.dispose(),i.delete(t)}}getWorldMarkerList(t){return this.list.has(t.uuid)||this.list.set(t.uuid,new Map),this.list.get(t.uuid)}dispose(t){for(const[e,i]of this.list){const e=[...i.keys()];for(const s of e){const e=i.get(s);t&&e.type!==t||(e.label.dispose(),i.delete(s))}}if(!t){this.list.clear(),this._markerKey=0;for(const t of this.clusterLabels)t.label.dispose();this.clusterLabels.clear(),this._clusterKey=0,this.currentKeys.clear()}this.onDisposed.trigger()}setupEvents(t,e){if(e&&this._setupWorlds.has(t.uuid)||!t.camera.hasCameraControls())return;const i=this.getWorldEvent(t);t.camera.controls.removeEventListener("sleep",i),t.camera.controls.removeEventListener("rest",i),e&&(t.camera.controls.addEventListener("sleep",i),t.camera.controls.addEventListener("rest",i))}cluster(t){if(!this.autoCluster)return;this.resetMarkers();const e=this.list.get(t.uuid);if(e){for(const[t,i]of e)if(!i.merged&&!i.static){this.currentKeys.clear();for(const[t,s]of e)s.static||i.key!==s.key&&!s.merged&&this.distance(i.label,s.label)<this.threshold&&(this.currentKeys.add(s.key),s.merged=!0);if(this.currentKeys.size>0){this.currentKeys.add(i.key),i.merged=!0;const t=Array.from(this.currentKeys),e=this.getAveragePositionFromLabels(t),s=new Ha(i.label.world,this.createClusterElement(this._clusterKey.toString())),{element:n}=s.three;n.firstChild.textContent=t.length.toString(),s.three.position.copy(e),this.clusterLabels.add({key:this._clusterKey.toString(),markerKeys:t,label:s}),this._clusterKey++}}this.removeMergeMarkers(t)}}getWorldEvent(t){if(!this._worldEvents.has(t.uuid)){const e=()=>{this.cluster(t)};this._worldEvents.set(t.uuid,e)}return this._worldEvents.get(t.uuid)}resetMarkers(){for(const[t,e]of this.list)for(const[t,i]of e)i.merged=!1;for(const t of this.clusterLabels)t.label.dispose();this.clusterLabels.clear(),this._clusterKey=0}removeMergeMarkers(t){const e=this.list.get(t.uuid);if(e){for(const[t,i]of e)i.merged?i.label.dispose():i.label.world.scene.three.add(i.label.three);for(const t of this.clusterLabels)if(1===t.markerKeys.length){for(const[e,i]of this.list){const e=i.get(t.markerKeys[0]);e&&(e.label.world.scene.three.add(e.label.three),e.merged=!1)}t.label.dispose(),this.clusterLabels.delete(t)}}}getAveragePositionFromLabels(t){const e=t.map(t=>{for(const[e,i]of this.list){const e=i.get(t);if(e)return e.label.three.position}return new o.Vector3});return e.reduce((t,e)=>t.add(e),new o.Vector3).divideScalar(e.length)}createClusterElement(t){const e=this.clusterElementFactory();e.textContent=t;const i=document.createElement("span");return i.append(e),i.style.pointerEvents="auto",i.style.cursor="pointer",i.addEventListener("pointerdown",()=>{this.navigateToCluster(t)}),i}getScreenPosition(t){const e=new o.Vector3;if(!t.world.renderer)throw new Error("Renderer not found!");const i=t.three.position.clone();i.project(t.world.camera.three);const s=t.world.renderer.getSize();return e.x=i.x*s.x/2+s.x/2,e.y=-i.y*s.y/2+s.y/2,e}distance(t,e){const i=this.getScreenPosition(t),s=this.getScreenPosition(e),n=i.x-s.x,r=i.y-s.y,o=.5*Math.sqrt(n*n+r*r);return 0===o?this.threshold+1:o}navigateToCluster(t){const e=[],i=Array.from(this.clusterLabels).find(e=>e.key===t);if(!i)return;const s=i.label.world.camera;if(!s.hasCameraControls())return void console.warn("Zoom to clusters only supported with Camera Controls!");for(const t of i.markerKeys)for(const[i,s]of this.list){const i=s.get(t);if(i){const{x:t,y:s,z:n}=i.label.three.position;e.push(t,s,n)}}i.label.dispose(),this.clusterLabels.delete(i);const n=new o.BufferGeometry,r=new Float32Array(e),a=new o.BufferAttribute(r,3);n.setAttribute("position",a);const l=new o.Mesh(n);l.geometry.computeBoundingSphere(),l.geometry.boundingSphere&&s.controls.fitToSphere(l,!0),n.dispose(),l.clear(),e.length=0}};e(Ga,"uuid","4079eb91-79b0-4ede-bcf2-15b837129236"),e(Ga,"DEFAULT_CLUSTER_STYLES",{backgroundColor:"#FFFFFF",textColor:"#000000",fontSize:"1.2rem",fontWeight:"500",borderRadius:"50%",padding:"5px 11px",textAlign:"center",cursor:"pointer",hoverBackgroundColor:"#BCF124",transition:void 0});let Za=Ga;const Ya={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\n\t\t}"};class Xa{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const qa=new B(-1,1,1,-1,0,1);const Qa=new class extends A{constructor(){super(),this.setAttribute("position",new M([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new M([0,2,0,0,2,0],2))}};class Ka{constructor(t){this._mesh=new u(Qa,t)}dispose(){this._mesh.geometry.dispose()}render(t){t.render(this._mesh,qa)}get material(){return this._mesh.material}set material(t){this._mesh.material=t}}class Ja extends Xa{constructor(t,e="tDiffuse"){super(),this.textureID=e,this.uniforms=null,this.material=null,t instanceof U?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=R.clone(t.uniforms),this.material=new U({name:void 0!==t.name?t.name:"unspecified",defines:Object.assign({},t.defines),uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this._fsQuad=new Ka(this.material)}render(t,e,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this._fsQuad.material=this.material,this.renderToScreen?(t.setRenderTarget(null),this._fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this._fsQuad.render(t))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}class $a extends Xa{constructor(t,e){super(),this.scene=t,this.camera=e,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(t,e,i){const s=t.getContext(),n=t.state;let r,o;n.buffers.color.setMask(!1),n.buffers.depth.setMask(!1),n.buffers.color.setLocked(!0),n.buffers.depth.setLocked(!0),this.inverse?(r=0,o=1):(r=1,o=0),n.buffers.stencil.setTest(!0),n.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),n.buffers.stencil.setFunc(s.ALWAYS,r,4294967295),n.buffers.stencil.setClear(o),n.buffers.stencil.setLocked(!0),t.setRenderTarget(i),this.clear&&t.clear(),t.render(this.scene,this.camera),t.setRenderTarget(e),this.clear&&t.clear(),t.render(this.scene,this.camera),n.buffers.color.setLocked(!1),n.buffers.depth.setLocked(!1),n.buffers.color.setMask(!0),n.buffers.depth.setMask(!0),n.buffers.stencil.setLocked(!1),n.buffers.stencil.setFunc(s.EQUAL,1,4294967295),n.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP),n.buffers.stencil.setLocked(!0)}}class tl extends Xa{constructor(){super(),this.needsSwap=!1}render(t){t.state.buffers.stencil.setLocked(!1),t.state.buffers.stencil.setTest(!1)}}class el{constructor(t,e){if(this.renderer=t,this._pixelRatio=t.getPixelRatio(),void 0===e){const i=t.getSize(new l);this._width=i.width,this._height=i.height,(e=new F(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:V})).texture.name="EffectComposer.rt1"}else this._width=e.width,this._height=e.height;this.renderTarget1=e,this.renderTarget2=e.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new Ja(Ya),this.copyPass.material.blending=j,this.clock=new H}swapBuffers(){const t=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=t}addPass(t){this.passes.push(t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(t,e){this.passes.splice(e,0,t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(t){const e=this.passes.indexOf(t);-1!==e&&this.passes.splice(e,1)}isLastEnabledPass(t){for(let e=t+1;e<this.passes.length;e++)if(this.passes[e].enabled)return!1;return!0}render(t){void 0===t&&(t=this.clock.getDelta());const e=this.renderer.getRenderTarget();let i=!1;for(let e=0,s=this.passes.length;e<s;e++){const s=this.passes[e];if(!1!==s.enabled){if(s.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(e),s.render(this.renderer,this.writeBuffer,this.readBuffer,t,i),s.needsSwap){if(i){const e=this.renderer.getContext(),i=this.renderer.state.buffers.stencil;i.setFunc(e.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,t),i.setFunc(e.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==$a&&(s instanceof $a?i=!0:s instanceof tl&&(i=!1))}}this.renderer.setRenderTarget(e)}reset(t){if(void 0===t){const e=this.renderer.getSize(new l);this._pixelRatio=this.renderer.getPixelRatio(),this._width=e.width,this._height=e.height,(t=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(t,e){this._width=t,this._height=e;const i=this._width*this._pixelRatio,s=this._height*this._pixelRatio;this.renderTarget1.setSize(i,s),this.renderTarget2.setSize(i,s);for(let t=0;t<this.passes.length;t++)this.passes[t].setSize(i,s)}setPixelRatio(t){this._pixelRatio=t,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}const il={defines:{PERSPECTIVE_CAMERA:1,SAMPLES:16,NORMAL_VECTOR_TYPE:1,DEPTH_SWIZZLING:"x",SCREEN_SPACE_RADIUS:0,SCREEN_SPACE_RADIUS_SCALE:100,SCENE_CLIP_BOX:0},uniforms:{tNormal:{value:null},tDepth:{value:null},tNoise:{value:null},resolution:{value:new l},cameraNear:{value:null},cameraFar:{value:null},cameraProjectionMatrix:{value:new g},cameraProjectionMatrixInverse:{value:new g},cameraWorldMatrix:{value:new g},radius:{value:.25},distanceExponent:{value:1},thickness:{value:1},distanceFallOff:{value:1},scale:{value:1},sceneBoxMin:{value:new a(-1,-1,-1)},sceneBoxMax:{value:new a(1,1,1)}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}",fragmentShader:"\n\t\tvarying vec2 vUv;\n\t\tuniform highp sampler2D tNormal;\n\t\tuniform highp sampler2D tDepth;\n\t\tuniform sampler2D tNoise;\n\t\tuniform vec2 resolution;\n\t\tuniform float cameraNear;\n\t\tuniform float cameraFar;\n\t\tuniform mat4 cameraProjectionMatrix;\n\t\tuniform mat4 cameraProjectionMatrixInverse;\n\t\tuniform mat4 cameraWorldMatrix;\n\t\tuniform float radius;\n\t\tuniform float distanceExponent;\n\t\tuniform float thickness;\n\t\tuniform float distanceFallOff;\n\t\tuniform float scale;\n\t\t#if SCENE_CLIP_BOX == 1\n\t\t\tuniform vec3 sceneBoxMin;\n\t\t\tuniform vec3 sceneBoxMax;\n\t\t#endif\n\n\t\t#include <common>\n\t\t#include <packing>\n\n\t\t#ifndef FRAGMENT_OUTPUT\n\t\t#define FRAGMENT_OUTPUT vec4(vec3(ao), 1.)\n\t\t#endif\n\n\t\tvec3 getViewPosition(const in vec2 screenPosition, const in float depth) {\n\t\t\tvec4 clipSpacePosition = vec4(vec3(screenPosition, depth) * 2.0 - 1.0, 1.0);\n\t\t\tvec4 viewSpacePosition = cameraProjectionMatrixInverse * clipSpacePosition;\n\t\t\treturn viewSpacePosition.xyz / viewSpacePosition.w;\n\t\t}\n\n\t\tfloat getDepth(const vec2 uv) {\n\t\t\treturn textureLod(tDepth, uv.xy, 0.0).DEPTH_SWIZZLING;\n\t\t}\n\n\t\tfloat fetchDepth(const ivec2 uv) {\n\t\t\treturn texelFetch(tDepth, uv.xy, 0).DEPTH_SWIZZLING;\n\t\t}\n\n\t\tfloat getViewZ(const in float depth) {\n\t\t\t#if PERSPECTIVE_CAMERA == 1\n\t\t\t\treturn perspectiveDepthToViewZ(depth, cameraNear, cameraFar);\n\t\t\t#else\n\t\t\t\treturn orthographicDepthToViewZ(depth, cameraNear, cameraFar);\n\t\t\t#endif\n\t\t}\n\n\t\tvec3 computeNormalFromDepth(const vec2 uv) {\n\t\t\tvec2 size = vec2(textureSize(tDepth, 0));\n\t\t\tivec2 p = ivec2(uv * size);\n\t\t\tfloat c0 = fetchDepth(p);\n\t\t\tfloat l2 = fetchDepth(p - ivec2(2, 0));\n\t\t\tfloat l1 = fetchDepth(p - ivec2(1, 0));\n\t\t\tfloat r1 = fetchDepth(p + ivec2(1, 0));\n\t\t\tfloat r2 = fetchDepth(p + ivec2(2, 0));\n\t\t\tfloat b2 = fetchDepth(p - ivec2(0, 2));\n\t\t\tfloat b1 = fetchDepth(p - ivec2(0, 1));\n\t\t\tfloat t1 = fetchDepth(p + ivec2(0, 1));\n\t\t\tfloat t2 = fetchDepth(p + ivec2(0, 2));\n\t\t\tfloat dl = abs((2.0 * l1 - l2) - c0);\n\t\t\tfloat dr = abs((2.0 * r1 - r2) - c0);\n\t\t\tfloat db = abs((2.0 * b1 - b2) - c0);\n\t\t\tfloat dt = abs((2.0 * t1 - t2) - c0);\n\t\t\tvec3 ce = getViewPosition(uv, c0).xyz;\n\t\t\tvec3 dpdx = (dl < dr) ? ce - getViewPosition((uv - vec2(1.0 / size.x, 0.0)), l1).xyz : -ce + getViewPosition((uv + vec2(1.0 / size.x, 0.0)), r1).xyz;\n\t\t\tvec3 dpdy = (db < dt) ? ce - getViewPosition((uv - vec2(0.0, 1.0 / size.y)), b1).xyz : -ce + getViewPosition((uv + vec2(0.0, 1.0 / size.y)), t1).xyz;\n\t\t\treturn normalize(cross(dpdx, dpdy));\n\t\t}\n\n\t\tvec3 getViewNormal(const vec2 uv) {\n\t\t\t#if NORMAL_VECTOR_TYPE == 2\n\t\t\t\treturn normalize(textureLod(tNormal, uv, 0.).rgb);\n\t\t\t#elif NORMAL_VECTOR_TYPE == 1\n\t\t\t\treturn unpackRGBToNormal(textureLod(tNormal, uv, 0.).rgb);\n\t\t\t#else\n\t\t\t\treturn computeNormalFromDepth(uv);\n\t\t\t#endif\n\t\t}\n\n\t\tvec3 getSceneUvAndDepth(vec3 sampleViewPos) {\n\t\t\tvec4 sampleClipPos = cameraProjectionMatrix * vec4(sampleViewPos, 1.);\n\t\t\tvec2 sampleUv = sampleClipPos.xy / sampleClipPos.w * 0.5 + 0.5;\n\t\t\tfloat sampleSceneDepth = getDepth(sampleUv);\n\t\t\treturn vec3(sampleUv, sampleSceneDepth);\n\t\t}\n\n\t\tvoid main() {\n\t\t\tfloat depth = getDepth(vUv.xy);\n\t\t\tif (depth >= 1.0) {\n\t\t\t\tdiscard;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvec3 viewPos = getViewPosition(vUv, depth);\n\t\t\tvec3 viewNormal = getViewNormal(vUv);\n\n\t\t\tfloat radiusToUse = radius;\n\t\t\tfloat distanceFalloffToUse = thickness;\n\t\t\t#if SCREEN_SPACE_RADIUS == 1\n\t\t\t\tfloat radiusScale = getViewPosition(vec2(0.5 + float(SCREEN_SPACE_RADIUS_SCALE) / resolution.x, 0.0), depth).x;\n\t\t\t\tradiusToUse *= radiusScale;\n\t\t\t\tdistanceFalloffToUse *= radiusScale;\n\t\t\t#endif\n\n\t\t\t#if SCENE_CLIP_BOX == 1\n\t\t\t\tvec3 worldPos = (cameraWorldMatrix * vec4(viewPos, 1.0)).xyz;\n\t\t\t\tfloat boxDistance = length(max(vec3(0.0), max(sceneBoxMin - worldPos, worldPos - sceneBoxMax)));\n\t\t\t\tif (boxDistance > radiusToUse) {\n\t\t\t\t\tdiscard;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t#endif\n\n\t\t\tvec2 noiseResolution = vec2(textureSize(tNoise, 0));\n\t\t\tvec2 noiseUv = vUv * resolution / noiseResolution;\n\t\t\tvec4 noiseTexel = textureLod(tNoise, noiseUv, 0.0);\n\t\t\tvec3 randomVec = noiseTexel.xyz * 2.0 - 1.0;\n\t\t\tvec3 tangent = normalize(vec3(randomVec.xy, 0.));\n\t\t\tvec3 bitangent = vec3(-tangent.y, tangent.x, 0.);\n\t\t\tmat3 kernelMatrix = mat3(tangent, bitangent, vec3(0., 0., 1.));\n\n\t\t\tconst int DIRECTIONS = SAMPLES < 30 ? 3 : 5;\n\t\t\tconst int STEPS = (SAMPLES + DIRECTIONS - 1) / DIRECTIONS;\n\t\t\tfloat ao = 0.0;\n\t\t\tfor (int i = 0; i < DIRECTIONS; ++i) {\n\n\t\t\t\tfloat angle = float(i) / float(DIRECTIONS) * PI;\n\t\t\t\tvec4 sampleDir = vec4(cos(angle), sin(angle), 0., 0.5 + 0.5 * noiseTexel.w);\n\t\t\t\tsampleDir.xyz = normalize(kernelMatrix * sampleDir.xyz);\n\n\t\t\t\tvec3 viewDir = normalize(-viewPos.xyz);\n\t\t\t\tvec3 sliceBitangent = normalize(cross(sampleDir.xyz, viewDir));\n\t\t\t\tvec3 sliceTangent = cross(sliceBitangent, viewDir);\n\t\t\t\tvec3 normalInSlice = normalize(viewNormal - sliceBitangent * dot(viewNormal, sliceBitangent));\n\n\t\t\t\tvec3 tangentToNormalInSlice = cross(normalInSlice, sliceBitangent);\n\t\t\t\tvec2 cosHorizons = vec2(dot(viewDir, tangentToNormalInSlice), dot(viewDir, -tangentToNormalInSlice));\n\n\t\t\t\tfor (int j = 0; j < STEPS; ++j) {\n\t\t\t\t\tvec3 sampleViewOffset = sampleDir.xyz * radiusToUse * sampleDir.w * pow(float(j + 1) / float(STEPS), distanceExponent);\n\n\t\t\t\t\tvec3 sampleSceneUvDepth = getSceneUvAndDepth(viewPos + sampleViewOffset);\n\t\t\t\t\tvec3 sampleSceneViewPos = getViewPosition(sampleSceneUvDepth.xy, sampleSceneUvDepth.z);\n\t\t\t\t\tvec3 viewDelta = sampleSceneViewPos - viewPos;\n\t\t\t\t\tif (abs(viewDelta.z) < thickness) {\n\t\t\t\t\t\tfloat sampleCosHorizon = dot(viewDir, normalize(viewDelta));\n\t\t\t\t\t\tcosHorizons.x += max(0., (sampleCosHorizon - cosHorizons.x) * mix(1., 2. / float(j + 2), distanceFallOff));\n\t\t\t\t\t}\n\n\t\t\t\t\tsampleSceneUvDepth = getSceneUvAndDepth(viewPos - sampleViewOffset);\n\t\t\t\t\tsampleSceneViewPos = getViewPosition(sampleSceneUvDepth.xy, sampleSceneUvDepth.z);\n\t\t\t\t\tviewDelta = sampleSceneViewPos - viewPos;\n\t\t\t\t\tif (abs(viewDelta.z) < thickness) {\n\t\t\t\t\t\tfloat sampleCosHorizon = dot(viewDir, normalize(viewDelta));\n\t\t\t\t\t\tcosHorizons.y += max(0., (sampleCosHorizon - cosHorizons.y) * mix(1., 2. / float(j + 2), distanceFallOff));\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tvec2 sinHorizons = sqrt(1. - cosHorizons * cosHorizons);\n\t\t\t\tfloat nx = dot(normalInSlice, sliceTangent);\n\t\t\t\tfloat ny = dot(normalInSlice, viewDir);\n\t\t\t\tfloat nxb = 1. / 2. * (acos(cosHorizons.y) - acos(cosHorizons.x) + sinHorizons.x * cosHorizons.x - sinHorizons.y * cosHorizons.y);\n\t\t\t\tfloat nyb = 1. / 2. * (2. - cosHorizons.x * cosHorizons.x - cosHorizons.y * cosHorizons.y);\n\t\t\t\tfloat occlusion = nx * nxb + ny * nyb;\n\t\t\t\tao += occlusion;\n\t\t\t}\n\n\t\t\tao = clamp(ao / float(DIRECTIONS), 0., 1.);\n\t\t#if SCENE_CLIP_BOX == 1\n\t\t\tao = mix(ao, 1., smoothstep(0., radiusToUse, boxDistance));\n\t\t#endif\n\t\t\tao = pow(ao, scale);\n\n\t\t\tgl_FragColor = FRAGMENT_OUTPUT;\n\t\t}"},sl={defines:{PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null}},vertexShader:"\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}",fragmentShader:"\n\t\tuniform sampler2D tDepth;\n\t\tuniform float cameraNear;\n\t\tuniform float cameraFar;\n\t\tvarying vec2 vUv;\n\n\t\t#include <packing>\n\n\t\tfloat getLinearDepth( const in vec2 screenPosition ) {\n\t\t\t#if PERSPECTIVE_CAMERA == 1\n\t\t\t\tfloat fragCoordZ = texture2D( tDepth, screenPosition ).x;\n\t\t\t\tfloat viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n\t\t\t\treturn viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n\t\t\t#else\n\t\t\t\treturn texture2D( tDepth, screenPosition ).x;\n\t\t\t#endif\n\t\t}\n\n\t\tvoid main() {\n\t\t\tfloat depth = getLinearDepth( vUv );\n\t\t\tgl_FragColor = vec4( vec3( 1.0 - depth ), 1.0 );\n\n\t\t}"},nl={uniforms:{tDiffuse:{value:null},intensity:{value:1}},vertexShader:"\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}",fragmentShader:"\n\t\tuniform float intensity;\n\t\tuniform sampler2D tDiffuse;\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = vec4(mix(vec3(1.), texel.rgb, intensity), texel.a);\n\t\t}"};function rl(t=5){const e=Math.floor(t)%2==0?Math.floor(t)+1:Math.floor(t),i=function(t){const e=Math.floor(t)%2==0?Math.floor(t)+1:Math.floor(t),i=e*e,s=Array(i).fill(0);let n=Math.floor(e/2),r=e-1;for(let t=1;t<=i;)-1===n&&r===e?(r=e-2,n=0):(r===e&&(r=0),n<0&&(n=e-1)),0===s[n*e+r]?(s[n*e+r]=t++,r++,n--):(r-=2,n++);return s}(e),s=i.length,n=new Uint8Array(4*s);for(let t=0;t<s;++t){const e=i[t],r=2*Math.PI*e/s,o=new a(Math.cos(r),Math.sin(r),0).normalize();n[4*t]=255*(.5*o.x+.5),n[4*t+1]=255*(.5*o.y+.5),n[4*t+2]=127,n[4*t+3]=255}const r=new W(n,e,e);return r.wrapS=G,r.wrapT=G,r.needsUpdate=!0,r}const ol={defines:{SAMPLES:16,SAMPLE_VECTORS:al(16,2,1),NORMAL_VECTOR_TYPE:1,DEPTH_VALUE_SOURCE:0},uniforms:{tDiffuse:{value:null},tNormal:{value:null},tDepth:{value:null},tNoise:{value:null},resolution:{value:new l},cameraProjectionMatrixInverse:{value:new g},lumaPhi:{value:5},depthPhi:{value:5},normalPhi:{value:5},radius:{value:4},index:{value:0}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}",fragmentShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform sampler2D tNormal;\n\t\tuniform sampler2D tDepth;\n\t\tuniform sampler2D tNoise;\n\t\tuniform vec2 resolution;\n\t\tuniform mat4 cameraProjectionMatrixInverse;\n\t\tuniform float lumaPhi;\n\t\tuniform float depthPhi;\n\t\tuniform float normalPhi;\n\t\tuniform float radius;\n\t\tuniform int index;\n\n\t\t#include <common>\n\t\t#include <packing>\n\n\t\t#ifndef SAMPLE_LUMINANCE\n\t\t#define SAMPLE_LUMINANCE dot(vec3(0.2125, 0.7154, 0.0721), a)\n\t\t#endif\n\n\t\t#ifndef FRAGMENT_OUTPUT\n\t\t#define FRAGMENT_OUTPUT vec4(denoised, 1.)\n\t\t#endif\n\n\t\tfloat getLuminance(const in vec3 a) {\n\t\t\treturn SAMPLE_LUMINANCE;\n\t\t}\n\n\t\tconst vec3 poissonDisk[SAMPLES] = SAMPLE_VECTORS;\n\n\t\tvec3 getViewPosition(const in vec2 screenPosition, const in float depth) {\n\t\t\tvec4 clipSpacePosition = vec4(vec3(screenPosition, depth) * 2.0 - 1.0, 1.0);\n\t\t\tvec4 viewSpacePosition = cameraProjectionMatrixInverse * clipSpacePosition;\n\t\t\treturn viewSpacePosition.xyz / viewSpacePosition.w;\n\t\t}\n\n\t\tfloat getDepth(const vec2 uv) {\n\t\t#if DEPTH_VALUE_SOURCE == 1\n\t\t\treturn textureLod(tDepth, uv.xy, 0.0).a;\n\t\t#else\n\t\t\treturn textureLod(tDepth, uv.xy, 0.0).r;\n\t\t#endif\n\t\t}\n\n\t\tfloat fetchDepth(const ivec2 uv) {\n\t\t\t#if DEPTH_VALUE_SOURCE == 1\n\t\t\t\treturn texelFetch(tDepth, uv.xy, 0).a;\n\t\t\t#else\n\t\t\t\treturn texelFetch(tDepth, uv.xy, 0).r;\n\t\t\t#endif\n\t\t}\n\n\t\tvec3 computeNormalFromDepth(const vec2 uv) {\n\t\t\tvec2 size = vec2(textureSize(tDepth, 0));\n\t\t\tivec2 p = ivec2(uv * size);\n\t\t\tfloat c0 = fetchDepth(p);\n\t\t\tfloat l2 = fetchDepth(p - ivec2(2, 0));\n\t\t\tfloat l1 = fetchDepth(p - ivec2(1, 0));\n\t\t\tfloat r1 = fetchDepth(p + ivec2(1, 0));\n\t\t\tfloat r2 = fetchDepth(p + ivec2(2, 0));\n\t\t\tfloat b2 = fetchDepth(p - ivec2(0, 2));\n\t\t\tfloat b1 = fetchDepth(p - ivec2(0, 1));\n\t\t\tfloat t1 = fetchDepth(p + ivec2(0, 1));\n\t\t\tfloat t2 = fetchDepth(p + ivec2(0, 2));\n\t\t\tfloat dl = abs((2.0 * l1 - l2) - c0);\n\t\t\tfloat dr = abs((2.0 * r1 - r2) - c0);\n\t\t\tfloat db = abs((2.0 * b1 - b2) - c0);\n\t\t\tfloat dt = abs((2.0 * t1 - t2) - c0);\n\t\t\tvec3 ce = getViewPosition(uv, c0).xyz;\n\t\t\tvec3 dpdx = (dl < dr) ?  ce - getViewPosition((uv - vec2(1.0 / size.x, 0.0)), l1).xyz\n\t\t\t\t\t\t\t\t\t: -ce + getViewPosition((uv + vec2(1.0 / size.x, 0.0)), r1).xyz;\n\t\t\tvec3 dpdy = (db < dt) ?  ce - getViewPosition((uv - vec2(0.0, 1.0 / size.y)), b1).xyz\n\t\t\t\t\t\t\t\t\t: -ce + getViewPosition((uv + vec2(0.0, 1.0 / size.y)), t1).xyz;\n\t\t\treturn normalize(cross(dpdx, dpdy));\n\t\t}\n\n\t\tvec3 getViewNormal(const vec2 uv) {\n\t\t#if NORMAL_VECTOR_TYPE == 2\n\t\t\treturn normalize(textureLod(tNormal, uv, 0.).rgb);\n\t\t#elif NORMAL_VECTOR_TYPE == 1\n\t\t\treturn unpackRGBToNormal(textureLod(tNormal, uv, 0.).rgb);\n\t\t#else\n\t\t\treturn computeNormalFromDepth(uv);\n\t\t#endif\n\t\t}\n\n\t\tvoid denoiseSample(in vec3 center, in vec3 viewNormal, in vec3 viewPos, in vec2 sampleUv, inout vec3 denoised, inout float totalWeight) {\n\t\t\tvec4 sampleTexel = textureLod(tDiffuse, sampleUv, 0.0);\n\t\t\tfloat sampleDepth = getDepth(sampleUv);\n\t\t\tvec3 sampleNormal = getViewNormal(sampleUv);\n\t\t\tvec3 neighborColor = sampleTexel.rgb;\n\t\t\tvec3 viewPosSample = getViewPosition(sampleUv, sampleDepth);\n\n\t\t\tfloat normalDiff = dot(viewNormal, sampleNormal);\n\t\t\tfloat normalSimilarity = pow(max(normalDiff, 0.), normalPhi);\n\t\t\tfloat lumaDiff = abs(getLuminance(neighborColor) - getLuminance(center));\n\t\t\tfloat lumaSimilarity = max(1.0 - lumaDiff / lumaPhi, 0.0);\n\t\t\tfloat depthDiff = abs(dot(viewPos - viewPosSample, viewNormal));\n\t\t\tfloat depthSimilarity = max(1. - depthDiff / depthPhi, 0.);\n\t\t\tfloat w = lumaSimilarity * depthSimilarity * normalSimilarity;\n\n\t\t\tdenoised += w * neighborColor;\n\t\t\ttotalWeight += w;\n\t\t}\n\n\t\tvoid main() {\n\t\t\tfloat depth = getDepth(vUv.xy);\n\t\t\tvec3 viewNormal = getViewNormal(vUv);\n\t\t\tif (depth == 1. || dot(viewNormal, viewNormal) == 0.) {\n\t\t\t\tdiscard;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvec4 texel = textureLod(tDiffuse, vUv, 0.0);\n\t\t\tvec3 center = texel.rgb;\n\t\t\tvec3 viewPos = getViewPosition(vUv, depth);\n\n\t\t\tvec2 noiseResolution = vec2(textureSize(tNoise, 0));\n\t\t\tvec2 noiseUv = vUv * resolution / noiseResolution;\n\t\t\tvec4 noiseTexel = textureLod(tNoise, noiseUv, 0.0);\n      \t\tvec2 noiseVec = vec2(sin(noiseTexel[index % 4] * 2. * PI), cos(noiseTexel[index % 4] * 2. * PI));\n    \t\tmat2 rotationMatrix = mat2(noiseVec.x, -noiseVec.y, noiseVec.x, noiseVec.y);\n\n\t\t\tfloat totalWeight = 1.0;\n\t\t\tvec3 denoised = texel.rgb;\n\t\t\tfor (int i = 0; i < SAMPLES; i++) {\n\t\t\t\tvec3 sampleDir = poissonDisk[i];\n\t\t\t\tvec2 offset = rotationMatrix * (sampleDir.xy * (1. + sampleDir.z * (radius - 1.)) / resolution);\n\t\t\t\tvec2 sampleUv = vUv + offset;\n\t\t\t\tdenoiseSample(center, viewNormal, viewPos, sampleUv, denoised, totalWeight);\n\t\t\t}\n\n\t\t\tif (totalWeight > 0.) {\n\t\t\t\tdenoised /= totalWeight;\n\t\t\t}\n\t\t\tgl_FragColor = FRAGMENT_OUTPUT;\n\t\t}"};function al(t,e,i){const s=function(t,e,i){const s=[];for(let n=0;n<t;n++){const r=2*Math.PI*e*n/t,o=Math.pow(n/(t-1),i);s.push(new a(Math.cos(r),Math.sin(r),o))}return s}(t,e,i);let n="vec3[SAMPLES](";for(let e=0;e<t;e++){const i=s[e];n+=`vec3(${i.x}, ${i.y}, ${i.z})${e<t-1?",":")"}`}return n}class ll{constructor(t=Math){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(let e=0;e<256;e++)this.p[e]=Math.floor(256*t.random());this.perm=[];for(let t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}noise(t,e){let i,s,n;const r=(t+e)*(.5*(Math.sqrt(3)-1)),o=Math.floor(t+r),a=Math.floor(e+r),l=(3-Math.sqrt(3))/6,h=(o+a)*l,c=t-(o-h),d=e-(a-h);let u,p;c>d?(u=1,p=0):(u=0,p=1);const f=c-u+l,m=d-p+l,g=c-1+2*l,v=d-1+2*l,_=255&o,y=255&a,w=this.perm[_+this.perm[y]]%12,b=this.perm[_+u+this.perm[y+p]]%12,x=this.perm[_+1+this.perm[y+1]]%12;let S=.5-c*c-d*d;S<0?i=0:(S*=S,i=S*S*this._dot(this.grad3[w],c,d));let E=.5-f*f-m*m;E<0?s=0:(E*=E,s=E*E*this._dot(this.grad3[b],f,m));let C=.5-g*g-v*v;return C<0?n=0:(C*=C,n=C*C*this._dot(this.grad3[x],g,v)),70*(i+s+n)}noise3d(t,e,i){let s,n,r,o;const a=.3333333333333333*(t+e+i),l=Math.floor(t+a),h=Math.floor(e+a),c=Math.floor(i+a),d=1/6,u=(l+h+c)*d,p=t-(l-u),f=e-(h-u),m=i-(c-u);let g,v,_,y,w,b;p>=f?f>=m?(g=1,v=0,_=0,y=1,w=1,b=0):p>=m?(g=1,v=0,_=0,y=1,w=0,b=1):(g=0,v=0,_=1,y=1,w=0,b=1):f<m?(g=0,v=0,_=1,y=0,w=1,b=1):p<m?(g=0,v=1,_=0,y=0,w=1,b=1):(g=0,v=1,_=0,y=1,w=1,b=0);const x=p-g+d,S=f-v+d,E=m-_+d,C=p-y+2*d,T=f-w+2*d,P=m-b+2*d,A=p-1+.5,M=f-1+.5,O=m-1+.5,D=255&l,z=255&h,I=255&c,k=this.perm[D+this.perm[z+this.perm[I]]]%12,L=this.perm[D+g+this.perm[z+v+this.perm[I+_]]]%12,N=this.perm[D+y+this.perm[z+w+this.perm[I+b]]]%12,B=this.perm[D+1+this.perm[z+1+this.perm[I+1]]]%12;let U=.6-p*p-f*f-m*m;U<0?s=0:(U*=U,s=U*U*this._dot3(this.grad3[k],p,f,m));let R=.6-x*x-S*S-E*E;R<0?n=0:(R*=R,n=R*R*this._dot3(this.grad3[L],x,S,E));let F=.6-C*C-T*T-P*P;F<0?r=0:(F*=F,r=F*F*this._dot3(this.grad3[N],C,T,P));let V=.6-A*A-M*M-O*O;return V<0?o=0:(V*=V,o=V*V*this._dot3(this.grad3[B],A,M,O)),32*(s+n+r+o)}noise4d(t,e,i,s){const n=this.grad4,r=this.simplex,o=this.perm,a=(Math.sqrt(5)-1)/4,l=(5-Math.sqrt(5))/20;let h,c,d,u,p;const f=(t+e+i+s)*a,m=Math.floor(t+f),g=Math.floor(e+f),v=Math.floor(i+f),_=Math.floor(s+f),y=(m+g+v+_)*l,w=t-(m-y),b=e-(g-y),x=i-(v-y),S=s-(_-y),E=(w>b?32:0)+(w>x?16:0)+(b>x?8:0)+(w>S?4:0)+(b>S?2:0)+(x>S?1:0),C=r[E][0]>=3?1:0,T=r[E][1]>=3?1:0,P=r[E][2]>=3?1:0,A=r[E][3]>=3?1:0,M=r[E][0]>=2?1:0,O=r[E][1]>=2?1:0,D=r[E][2]>=2?1:0,z=r[E][3]>=2?1:0,I=r[E][0]>=1?1:0,k=r[E][1]>=1?1:0,L=r[E][2]>=1?1:0,N=r[E][3]>=1?1:0,B=w-C+l,U=b-T+l,R=x-P+l,F=S-A+l,V=w-M+2*l,j=b-O+2*l,H=x-D+2*l,W=S-z+2*l,G=w-I+3*l,Z=b-k+3*l,Y=x-L+3*l,X=S-N+3*l,q=w-1+4*l,Q=b-1+4*l,K=x-1+4*l,J=S-1+4*l,$=255&m,tt=255&g,et=255&v,it=255&_,st=o[$+o[tt+o[et+o[it]]]]%32,nt=o[$+C+o[tt+T+o[et+P+o[it+A]]]]%32,rt=o[$+M+o[tt+O+o[et+D+o[it+z]]]]%32,ot=o[$+I+o[tt+k+o[et+L+o[it+N]]]]%32,at=o[$+1+o[tt+1+o[et+1+o[it+1]]]]%32;let lt=.6-w*w-b*b-x*x-S*S;lt<0?h=0:(lt*=lt,h=lt*lt*this._dot4(n[st],w,b,x,S));let ht=.6-B*B-U*U-R*R-F*F;ht<0?c=0:(ht*=ht,c=ht*ht*this._dot4(n[nt],B,U,R,F));let ct=.6-V*V-j*j-H*H-W*W;ct<0?d=0:(ct*=ct,d=ct*ct*this._dot4(n[rt],V,j,H,W));let dt=.6-G*G-Z*Z-Y*Y-X*X;dt<0?u=0:(dt*=dt,u=dt*dt*this._dot4(n[ot],G,Z,Y,X));let ut=.6-q*q-Q*Q-K*K-J*J;return ut<0?p=0:(ut*=ut,p=ut*ut*this._dot4(n[at],q,Q,K,J)),27*(h+c+d+u+p)}_dot(t,e,i){return t[0]*e+t[1]*i}_dot3(t,e,i,s){return t[0]*e+t[1]*i+t[2]*s}_dot4(t,e,i,s,n){return t[0]*e+t[1]*i+t[2]*s+t[3]*n}}class hl extends Xa{constructor(t,e,i=512,s=512,n,r,o){super(),this.width=i,this.height=s,this.clear=!0,this.camera=e,this.scene=t,this.output=0,this._renderGBuffer=!0,this._visibilityCache=new Map,this.blendIntensity=1,this.pdRings=2,this.pdRadiusExponent=2,this.pdSamples=16,this.gtaoNoiseTexture=rl(),this.pdNoiseTexture=this._generateNoise(),this.gtaoRenderTarget=new F(this.width,this.height,{type:V}),this.pdRenderTarget=this.gtaoRenderTarget.clone(),this.gtaoMaterial=new U({defines:Object.assign({},il.defines),uniforms:R.clone(il.uniforms),vertexShader:il.vertexShader,fragmentShader:il.fragmentShader,blending:j,depthTest:!1,depthWrite:!1}),this.gtaoMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.gtaoMaterial.uniforms.tNoise.value=this.gtaoNoiseTexture,this.gtaoMaterial.uniforms.resolution.value.set(this.width,this.height),this.gtaoMaterial.uniforms.cameraNear.value=this.camera.near,this.gtaoMaterial.uniforms.cameraFar.value=this.camera.far,this.normalMaterial=new Z,this.normalMaterial.blending=j,this.pdMaterial=new U({defines:Object.assign({},ol.defines),uniforms:R.clone(ol.uniforms),vertexShader:ol.vertexShader,fragmentShader:ol.fragmentShader,depthTest:!1,depthWrite:!1}),this.pdMaterial.uniforms.tDiffuse.value=this.gtaoRenderTarget.texture,this.pdMaterial.uniforms.tNoise.value=this.pdNoiseTexture,this.pdMaterial.uniforms.resolution.value.set(this.width,this.height),this.pdMaterial.uniforms.lumaPhi.value=10,this.pdMaterial.uniforms.depthPhi.value=2,this.pdMaterial.uniforms.normalPhi.value=3,this.pdMaterial.uniforms.radius.value=8,this.depthRenderMaterial=new U({defines:Object.assign({},sl.defines),uniforms:R.clone(sl.uniforms),vertexShader:sl.vertexShader,fragmentShader:sl.fragmentShader,blending:j}),this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this.copyMaterial=new U({uniforms:R.clone(Ya.uniforms),vertexShader:Ya.vertexShader,fragmentShader:Ya.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blendSrc:Q,blendDst:X,blendEquation:Y,blendSrcAlpha:q,blendDstAlpha:X,blendEquationAlpha:Y}),this.blendMaterial=new U({uniforms:R.clone(nl.uniforms),vertexShader:nl.vertexShader,fragmentShader:nl.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blending:K,blendSrc:Q,blendDst:X,blendEquation:Y,blendSrcAlpha:q,blendDstAlpha:X,blendEquationAlpha:Y}),this._fsQuad=new Ka(null),this._originalClearColor=new J,this.setGBuffer(n?n.depthTexture:void 0,n?n.normalTexture:void 0),void 0!==r&&this.updateGtaoMaterial(r),void 0!==o&&this.updatePdMaterial(o)}setSize(t,e){this.width=t,this.height=e,this.gtaoRenderTarget.setSize(t,e),this.normalRenderTarget.setSize(t,e),this.pdRenderTarget.setSize(t,e),this.gtaoMaterial.uniforms.resolution.value.set(t,e),this.gtaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.gtaoMaterial.uniforms.cameraProjectionMatrixInverse.value.copy(this.camera.projectionMatrixInverse),this.pdMaterial.uniforms.resolution.value.set(t,e),this.pdMaterial.uniforms.cameraProjectionMatrixInverse.value.copy(this.camera.projectionMatrixInverse)}dispose(){this.gtaoNoiseTexture.dispose(),this.pdNoiseTexture.dispose(),this.normalRenderTarget.dispose(),this.gtaoRenderTarget.dispose(),this.pdRenderTarget.dispose(),this.normalMaterial.dispose(),this.pdMaterial.dispose(),this.copyMaterial.dispose(),this.depthRenderMaterial.dispose(),this._fsQuad.dispose()}get gtaoMap(){return this.pdRenderTarget.texture}setGBuffer(t,e){void 0!==t?(this.depthTexture=t,this.normalTexture=e,this._renderGBuffer=!1):(this.depthTexture=new $,this.depthTexture.format=tt,this.depthTexture.type=et,this.normalRenderTarget=new F(this.width,this.height,{minFilter:it,magFilter:it,type:V,depthTexture:this.depthTexture}),this.normalTexture=this.normalRenderTarget.texture,this._renderGBuffer=!0);const i=this.normalTexture?1:0,s=this.depthTexture===this.normalTexture?"w":"x";this.gtaoMaterial.defines.NORMAL_VECTOR_TYPE=i,this.gtaoMaterial.defines.DEPTH_SWIZZLING=s,this.gtaoMaterial.uniforms.tNormal.value=this.normalTexture,this.gtaoMaterial.uniforms.tDepth.value=this.depthTexture,this.pdMaterial.defines.NORMAL_VECTOR_TYPE=i,this.pdMaterial.defines.DEPTH_SWIZZLING=s,this.pdMaterial.uniforms.tNormal.value=this.normalTexture,this.pdMaterial.uniforms.tDepth.value=this.depthTexture,this.depthRenderMaterial.uniforms.tDepth.value=this.normalRenderTarget.depthTexture}setSceneClipBox(t){t?(this.gtaoMaterial.needsUpdate=1!==this.gtaoMaterial.defines.SCENE_CLIP_BOX,this.gtaoMaterial.defines.SCENE_CLIP_BOX=1,this.gtaoMaterial.uniforms.sceneBoxMin.value.copy(t.min),this.gtaoMaterial.uniforms.sceneBoxMax.value.copy(t.max)):(this.gtaoMaterial.needsUpdate=0===this.gtaoMaterial.defines.SCENE_CLIP_BOX,this.gtaoMaterial.defines.SCENE_CLIP_BOX=0)}updateGtaoMaterial(t){void 0!==t.radius&&(this.gtaoMaterial.uniforms.radius.value=t.radius),void 0!==t.distanceExponent&&(this.gtaoMaterial.uniforms.distanceExponent.value=t.distanceExponent),void 0!==t.thickness&&(this.gtaoMaterial.uniforms.thickness.value=t.thickness),void 0!==t.distanceFallOff&&(this.gtaoMaterial.uniforms.distanceFallOff.value=t.distanceFallOff,this.gtaoMaterial.needsUpdate=!0),void 0!==t.scale&&(this.gtaoMaterial.uniforms.scale.value=t.scale),void 0!==t.samples&&t.samples!==this.gtaoMaterial.defines.SAMPLES&&(this.gtaoMaterial.defines.SAMPLES=t.samples,this.gtaoMaterial.needsUpdate=!0),void 0!==t.screenSpaceRadius&&(t.screenSpaceRadius?1:0)!==this.gtaoMaterial.defines.SCREEN_SPACE_RADIUS&&(this.gtaoMaterial.defines.SCREEN_SPACE_RADIUS=t.screenSpaceRadius?1:0,this.gtaoMaterial.needsUpdate=!0)}updatePdMaterial(t){let e=!1;void 0!==t.lumaPhi&&(this.pdMaterial.uniforms.lumaPhi.value=t.lumaPhi),void 0!==t.depthPhi&&(this.pdMaterial.uniforms.depthPhi.value=t.depthPhi),void 0!==t.normalPhi&&(this.pdMaterial.uniforms.normalPhi.value=t.normalPhi),void 0!==t.radius&&t.radius!==this.radius&&(this.pdMaterial.uniforms.radius.value=t.radius),void 0!==t.radiusExponent&&t.radiusExponent!==this.pdRadiusExponent&&(this.pdRadiusExponent=t.radiusExponent,e=!0),void 0!==t.rings&&t.rings!==this.pdRings&&(this.pdRings=t.rings,e=!0),void 0!==t.samples&&t.samples!==this.pdSamples&&(this.pdSamples=t.samples,e=!0),e&&(this.pdMaterial.defines.SAMPLES=this.pdSamples,this.pdMaterial.defines.SAMPLE_VECTORS=al(this.pdSamples,this.pdRings,this.pdRadiusExponent),this.pdMaterial.needsUpdate=!0)}render(t,e,i){switch(this._renderGBuffer&&(this._overrideVisibility(),this._renderOverride(t,this.normalMaterial,this.normalRenderTarget,7829503,1),this._restoreVisibility()),this.gtaoMaterial.uniforms.cameraNear.value=this.camera.near,this.gtaoMaterial.uniforms.cameraFar.value=this.camera.far,this.gtaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.gtaoMaterial.uniforms.cameraProjectionMatrixInverse.value.copy(this.camera.projectionMatrixInverse),this.gtaoMaterial.uniforms.cameraWorldMatrix.value.copy(this.camera.matrixWorld),this._renderPass(t,this.gtaoMaterial,this.gtaoRenderTarget,16777215,1),this.pdMaterial.uniforms.cameraProjectionMatrixInverse.value.copy(this.camera.projectionMatrixInverse),this._renderPass(t,this.pdMaterial,this.pdRenderTarget,16777215,1),this.output){case hl.OUTPUT.Off:break;case hl.OUTPUT.Diffuse:this.copyMaterial.uniforms.tDiffuse.value=i.texture,this.copyMaterial.blending=j,this._renderPass(t,this.copyMaterial,this.renderToScreen?null:e);break;case hl.OUTPUT.AO:this.copyMaterial.uniforms.tDiffuse.value=this.gtaoRenderTarget.texture,this.copyMaterial.blending=j,this._renderPass(t,this.copyMaterial,this.renderToScreen?null:e);break;case hl.OUTPUT.Denoise:this.copyMaterial.uniforms.tDiffuse.value=this.pdRenderTarget.texture,this.copyMaterial.blending=j,this._renderPass(t,this.copyMaterial,this.renderToScreen?null:e);break;case hl.OUTPUT.Depth:this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this._renderPass(t,this.depthRenderMaterial,this.renderToScreen?null:e);break;case hl.OUTPUT.Normal:this.copyMaterial.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.copyMaterial.blending=j,this._renderPass(t,this.copyMaterial,this.renderToScreen?null:e);break;case hl.OUTPUT.Default:this.copyMaterial.uniforms.tDiffuse.value=i.texture,this.copyMaterial.blending=j,this._renderPass(t,this.copyMaterial,this.renderToScreen?null:e),this.blendMaterial.uniforms.intensity.value=this.blendIntensity,this.blendMaterial.uniforms.tDiffuse.value=this.pdRenderTarget.texture,this._renderPass(t,this.blendMaterial,this.renderToScreen?null:e);break;default:console.warn("THREE.GTAOPass: Unknown output type.")}}_renderPass(t,e,i,s,n){t.getClearColor(this._originalClearColor);const r=t.getClearAlpha(),o=t.autoClear;t.setRenderTarget(i),t.autoClear=!1,null!=s&&(t.setClearColor(s),t.setClearAlpha(n||0),t.clear()),this._fsQuad.material=e,this._fsQuad.render(t),t.autoClear=o,t.setClearColor(this._originalClearColor),t.setClearAlpha(r)}_renderOverride(t,e,i,s,n){t.getClearColor(this._originalClearColor);const r=t.getClearAlpha(),o=t.autoClear;t.setRenderTarget(i),t.autoClear=!1,s=e.clearColor||s,n=e.clearAlpha||n,null!=s&&(t.setClearColor(s),t.setClearAlpha(n||0),t.clear()),this.scene.overrideMaterial=e,t.render(this.scene,this.camera),this.scene.overrideMaterial=null,t.autoClear=o,t.setClearColor(this._originalClearColor),t.setClearAlpha(r)}_overrideVisibility(){const t=this.scene,e=this._visibilityCache;t.traverse(function(t){e.set(t,t.visible),(t.isPoints||t.isLine)&&(t.visible=!1)})}_restoreVisibility(){const t=this.scene,e=this._visibilityCache;t.traverse(function(t){const i=e.get(t);t.visible=i}),e.clear()}_generateNoise(t=64){const e=new ll,i=new Uint8Array(t*t*4);for(let s=0;s<t;s++)for(let n=0;n<t;n++){const r=s,o=n;i[4*(s*t+n)]=255*(.5*e.noise(r,o)+.5),i[4*(s*t+n)+1]=255*(.5*e.noise(r+t,o)+.5),i[4*(s*t+n)+2]=255*(.5*e.noise(r,o+t)+.5),i[4*(s*t+n)+3]=255*(.5*e.noise(r+t,o+t)+.5)}const s=new W(i,t,t,st,nt);return s.wrapS=G,s.wrapT=G,s.needsUpdate=!0,s}}hl.OUTPUT={Off:-1,Default:0,Diffuse:1,Depth:2,Normal:3,AO:4,Denoise:5};const cl={name:"OutputShader",uniforms:{tDiffuse:{value:null},toneMappingExposure:{value:1}},vertexShader:"\n\t\tprecision highp float;\n\n\t\tuniform mat4 modelViewMatrix;\n\t\tuniform mat4 projectionMatrix;\n\n\t\tattribute vec3 position;\n\t\tattribute vec2 uv;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tprecision highp float;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\t#include <tonemapping_pars_fragment>\n\t\t#include <colorspace_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = texture2D( tDiffuse, vUv );\n\n\t\t\t// tone mapping\n\n\t\t\t#ifdef LINEAR_TONE_MAPPING\n\n\t\t\t\tgl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( REINHARD_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( CINEON_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = CineonToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( ACES_FILMIC_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( AGX_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = AgXToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( NEUTRAL_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = NeutralToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( CUSTOM_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = CustomToneMapping( gl_FragColor.rgb );\n\n\t\t\t#endif\n\n\t\t\t// color space\n\n\t\t\t#ifdef SRGB_TRANSFER\n\n\t\t\t\tgl_FragColor = sRGBTransferOETF( gl_FragColor );\n\n\t\t\t#endif\n\n\t\t}"};class dl extends Xa{constructor(){super(),this.uniforms=R.clone(cl.uniforms),this.material=new rt({name:cl.name,uniforms:this.uniforms,vertexShader:cl.vertexShader,fragmentShader:cl.fragmentShader}),this._fsQuad=new Ka(this.material),this._outputColorSpace=null,this._toneMapping=null}render(t,e,i){this.uniforms.tDiffuse.value=i.texture,this.uniforms.toneMappingExposure.value=t.toneMappingExposure,(this._outputColorSpace!==t.outputColorSpace||this._toneMapping!==t.toneMapping)&&(this._outputColorSpace=t.outputColorSpace,this._toneMapping=t.toneMapping,this.material.defines={},ot.getTransfer(this._outputColorSpace)===at&&(this.material.defines.SRGB_TRANSFER=""),this._toneMapping===lt?this.material.defines.LINEAR_TONE_MAPPING="":this._toneMapping===ht?this.material.defines.REINHARD_TONE_MAPPING="":this._toneMapping===ct?this.material.defines.CINEON_TONE_MAPPING="":this._toneMapping===dt?this.material.defines.ACES_FILMIC_TONE_MAPPING="":this._toneMapping===ut?this.material.defines.AGX_TONE_MAPPING="":this._toneMapping===pt?this.material.defines.NEUTRAL_TONE_MAPPING="":this._toneMapping===ft&&(this.material.defines.CUSTOM_TONE_MAPPING=""),this.material.needsUpdate=!0),!0===this.renderToScreen?(t.setRenderTarget(null),this._fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this._fsQuad.render(t))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}const ul={defines:{SMAA_THRESHOLD:"0.1"},uniforms:{tDiffuse:{value:null},resolution:{value:new l(1/1024,1/512)}},vertexShader:"\n\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[ 3 ];\n\n\t\tvoid SMAAEdgeDetectionVS( vec2 texcoord ) {\n\t\t\tvOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 ); // WebGL port note: Changed sign in W component\n\t\t\tvOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 ); // WebGL port note: Changed sign in W component\n\t\t\tvOffset[ 2 ] = texcoord.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 ); // WebGL port note: Changed sign in W component\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tSMAAEdgeDetectionVS( vUv );\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[ 3 ];\n\n\t\tvec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {\n\t\t\tvec2 threshold = vec2( SMAA_THRESHOLD, SMAA_THRESHOLD );\n\n\t\t\t// Calculate color deltas:\n\t\t\tvec4 delta;\n\t\t\tvec3 C = texture2D( colorTex, texcoord ).rgb;\n\n\t\t\tvec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;\n\t\t\tvec3 t = abs( C - Cleft );\n\t\t\tdelta.x = max( max( t.r, t.g ), t.b );\n\n\t\t\tvec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;\n\t\t\tt = abs( C - Ctop );\n\t\t\tdelta.y = max( max( t.r, t.g ), t.b );\n\n\t\t\t// We do the usual threshold:\n\t\t\tvec2 edges = step( threshold, delta.xy );\n\n\t\t\t// Then discard if there is no edge:\n\t\t\tif ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )\n\t\t\t\tdiscard;\n\n\t\t\t// Calculate right and bottom deltas:\n\t\t\tvec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;\n\t\t\tt = abs( C - Cright );\n\t\t\tdelta.z = max( max( t.r, t.g ), t.b );\n\n\t\t\tvec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;\n\t\t\tt = abs( C - Cbottom );\n\t\t\tdelta.w = max( max( t.r, t.g ), t.b );\n\n\t\t\t// Calculate the maximum delta in the direct neighborhood:\n\t\t\tfloat maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );\n\n\t\t\t// Calculate left-left and top-top deltas:\n\t\t\tvec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;\n\t\t\tt = abs( C - Cleftleft );\n\t\t\tdelta.z = max( max( t.r, t.g ), t.b );\n\n\t\t\tvec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;\n\t\t\tt = abs( C - Ctoptop );\n\t\t\tdelta.w = max( max( t.r, t.g ), t.b );\n\n\t\t\t// Calculate the final maximum delta:\n\t\t\tmaxDelta = max( max( maxDelta, delta.z ), delta.w );\n\n\t\t\t// Local contrast adaptation in action:\n\t\t\tedges.xy *= step( 0.5 * maxDelta, delta.xy );\n\n\t\t\treturn vec4( edges, 0.0, 0.0 );\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = SMAAColorEdgeDetectionPS( vUv, vOffset, tDiffuse );\n\n\t\t}"},pl={defines:{SMAA_MAX_SEARCH_STEPS:"8",SMAA_AREATEX_MAX_DISTANCE:"16",SMAA_AREATEX_PIXEL_SIZE:"( 1.0 / vec2( 160.0, 560.0 ) )",SMAA_AREATEX_SUBTEX_SIZE:"( 1.0 / 7.0 )"},uniforms:{tDiffuse:{value:null},tArea:{value:null},tSearch:{value:null},resolution:{value:new l(1/1024,1/512)}},vertexShader:"\n\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[ 3 ];\n\t\tvarying vec2 vPixcoord;\n\n\t\tvoid SMAABlendingWeightCalculationVS( vec2 texcoord ) {\n\t\t\tvPixcoord = texcoord / resolution;\n\n\t\t\t// We will use these offsets for the searches later on (see @PSEUDO_GATHER4):\n\t\t\tvOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 ); // WebGL port note: Changed sign in Y and W components\n\t\t\tvOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 ); // WebGL port note: Changed sign in Y and W components\n\n\t\t\t// And these for the searches, they indicate the ends of the loops:\n\t\t\tvOffset[ 2 ] = vec4( vOffset[ 0 ].xz, vOffset[ 1 ].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( SMAA_MAX_SEARCH_STEPS );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tSMAABlendingWeightCalculationVS( vUv );\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\t#define SMAASampleLevelZeroOffset( tex, coord, offset ) texture2D( tex, coord + float( offset ) * resolution, 0.0 )\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform sampler2D tArea;\n\t\tuniform sampler2D tSearch;\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[3];\n\t\tvarying vec2 vPixcoord;\n\n\t\t#if __VERSION__ == 100\n\t\tvec2 round( vec2 x ) {\n\t\t\treturn sign( x ) * floor( abs( x ) + 0.5 );\n\t\t}\n\t\t#endif\n\n\t\tfloat SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {\n\t\t\t// Not required if searchTex accesses are set to point:\n\t\t\t// float2 SEARCH_TEX_PIXEL_SIZE = 1.0 / float2(66.0, 33.0);\n\t\t\t// e = float2(bias, 0.0) + 0.5 * SEARCH_TEX_PIXEL_SIZE +\n\t\t\t//     e * float2(scale, 1.0) * float2(64.0, 32.0) * SEARCH_TEX_PIXEL_SIZE;\n\t\t\te.r = bias + e.r * scale;\n\t\t\treturn 255.0 * texture2D( searchTex, e, 0.0 ).r;\n\t\t}\n\n\t\tfloat SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n\t\t\t/**\n\t\t\t\t* @PSEUDO_GATHER4\n\t\t\t\t* This texcoord has been offset by (-0.25, -0.125) in the vertex shader to\n\t\t\t\t* sample between edge, thus fetching four edges in a row.\n\t\t\t\t* Sampling with different offsets in each direction allows to disambiguate\n\t\t\t\t* which edges are active from the four fetched ones.\n\t\t\t\t*/\n\t\t\tvec2 e = vec2( 0.0, 1.0 );\n\n\t\t\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for\n\t\t\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;\n\t\t\t\ttexcoord -= vec2( 2.0, 0.0 ) * resolution;\n\t\t\t\tif ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n\t\t\t}\n\n\t\t\t// We correct the previous (-0.25, -0.125) offset we applied:\n\t\t\ttexcoord.x += 0.25 * resolution.x;\n\n\t\t\t// The searches are bias by 1, so adjust the coords accordingly:\n\t\t\ttexcoord.x += resolution.x;\n\n\t\t\t// Disambiguate the length added by the last step:\n\t\t\ttexcoord.x += 2.0 * resolution.x; // Undo last step\n\t\t\ttexcoord.x -= resolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);\n\n\t\t\treturn texcoord.x;\n\t\t}\n\n\t\tfloat SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n\t\t\tvec2 e = vec2( 0.0, 1.0 );\n\n\t\t\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for\n\t\t\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;\n\t\t\t\ttexcoord += vec2( 2.0, 0.0 ) * resolution;\n\t\t\t\tif ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n\t\t\t}\n\n\t\t\ttexcoord.x -= 0.25 * resolution.x;\n\t\t\ttexcoord.x -= resolution.x;\n\t\t\ttexcoord.x -= 2.0 * resolution.x;\n\t\t\ttexcoord.x += resolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );\n\n\t\t\treturn texcoord.x;\n\t\t}\n\n\t\tfloat SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n\t\t\tvec2 e = vec2( 1.0, 0.0 );\n\n\t\t\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for\n\t\t\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;\n\t\t\t\ttexcoord += vec2( 0.0, 2.0 ) * resolution; // WebGL port note: Changed sign\n\t\t\t\tif ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n\t\t\t}\n\n\t\t\ttexcoord.y -= 0.25 * resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y -= resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y -= 2.0 * resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y += resolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 ); // WebGL port note: Changed sign\n\n\t\t\treturn texcoord.y;\n\t\t}\n\n\t\tfloat SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n\t\t\tvec2 e = vec2( 1.0, 0.0 );\n\n\t\t\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for\n\t\t\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;\n\t\t\t\ttexcoord -= vec2( 0.0, 2.0 ) * resolution; // WebGL port note: Changed sign\n\t\t\t\tif ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n\t\t\t}\n\n\t\t\ttexcoord.y += 0.25 * resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y += resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y += 2.0 * resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y -= resolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 ); // WebGL port note: Changed sign\n\n\t\t\treturn texcoord.y;\n\t\t}\n\n\t\tvec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {\n\t\t\t// Rounding prevents precision errors of bilinear filtering:\n\t\t\tvec2 texcoord = float( SMAA_AREATEX_MAX_DISTANCE ) * round( 4.0 * vec2( e1, e2 ) ) + dist;\n\n\t\t\t// We do a scale and bias for mapping to texel space:\n\t\t\ttexcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );\n\n\t\t\t// Move to proper place, according to the subpixel offset:\n\t\t\ttexcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;\n\n\t\t\treturn texture2D( areaTex, texcoord, 0.0 ).rg;\n\t\t}\n\n\t\tvec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {\n\t\t\tvec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );\n\n\t\t\tvec2 e = texture2D( edgesTex, texcoord ).rg;\n\n\t\t\tif ( e.g > 0.0 ) { // Edge at north\n\t\t\t\tvec2 d;\n\n\t\t\t\t// Find the distance to the left:\n\t\t\t\tvec2 coords;\n\t\t\t\tcoords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );\n\t\t\t\tcoords.y = offset[ 1 ].y; // offset[1].y = texcoord.y - 0.25 * resolution.y (@CROSSING_OFFSET)\n\t\t\t\td.x = coords.x;\n\n\t\t\t\t// Now fetch the left crossing edges, two at a time using bilinear\n\t\t\t\t// filtering. Sampling at -0.25 (see @CROSSING_OFFSET) enables to\n\t\t\t\t// discern what value each edge has:\n\t\t\t\tfloat e1 = texture2D( edgesTex, coords, 0.0 ).r;\n\n\t\t\t\t// Find the distance to the right:\n\t\t\t\tcoords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );\n\t\t\t\td.y = coords.x;\n\n\t\t\t\t// We want the distances to be in pixel units (doing this here allow to\n\t\t\t\t// better interleave arithmetic and memory accesses):\n\t\t\t\td = d / resolution.x - pixcoord.x;\n\n\t\t\t\t// SMAAArea below needs a sqrt, as the areas texture is compressed\n\t\t\t\t// quadratically:\n\t\t\t\tvec2 sqrt_d = sqrt( abs( d ) );\n\n\t\t\t\t// Fetch the right crossing edges:\n\t\t\t\tcoords.y -= 1.0 * resolution.y; // WebGL port note: Added\n\t\t\t\tfloat e2 = SMAASampleLevelZeroOffset( edgesTex, coords, ivec2( 1, 0 ) ).r;\n\n\t\t\t\t// Ok, we know how this pattern looks like, now it is time for getting\n\t\t\t\t// the actual area:\n\t\t\t\tweights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );\n\t\t\t}\n\n\t\t\tif ( e.r > 0.0 ) { // Edge at west\n\t\t\t\tvec2 d;\n\n\t\t\t\t// Find the distance to the top:\n\t\t\t\tvec2 coords;\n\n\t\t\t\tcoords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );\n\t\t\t\tcoords.x = offset[ 0 ].x; // offset[1].x = texcoord.x - 0.25 * resolution.x;\n\t\t\t\td.x = coords.y;\n\n\t\t\t\t// Fetch the top crossing edges:\n\t\t\t\tfloat e1 = texture2D( edgesTex, coords, 0.0 ).g;\n\n\t\t\t\t// Find the distance to the bottom:\n\t\t\t\tcoords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );\n\t\t\t\td.y = coords.y;\n\n\t\t\t\t// We want the distances to be in pixel units:\n\t\t\t\td = d / resolution.y - pixcoord.y;\n\n\t\t\t\t// SMAAArea below needs a sqrt, as the areas texture is compressed\n\t\t\t\t// quadratically:\n\t\t\t\tvec2 sqrt_d = sqrt( abs( d ) );\n\n\t\t\t\t// Fetch the bottom crossing edges:\n\t\t\t\tcoords.y -= 1.0 * resolution.y; // WebGL port note: Added\n\t\t\t\tfloat e2 = SMAASampleLevelZeroOffset( edgesTex, coords, ivec2( 0, 1 ) ).g;\n\n\t\t\t\t// Get the area for this direction:\n\t\t\t\tweights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );\n\t\t\t}\n\n\t\t\treturn weights;\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = SMAABlendingWeightCalculationPS( vUv, vPixcoord, vOffset, tDiffuse, tArea, tSearch, ivec4( 0.0 ) );\n\n\t\t}"},fl={uniforms:{tDiffuse:{value:null},tColor:{value:null},resolution:{value:new l(1/1024,1/512)}},vertexShader:"\n\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[ 2 ];\n\n\t\tvoid SMAANeighborhoodBlendingVS( vec2 texcoord ) {\n\t\t\tvOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 ); // WebGL port note: Changed sign in W component\n\t\t\tvOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 ); // WebGL port note: Changed sign in W component\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tSMAANeighborhoodBlendingVS( vUv );\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform sampler2D tColor;\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[ 2 ];\n\n\t\tvec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {\n\t\t\t// Fetch the blending weights for current pixel:\n\t\t\tvec4 a;\n\t\t\ta.xz = texture2D( blendTex, texcoord ).xz;\n\t\t\ta.y = texture2D( blendTex, offset[ 1 ].zw ).g;\n\t\t\ta.w = texture2D( blendTex, offset[ 1 ].xy ).a;\n\n\t\t\t// Is there any blending weight with a value greater than 0.0?\n\t\t\tif ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {\n\t\t\t\treturn texture2D( colorTex, texcoord, 0.0 );\n\t\t\t} else {\n\t\t\t\t// Up to 4 lines can be crossing a pixel (one through each edge). We\n\t\t\t\t// favor blending by choosing the line with the maximum weight for each\n\t\t\t\t// direction:\n\t\t\t\tvec2 offset;\n\t\t\t\toffset.x = a.a > a.b ? a.a : -a.b; // left vs. right\n\t\t\t\toffset.y = a.g > a.r ? -a.g : a.r; // top vs. bottom // WebGL port note: Changed signs\n\n\t\t\t\t// Then we go in the direction that has the maximum weight:\n\t\t\t\tif ( abs( offset.x ) > abs( offset.y )) { // horizontal vs. vertical\n\t\t\t\t\toffset.y = 0.0;\n\t\t\t\t} else {\n\t\t\t\t\toffset.x = 0.0;\n\t\t\t\t}\n\n\t\t\t\t// Fetch the opposite color and lerp by hand:\n\t\t\t\tvec4 C = texture2D( colorTex, texcoord, 0.0 );\n\t\t\t\ttexcoord += sign( offset ) * resolution;\n\t\t\t\tvec4 Cop = texture2D( colorTex, texcoord, 0.0 );\n\t\t\t\tfloat s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );\n\n\t\t\t\t// WebGL port note: Added gamma correction\n\t\t\t\tC.xyz = pow(C.xyz, vec3(2.2));\n\t\t\t\tCop.xyz = pow(Cop.xyz, vec3(2.2));\n\t\t\t\tvec4 mixed = mix(C, Cop, s);\n\t\t\t\tmixed.xyz = pow(mixed.xyz, vec3(1.0 / 2.2));\n\n\t\t\t\treturn mixed;\n\t\t\t}\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = SMAANeighborhoodBlendingPS( vUv, vOffset, tColor, tDiffuse );\n\n\t\t}"};class ml extends Xa{constructor(){super(),this._edgesRT=new F(1,1,{depthBuffer:!1,type:V}),this._edgesRT.texture.name="SMAAPass.edges",this._weightsRT=new F(1,1,{depthBuffer:!1,type:V}),this._weightsRT.texture.name="SMAAPass.weights";const t=this,e=new Image;e.src=this._getAreaTexture(),e.onload=function(){t._areaTexture.needsUpdate=!0},this._areaTexture=new mt,this._areaTexture.name="SMAAPass.area",this._areaTexture.image=e,this._areaTexture.minFilter=gt,this._areaTexture.generateMipmaps=!1,this._areaTexture.flipY=!1;const i=new Image;i.src=this._getSearchTexture(),i.onload=function(){t._searchTexture.needsUpdate=!0},this._searchTexture=new mt,this._searchTexture.name="SMAAPass.search",this._searchTexture.image=i,this._searchTexture.magFilter=it,this._searchTexture.minFilter=it,this._searchTexture.generateMipmaps=!1,this._searchTexture.flipY=!1,this._uniformsEdges=R.clone(ul.uniforms),this._materialEdges=new U({defines:Object.assign({},ul.defines),uniforms:this._uniformsEdges,vertexShader:ul.vertexShader,fragmentShader:ul.fragmentShader}),this._uniformsWeights=R.clone(pl.uniforms),this._uniformsWeights.tDiffuse.value=this._edgesRT.texture,this._uniformsWeights.tArea.value=this._areaTexture,this._uniformsWeights.tSearch.value=this._searchTexture,this._materialWeights=new U({defines:Object.assign({},pl.defines),uniforms:this._uniformsWeights,vertexShader:pl.vertexShader,fragmentShader:pl.fragmentShader}),this._uniformsBlend=R.clone(fl.uniforms),this._uniformsBlend.tDiffuse.value=this._weightsRT.texture,this._materialBlend=new U({uniforms:this._uniformsBlend,vertexShader:fl.vertexShader,fragmentShader:fl.fragmentShader}),this._fsQuad=new Ka(null)}render(t,e,i){this._uniformsEdges.tDiffuse.value=i.texture,this._fsQuad.material=this._materialEdges,t.setRenderTarget(this._edgesRT),this.clear&&t.clear(),this._fsQuad.render(t),this._fsQuad.material=this._materialWeights,t.setRenderTarget(this._weightsRT),this.clear&&t.clear(),this._fsQuad.render(t),this._uniformsBlend.tColor.value=i.texture,this._fsQuad.material=this._materialBlend,this.renderToScreen?(t.setRenderTarget(null),this._fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(),this._fsQuad.render(t))}setSize(t,e){this._edgesRT.setSize(t,e),this._weightsRT.setSize(t,e),this._materialEdges.uniforms.resolution.value.set(1/t,1/e),this._materialWeights.uniforms.resolution.value.set(1/t,1/e),this._materialBlend.uniforms.resolution.value.set(1/t,1/e)}dispose(){this._edgesRT.dispose(),this._weightsRT.dispose(),this._areaTexture.dispose(),this._searchTexture.dispose(),this._materialEdges.dispose(),this._materialWeights.dispose(),this._materialBlend.dispose(),this._fsQuad.dispose()}_getAreaTexture(){return"data:image/png;base64,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"}_getSearchTexture(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAAAhCAAAAABIXyLAAAAAOElEQVRIx2NgGAWjYBSMglEwEICREYRgFBZBqDCSLA2MGPUIVQETE9iNUAqLR5gIeoQKRgwXjwAAGn4AtaFeYLEAAAAASUVORK5CYII="}}var gl=(t=>(t[t.DEFAULT=0]="DEFAULT",t[t.GLOBAL=1]="GLOBAL",t))(gl||{});class vl extends Xa{constructor(t,i,s=1){super(),e(this,"_edgeMaterial"),e(this,"_combineMaterial"),e(this,"_fsQuad"),e(this,"_edgeRenderTarget"),e(this,"_vertexColorRenderTarget"),e(this,"_fragments"),e(this,"_renderer"),e(this,"_overrideMaterial"),e(this,"_depthBiasStrength",.001),e(this,"_mode",0),this._renderer=t,this._fragments=i,this._overrideMaterial=new o.ShaderMaterial({clipping:!0,vertexColors:!0,side:o.DoubleSide,uniforms:{depthBiasStrength:{value:this._depthBiasStrength}},vertexShader:"\n        #include <common>\n        #include <color_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n        \n        uniform float depthBiasStrength;\n        \n        void main() {\n          #include <color_vertex>\n          vColor = color;\n          \n          #include <begin_vertex>\n          #include <project_vertex>\n          \n          // Compute priority from vertex color (using luminance)\n          // Higher values = higher priority = render on top\n          float priority = dot(color, vec3(0.299, 0.587, 0.114)); // Luminance\n          \n          // Apply depth bias: subtract from z to bring higher priority faces closer\n          // In clip space, smaller z values are closer to camera\n          gl_Position.z -= priority * depthBiasStrength;\n\n          #include <clipping_planes_vertex>\n        }\n      ",fragmentShader:"\n        varying vec3 vColor;\n        #include <clipping_planes_pars_fragment>\n        \n        void main() {\n          #include <clipping_planes_fragment>\n          gl_FragColor = vec4(vColor, 1.0);\n        }\n      "}),this._edgeMaterial=new o.ShaderMaterial({uniforms:{tDiffuse:{value:null},width:{value:s}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform float width;\n        varying vec2 vUv;\n\n        void main() {\n          vec2 texel = vec2(1.0 / float(textureSize(tDiffuse, 0).x), 1.0 / float(textureSize(tDiffuse, 0).y));\n          vec2 offset = texel * width;\n          \n          vec4 center = texture2D(tDiffuse, vUv);\n          vec4 right = texture2D(tDiffuse, vUv + vec2(offset.x, 0.0));\n          vec4 up = texture2D(tDiffuse, vUv + vec2(0.0, offset.y));\n          \n          float diff = 0.0;\n          diff += distance(center.rgb, right.rgb);\n          diff += distance(center.rgb, up.rgb);\n          gl_FragColor = vec4(vec3(step(0.0001, diff)), 1.0);\n        }\n      "}),this._combineMaterial=new o.ShaderMaterial({uniforms:{tDiffuse:{value:null},tEdges:{value:null},edgeColor:{value:new o.Color(8947848)}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform sampler2D tEdges;\n        uniform vec3 edgeColor;\n        varying vec2 vUv;\n\n        void main() {\n          vec4 color = texture2D(tDiffuse, vUv);\n          vec4 edges = texture2D(tEdges, vUv);\n          \n          // Combine color with edges (edges are black, so we multiply)\n          gl_FragColor = mix(color, vec4(edgeColor, 1.0), edges.r);\n        }\n      "}),this._fsQuad=new Ka(this._edgeMaterial),this._edgeRenderTarget=new o.WebGLRenderTarget(1,1,{minFilter:o.LinearFilter,magFilter:o.LinearFilter,format:o.RGBAFormat}),this._vertexColorRenderTarget=new o.WebGLRenderTarget(1,1,{minFilter:o.LinearFilter,magFilter:o.LinearFilter,format:o.RGBAFormat})}get mode(){return this._mode}set mode(t){this._mode=t,this.setMaterialToMesh(!1)}get width(){return this._edgeMaterial.uniforms.width.value}set width(t){this._edgeMaterial.uniforms.width.value=t}get color(){return this._combineMaterial.uniforms.edgeColor.value}set color(t){this._combineMaterial.uniforms.edgeColor.value=t}get depthBiasStrength(){return this._depthBiasStrength}set depthBiasStrength(t){this._depthBiasStrength=t,this._overrideMaterial&&(this._overrideMaterial.uniforms.depthBiasStrength.value=t)}setSize(t,e){this._edgeRenderTarget.setSize(t,e),this._vertexColorRenderTarget.setSize(t,e)}setWidth(t){this._edgeMaterial.uniforms.width.value=t}render(t,e,i){const s=this._renderer.currentWorld,n=s.scene.three,r=s.scene.three,o=r.fog,a=r.background;if(r.fog=null,r.background=null,0===this._mode)this.setMaterialToMesh(!0),t.setRenderTarget(this._vertexColorRenderTarget),t.render(n,s.camera.three),this.setMaterialToMesh(!1);else if(1===this._mode){const e=n.overrideMaterial;n.overrideMaterial=this._overrideMaterial,t.setRenderTarget(this._vertexColorRenderTarget),t.render(n,s.camera.three),n.overrideMaterial=e}r.fog=o,r.background=a,this._edgeMaterial.uniforms.tDiffuse.value=this._vertexColorRenderTarget.texture,this._fsQuad.material=this._edgeMaterial,t.setRenderTarget(this._edgeRenderTarget),this._fsQuad.render(t),this._combineMaterial.uniforms.tDiffuse.value=i.texture,this._combineMaterial.uniforms.tEdges.value=this._edgeRenderTarget.texture,this._fsQuad.material=this._combineMaterial,this.renderToScreen?t.setRenderTarget(null):t.setRenderTarget(e),this._fsQuad.render(t)}dispose(){this._edgeMaterial.dispose(),this._combineMaterial.dispose(),this._overrideMaterial.dispose(),this._fsQuad.dispose(),this._edgeRenderTarget.dispose(),this._vertexColorRenderTarget.dispose()}setMaterialToMesh(t){for(const[,e]of this._fragments.core.models.list)for(const[,i]of e.tiles)"isLODGeometry"in i.geometry||(t?(i.userData.edgePassPreviousMaterial=i.material,i.material=[this._overrideMaterial]):"edgePassPreviousMaterial"in i.userData&&(i.material=i.userData.edgePassPreviousMaterial))}}class _l extends Xa{constructor(t,i,s){super(),e(this,"outlineColor",new o.Color(16762880)),e(this,"thickness",2),e(this,"fillColor",new o.Color(16776960)),e(this,"fillOpacity",.3),e(this,"debugShowMask",!1),e(this,"scene",new o.Scene),e(this,"_maskTarget"),e(this,"_fsQuad"),e(this,"_world"),e(this,"_debugQuad",null),this._world=s,this.scene.background=new o.Color(0),this._maskTarget=new o.WebGLRenderTarget(t,i,{minFilter:o.LinearFilter,magFilter:o.LinearFilter,format:o.RGBAFormat,type:o.UnsignedByteType}),this._fsQuad=new Ka(new o.ShaderMaterial({uniforms:{tDiffuse:{value:null},tMask:{value:null},outlineColor:{value:new o.Color(65280)},thickness:{value:2},resolution:{value:new o.Vector2(t,i)},fillColor:{value:new o.Color(16776960)},fillOpacity:{value:.3}},vertexShader:"\n          varying vec2 vUv;\n          void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n          }\n        ",fragmentShader:"\n          uniform sampler2D tDiffuse;\n          uniform sampler2D tMask;\n          uniform vec3 outlineColor;\n          uniform float thickness;\n          uniform vec2 resolution;\n          uniform vec3 fillColor;\n          uniform float fillOpacity;\n          varying vec2 vUv;\n\n          void main() {\n            float mask = texture2D(tMask, vUv).r;\n            float outline = 0.0;\n            float t = thickness;\n            vec2 texel = 1.0 / resolution;\n            for (float x = -t; x <= t; x++) {\n              for (float y = -t; y <= t; y++) {\n                vec2 offset = vec2(x, y) * texel;\n                float neighbor = texture2D(tMask, vUv + offset).r;\n                if (neighbor > 0.5) outline = 1.0;\n              }\n            }\n            vec4 sceneColor = texture2D(tDiffuse, vUv);\n            // Fill inside\n            if (mask > 0.5) {\n              sceneColor.rgb = mix(sceneColor.rgb, fillColor, fillOpacity);\n            }\n            // Only draw outline where mask is not set but neighbor is\n            if (outline > 0.5 && mask < 0.5) {\n              gl_FragColor = vec4(outlineColor, 1.0);\n            } else {\n              gl_FragColor = sceneColor;\n            }\n          }\n        "})),this._debugQuad=new Ka(new o.ShaderMaterial({uniforms:{tMask:{value:null}},vertexShader:"\n          varying vec2 vUv;\n          void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n          }\n        ",fragmentShader:"\n          uniform sampler2D tMask;\n          varying vec2 vUv;\n          void main() {\n            float mask = texture2D(tMask, vUv).r;\n            gl_FragColor = vec4(vec3(mask), 1.0);\n          }\n        "}))}setSize(t,e){this._maskTarget.setSize(t,e),this._fsQuad.material.uniforms.resolution.value.set(t,e)}render(t,e,i){const s=this._world.camera.three,n=t.getClearColor(new o.Color),r=t.getClearAlpha();if(t.setClearColor(0,0),t.setRenderTarget(this._maskTarget),t.clear(),t.render(this.scene,s),t.setClearColor(n,r),this.debugShowMask){return this._debugQuad.material.uniforms.tMask.value=this._maskTarget.texture,this.renderToScreen?t.setRenderTarget(null):t.setRenderTarget(e),void this._debugQuad.render(t)}const a=this._fsQuad.material;a.uniforms.tDiffuse.value=i.texture,a.uniforms.tMask.value=this._maskTarget.texture,a.uniforms.outlineColor.value.copy(this.outlineColor),a.uniforms.thickness.value=this.thickness,a.uniforms.fillColor.value.copy(this.fillColor),a.uniforms.fillOpacity.value=this.fillOpacity,this.renderToScreen?t.setRenderTarget(null):t.setRenderTarget(e),this._fsQuad.render(t)}dispose(){this._maskTarget.dispose(),this._fsQuad.dispose();const t=[...this.scene.children];for(const e of t)e.removeFromParent()}}class yl extends Xa{constructor(t,i){super(),e(this,"materialToExclude",new o.MeshBasicMaterial({color:0})),e(this,"_excludedMaterials",new Set),e(this,"_originalMaterials",new Map),e(this,"_renderer"),e(this,"_world"),e(this,"_fsQuad"),e(this,"_combineMaterial"),e(this,"_excludedRenderTarget"),this._renderer=t,this._world=i,this._excludedRenderTarget=new o.WebGLRenderTarget(1,1,{minFilter:o.LinearFilter,magFilter:o.LinearFilter,format:o.RGBAFormat}),this._combineMaterial=new o.ShaderMaterial({uniforms:{tDiffuse:{value:null},tExcluded:{value:null}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform sampler2D tExcluded;\n        varying vec2 vUv;\n\n        void main() {\n          vec4 inputColor = texture2D(tDiffuse, vUv);\n          vec4 excludedColor = texture2D(tExcluded, vUv);\n          \n          // If excluded pixel is black (or very dark), use input color\n          // Otherwise, use excluded color\n          float excludedLuminance = (excludedColor.r + excludedColor.g + excludedColor.b) / 3.0;\n          float threshold = 0.01; // Adjust this threshold as needed\n          \n          if (excludedLuminance < threshold) {\n            gl_FragColor = inputColor;\n          } else {\n            gl_FragColor = excludedColor;\n          }\n        }\n      "}),this._fsQuad=new Ka(this._combineMaterial)}addExcludedMaterial(t){this._excludedMaterials.add(t)}removeExcludedMaterial(t){this._excludedMaterials.delete(t)}clearExcludedMaterials(){this._excludedMaterials.clear()}get excludedMaterials(){return Array.from(this._excludedMaterials)}setSize(t,e){this._excludedRenderTarget.setSize(t,e)}render(t,e,i){const s=this._world.scene.three,n=this._world.camera.three,r=t.getClearColor(new o.Color),a=t.getClearAlpha();t.setClearColor(0,0),this._substituteMaterials(s),t.setRenderTarget(this._excludedRenderTarget),t.render(s,n),this._restoreMaterials(),this._combineMaterial.uniforms.tDiffuse.value=i.texture,this._combineMaterial.uniforms.tExcluded.value=this._excludedRenderTarget.texture,this.renderToScreen?t.setRenderTarget(null):t.setRenderTarget(e),this._fsQuad.render(t),t.setClearColor(r,a)}_substituteMaterials(t){if(t instanceof o.Mesh){const e=t.material;if(Array.isArray(e)){for(const t of e)if("isLodMaterial"in t)return}else if("isLodMaterial"in e)return;this._excludedMaterials.has(e)||(this._originalMaterials.set(t,e),t.material=this.materialToExclude)}for(const e of t.children)this._substituteMaterials(e)}_restoreMaterials(){for(const[t,e]of this._originalMaterials)t.material=e;this._originalMaterials.clear()}dispose(){this.materialToExclude.dispose(),this._combineMaterial.dispose(),this._fsQuad.dispose(),this._excludedRenderTarget.dispose(),this._excludedMaterials.clear(),this._originalMaterials.clear()}}class wl extends Xa{constructor(t,i,s=null,n=null,r=null){super(),e(this,"scene"),e(this,"camera"),e(this,"overrideMaterial"),e(this,"clearColor"),e(this,"clearAlpha"),e(this,"clearDepth"),e(this,"needsSwap"),e(this,"isolatedMaterials",[]),e(this,"_oldClearColor"),this.scene=t,this.camera=i,this.overrideMaterial=s,this.clearColor=n,this.clearAlpha=r,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new o.Color}render(t,e,i){for(const t of this.isolatedMaterials)void 0!==t.userData.wasVisibleBasePass&&(t.visible=t.userData.wasVisibleBasePass);const s=t.autoClear;let n,r;t.autoClear=!1,null!==this.overrideMaterial&&(r=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),null!==this.clearColor&&(t.getClearColor(this._oldClearColor),t.setClearColor(this.clearColor,t.getClearAlpha())),null!==this.clearAlpha&&(n=t.getClearAlpha(),t.setClearAlpha(this.clearAlpha)),!0===this.clearDepth&&t.clearDepth(),t.setRenderTarget(this.renderToScreen?null:i),!0===this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),t.render(this.scene,this.camera),null!==this.clearColor&&t.setClearColor(this._oldClearColor),null!==this.clearAlpha&&t.setClearAlpha(n),null!==this.overrideMaterial&&(this.scene.overrideMaterial=r),t.autoClear=s;for(const t of this.isolatedMaterials)t.userData.wasVisibleBasePass=t.visible,t.visible=!1}}class bl extends Xa{constructor(t,i){super(),e(this,"resolution"),e(this,"renderScene"),e(this,"renderCamera"),e(this,"fsQuad"),e(this,"glossOverrideMaterial"),e(this,"glossBuffer"),e(this,"_glossEnabled",!0),this.renderScene=i.scene.three,this.renderCamera=i.camera.three,this.resolution=new o.Vector2(t.x,t.y),this.fsQuad=new Ka,this.fsQuad.material=this.createGlossMaterial(),this.glossBuffer=this.newRenderTarget();const s=new o.ShaderMaterial({clipping:!0,uniforms:{glossExponent:{value:10},fresnelExponent:{value:6},glossFactor:{value:.2},fresnelFactor:{value:1}},vertexShader:"\n    varying vec3 vCameraPosition;\n    varying vec3 vPosition;\n    varying vec3 vNormal;\n    \n    #include <clipping_planes_pars_vertex>\n  \n    void main() {\n       #include <begin_vertex>\n       \n       vec4 absPosition = vec4(position, 1.0);\n       vNormal = normal;\n       \n       #ifdef USE_INSTANCING\n          absPosition = instanceMatrix * absPosition;\n          vNormal = (instanceMatrix * vec4(normal, 0.)).xyz;\n       #endif\n       \n       absPosition = modelMatrix * absPosition;\n       vNormal = (normalize(modelMatrix * vec4(vNormal, 0.))).xyz;\n       \n       gl_Position = projectionMatrix * viewMatrix * absPosition;\n       \n       vCameraPosition = cameraPosition;\n       vPosition = absPosition.xyz;\n       \n       #include <project_vertex>\n       #include <clipping_planes_vertex>\n    }\n    ",fragmentShader:"\n    uniform float glossExponent;\n    uniform float glossFactor;\n    uniform float fresnelExponent;\n    uniform float fresnelFactor;\n\n    varying vec3 vCameraPosition;\n    varying vec3 vPosition;\n    varying vec3 vNormal;\n    \n    #include <clipping_planes_pars_fragment>\n  \n    void main() {\n      #include <clipping_planes_fragment>\n      vec3 cameraPixelVec = normalize(vCameraPosition - vPosition);\n      float dotProduct = dot(vNormal, cameraPixelVec);\n\n      // Use abs() for both gloss and fresnel to handle DoubleSide materials\n      // On back faces, dotProduct is negative, which breaks the fresnel calculation\n\n      float absDotProduct = abs(dotProduct);\n      float gloss = absDotProduct;\n\n      // Use absDotProduct instead of dotProduct to prevent values > 1.0\n      \n      float fresnel = pow(1.0 - absDotProduct, fresnelExponent) * fresnelFactor;\n\n      gloss = pow(gloss, glossExponent) * glossFactor;\n\n      float result = gloss + fresnel;\n\n      gl_FragColor = vec4(result, result, result, 1.);\n    }\n    "});this.glossOverrideMaterial=s}get glossEnabled(){return this._glossEnabled}set glossEnabled(t){this._glossEnabled=t;this.fsQuad.material.uniforms.glossEnabled.value=t?1:0}get minGloss(){return this.fsQuad.material.uniforms.minGloss.value}set minGloss(t){this.fsQuad.material.uniforms.minGloss.value=t}get maxGloss(){return this.fsQuad.material.uniforms.maxGloss.value}set maxGloss(t){this.fsQuad.material.uniforms.maxGloss.value=t}get glossExponent(){return this.glossOverrideMaterial.uniforms.glossExponent.value}set glossExponent(t){this.glossOverrideMaterial.uniforms.glossExponent.value=t}get fresnelExponent(){return this.glossOverrideMaterial.uniforms.fresnelExponent.value}set fresnelExponent(t){this.glossOverrideMaterial.uniforms.fresnelExponent.value=t}get glossFactor(){return this.glossOverrideMaterial.uniforms.glossFactor.value}set glossFactor(t){this.glossOverrideMaterial.uniforms.glossFactor.value=t}get fresnelFactor(){return this.glossOverrideMaterial.uniforms.fresnelFactor.value}set fresnelFactor(t){this.glossOverrideMaterial.uniforms.fresnelFactor.value=t}dispose(){this.glossBuffer.dispose(),this.glossOverrideMaterial.dispose(),this.fsQuad.dispose()}setSize(t,e){this.glossBuffer.setSize(t,e),this.resolution.set(t,e),this.fsQuad.material.uniforms.screenSize.value.set(this.resolution.x,this.resolution.y,1/this.resolution.x,1/this.resolution.y)}render(t,e,i){const s=e.depthBuffer;e.depthBuffer=!1;const n=this.renderScene.overrideMaterial,r=this.renderScene.background;this.renderScene.background=null,t.setRenderTarget(this.glossBuffer),this.renderScene.overrideMaterial=this.glossOverrideMaterial,t.render(this.renderScene,this.renderCamera),this.renderScene.overrideMaterial=n,this.renderScene.background=r;const o=this.fsQuad.material;o.uniforms.glossBuffer.value=this.glossBuffer.texture,o.uniforms.sceneColorBuffer.value=i.texture,this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.fsQuad.render(t)),e.depthBuffer=s}get vertexShader(){return"\n      varying vec2 vUv;\n      void main() {\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n      }\n    "}get fragmentShader(){return"\n      uniform sampler2D sceneColorBuffer;\n      uniform sampler2D glossBuffer;\n      uniform vec4 screenSize;\n      uniform float glossEnabled;\n      uniform float minGloss;\n      uniform float maxGloss;\n\n\n      varying vec2 vUv;\n\n      vec4 getValue(sampler2D buffer, int x, int y) {\n        return texture2D(buffer, vUv + screenSize.zw * vec2(x, y));\n      }\n\n      void main() {\n        vec4 sceneColor = getValue(sceneColorBuffer, 0, 0);\n        \n        // Apply gloss effect\n        vec3 gloss = getValue(glossBuffer, 0, 0).xyz;\n        // Prevent the gloss from being zero, which would break normalize() later\n        gloss = max(gloss, vec3(0.001));\n        \n        vec3 glossEffect = gloss * glossEnabled;\n\n        // Map glossEffect to range [minGloss, maxGloss]\n        // All dimensions of the glossEffect are the same, so we can use the x dimension.\n        float mappedGloss = minGloss + (maxGloss - minGloss) * glossEffect.x;\n\n\n        glossEffect = normalize(glossEffect) * mappedGloss;\n\n        vec4 glossedColor = sceneColor + vec4(glossEffect, 0.0);\n\n        // Prevent the glossed color from being darker than zero\n        glossedColor = max(glossedColor, vec4(0.0, 0.0, 0.0, sceneColor.a));\n        \n        gl_FragColor = glossedColor;\n      }\n    "}createGlossMaterial(){return new o.ShaderMaterial({uniforms:{sceneColorBuffer:{value:null},glossBuffer:{value:null},glossEnabled:{value:this._glossEnabled?1:0},minGloss:{value:-.12},maxGloss:{value:.8},screenSize:{value:new o.Vector4(this.resolution.x,this.resolution.y,1/this.resolution.x,1/this.resolution.y)}},vertexShader:this.vertexShader,fragmentShader:this.fragmentShader})}newRenderTarget(){const t=new o.WebGLRenderTarget(this.resolution.x,this.resolution.y);return t.texture.colorSpace="srgb-linear",t.texture.format=o.RGBAFormat,t.texture.type=o.HalfFloatType,t.texture.minFilter=o.NearestFilter,t.texture.magFilter=o.NearestFilter,t.texture.generateMipmaps=!1,t.stencilBuffer=!1,t}}var xl=(t=>(t[t.COLOR=0]="COLOR",t[t.PEN=1]="PEN",t[t.PEN_SHADOWS=2]="PEN_SHADOWS",t[t.COLOR_PEN=3]="COLOR_PEN",t[t.COLOR_SHADOWS=4]="COLOR_SHADOWS",t[t.COLOR_PEN_SHADOWS=5]="COLOR_PEN_SHADOWS",t))(xl||{});class Sl{constructor(t,i){e(this,"invisibleMaterials",new Set),e(this,"composer"),e(this,"onStyleChanged",new At),e(this,"_enabled",!1),e(this,"_initialized",!1),e(this,"_basePass"),e(this,"_aoPass"),e(this,"_outputPass"),e(this,"_edgeDetectionPass"),e(this,"_smaaPass"),e(this,"_simpleOutlinePass"),e(this,"_excludedObjectsPass"),e(this,"_glossPass"),e(this,"_style",0),e(this,"_outlinesEnabled",!1),e(this,"_glossEnabled",!1),e(this,"_smaaEnabled",!1),e(this,"_excludedObjectsEnabled",!1),e(this,"_components"),e(this,"_renderer"),e(this,"defaultAoParameters",{radius:.25,distanceExponent:5.7,thickness:10,scale:2,samples:16,distanceFallOff:1,screenSpaceRadius:!0}),this._components=t,this._renderer=i}get basePass(){if(!this._basePass)throw new Error("Base pass not initialized");return this._basePass}get enabled(){return this._enabled}set enabled(t){if(this._enabled=t,t&&!this._initialized&&this.initialize(),!t)for(const t of this.basePass.isolatedMaterials)t.visible=!0}get aoPass(){if(!this._aoPass)throw new Error("AO pass not initialized");return this._aoPass}get outlinePass(){if(!this._simpleOutlinePass)throw new Error("Outline pass not initialized");return this._simpleOutlinePass}get edgesPass(){if(!this._edgeDetectionPass)throw new Error("Edge detection pass not initialized");return this._edgeDetectionPass}get excludedObjectsPass(){if(!this._excludedObjectsPass)throw new Error("Excluded objects pass not initialized");return this._excludedObjectsPass}get glossPass(){if(!this._glossPass)throw new Error("Gloss pass not initialized");return this._glossPass}get outlinesEnabled(){return this._outlinesEnabled}set outlinesEnabled(t){this._outlinesEnabled=t,this.style=this._style}get excludedObjectsEnabled(){return this._excludedObjectsEnabled}set excludedObjectsEnabled(t){this._excludedObjectsEnabled=t,this.style=this._style}get glossEnabled(){return this._glossEnabled}set glossEnabled(t){this._glossEnabled=t,this.style=this._style}get smaaEnabled(){return this._smaaEnabled}set smaaEnabled(t){this._smaaEnabled=t,this.style=this._style}get style(){return this._style}set style(t){this.composer&&(!this.composer||!this._basePass||!this._smaaPass||!this._outputPass||!this._aoPass||!this._edgeDetectionPass||!this._simpleOutlinePass||!this._excludedObjectsPass||!this._glossPass||(2===this._style&&this._aoPass.updateGtaoMaterial(this.defaultAoParameters),this._style=t,this.clear(),0===t&&(this.composer.addPass(this._basePass),this._glossEnabled&&this.composer.addPass(this._glossPass),this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass),this.composer.addPass(this._outputPass)),1===t&&(this.composer.addPass(this._edgeDetectionPass),this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass)),2===t&&(this.composer.addPass(this._basePass),this.composer.addPass(this._aoPass),this._aoPass.output=hl.OUTPUT.AO,this.composer.addPass(this._edgeDetectionPass),this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass),this.composer.addPass(this._outputPass)),3===t&&(this.composer.addPass(this._basePass),this._glossEnabled&&this.composer.addPass(this._glossPass),this.composer.addPass(this._edgeDetectionPass),this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass),this.composer.addPass(this._outputPass)),4===t&&(this.composer.addPass(this._basePass),this._glossEnabled&&this.composer.addPass(this._glossPass),this.composer.addPass(this._aoPass),this._aoPass.output=hl.OUTPUT.Default,this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass),this.composer.addPass(this._outputPass)),5===t&&(this.composer.addPass(this._basePass),this._glossEnabled&&this.composer.addPass(this._glossPass),this.composer.addPass(this._aoPass),this._aoPass.output=hl.OUTPUT.Default,this.composer.addPass(this._edgeDetectionPass),this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass),this.composer.addPass(this._outputPass)),this.onStyleChanged.trigger(t)))}update(){if(this.composer){for(const t of this.invisibleMaterials)t.userData.wasVisibleForPostproduction=t.visible,t.visible=!1;this.composer.render();for(const t of this.invisibleMaterials)t.visible=t.userData.wasVisibleForPostproduction}}dispose(){var t,e,i,s,n,r,o,a;null==(t=this.composer)||t.dispose(),null==(e=this._aoPass)||e.dispose(),null==(i=this._outputPass)||i.dispose(),null==(s=this._edgeDetectionPass)||s.dispose(),null==(n=this._smaaPass)||n.dispose(),null==(r=this._simpleOutlinePass)||r.dispose(),null==(o=this._excludedObjectsPass)||o.dispose(),null==(a=this._glossPass)||a.dispose()}setSize(t,e){0===t||0===e||(this.composer&&this.composer.setSize(t,e),this._simpleOutlinePass&&this._simpleOutlinePass.setSize(t,e),this._excludedObjectsPass&&this._excludedObjectsPass.setSize(t,e),this._glossPass&&this._glossPass.setSize(t,e))}updateCamera(){const t=this._renderer.currentWorld.camera.three;this._basePass&&(this._basePass.camera=t),this._aoPass&&(this._aoPass.camera=t)}clear(){if(!this.composer)return;const t=[...this.composer.passes];for(const e of t)this.composer.removePass(e);this._renderer.three.setClearColor(0,0),this._renderer.three.setRenderTarget(this.composer.renderTarget1),this._renderer.three.clear(),this._renderer.three.setRenderTarget(this.composer.renderTarget2),this._renderer.three.clear(),this._renderer.three.setRenderTarget(null)}initialize(){this._initialized=!0;const t=this._renderer.currentWorld.scene.three,e=this._renderer.currentWorld.camera.three;this._renderer.three.setClearColor(0,0),this.composer=new el(this._renderer.three);const i=new wl(t,e);this._basePass=i,this._smaaPass=new ml,this._aoPass=new hl(t,e,this._renderer.three.domElement.width,this._renderer.three.domElement.height),this._aoPass.output=hl.OUTPUT.Default;const s=this._components.get(pi);this._edgeDetectionPass=new vl(this._renderer,s),this._outputPass=new dl,this._simpleOutlinePass=new _l(this._renderer.three.domElement.width,this._renderer.three.domElement.height,this._renderer.currentWorld),this._excludedObjectsPass=new yl(this._renderer,this._renderer.currentWorld),this._glossPass=new bl(new o.Vector2(this._renderer.three.domElement.width,this._renderer.three.domElement.height),this._renderer.currentWorld),this.style=0}}class El extends Wa{constructor(t,i,s){super(t,i,s),e(this,"manualDefaultStyle",xl.COLOR),e(this,"turnOffOnManualMode",!0),e(this,"manualModeDelay",50),e(this,"_postproduction"),e(this,"_timeout"),e(this,"_previousStyle",xl.COLOR),e(this,"_previousEnabled",!1),this.onResize.add(t=>{this.setPostproductionSize(t)}),this.onWorldChanged.add(()=>{this.currentWorld&&(this._postproduction&&this._postproduction.dispose(),this._postproduction=new Sl(t,this),this._postproduction.onStyleChanged.add(t=>{this._previousStyle=t}),this.setPostproductionSize())})}get postproduction(){if(!this._postproduction)throw new Error("Renderer not initialized yet with a world!");return this._postproduction}update(){if(!this.enabled||!this.currentWorld||this.mode===Di.MANUAL&&!this.needsUpdate)return;this.needsUpdate=!1,this.onBeforeUpdate.trigger();const t=this.currentWorld.scene.three,e=this.currentWorld.camera.three;this.mode===Di.MANUAL&&(this.turnOffOnManualMode&&this.postproduction.enabled&&(this._previousEnabled=this.postproduction.enabled,this.postproduction.enabled=!1),this.manualDefaultStyle!==this.postproduction.style&&this.setStyleWithoutEvent(this.manualDefaultStyle)),this.postproduction.enabled?this.postproduction.update():this.three.render(t,e),t instanceof o.Scene&&this.three2D.render(t,e),this.mode===Di.MANUAL&&(this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(()=>{this.turnOffOnManualMode&&(this.postproduction.enabled=this._previousEnabled),this.setStyleWithoutEvent(this._previousStyle),this.postproduction.update()},this.manualModeDelay)),this.onAfterUpdate.trigger()}dispose(){super.dispose(),this.postproduction.dispose()}setStyleWithoutEvent(t){this.postproduction.onStyleChanged.enabled=!1,this.postproduction.style=t,this.postproduction.onStyleChanged.enabled=!0}setPostproductionSize(t){if(t&&(0===t.x||0===t.y)||!this.container||!this._postproduction)return;const e=Math.min(window.devicePixelRatio,2),i=(null==t?void 0:t.x)??this.container.clientWidth*e,s=(null==t?void 0:t.y)??this.container.clientHeight*e;0===i||0===s||this.postproduction.setSize(i,s)}}const Cl=new d,Tl=new a;class Pl extends vt{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new M([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new M([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix4(t){const e=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==e&&(e.applyMatrix4(t),i.applyMatrix4(t),e.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){let e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));const i=new _t(e,6,1);return this.setAttribute("instanceStart",new yt(i,3,0)),this.setAttribute("instanceEnd",new yt(i,3,3)),this.instanceCount=this.attributes.instanceStart.count,this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){let e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));const i=new _t(e,6,1);return this.setAttribute("instanceColorStart",new yt(i,3,0)),this.setAttribute("instanceColorEnd",new yt(i,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new wt(t.geometry)),this}fromLineSegments(t){const e=t.geometry;return this.setPositions(e.attributes.position.array),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new d);const t=this.attributes.instanceStart,e=this.attributes.instanceEnd;void 0!==t&&void 0!==e&&(this.boundingBox.setFromBufferAttribute(t),Cl.setFromBufferAttribute(e),this.boundingBox.union(Cl))}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new _),null===this.boundingBox&&this.computeBoundingBox();const t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(void 0!==t&&void 0!==e){const i=this.boundingSphere.center;this.boundingBox.getCenter(i);let s=0;for(let n=0,r=t.count;n<r;n++)Tl.fromBufferAttribute(t,n),s=Math.max(s,i.distanceToSquared(Tl)),Tl.fromBufferAttribute(e,n),s=Math.max(s,i.distanceToSquared(Tl));this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}}xt.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new l(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},bt.line={uniforms:R.merge([xt.common,xt.fog,xt.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\tworldStart = start.xyz;\n\t\t\t\tworldEnd = end.xyz;\n\n\t\t\t#else\n\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec3 ndcStart = clipStart.xyz / clipStart.w;\n\t\t\tvec3 ndcEnd = clipEnd.xyz / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd.xy - ndcStart.xy;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\tvec3 worldDir = normalize( end.xyz - start.xyz );\n\t\t\t\tvec3 tmpFwd = normalize( mix( start.xyz, end.xyz, 0.5 ) );\n\t\t\t\tvec3 worldUp = normalize( cross( worldDir, tmpFwd ) );\n\t\t\t\tvec3 worldFwd = cross( worldDir, worldUp );\n\t\t\t\tworldPos = position.y < 0.5 ? start: end;\n\n\t\t\t\t// height offset\n\t\t\t\tfloat hw = linewidth * 0.5;\n\t\t\t\tworldPos.xyz += position.x < 0.0 ? hw * worldUp : - hw * worldUp;\n\n\t\t\t\t// don't extend the line if we're rendering dashes because we\n\t\t\t\t// won't be rendering the endcaps\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t// cap extension\n\t\t\t\t\tworldPos.xyz += position.y < 0.5 ? - hw * worldDir : hw * worldDir;\n\n\t\t\t\t\t// add width to the box\n\t\t\t\t\tworldPos.xyz += worldFwd * hw;\n\n\t\t\t\t\t// endcaps\n\t\t\t\t\tif ( position.y > 1.0 || position.y < 0.0 ) {\n\n\t\t\t\t\t\tworldPos.xyz -= worldFwd * 2.0 * hw;\n\n\t\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t\t// project the worldpos\n\t\t\t\tvec4 clip = projectionMatrix * worldPos;\n\n\t\t\t\t// shift the depth of the projected points so the line\n\t\t\t\t// segments overlap neatly\n\t\t\t\tvec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;\n\t\t\t\tclip.z = clipPose.z * clip.w;\n\n\t\t\t#else\n\n\t\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\t\t\t\t// undo aspect ratio adjustment\n\t\t\t\tdir.x /= aspect;\n\t\t\t\toffset.x /= aspect;\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\t\toffset += - dir;\n\n\t\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\t\toffset += dir;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= linewidth;\n\n\t\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\t\toffset /= resolution.y;\n\n\t\t\t\t// select end\n\t\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t\t// back to clip space\n\t\t\t\toffset *= clip.w;\n\n\t\t\t\tclip.xy += offset;\n\n\t\t\t#endif\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\t\tuniform float linewidth;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashOffset;\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {\n\n\t\t\tfloat mua;\n\t\t\tfloat mub;\n\n\t\t\tvec3 p13 = p1 - p3;\n\t\t\tvec3 p43 = p4 - p3;\n\n\t\t\tvec3 p21 = p2 - p1;\n\n\t\t\tfloat d1343 = dot( p13, p43 );\n\t\t\tfloat d4321 = dot( p43, p21 );\n\t\t\tfloat d1321 = dot( p13, p21 );\n\t\t\tfloat d4343 = dot( p43, p43 );\n\t\t\tfloat d2121 = dot( p21, p21 );\n\n\t\t\tfloat denom = d2121 * d4343 - d4321 * d4321;\n\n\t\t\tfloat numer = d1343 * d4321 - d1321 * d4343;\n\n\t\t\tmua = numer / denom;\n\t\t\tmua = clamp( mua, 0.0, 1.0 );\n\t\t\tmub = ( d1343 + d4321 * ( mua ) ) / d4343;\n\t\t\tmub = clamp( mub, 0.0, 1.0 );\n\n\t\t\treturn vec2( mua, mub );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tfloat alpha = opacity;\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// Find the closest points on the view ray and the line segment\n\t\t\t\tvec3 rayEnd = normalize( worldPos.xyz ) * 1e5;\n\t\t\t\tvec3 lineDir = worldEnd - worldStart;\n\t\t\t\tvec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );\n\n\t\t\t\tvec3 p1 = worldStart + lineDir * params.x;\n\t\t\t\tvec3 p2 = rayEnd * params.y;\n\t\t\t\tvec3 delta = p1 - p2;\n\t\t\t\tfloat len = length( delta );\n\t\t\t\tfloat norm = len / linewidth;\n\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t\tfloat dnorm = fwidth( norm );\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );\n\n\t\t\t\t\t#else\n\n\t\t\t\t\t\tif ( norm > 0.5 ) {\n\n\t\t\t\t\t\t\tdiscard;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t#endif\n\n\t\t\t\t#endif\n\n\t\t\t#else\n\n\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t// artifacts appear on some hardware if a derivative is taken within a conditional\n\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\tfloat len2 = a * a + b * b;\n\t\t\t\t\tfloat dlen = fwidth( len2 );\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );\n\n\t\t\t\t\t}\n\n\t\t\t\t#else\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t#endif\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, alpha );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, alpha );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <colorspace_fragment>\n\t\t\t#include <fog_fragment>\n\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t"};class Al extends U{constructor(t){super({type:"LineMaterial",uniforms:R.clone(bt.line.uniforms),vertexShader:bt.line.vertexShader,fragmentShader:bt.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(t)}get color(){return this.uniforms.diffuse.value}set color(t){this.uniforms.diffuse.value=t}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(t){!0===t?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get linewidth(){return this.uniforms.linewidth.value}set linewidth(t){this.uniforms.linewidth&&(this.uniforms.linewidth.value=t)}get dashed(){return"USE_DASH"in this.defines}set dashed(t){!0===t!==this.dashed&&(this.needsUpdate=!0),!0===t?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(t){this.uniforms.dashScale.value=t}get dashSize(){return this.uniforms.dashSize.value}set dashSize(t){this.uniforms.dashSize.value=t}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(t){this.uniforms.dashOffset.value=t}get gapSize(){return this.uniforms.gapSize.value}set gapSize(t){this.uniforms.gapSize.value=t}get opacity(){return this.uniforms.opacity.value}set opacity(t){this.uniforms&&(this.uniforms.opacity.value=t)}get resolution(){return this.uniforms.resolution.value}set resolution(t){this.uniforms.resolution.value.copy(t)}get alphaToCoverage(){return"USE_ALPHA_TO_COVERAGE"in this.defines}set alphaToCoverage(t){this.defines&&(!0===t!==this.alphaToCoverage&&(this.needsUpdate=!0),!0===t?this.defines.USE_ALPHA_TO_COVERAGE="":delete this.defines.USE_ALPHA_TO_COVERAGE)}}const Ml=new St,Ol=new a,Dl=new a,zl=new St,Il=new St,kl=new St,Ll=new a,Nl=new g,Bl=new c,Ul=new a,Rl=new d,Fl=new _,Vl=new St;let jl,Hl;function Wl(t,e,i){return Vl.set(0,0,-e,1).applyMatrix4(t.projectionMatrix),Vl.multiplyScalar(1/Vl.w),Vl.x=Hl/i.width,Vl.y=Hl/i.height,Vl.applyMatrix4(t.projectionMatrixInverse),Vl.multiplyScalar(1/Vl.w),Math.abs(Math.max(Vl.x,Vl.y))}class Gl extends u{constructor(t=new Pl,e=new Al({color:16777215*Math.random()})){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const t=this.geometry,e=t.attributes.instanceStart,i=t.attributes.instanceEnd,s=new Float32Array(2*e.count);for(let t=0,n=0,r=e.count;t<r;t++,n+=2)Ol.fromBufferAttribute(e,t),Dl.fromBufferAttribute(i,t),s[n]=0===n?0:s[n-1],s[n+1]=s[n]+Ol.distanceTo(Dl);const n=new _t(s,2,1);return t.setAttribute("instanceDistanceStart",new yt(n,1,0)),t.setAttribute("instanceDistanceEnd",new yt(n,1,1)),this}raycast(t,e){const i=this.material.worldUnits,s=t.camera;null===s&&!i&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const n=void 0!==t.params.Line2&&t.params.Line2.threshold||0;jl=t.ray;const r=this.matrixWorld,o=this.geometry,l=this.material;let h,c;if(Hl=l.linewidth+n,null===o.boundingSphere&&o.computeBoundingSphere(),Fl.copy(o.boundingSphere).applyMatrix4(r),i)h=.5*Hl;else{h=Wl(s,Math.max(s.near,Fl.distanceToPoint(jl.origin)),l.resolution)}if(Fl.radius+=h,!1!==jl.intersectsSphere(Fl)){if(null===o.boundingBox&&o.computeBoundingBox(),Rl.copy(o.boundingBox).applyMatrix4(r),i)c=.5*Hl;else{c=Wl(s,Math.max(s.near,Rl.distanceToPoint(jl.origin)),l.resolution)}Rl.expandByScalar(c),!1!==jl.intersectsBox(Rl)&&(i?function(t,e){const i=t.matrixWorld,s=t.geometry,n=s.attributes.instanceStart,r=s.attributes.instanceEnd;for(let o=0,l=Math.min(s.instanceCount,n.count);o<l;o++){Bl.start.fromBufferAttribute(n,o),Bl.end.fromBufferAttribute(r,o),Bl.applyMatrix4(i);const s=new a,l=new a;jl.distanceSqToSegment(Bl.start,Bl.end,l,s),l.distanceTo(s)<.5*Hl&&e.push({point:l,pointOnLine:s,distance:jl.origin.distanceTo(l),object:t,face:null,faceIndex:o,uv:null,uv1:null})}}(this,e):function(t,e,i){const s=e.projectionMatrix,n=t.material.resolution,r=t.matrixWorld,o=t.geometry,l=o.attributes.instanceStart,h=o.attributes.instanceEnd,c=Math.min(o.instanceCount,l.count),d=-e.near;jl.at(1,kl),kl.w=1,kl.applyMatrix4(e.matrixWorldInverse),kl.applyMatrix4(s),kl.multiplyScalar(1/kl.w),kl.x*=n.x/2,kl.y*=n.y/2,kl.z=0,Ll.copy(kl),Nl.multiplyMatrices(e.matrixWorldInverse,r);for(let e=0,o=c;e<o;e++){if(zl.fromBufferAttribute(l,e),Il.fromBufferAttribute(h,e),zl.w=1,Il.w=1,zl.applyMatrix4(Nl),Il.applyMatrix4(Nl),zl.z>d&&Il.z>d)continue;if(zl.z>d){const t=zl.z-Il.z,e=(zl.z-d)/t;zl.lerp(Il,e)}else if(Il.z>d){const t=Il.z-zl.z,e=(Il.z-d)/t;Il.lerp(zl,e)}zl.applyMatrix4(s),Il.applyMatrix4(s),zl.multiplyScalar(1/zl.w),Il.multiplyScalar(1/Il.w),zl.x*=n.x/2,zl.y*=n.y/2,Il.x*=n.x/2,Il.y*=n.y/2,Bl.start.copy(zl),Bl.start.z=0,Bl.end.copy(Il),Bl.end.z=0;const o=Bl.closestPointToPointParameter(Ll,!0);Bl.at(o,Ul);const c=Et.lerp(zl.z,Il.z,o),u=c>=-1&&c<=1,p=Ll.distanceTo(Ul)<.5*Hl;if(u&&p){Bl.start.fromBufferAttribute(l,e),Bl.end.fromBufferAttribute(h,e),Bl.start.applyMatrix4(r),Bl.end.applyMatrix4(r);const s=new a,n=new a;jl.distanceSqToSegment(Bl.start,Bl.end,n,s),i.push({point:n,pointOnLine:s,distance:jl.origin.distanceTo(n),object:t,face:null,faceIndex:e,uv:null,uv1:null})}}}(this,s,e))}}onBeforeRender(t){const e=this.material.uniforms;e&&e.resolution&&(t.getViewport(Ml),this.material.uniforms.resolution.value.set(Ml.z,Ml.w))}}class Zl{constructor(t,i){e(this,"_components"),e(this,"_modelStyleGeometries",new s),e(this,"onDisposed",new At),e(this,"three",new o.Group),e(this,"plane"),e(this,"items",new s),e(this,"world",null),e(this,"_visible",!1),this._components=t,this.plane=i,this.setupEvents()}set visible(t){t?this.world&&(this.world.scene.three.add(this.three),this._visible=!0):(this.three.removeFromParent(),this._visible=!1)}get visible(){return this._visible}setupEvents(){const t=this._components.get(Xl);this.items.guard=(e,{style:i})=>!!t.styles.get(i),this.items.onItemSet.add(({value:t})=>{const{style:e,data:i}=t;this.create(e,i)})}async getStyleMeshes(t,e){const i=this._components.get(Xl).styles.get(e);if(!i)throw new Error(`ClipStyler: "${e}" style not found.`);const n=this._components.get(pi),r=n.list.get(t);if(!r)throw new Error(`ClipEdges: model with id "${t}" not found.`);const{linesMaterial:a,fillsMaterial:l}=i;let h=this._modelStyleGeometries.get(t);h||(h=new s,this._modelStyleGeometries.set(t,h));let c=h.get(e);if(!c){let t,i;a&&(t=new Gl(new Pl,a),t.frustumCulled=!1,r&&n.applyBaseCoordinateSystem(t,await r.getCoordinationMatrix()),this.three.add(t)),l&&(i=new o.Mesh(new o.BufferGeometry,l),r&&n.applyBaseCoordinateSystem(i,await r.getCoordinationMatrix()),this.three.add(i)),c={edges:t,fills:i},h.set(e,c)}return c}async updateMeshes(t,e,i){const s=this._components.get(pi),n=s.list.get(t);if(!n)return;const r=this._components.get(Lt),a=this.plane.clone(),l=(await n.getCoordinationMatrix()).clone().multiply(s.baseCoordinationMatrix.clone().invert());a.applyMatrix4(l),a.constant-=.01;const h=await n.getSection(a,i),{buffer:c,index:d,fillsIndices:u}=h,p=await this.getStyleMeshes(t,e),{edges:f,fills:m}=p,g=new o.BufferAttribute(c,3,!1);if(f){g.setUsage(o.DynamicDrawUsage);const t=new o.BufferGeometry;t.setAttribute("position",g),t.setDrawRange(0,d);const e=new o.LineSegments(t);f.geometry.fromLineSegments(e),r.destroy(e)}m&&(m.geometry.attributes.position=g,m.geometry.setIndex(u))}async create(t,e){if(!this._components.get(Xl).styles.get(t))throw new Error(`ClipEdges: "${t}" style not found.`);const i=this._components.get(Si);let s=null;e&&(s=await i.find(e));const n=this._components.get(pi);if(s)for(const[e,i]of Object.entries(s))n.list.get(e)&&this.updateMeshes(e,t,[...i]);else for(const[e]of n.list)this.updateMeshes(e,t)}async update(t){for(const[e,{data:i,style:s}]of this.items)t&&!t.includes(e)||this.create(s,i)}dispose(){this._components.get(Lt).destroy(this.three,!0,!0),this._modelStyleGeometries.clear()}}const Yl=class t extends Ot{constructor(s){super(s),e(this,"onDisposed",new At),e(this,"enabled",!0),e(this,"world",null),e(this,"styles",new i.DataMap),e(this,"list",new i.DataMap),e(this,"_visible",!0),this.components.list.set(t.uuid,this),this.setEvents()}get visible(){return this._visible}set visible(t){this._visible=t;for(const[,e]of this.list)e.visible=t}setEvents(){this.list.onBeforeDelete.add(({value:t})=>t.dispose())}setEdgesConfig(t,e){if(t.world=(null==e?void 0:e.world)??this.world,null!=e&&e.items)for(const[i,s]of Object.entries(e.items))t.items.set(i,s);const i=(null==e?void 0:e.id)??Bt.create();this.list.set(i,t)}create(t,e){const i=new Zl(this.components,t);return e&&this.setEdgesConfig(i,e),i}createFromView(t,e){const i=this.create(t.plane,e);return(void 0===(null==e?void 0:e.link)||e.link)&&(t.onDisposed.add(()=>i.dispose()),t.onUpdated.add(()=>i.update()),t.onStateChanged.add(()=>i.visible=t.open)),i}createFromClipping(t,e){const i=this.components.get(oa).list.get(t);if(!i)throw new Error(`ClipStyler: Clipping plane with ID ${t} not found.`);const s=this.create(i.three,e);return s.visible=!0,(void 0===(null==e?void 0:e.link)||e.link)&&(i.onDraggingEnded.add(()=>s.update()),i.onDisposed.add(()=>s.dispose())),s}dispose(){this.styles.clear(),this.list.clear(),this.onDisposed.trigger(t.uuid)}};e(Yl,"uuid","24dfc306-a3c4-410f-8071-babc4afa5e4d");let Xl=Yl;const ql=class t extends Ot{constructor(n){super(n),e(this,"onDisposed",new At),e(this,"onBeforeUpdate",new At),e(this,"onAfterUpdate",new At),e(this,"onSetup",new At),e(this,"isSetup",!1),e(this,"enabled",!0),e(this,"events",{}),e(this,"multiple","ctrlKey"),e(this,"zoomFactor",1.5),e(this,"zoomToSelection",!1),e(this,"backupColor",null),e(this,"selection",{}),e(this,"config",{selectName:"select",selectionColor:null,autoHighlightOnClick:!0,world:null,selectEnabled:!0,autoUpdateFragments:!0,selectMaterialDefinition:{color:new o.Color("#BCF124"),renderedFaces:i.RenderedFaces.ONE,opacity:1,transparent:!1}}),e(this,"styles",new s),e(this,"autoToggle",new Set),e(this,"mouseDownPosition",{x:0,y:0}),e(this,"mouseMoveThreshold",5),e(this,"selectable",{}),e(this,"eventManager",new ai),e(this,"_mouseState",{down:!1,moved:!1}),e(this,"_fromHighlight",!1),e(this,"restorePreviousColors",(t=this.selection.select)=>{for(const[e,i]of Object.entries(this.selection))if(e!==this.config.selectName&&this.styles.get(e))for(const[e,s]of Object.entries(t)){const t=i[e];if(!t)continue;const n=[...s].filter(e=>t.has(e));0!==n.length&&new Set(n)}}),e(this,"onMouseDown",t=>{this.enabled&&(this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.mouseDownPosition={x:t.clientX,y:t.clientY},this._mouseState.down=!0)}),e(this,"debounceTimeout",null),e(this,"onMouseUp",async t=>{if(!this.enabled)return;const{world:e,autoHighlightOnClick:i,selectEnabled:s}=this.config;if(!e)throw new Error("No world found!");if(!e.renderer)throw new Error("This world doesn't have a renderer!");if(t.target===e.renderer.three.domElement){if(this._mouseState.down=!1,this._mouseState.moved||0!==t.button)return void(this._mouseState.moved=!1);if(this._mouseState.moved=!1,i&&s){const e="none"===this.multiple||!t[this.multiple];await this.highlight(this.config.selectName,e,this.zoomToSelection)}}}),e(this,"onMouseMove",async t=>{if(!this.enabled)return;const e=t.clientX-this.mouseDownPosition.x,i=t.clientY-this.mouseDownPosition.y,s=Math.sqrt(e*e+i*i);this._mouseState.moved||s>this.mouseMoveThreshold&&(this._mouseState.moved=this._mouseState.down)}),this.components.add(t.uuid,this),this.eventManager.list.add(this.onSetup),this.eventManager.list.add(this.onDisposed),this.setStyleEvents()}setStyleEvents(){this.styles.onBeforeDelete.add(async({key:t})=>{if(await this.clear(t),delete this.selection[t],!(t in this.events))return;const{onClear:e,onHighlight:i,onBeforeHighlight:s}=this.events[t];this.eventManager.list.delete(e),this.eventManager.list.delete(i),this.eventManager.list.delete(s),delete this.events[t]}),this.styles.onItemSet.add(({key:t})=>{this.selection[t]={};const e=new At,i=new At,s=new At;this.events[t]={onHighlight:e,onClear:s,onBeforeHighlight:i},this.eventManager.add([s,e,i])})}async dispose(){this.setupEvents(!1),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.selection={},this.styles.clear(),this.onDisposed.trigger(t.uuid),this.eventManager.reset(),this.isSetup=!1}add(t){if(console.warn("highlighter.add() is deprecated, use highlighter.styles.set() instead"),"string"==typeof t)this.styles.set(t,null);else{const{customId:e}=t;this.styles.set(e,t)}}async remove(t){console.warn("highlighter.remove() is deprecated, use highlighter.styles.delete() instead"),this.styles.delete(t)}async highlight(t,e=!0,i=this.zoomToSelection,s=null){if(!this.enabled)return;if(!this.config.world)throw new Error("No world found in config!");const n=this.config.world;if(!this.selection[t])throw new Error(`Selection ${t} does not exist.`);const r=await this.components.get(Mi).get(n).castRay();if(!r||void 0===r.localId||null===r.localId)return void(e&&this.clear(t));const{localId:o,fragments:{modelId:a}}=r,l={[a]:new Set([o])};await this.highlightByID(t,l,e,i,s,!0)}async highlightByID(t,e,i=!0,s=this.zoomToSelection,n=null,r=!1){var o;if(!this.enabled)return;this._fromHighlight=!0,this.events[t].onBeforeHighlight.trigger(this.selection[t]),i&&await this.clear(t);let a=ri.clone(e);const l=this.components.get(pi);for(const[t,i]of Object.entries(e)){const e=l.list.get(t);null!=e&&e.isDeltaModel&&e.parentModelId&&ri.add(a,{[e.parentModelId]:i})}const h=null==(o=this.selectable)?void 0:o[t];if(h){const t=ri.clone(h);a=ri.intersect([a,t])}if(n){const t=ri.clone(n);for(const[e,i]of Object.entries(t)){const s=l.list.get(e);null!=s&&s.deltaModelId&&ri.add(t,{[s.deltaModelId]:i})}ri.remove(a,n)}if(r&&this.autoToggle.has(t)){const e={};let i=!1;for(const s in a){const n=this.selection[t][s];if(!n)continue;const r=a[s];for(const t of r)if(n.has(t)){n.delete(t);let r=e[s];r||(r=new Set,e[s]=r),r.add(t),i=!0}else n.add(t);a[s]=n}i&&(this.events[t].onClear.trigger(e),t===this.config.selectName&&this.restorePreviousColors(e))}this.updateStyleMap(t,a),this.events[t].onHighlight.trigger(this.selection[t]),this._fromHighlight=!1,await this.updateColors(),s&&await this.zoomSelection(a)}async updateColors(){const t=this.components.get(pi),e=[t.resetHighlight()];for(const[i,s]of Object.entries(this.selection)){const n=this.styles.get(i);if(!n)continue;const r="select"!==i&&this.styles.get(this.config.selectName)?this.getMapWithoutSelection(i):s;r&&e.push(t.highlight({...n,customId:i},r))}this.config.autoUpdateFragments&&e.push(t.core.update(!0)),await Promise.allSettled(e)}updateStyleMap(t,e){const i=this.selection[t];for(const t in e){let s=i[t];s||(s=new Set,i[t]=s);const n=e[t];for(const t of n)s.add(t)}if(t!==this.config.selectName)for(const[e,s]of Object.entries(this.selection)){if(e===this.config.selectName||e===t)continue;const n=s;for(const[t,e]of Object.entries(i)){const i=n[t];if(i)for(const t of e)i.delete(t)}}}getMapWithoutSelection(t,e){const i=this.selection[t];if(!i)throw new Error(`Style ${t} does not exist.`);const s=this.selection[this.config.selectName]??{},n={};for(const r in i){const o=i[r],a=t===this.config.selectName?new Set:s[r]??new Set,l=Array.from(o).filter(t=>{var i;return!a.has(t)&&(!e||(null==(i=e[r])?void 0:i.has(t)))});l.length>0&&(n[r]=new Set(l))}return Object.keys(n).length>0?n:null}async clear(t,e){const i=t?[t]:Object.keys(this.selection),s=e??void 0;for(const t of i){const e=this.selection[t]??{},i=s??e;t===this.config.selectName&&this.restorePreviousColors();const n={};for(const[t,s]of Object.entries(i)){const i=e[t];if(i)for(const e of s){if(!i.delete(e))continue;let s=n[t];s||(s=new Set,n[t]=s),s.add(e)}}Object.keys(n).length>0&&this.events[t].onClear.trigger(n),this.selection[t]={}}this._fromHighlight||await this.updateColors()}setup(t){if(this.isSetup)return;this.config={...this.config,...t};const{selectName:e,selectionColor:i,selectMaterialDefinition:s}=this.config;this.config.world&&this.components.get(Mi).get(this.config.world),s?(i&&(console.warn("highlighter.config.selectionColor is deprecated, use selectMaterialDefinition instead"),s.color=i),this.styles.set(e,s)):this.styles.set(e,null),this.autoToggle.add(this.config.selectName),this.setupEvents(!0),this.enabled=!0,this.isSetup=!0,this.onSetup.trigger(this)}async zoomSelection(t){if(!this.config.world)throw new Error("No world found in config!");const e=this.config.world;let i=!1;for(const e in t)if(t[e].size>0){i=!0;break}if(!i||!e.camera.hasCameraControls())return;const s=await this.components.get(pi).getBBoxes(t),n=new o.Sphere,r=new o.Box3;for(const t of s)r.union(t);r.getBoundingSphere(n);const a=1/0,l=-1/0,{x:h,y:c,z:d}=n.center,u=n.radius===a||h===a||c===a||d===a,p=n.radius===l||h===l||c===l||d===l,f=0===n.radius;u||p||f||(n.radius*=this.zoomFactor,await e.camera.controls.fitToSphere(n,!0))}setupEvents(t){if(!this.config.world)return void console.log("No world found while setting up events!");if(this.config.world.isDisposing)return;if(!this.config.world.renderer)throw new Error("The given world doesn't have a renderer!");const e=this.config.world.renderer.three.domElement;e.removeEventListener("mousedown",this.onMouseDown),e.removeEventListener("mouseup",this.onMouseUp),e.removeEventListener("pointermove",this.onMouseMove),t&&(e.addEventListener("mousedown",this.onMouseDown),e.addEventListener("mouseup",this.onMouseUp),e.addEventListener("pointermove",this.onMouseMove))}};e(ql,"uuid","cb8a76f2-654a-4b50-80c6-66fd83cafd77");let Ql=ql;const Kl=class t extends Ot{constructor(){super(...arguments),e(this,"enabled",!0),e(this,"geometries",new i.DataMap),e(this,"onDisposed",new At)}async get(t,e){const{material:s,applyTransformation:n}={applyTransformation:!0,...e},r=this.components.get(pi),o=new i.DataMap;for(const[e,a]of Object.entries(t)){const t=r.list.get(e);if(!t)continue;const l=this.getModelMeshes(e);for(const r of a){let a=o.get(e);a||(a=new i.DataMap,o.set(e,a));let h=l.get(r);if(h&&h.length>0){const e=[];for(const[i,{geometry:r,transform:o}]of h.entries()){const i=await this.createMesh(t,r,o,{material:s,applyTransformation:n});e.push(i)}a.set(r,e);continue}h=[],l.set(r,h);const[c]=await t.getItemsGeometry([r]);if(!c)continue;const d=[];for(const e of c){const i=this.createGeometry(e);if(!i)continue;const{geometry:r,transform:o}=i;h.push(i);const a=await this.createMesh(t,r,o,{material:s,applyTransformation:n});d.push(a)}a.set(r,d)}}return o}getModelMeshes(t){let e=this.geometries.get(t);return e||(e=new i.DataMap,this.geometries.set(t,e)),e}remove(t=[...this.geometries.keys()]){for(const e of t){const t=this.geometries.get(e);if(t){for(const[e,i]of t)for(const{geometry:t}of i)t.dispose();this.geometries.delete(e)}}}dispose(e=!0){this.remove(),e&&this.geometries.dispose(),this.onDisposed.trigger(t.uuid)}getMeshesFromResult(t){const e=[];for(const i of t.values())for(const t of i.values())e.push(...t);return e}createGeometry(t){const{positions:e,indices:i,normals:s,transform:n}=t;if(!(e&&i&&s))return null;const r=new o.BufferGeometry;return r.setAttribute("position",new o.BufferAttribute(e,3)),r.setAttribute("normal",new o.BufferAttribute(s,3,!0)),r.setIndex(new o.BufferAttribute(i,1)),{geometry:r,transform:n}}async createMesh(t,e,i,s){const{material:n,applyTransformation:r}={applyTransformation:!0,...s},a=new o.Mesh(e,n);return a.applyMatrix4(i),a.applyMatrix4(t.object.matrixWorld),r||(a.position.set(0,0,0),a.rotation.set(0,0,0)),a}};e(Kl,"uuid","ab45d0a7-feea-4afc-927c-80832dae76dd");let Jl=Kl;const $l=class t extends Ot{constructor(i){super(i),e(this,"_world"),e(this,"styles",new n),e(this,"outlinePositions",!1),e(this,"_mesh",null),e(this,"onDisposed",new At),e(this,"_meshes",[]),e(this,"_map",{}),e(this,"_activeStyles",new Set),e(this,"_styleCallbacks",{}),i.add(t.uuid,this),this.setupEvents()}set world(t){this._world=t,t&&this.getRenderer().postproduction.excludedObjectsPass.addExcludedMaterial(this._points.material)}get world(){return this._world}get _points(){return this._mesh||(this._mesh=new o.Points(new o.BufferGeometry,new o.PointsMaterial({size:10,sizeAttenuation:!1,depthTest:!1}))),this._mesh}get enabled(){return!(!this.world||this.world.isDisposing)&&this.getRenderer().postproduction.outlinesEnabled}set enabled(t){if(!this.world||this.world.isDisposing)return;this.getRenderer().postproduction.outlinesEnabled=t,this.outlinePositions&&(this._points.material.color=this.color,this.world.scene.three.add(this._points))}get color(){return this.getRenderer().postproduction.outlinePass.outlineColor}set color(t){this.getRenderer().postproduction.outlinePass.outlineColor.copy(t),this._points.material.color.copy(t)}get thickness(){return this.getRenderer().postproduction.outlinePass.thickness}set thickness(t){this.getRenderer().postproduction.outlinePass.thickness=t}get fillColor(){return this.getRenderer().postproduction.outlinePass.fillColor}set fillColor(t){this.getRenderer().postproduction.outlinePass.fillColor.copy(t)}get fillOpacity(){return this.getRenderer().postproduction.outlinePass.fillOpacity}set fillOpacity(t){this.getRenderer().postproduction.outlinePass.fillOpacity=t}setupEvents(){const t=this.components.get(Ql);this.styles.guard=e=>t.styles.has(e),this.styles.onItemAdded.add(t=>{const e=this.components.get(Ql),i=()=>{this._activeStyles.add(t),this.updateFromStyles()},s=()=>{this._activeStyles.delete(t),this.updateFromStyles()};this._styleCallbacks[t]={onHighlight:i,onClear:s},e.events[t].onHighlight.add(i),e.events[t].onClear.add(s)}),this.styles.onBeforeDelete.add(e=>{const{onHighlight:i,onClear:s}=this._styleCallbacks[e];t.events[e].onHighlight.remove(i),t.events[e].onClear.remove(s),this._activeStyles.delete(e),delete this._styleCallbacks[e]}),t.styles.onItemDeleted.add(t=>this.styles.delete(t))}async updateFromStyles(){const t=this.components.get(Ql),e=[];for(const i of this._activeStyles){const s=t.selection[i];s&&e.push(s)}const i=ri.join(e);this._map=i,await this.update()}async update(t=this._map){if(t===this._map&&this.cleanMeshes(),this.outlinePositions&&this.updatePoints(),0===Object.keys(t).length)return;const e=this.components.get(pi),i=this.getRenderer().postproduction.outlinePass,s=await this.components.get(Jl).get(t);for(const n of Object.keys(t)){const t=e.list.get(n),r=new Set(await(null==t?void 0:t.getItemsByVisibility(!1)));if(t)for(const[t,e]of s.entries())for(const[t,s]of e)if(!r.has(t))for(const t of s)this._meshes.push(t),i.scene.add(t)}}async addItems(t){ri.add(this._map,t),await this.update(t)}async removeItems(t){ri.remove(this._map,t),await this.update()}clean(){this._map={},this._activeStyles.clear(),this.cleanMeshes(),this._mesh&&this.components.get(Lt).destroy(this._mesh,!0,!0),this._mesh=null}dispose(){this.styles.clear(),this.clean(),this.onDisposed.trigger(t.uuid)}cleanMeshes(){for(const t of this._meshes)t.removeFromParent();this._meshes=[]}async updatePoints(){let t=0;for(const[e,i]of Object.entries(this._map))t+=i.size;this._points.geometry.setAttribute("position",new o.Float32BufferAttribute(new Float32Array(3*t),3));const e=await this.components.get(pi).getPositions(this._map);for(let t=0;t<e.length;t++){const{x:i,y:s,z:n}=e[t];this._points.geometry.attributes.position.array[3*t]=i,this._points.geometry.attributes.position.array[3*t+1]=s,this._points.geometry.attributes.position.array[3*t+2]=n}this._points.geometry.attributes.position.needsUpdate=!0}getRenderer(){if(!this.world)throw new Error("You must set a world to use the outliner!");const t=this.world.renderer;if(!t.postproduction)throw new Error("The world given to the outliner must use the postproduction renderer.");return t}};e($l,"uuid","2fd3bcc5-b3b6-4ded-9f64-f47a02854a10");let th=$l;const eh=class t extends Ot{constructor(i){super(i),e(this,"onHoverStarted",new At),e(this,"onHoverEnded",new At),e(this,"HOVERER_OPACITY_KEY","_maxHoverOpacity"),e(this,"_hoverTimeout",null),e(this,"_meshes",new n),e(this,"_localId",null),e(this,"_fadeAnimation",null),e(this,"_world",null),e(this,"_enabled",!1),e(this,"_material",new o.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.5,depthTest:!1,userData:{[this.HOVERER_OPACITY_KEY]:.5}})),e(this,"onDisposed",new At),e(this,"duration",200),e(this,"animation",!0),e(this,"mouseStopTimeout",null),e(this,"onMouseMove",()=>{null!==this.mouseStopTimeout&&clearTimeout(this.mouseStopTimeout),this.mouseStopTimeout=window.setTimeout(()=>this.hover(),50)}),e(this,"onMouseLeave",()=>{this._meshes.clear()}),e(this,"animate",()=>{if(!(this._fadeAnimation&&this.animation&&this.material.transparent))return;const{startTime:t,duration:e,fadeIn:i}=this._fadeAnimation,s=Date.now()-t,n=Math.min(s/e,1),r=i?n:1-n,o=this.material.userData[this.HOVERER_OPACITY_KEY],a=r*(void 0!==o?o:1);this.material.opacity=a,n<1?requestAnimationFrame(this.animate):(i||this._meshes.clear(),this._fadeAnimation=null,this.onHoverEnded.trigger(this))}),i.add(t.uuid,this),this._meshes.onBeforeDelete.add(t=>{t.removeFromParent(),t.geometry.dispose()}),this._meshes.onItemAdded.add(t=>{this.world&&this.world.scene.three.add(t)}),this._meshes.onCleared.add(()=>{this._localId=null,this._hoverTimeout&&(clearTimeout(this._hoverTimeout),this._hoverTimeout=null)})}set world(t){if(t){this.components.get(Mi).get(t),this._world=t,this.setupEvents(!0);for(const e of this._meshes)t.scene.three.add(e)}else{this.setupEvents(!1),this._world=null;for(const t of this._meshes)t.removeFromParent()}}get world(){return this._world}set enabled(t){this.setupEvents(t),this._enabled=t}get enabled(){return this._enabled}set material(t){t.userData[this.HOVERER_OPACITY_KEY]=t.opacity;for(const e of this._meshes)e.material=t;this._material.dispose(),this._material=t}get material(){return this._material}setupEvents(t){if(!this.world||this.world.isDisposing)return;if(!this.world.renderer)throw new Error("The given world doesn't have a renderer!");const e=this.world.renderer.three.domElement;e.removeEventListener("mousemove",this.onMouseMove),e.removeEventListener("mouseleave",this.onMouseMove),t&&(e.addEventListener("mousemove",this.onMouseMove),e.addEventListener("mouseleave",this.onMouseLeave))}async hover(){if(!this.enabled||!this.world)return;const t=await this.components.get(Mi).get(this.world).castRay();if(!t)return void this._meshes.clear();const{fragments:e,localId:i}=t;this._localId!==i&&(this._meshes.clear(),this._localId=i,this._hoverTimeout=window.setTimeout(async()=>{const t={[e.modelId]:new Set([i])},s=await this.components.get(Jl).get(t);for(const[t,e]of s.entries()){const t=[...e.values()].flat();for(const e of t)e.material=this.material,this._meshes.add(e)}this._fadeAnimation={startTime:Date.now(),duration:this.duration,fadeIn:!0},this.onHoverStarted.trigger(this),this.animate()},100))}clear(){this._meshes.clear()}dispose(){this._enabled=!1,this._meshes.clear(),this._fadeAnimation=null,this._hoverTimeout=null,this.onHoverStarted.reset(),this.onHoverEnded.reset(),this.onDisposed.trigger()}};e(eh,"uuid","26fbd870-b1b2-4b71-b747-4063d484de1b");let ih=eh;class sh{constructor(t){e(this,"alignments",[]),e(this,"enabled",!0),e(this,"world",null),e(this,"_raycastable",[]),e(this,"_components"),this._components=t}update(){this.dispose();for(const t of this.alignments)for(const e of t.children){const t=e;t.updateWorldMatrix(!0,!0);for(const e of t.children){const t=e;if(t.isLine2&&t.userData.points){const e=new o.BufferGeometry,i=new o.Line;i.geometry.setIndex(t.geometry.index);const s=new Float32Array(t.userData.points),n=new o.BufferAttribute(s,3);e.setAttribute("position",n),i.geometry=e,i.userData.curve=t,i.applyMatrix4(t.matrixWorld),i.updateMatrixWorld(),this._raycastable.push(i)}}}}dispose(){for(const t of this._raycastable)t.geometry.dispose(),t.geometry=void 0;this._raycastable=[]}castRay(){if(!this.enabled||!this.world)return null;const t=this._components.get(Mi).get(this.world).castRayToObjects(this._raycastable);if(!t)return null;const e=t.object,i=e.geometry,s=t.index,n=i.attributes.position.array[3*s],r=i.attributes.position.array[3*s+1],a=i.attributes.position.array[3*s+2],l=i.attributes.position.array[3*s+3],h=i.attributes.position.array[3*s+4],c=i.attributes.position.array[3*s+5],d=new o.Vector3(l-n,h-r,c-a).normalize();return{point:t.point,normal:d,curve:e.userData.curve,alignment:e.userData.curve.parent}}}class nh{static alignmentPercentageToPoint(t,e){const i=new o.Vector3,s=new o.Vector3,n=e*this.alignmentLength(t);let r=0;if(t.updateWorldMatrix(!0,!0),1===e)for(let e=t.children.length-1;e>=0;e--){const i=t.children[e],s=i.userData.points;if(!s)continue;const n=new o.Vector3(s[s.length-3],s[s.length-2],s[s.length-1]);return n.applyMatrix4(i.matrixWorld),{normal:new o.Vector3,point:n,curve:i,alignment:t}}for(const e of t.children){const o=e.userData.points;if(o)for(let a=0;a<o.length-3;a+=3){const l=i.set(o[a],o[a+1],o[a+2]),h=s.set(o[a+3],o[a+4],o[a+5]),c=l.distanceTo(h);if(r+c>=n){const i=n-r,s=h.clone().sub(l).normalize(),o=s.clone().multiplyScalar(i);return l.add(o),l.applyMatrix4(e.matrixWorld),{normal:s,point:l,curve:e,alignment:t}}r+=c}}return null}static curvePercentageToPoint(t,e,i){const s=new o.Vector3,n=new o.Vector3,r=i*this.curveLength(e);let a=0;const l=e.userData.points;if(!l)throw new Error("No points found in curve");for(let i=0;i<l.length-3;i+=3){const o=s.set(l[i],l[i+1],l[i+2]),h=n.set(l[i+3],l[i+4],l[i+5]),c=o.distanceTo(h);if(a+c>=r){const i=r-a,s=h.clone().sub(o).normalize(),n=s.clone().multiplyScalar(i);return o.add(n),{normal:s,point:o,curve:e,alignment:t}}a+=c}return null}static alignmentLength(t){let e=0;if(void 0!==t.userData.length)return t.userData.length;for(const i of t.children)"isLine2"in i&&(e+=this.curveLength(i));return t.userData.length=e,e}static curveLength(t){let e=0;if(void 0!==t.userData.length)return t.userData.length;const i=new o.Vector3,s=new o.Vector3,n=t.userData.points;if(!n)throw new Error("No points found in curve");for(let t=0;t<n.length-2-3;t+=3){const r=i.set(n[t],n[t+1],n[t+2]),o=s.set(n[t+3],n[t+4],n[t+5]);e+=r.distanceTo(o)}return t.userData.length=e,e}static curvePointToAlignmentPercentage(t,e,i){const s=new o.Vector3,n=new o.Vector3,r=this.alignmentLength(t);let a=0;t.updateWorldMatrix(!0,!0);for(const o of t.children){const t=o.userData.points;if(t)for(let l=0;l<t.length-3;l+=3){const h=s.set(t[l],t[l+1],t[l+2]),c=n.set(t[l+3],t[l+4],t[l+5]);h.applyMatrix4(o.matrixWorld),c.applyMatrix4(o.matrixWorld);const d=h.distanceTo(c),u=h.distanceTo(e)<.001,p=c.distanceTo(e)<.001,f=this.isPointbetweenTwoOthers(h,c,e);if(o===i&&(u||p||f)){return(a+h.distanceTo(e))/r}a+=d}}return null}static isPointbetweenTwoOthers(t,e,i){const s=new o.Vector3;s.subVectors(e,t).normalize();const n=new o.Vector3;n.subVectors(i,t).normalize();const r=new o.Vector3;r.subVectors(i,e).normalize();const a=.9984;return s.dot(n)>a&&s.dot(r)<-a}}class rh{constructor(t,i){e(this,"onDisposed",new At),e(this,"alignments",[]),e(this,"components"),e(this,"onMarkerChange",new At),e(this,"enabled",!0),e(this,"highlightMaterial"),e(this,"increments",20),e(this,"screenDistanceLimit",.1),e(this,"fadeInTime",500),e(this,"_mouseMarkers"),e(this,"_highlighted",new Set),e(this,"_stationPoints",new Map),e(this,"_originalHighlightMaterialId","originalHighlightMaterial"),e(this,"_world",null),e(this,"_raycaster"),e(this,"_stationLabelColor",new o.Color(16777215)),e(this,"_stationLabelBackgroundColor",new o.Color(8014801)),e(this,"_stationPointerColor",new o.Color(16777215)),e(this,"_stationPointerBackgroundColor",new o.Color(4803766)),e(this,"_pointerDown",performance.now()),e(this,"_pointerDownTime",150),e(this,"onPointerDown",()=>{this._pointerDown=performance.now()}),e(this,"onPointerUp",()=>{if(performance.now()-this._pointerDown>this._pointerDownTime)return;const t=this.setMarkerToMouse("select");t&&this.onMarkerChange.trigger(t)}),e(this,"onMouseMove",()=>{this.setMarkerToMouse("hover")}),this.components=t,this.highlightMaterial=i,this._raycaster=new sh(t),this._raycaster.alignments=this.alignments}get world(){return this._world}set world(t){var e,i,s,n;if(t===this._world||(this._world&&this.setupEvents(!1),this._world=t,null==(e=this._mouseMarkers)||e.hover.removeFromParent(),null==(i=this._mouseMarkers)||i.select.removeFromParent(),null==(s=this._mouseMarkers)||s.hover.element.remove(),null==(n=this._mouseMarkers)||n.select.element.remove(),!t))return;this._raycaster.world=t;const r=this.newCivilLabel(0,"stationPointer");t.scene.three.add(r),r.visible=!1,r.element.style.transition="";const o=this.newCivilLabel(0,"stationPointer");o.element.style.transition="",o.element.style.opacity="0.5",t.scene.three.add(o),o.visible=!1,this._mouseMarkers={select:r,hover:o},this.setupEvents(!0)}get stationLabelColor(){return this._stationLabelColor}set stationLabelColor(t){this._stationLabelColor=t;const e=`#${t.getHexString()}`;for(const[,{labels:t}]of this._stationPoints){const i=[...t.children];for(const t of i){this.getLabel(t).style.color=e;this.getPoint(t).style.backgroundColor=e}}}get stationLabelBackgroundColor(){return this._stationLabelBackgroundColor}set stationLabelBackgroundColor(t){this._stationLabelBackgroundColor=t;const e=`#${t.getHexString()}`;for(const[,{labels:t}]of this._stationPoints){const i=[...t.children];for(const t of i){this.getLabel(t).style.backgroundColor=e;this.getPoint(t).style.border=`2px solid ${e}`}}}get stationPointerColor(){return this._stationPointerColor}set stationPointerColor(t){this._stationPointerColor=t;const e=`#${t.getHexString()}`;if(this._mouseMarkers){const t=this._mouseMarkers.select;this.getLabel(t).style.color=e;this.getPoint(t).style.backgroundColor=e}}get stationPointerBackgroundColor(){return this._stationPointerBackgroundColor}set stationPointerBackgroundColor(t){this._stationPointerBackgroundColor=t;const e=`#${t.getHexString()}`;if(this._mouseMarkers){const t=this._mouseMarkers.select;this.getLabel(t).style.backgroundColor=e;this.getPoint(t).style.border=`2px solid ${e}`}}dispose(){var t,e,i,s;this.clearHighlight(),this.clearStations(),this.alignments=[],null==(t=this._mouseMarkers)||t.hover.removeFromParent(),null==(e=this._mouseMarkers)||e.select.removeFromParent(),null==(i=this._mouseMarkers)||i.hover.element.remove(),null==(s=this._mouseMarkers)||s.select.element.remove(),this._raycaster.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}updateAlignments(){this._raycaster.update()}setMarkerAtPoint(t,e){if(!this._mouseMarkers)throw new Error("No mouse markers found! Initialize the world before using this.");this.updateMarkerValue(t,e),this._mouseMarkers[e].visible=!0,this._mouseMarkers[e].position.copy(t.point)}highlight(t,e=!0){e&&this.clearHighlight(this._highlighted);for(const e of t.children)"isLineSegments2"in e&&"material"in e&&(e.userData[this._originalHighlightMaterialId]=e.material,e.material=this.highlightMaterial);this._highlighted.add(t)}clearHighlight(t=this._highlighted){for(const e of t)for(const t of e.children)"isLineSegments2"in t&&"material"in t&&(t.material=t.userData[this._originalHighlightMaterialId],delete t.userData[this._originalHighlightMaterialId]);this._highlighted.clear()}createStations(t){if(!this.world||this._stationPoints.has(t.uuid))return;const e=new o.Group;this.world.scene.three.add(e),this._stationPoints.set(t.uuid,{alignment:t,labels:e})}clearStations(t=this._stationPoints.keys()){for(const e of t){const t=this._stationPoints.get(e);t&&(this.clearLabels(t.labels),this._stationPoints.delete(e))}}updateStations(){if(!this.world)throw new Error("No world found!");if(!this.world.renderer)throw new Error("No renderer found!");const t=this.world.camera.three,e=this.world.renderer.three,i=new o.Frustum,s=e.clippingPlanes,n=new o.Vector3,r=new o.Vector3;let a=!0;const l=new o.Vector3;for(const[,{alignment:e,labels:h}]of this._stationPoints){this.clearLabels(h),e.updateWorldMatrix(!0,!0);const c=e.userData.initialStation;let d=c||0;const u=d%this.increments;let p=c+this.increments-u;for(const c of e.children){if(!("isLine2"in c))continue;const e=c;if(e.geometry.boundingBox||e.geometry.computeBoundingBox(),i.setFromProjectionMatrix((new o.Matrix4).multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse)),!i.intersectsBox(e.geometry.boundingBox)){d+=nh.curveLength(c);const t=d%this.increments;p=d+this.increments-t;continue}const u=c.userData.points,f=u[0],m=u[1],g=u[2];if(l.set(f,m,g),l.applyMatrix4(c.matrixWorld),!this.isLabelClipped(s,l))if(a){a=!1,n.set(l.x,l.y,l.z),n.project(t),n.z=0;const e=this.newCivilLabel(d,"stationLabel");e.position.set(l.x,l.y,l.z),h.children.push(e)}else if(r.set(l.x,l.y,l.z),r.project(t),r.z=0,n.distanceTo(r)>this.screenDistanceLimit){const t=this.newCivilLabel(d,"stationLabel");t.position.set(l.x,l.y,l.z),h.children.push(t),n.copy(r)}const v=new o.Vector3,_=new o.Vector3;for(let e=0;e<u.length-3;e+=3){v.set(u[e],u[e+1],u[e+2]),_.set(u[e+3],u[e+4],u[e+5]);const o=v.distanceTo(_),a=d+o,f=_.clone().sub(v).normalize();for(;a>p;){const e=p-d,o=f.clone();o.multiplyScalar(e);const{x:a,y:u,z:m}=v.clone().add(o);if(l.set(a,u,m),l.applyMatrix4(c.matrixWorld),!this.isLabelClipped(s,l)&&i.containsPoint(l)&&(r.set(l.x,l.y,l.z),r.project(t),r.z=0,n.distanceTo(r)>this.screenDistanceLimit)){const t=this.newCivilLabel(p,"stationLabel");t.position.set(l.x,l.y,l.z),h.children.push(t),n.copy(r)}p+=this.increments}d+=o}const y=u[u.length-3],w=u[u.length-2],b=u[u.length-1];if((l.set(y,w,b),l.applyMatrix4(c.matrixWorld),!this.isLabelClipped(s,l)&&i.containsPoint(l))&&(r.set(l.x,l.y,l.z),r.project(t),r.z=0,n.distanceTo(r)>this.screenDistanceLimit)){const t=this.newCivilLabel(d,"stationLabel");t.position.set(l.x,l.y,l.z),h.children.push(t),n.copy(r)}}}}getCursorValue(){if(!this._mouseMarkers)throw new Error("No mouse markers found! Initialize the world before using this.");return this._mouseMarkers.select.element.children[0].children[0].innerText}setCursorValue(t,e){if(!this._mouseMarkers)throw new Error("No mouse markers found! Initialize the world before using this.");this._mouseMarkers[e].element.children[0].children[0].innerText=t}isLabelClipped(t,e){for(const i of t)if(!(i.distanceToPoint(e)>0))return!0;return!1}clearLabels(t){const e=[...t.children];for(const t of e)t.element.style.opacity="0";setTimeout(()=>{for(const t of e)t.removeFromParent(),t.element.remove(),t.visible=!1},this.fadeInTime)}newCivilLabel(t,e){const i=document.createElement("div"),s="stationLabel"===e?this.stationLabelColor:this.stationPointerColor,n="stationLabel"===e?this.stationLabelBackgroundColor:this.stationPointerBackgroundColor,r=document.createElement("div");r.style.width="4px",r.style.height="4px",r.style.borderRadius="50%",r.style.backgroundColor=`#${s.getHexString()}`,r.style.border=`2px solid #${n.getHexString()}`,r.style.display="flex",r.style.justifyContent="center";const o=this.getFormattedStation(t),a=document.createElement("div");a.innerText=o,a.style.backgroundColor=`#${n.getHexString()}`,a.style.color=`#${s.getHexString()}`,a.style.padding="0.3rem",a.style.position="absolute",a.style.bottom="1rem",a.style.borderRadius="6px",a.style.boxShadow="rgba(0, 0, 0, 0.6) 0px 4px 6px",r.appendChild(a);const l=new Na(i);return i.appendChild(r),"stationLabel"===e&&(i.style.transition=`opacity ${this.fadeInTime}ms ease-in-out`,i.style.opacity="0",setTimeout(()=>{i.style.opacity="1"})),l}setupEvents(t){if(!this.world)throw new Error("No world found!");if(this.world.isDisposing||!this.world.renderer)return;const e=this.world.renderer.three.domElement,i=this.components.get(Mi).get(this.world);i.three.params.Line||(i.three.params.Line={threshold:10}),e.removeEventListener("pointerdown",this.onPointerDown),e.removeEventListener("pointerup",this.onPointerUp),e.removeEventListener("pointermove",this.onMouseMove),t&&(e.addEventListener("pointerdown",this.onPointerDown),e.addEventListener("pointerup",this.onPointerUp),e.addEventListener("pointermove",this.onMouseMove))}setMarkerToMouse(t){if(!this.enabled||!this._mouseMarkers)return null;if(!this.world)throw new Error("No world found!");const e=this._raycaster.castRay();if(!e)return this._mouseMarkers[t].visible=!1,null;this._mouseMarkers[t].visible=!0;const i=e.point;return this._mouseMarkers[t].position.copy(i),this.updateMarkerValue(e,t),e}updateMarkerValue(t,e){if(!this._mouseMarkers)return;const{alignment:i,curve:s,point:n}=t,r=nh.curvePointToAlignmentPercentage(i,n,s);if(null===r)throw new Error("Point is not on the curve");const o=r*nh.alignmentLength(i)+i.userData.initialStation,a=this.getFormattedStation(o);this.setCursorValue(a,e)}getFormattedStation(t){const e=Math.floor(t/1e3);return`${e}+${Math.round(t-1e3*e)}`}getLabel(t){return t.element.children[0].children[0]}getPoint(t){return t.element.children[0]}}const oh=class t extends Ot{constructor(i){super(i),e(this,"onDisposed",new At),e(this,"list",new Map),e(this,"enabled",!0),e(this,"highlightMaterial",new Al({color:8014801,linewidth:5,depthTest:!1})),e(this,"_increments",20),e(this,"_screenDistanceLimit",.1),e(this,"_fadeInTime",500),e(this,"_stationLabelColor",new o.Color(16777215)),e(this,"_stationLabelBackgroundColor",new o.Color(8014801)),e(this,"_stationPointerColor",new o.Color(16777215)),e(this,"_stationPointerBackgroundColor",new o.Color(4803766)),this.components.add(t.uuid,this)}get increments(){return this._increments}set increments(t){this._increments=t;for(const[,e]of this.list)e.increments=t}get screenDistanceLimit(){return this._screenDistanceLimit}set screenDistanceLimit(t){this._screenDistanceLimit=t;for(const[,e]of this.list)e.screenDistanceLimit=t}get fadeInTime(){return this._fadeInTime}set fadeInTime(t){this._fadeInTime=t;for(const[,e]of this.list)e.fadeInTime=t}get stationLabelColor(){return this._stationLabelColor}set stationLabelColor(t){this._stationLabelColor=t;for(const[,e]of this.list)e.stationLabelColor=t}get stationLabelBackgroundColor(){return this._stationLabelBackgroundColor}set stationLabelBackgroundColor(t){this._stationLabelBackgroundColor=t;for(const[,e]of this.list)e.stationLabelBackgroundColor=t}get stationPointerColor(){return this._stationPointerColor}set stationPointerColor(t){this._stationPointerColor=t;for(const[,e]of this.list)e.stationPointerColor=t}get stationPointerBackgroundColor(){return this._stationPointerBackgroundColor}set stationPointerBackgroundColor(t){this._stationPointerBackgroundColor=t;for(const[,e]of this.list)e.stationPointerBackgroundColor=t}create(t){const e=new rh(this.components,this.highlightMaterial);return this.list.set(t,e),e}delete(t){const e=this.list.get(t);e&&(e.dispose(),this.list.delete(t))}dispose(){for(const[,t]of this.list)t.dispose();this.onDisposed.trigger(),this.onDisposed.reset()}updateAlignments(){for(const[,t]of this.list)t.updateAlignments()}};e(oh,"uuid","0a59c09e-2b49-474a-9320-99f51f40f182");let ah=oh;var lh=(t=>(t.SELECT="select",t.HOVER="hover",t))(lh||{});const hh=class t extends Ot{constructor(i){super(i),e(this,"enabled",!0),e(this,"onDisposed",new At),e(this,"_world",null),e(this,"_flip",!1),e(this,"_plane"),e(this,"_point",new o.Vector3),e(this,"_edgeMeshes",[]),e(this,"_sectionVisible",!1),e(this,"_sectionOffset",.1),e(this,"edgeMaterial",new Al({color:0,linewidth:5,depthTest:!1})),this.components.add(t.uuid,this)}get plane(){if(!this._plane)throw new Error("Plane is not set. You must give a world.");return this._plane}set plane(t){this._plane=t}get sectionVisible(){return this._sectionVisible}set sectionVisible(t){this._sectionVisible=t;for(const e of this._edgeMeshes)e.visible=t}get world(){return this._world}set world(t){var e;if(this._world=t,null==(e=this._plane)||e.dispose(),!t)return;const i=this.components.get(oa),s=i.createFromNormalAndCoplanarPoint(t,new o.Vector3(1,0,0),new o.Vector3);this.plane=i.list.get(s),this.plane.visible=!1,this.plane.enabled=!1}get flip(){return this._flip}set flip(t){var e;if(t===this._flip)return;this._flip=t;const i=null==(e=this.plane)?void 0:e.normal.clone().multiplyScalar(-1);for(const t of this._edgeMeshes)t.position.add(i.clone().multiplyScalar(this._sectionOffset));this.plane.setFromNormalAndCoplanarPoint(i,this._point),this.plane.update()}dispose(){var t;this.clearMeshes(),null==(t=this.plane)||t.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}async set(t,e){this.flip&&e.multiplyScalar(-1),this.plane.setFromNormalAndCoplanarPoint(e,t),this._point.copy(t)}async update(){this.clearMeshes();const t=this.components.get(pi);this.plane.update();const e=[];for(const[,i]of t.list)e.push(this.generateModelSection(i));await Promise.all(e)}async generateModelSection(t){if(!this.world)return;const e=this.plane.three.clone();e.constant-=.01;const{buffer:i}=await t.getSection(e),s=new o.BufferGeometry,n=new o.BufferAttribute(i,3,!1);s.setAttribute("position",n);const r=new o.LineSegments(s),a=new Pl;a.fromLineSegments(r);const l=new Gl(a,this.edgeMaterial);l.frustumCulled=!1,this.world.scene.three.add(l),this._edgeMeshes.push(l),l.renderOrder=3,r.geometry.dispose()}clearMeshes(){for(const t of this._edgeMeshes)t.removeFromParent(),t.geometry.dispose(),t.material=void 0;this._edgeMeshes=[]}};e(hh,"uuid","96b2c87e-d90b-4639-8257-8f01136fe324");let ch=hh;var dh=(t=>(t[t.DEFAULT=0]="DEFAULT",t[t.SYNCHRONOUS=1]="SYNCHRONOUS",t))(dh||{});const uh=class t{constructor(i){e(this,"onDisposed",new At),e(this,"marker",null),e(this,"world",null),e(this,"mode",0),e(this,"maxDistance",1),e(this,"_enabled",!1),e(this,"_components"),e(this,"_preview",document.createElement("div")),e(this,"_pointerVisible",!1),e(this,"_intersectionFound",!1),this._components=i;for(const e in t.baseSnappingStyle){const i=t.baseSnappingStyle[e];this._preview.style[e]=i}this._preview.style.zIndex="999",this._preview.style.pointerEvents="none",this._preview.style.position="fixed",this._preview.style.top="0",this._preview.style.left="0"}set enabled(t){this._enabled=t,this.marker&&(this.marker.visible=t),t&&this.get()}get enabled(){return this._enabled}dispose(){this.marker&&this.marker.dispose()}async get(t){return 1===this.mode?this.getSynchronous(t):this.getDefault(t)}async getSynchronous(e){const s=(null==e?void 0:e.world)??this.world;if(!s)throw new Error("GraphicVertexPicker: a world is need to get a casting result.");const n=this._components.get(Mi).get(s);let r=null;if(0===this.mode?r=await n.castRay({snappingClasses:null==e?void 0:e.snappingClasses}):1===this.mode&&(r=await n.castRayToObjects()),this._intersectionFound=!!r,r){const{point:n}=r;if(!this.marker){const t=document.createElement("div");this.marker=new Ha(s,t)}if(this.marker.world!==s&&(this.marker.world=s,this.marker.three.removeFromParent(),s.scene.three.add(this.marker.three)),this.hidePointer(),this.marker.visible=!0,null!=e&&e.snappingClasses){const s=(null==e?void 0:e.snappingClasses)||[];let o=i.SnappingClass.FACE;s.includes(i.SnappingClass.POINT)?o=i.SnappingClass.POINT:s.includes(i.SnappingClass.LINE)&&(o=i.SnappingClass.LINE);let a=!1;if(o!==i.SnappingClass.FACE&&(a=this.applySnapping(r,o)),a){const e=t.snappingStyles[o]??t.baseSnappingStyle;Object.assign(this.marker.three.element.style,e)}else Object.assign(this.marker.three.element.style,t.baseSnappingStyle);this.marker.three.position.copy(n)}else Object.assign(this.marker.three.element.style,t.baseSnappingStyle)}else this.marker&&(this.marker.visible=!1);return r}async getDefault(e){const i=(null==e?void 0:e.world)??this.world;if(!i)throw new Error("GraphicVertexPicker: a world is need to get a casting result.");const s=await this._components.get(Mi).get(i).castRay({snappingClasses:null==e?void 0:e.snappingClasses});if(this._intersectionFound=!!s,s){const{point:e}=s;if(!this.marker){const t=document.createElement("div");this.marker=new Ha(i,t)}if(this.marker.world!==i&&(this.marker.world=i,this.marker.three.removeFromParent(),i.scene.three.add(this.marker.three)),this.hidePointer(),this.marker.visible=!0,this.marker.three.position.copy(e),!("snappingClass"in s)||"number"!=typeof s.snappingClass||0!==s.snappingClass&&1!==s.snappingClass&&2!==s.snappingClass)Object.assign(this.marker.three.element.style,t.baseSnappingStyle);else{const e=t.snappingStyles[s.snappingClass]??t.baseSnappingStyle;Object.assign(this.marker.three.element.style,e)}}else this.marker&&(this.marker.visible=!1);return s}updatePointer(){if(!this.world||!this.marker)return;if(1===this.mode&&this._intersectionFound)return void this.hidePointer();this.showPointer(),this.marker.visible&&(this.marker.visible=!1);const t=this._components.get(Mi).get(this.world).mouse.rawPosition;this._preview.style.transform=`translate(-50%, -50%) translate(${t.x}px, ${t.y}px)`}showPointer(){var t;this.world&&!this._pointerVisible&&(this._pointerVisible=!0,null==(t=this.world.renderer.three.domElement.parentElement)||t.appendChild(this._preview))}hidePointer(){var t;this.world&&this._pointerVisible&&(this._pointerVisible=!1,null==(t=this.world.renderer.three.domElement.parentElement)||t.removeChild(this._preview))}applySnapping(t,e){if(e===i.SnappingClass.FACE)return!0;const s=t.object;if(!(t.face&&s&&s.geometry&&s.geometry.index&&s.geometry.attributes&&s.geometry.attributes.position))return!1;const n=t.object.matrixWorld,r=s.geometry.attributes.position.array,a=t.point,l=t.face.a,h=t.face.b,c=t.face.c,d=new o.Vector3(r[3*l],r[3*l+1],r[3*l+2]).applyMatrix4(n),u=new o.Vector3(r[3*h],r[3*h+1],r[3*h+2]).applyMatrix4(n),p=new o.Vector3(r[3*c],r[3*c+1],r[3*c+2]).applyMatrix4(n);if(t.facePoints=[d.x,d.y,d.z,u.x,u.y,u.z,p.x,p.y,p.z],e===i.SnappingClass.LINE){const e=[[d,u],[u,p],[p,d]],i=new o.Vector3,s=new o.Vector3,n=new o.Line3;let r=Number.MAX_SAFE_INTEGER,l=!1;const h=this.maxDistance*this.maxDistance;for(const[o,c]of e){n.set(o,c),n.closestPointToPoint(a,!0,i);const e=a.distanceToSquared(i);e<h&&e<r&&(t.snappedEdgeP1=o,t.snappedEdgeP2=c,r=e,s.copy(i),l=!0)}return!!l&&(t.point.copy(s),!0)}const f=[d,u,p],m=new o.Vector3;let g=Number.MAX_SAFE_INTEGER,v=!1;const _=this.maxDistance*this.maxDistance;for(let t=0;t<f.length;t++){const e=f[t],i=a.distanceToSquared(e);i<_&&i<g&&(g=i,m.copy(e),v=!0)}return!!v&&(t.point.copy(m),!0)}};e(uh,"baseSnappingStyle",{height:"6px",width:"6px",borderRadius:"100%",borderWidth:"2px",borderColor:"rgb(122, 75, 209)",borderStyle:"solid",zIndex:"-20"}),e(uh,"snappingStyles",{[i.SnappingClass.FACE]:{...uh.baseSnappingStyle},[i.SnappingClass.POINT]:{...uh.baseSnappingStyle,borderColor:"#e25959",borderRadius:"0"},[i.SnappingClass.LINE]:{...uh.baseSnappingStyle,borderColor:"#2d2d2d",borderRadius:"0"}});let ph=uh;function fh(){const t=document.createElement("div");return t.style.backgroundColor="blue",t.style.color="white",t.style.padding="6px",t.style.borderRadius="6px",t.style.boxShadow="0px 4px 6px rgba(0, 0, 0, 0.6)",t.style.zIndex="-10",t}class mh extends o.Line3{constructor(){super(...arguments),e(this,"id",Bt.create()),e(this,"_units","m"),e(this,"_rounding",2)}set units(t){this._units=t}get units(){return this._units}set rounding(t){this._rounding=t}get rounding(){return this._rounding}get value(){const t=this.distance();return Ia.convertUnits(t,"m",this.units,this.rounding)}}class gh{constructor(t,i,s,r=2,a="m"){e(this,"label"),e(this,"boundingBox",new o.Mesh),e(this,"world"),e(this,"_components"),e(this,"_units","m"),e(this,"_rounding",2),e(this,"startNormal",null),e(this,"line"),e(this,"rectangleComponentLines",[]),e(this,"projectionComponentLines",[]),e(this,"_visible",!0),e(this,"_root",new o.Group),e(this,"_endpoints",new n),e(this,"lineElement"),e(this,"rectangleDimensions",new n),e(this,"projectionDimensions",new n),e(this,"isSelected",!1),e(this,"_latestRectangularInversion",!1),e(this,"_endpointElement",function(t={}){const{color:e="white",size:i="4px",border:s="2px solid blue",background:n="white"}=t,r=document.createElement("div");return r.style.backgroundColor=n,r.style.color=e,r.style.height=i,r.style.width=i,r.style.borderRadius="50%",r.style.border=s,r.style.zIndex="-20",r}()),e(this,"_material"),e(this,"_componentsMaterial",new o.LineDashedMaterial({depthTest:!1,gapSize:.2,dashSize:.2,transparent:!0,opacity:.5,color:3026478})),e(this,"valueFormatter",null),this._components=t,this.world=i,this._material=s.lineMaterial,this._rounding=r,this._units=a,this.line=s.line,this.startNormal=s.startNormal??null,this.rectangleComponentLines=[new mh,new mh],this.updateRectangleComponents(),this.updateProjectionComponents(),this.lineElement=this.createLine(s),this._endpoints.onItemAdded.add(t=>{this._root.add(t.three);const e=1===this._endpoints.size?this.line.start:this.line.end;t.three.position.copy(e)}),this._endpoints.onBeforeDelete.add(t=>t.dispose()),this.createEndpoints();for(const t of this._endpoints)t.three.element.style.borderColor=`#${s.lineMaterial.color.getHexString()}`;this.label=this.newText(),this.label.three.element.style.backgroundColor=`#${s.lineMaterial.color.getHexString()}`,this.label.three.renderOrder=1,this._root.renderOrder=2,this.world.scene.three.add(this._root),this.setupEvents()}set units(t){for(const e of this.rectangleDimensions)e.units=t;for(const e of this.projectionDimensions)e.units=t;this._units=t,this.updateLabel()}get units(){return this._units}set rounding(t){for(const e of this.rectangleDimensions)e.rounding=t;for(const e of this.projectionDimensions)e.rounding=t;this._rounding=t,this.updateLabel()}get rounding(){return this._rounding}get visible(){return this._visible}set visible(t){for(const e of this.rectangleDimensions)e.visible=t;for(const e of this.projectionDimensions)e.visible=t;this._visible=t,this.label.visible=t;for(const e of this._endpoints)e.visible=t;const[e,i]=this._endpoints,s=e.three,n=i.three,r=this.label.three;t?(this.world.scene.three.add(this._root),this._root.add(r,s,n)):(r.removeFromParent(),s.removeFromParent(),n.removeFromParent(),this._root.removeFromParent())}set end(t){this.line.end=t;const e=this.lineElement.geometry.attributes.position;e.setXYZ(1,t.x,t.y,t.z),e.needsUpdate=!0,this.update()}set start(t){this.line.start=t;const e=this.lineElement.geometry.attributes.position;e.setXYZ(0,t.x,t.y,t.z),e.needsUpdate=!0,this.update()}applyPlanesVisibility(t){for(const e of this._endpoints){if(!e.wasVisible)continue;let i=!1;for(const s of t)if(s.distanceToPoint(e.three.position)<0){i=!0;break}e.three.visible=!i}if(this.label.wasVisible){let e=!1;const i=this.label.three.position;for(const s of t)if(s.distanceToPoint(i)<0){e=!0;break}this.label.three.visible=!e}for(const e of this.rectangleDimensions)e.applyPlanesVisibility(t);for(const e of this.projectionDimensions)e.applyPlanesVisibility(t)}setupEvents(){this.rectangleDimensions.onBeforeDelete.add(t=>t.dispose()),this.projectionDimensions.onBeforeDelete.add(t=>t.dispose())}dispose(){this.visible=!1;const t=this._components.get(Lt);t.destroy(this._root),t.destroy(this.lineElement),this._endpoints.clear(),this.label.dispose(),this.boundingBox&&t.destroy(this.boundingBox),this.rectangleDimensions.clear(),this.projectionDimensions.clear(),this._components=null}createBoundingBox(){const t=new o.Vector3;this.line.getCenter(t);const e=this.line.distance();this.boundingBox.geometry=new o.BoxGeometry(1,1,e),this.boundingBox.position.copy(t),this.boundingBox.lookAt(this.line.end),this.boundingBox.visible=!1,this._root.add(this.boundingBox)}invertRectangularDimensions(){0!==this.rectangleDimensions.size&&(this.rectangleDimensions.clear(),this._latestRectangularInversion=!this._latestRectangularInversion,this.updateRectangleComponents(this._latestRectangularInversion),this.displayRectangularDimensions())}displayRectangularDimensions(){this.rectangleDimensions.clear();for(const t of this.rectangleComponentLines){const e=new gh(this._components,this.world,{line:t,lineMaterial:this._componentsMaterial,endpointElement:this.endpointElement});e.lineElement.computeLineDistances(),this.rectangleDimensions.add(e)}}displayProjectionDimensions(){this.projectionDimensions.clear();for(const t of this.projectionComponentLines){const e=new gh(this._components,this.world,{line:t,lineMaterial:this._componentsMaterial,endpointElement:this.endpointElement});e.lineElement.computeLineDistances(),this.projectionDimensions.add(e)}}set endpointElement(t){for(const e of this.rectangleDimensions)e.endpointElement=t;for(const e of this.projectionDimensions)e.endpointElement=t;this._endpointElement=t,this.createEndpoints()}get endpointElement(){return this._endpointElement}createEndpoints(){this._endpoints.clear();const t=new Ha(this.world,this._endpointElement),e=new Ha(this.world,this._endpointElement.cloneNode(!0));this._endpoints.add(t,e)}updateProjectionComponents(){if(!this.startNormal)return;const t=(new o.Plane).setFromNormalAndCoplanarPoint(this.startNormal,this.line.start),e=new o.Vector3;t.projectPoint(this.line.end,e);let[i]=this.projectionComponentLines;i||(i=new mh,this.projectionComponentLines.push(i)),i.set(this.line.end,e),i.distance()<.01&&this.projectionComponentLines.shift();for(const t of this.projectionDimensions)t&&t.update()}updateRectangleComponents(t=!1){const e=t?this.line.end:this.line.start,i=t?this.line.start:this.line.end,s=new o.Vector3;s.subVectors(i,e),Math.abs(i.y-e.y)>=.1?s.y=0:s.x=0;const n=e.clone().add(s),[r,a]=this.rectangleComponentLines;r.set(n,e),a.set(n,i);for(const t of this.rectangleDimensions)t.update()}updateLabel(){this.label.three.element.textContent=this.getTextContent();const t=new o.Vector3;this.line.getCenter(t),this.label.three.position.copy(t)}updateGeometry(){this.updateRectangleComponents(),this.updateProjectionComponents(),[...this._endpoints][0].three.position.copy(this.line.start),[...this._endpoints][1].three.position.copy(this.line.end),this.lineElement.geometry.computeBoundingSphere()}update(){this.updateGeometry(),this.updateLabel()}set material(t){this._material.dispose(),this._material=t,this.lineElement.material=t}get material(){return this._material}createLine(t){const e=new o.BufferGeometry;e.setFromPoints([t.line.start,t.line.end]);const i=new o.Line(e,t.lineMaterial);return this._root.add(i),i}newText(){const t=fh();t.textContent=this.getTextContent();const e=new Ha(this.world,t),i=new o.Vector3;return this.line.getCenter(i),e.three.position.copy(i),this._root.add(e.three),e}getTextContent(t=this.line.distance()){const e=Ia.convertUnits(t,"m",this._units,this.rounding);return`${Hh.valueFormatter?Hh.valueFormatter(e):e.toFixed(this.rounding)} ${this._units}`}set color(t){const e=`#${t.getHexString()}`;this.label.three.element.style.backgroundColor=e;for(const t of this._endpoints)t.three.element.style.borderColor=e;this._material.color.set(t)}}class vh{constructor(t){e(this,"id",Bt.create()),e(this,"points",new n),e(this,"tolerance",.005),e(this,"_plane",null),e(this,"_rounding",2),e(this,"_units","m2"),this.points.guard=t=>{const e=[...this.points].some(e=>e.equals(t)),i=this.isPointInPlane(t);return!e&&i},this.points.onItemAdded.add(t=>{if(this.plane){const e=new o.Vector3;this.plane.projectPoint(t,e),t.copy(e)}this.points.size<3||3===this.points.size&&this.computePlane()}),this.points.onItemDeleted.add(()=>{this.points.size>=3||(this._plane=null)}),this.points.onCleared.add(()=>{this._plane=null}),t&&this.points.add(...t)}get plane(){return this._plane}get _coordinateSystem(){if(!this.plane)return null;const t=this.plane.normal,e=new o.Vector3,i=new o.Vector3;return Math.abs(t.x)>Math.abs(t.z)?e.set(-t.y,t.x,0).normalize():e.set(0,-t.z,t.y).normalize(),i.crossVectors(t,e).normalize(),{normal:t.clone(),x:e.clone(),y:i.clone()}}get points2D(){if(!this.plane){if(!(this.points.size>=3))return null;this.computePlane()}return[...this.points].map(t=>this.convertPointTo2D(t)).filter(t=>null!==t)}get center(){if(!this.plane||this.points.size<3)return null;const t=this.points2D;if(!t||0===t.length)return null;const e=t.reduce((t,e)=>t.add(e),new o.Vector2).divideScalar(t.length);return this.convertPointTo3D(e)}get value(){return Ia.convertUnits(this.rawValue,"m2",this.units,this.rounding)}get rawValue(){const t=this.points2D;return t?Math.abs(o.ShapeUtils.area(t)):0}get boundingBox(){if(0===this.points.size)return null;const t=new o.Box3;for(const e of this.points)t.expandByPoint(e);return t}get perimeter(){const t=this.points2D;if(!t||t.length<2)return 0;let e=0;for(let i=0;i<t.length;i++){const s=t[i],n=t[(i+1)%t.length];e+=s.distanceTo(n)}return e}set rounding(t){this._rounding=t}get rounding(){return this._rounding}set units(t){this._units=t}get units(){return this._units}isPointInPlane(t){if(!this.plane)return!0;const e=this.plane.distanceToPoint(t);return Math.abs(e)<this.tolerance}clone(){const t=new vh([...this.points]);return t.units=this.units,t.rounding=this.rounding,t.tolerance=this.tolerance,t}computePlane(){const[t,e,i]=this.points;if(!(t&&e&&i))return null;const s=(new o.Vector3).subVectors(e,t),n=(new o.Vector3).subVectors(i,t),r=(new o.Vector3).crossVectors(s,n).normalize();return this._plane=(new o.Plane).setFromNormalAndCoplanarPoint(r,t),this.plane}convertPointTo2D(t){if(!this.isPointInPlane(t)||!this.plane)return null;const e=this._coordinateSystem;if(!e)return null;const i=new o.Vector3;this.plane.projectPoint(t,i);const s=i.dot(e.x),n=i.dot(e.y);return new o.Vector2(s,n)}convertPointTo3D(t){if(!this.plane)return null;const e=this._coordinateSystem;if(!e)return null;const{x:i,y:s,normal:n}=e;return(new o.Vector3).addScaledVector(i,t.x).addScaledVector(s,t.y).addScaledVector(n,-this.plane.constant)}}class _h{constructor(t){e(this,"_components"),e(this,"id",Bt.create()),e(this,"onItemsChanged",new At),e(this,"_items",{}),e(this,"_units","m3"),e(this,"_rounding",2),this._components=t}set items(t){this._items=t,this.onItemsChanged.trigger()}get items(){return this._items}set units(t){this._units=t}get units(){return this._units}set rounding(t){this._rounding=t}get rounding(){return this._rounding}async getRawValue(){return await this._components.get(Ia).getItemsVolume(this.items)}async getValue(){const t=await this.getRawValue();return Ia.convertUnits(t,"m3",this.units,this.rounding)}async getCenter(){return await this._components.get(_i).getCenter(this.items)}async getBox(){const t=this._components.get(_i);t.list.clear(),await t.addFromModelIdMap(this.items);const e=t.get();return t.list.clear(),e}clone(){const t=new _h(this._components);return t.items=ri.clone(this.items),t}}function yh(t,e,i=2){const s=t.length;let n=function(t,e,i,s,n){let r;if(n===function(t,e,i,s){let n=0;for(let r=e,o=i-s;r<i;r+=s)n+=(t[o]-t[r])*(t[r+1]+t[o+1]),o=r;return n}(t,e,i,s)>0)for(let n=e;n<i;n+=s)r=Nh(n/s|0,t[n],t[n+1],r);else for(let n=i-s;n>=e;n-=s)r=Nh(n/s|0,t[n],t[n+1],r);return r&&Oh(r,r.next)&&(Bh(r),r=r.next),r}(t,0,s,i,!0);const r=[];if(!n||n.next===n.prev)return r;let o,a,l;if(t.length>80*i){o=1/0,a=1/0;let e=-1/0,n=-1/0;for(let r=i;r<s;r+=i){const i=t[r],s=t[r+1];i<o&&(o=i),s<a&&(a=s),i>e&&(e=i),s>n&&(n=s)}l=Math.max(e-o,n-a),l=0!==l?32767/l:0}return bh(n,r,i,o,a,l,0),r}function wh(t,e){if(!t)return t;e||(e=t);let i,s=t;do{if(i=!1,s.steiner||!Oh(s,s.next)&&0!==Mh(s.prev,s,s.next))s=s.next;else{if(Bh(s),s=e=s.prev,s===s.next)break;i=!0}}while(i||s!==e);return e}function bh(t,e,i,s,n,r,o){if(!t)return;!o&&r&&function(t,e,i,s){let n=t;do{0===n.z&&(n.z=Th(n.x,n.y,e,i,s)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==t);n.prevZ.nextZ=null,n.prevZ=null,function(t){let e,i=1;do{let s,n=t;t=null;let r=null;for(e=0;n;){e++;let o=n,a=0;for(let t=0;t<i&&(a++,o=o.nextZ,o);t++);let l=i;for(;a>0||l>0&&o;)0!==a&&(0===l||!o||n.z<=o.z)?(s=n,n=n.nextZ,a--):(s=o,o=o.nextZ,l--),r?r.nextZ=s:t=s,s.prevZ=r,r=s;n=o}r.nextZ=null,i*=2}while(e>1)}(n)}(t,s,n,r);let a=t;for(;t.prev!==t.next;){const l=t.prev,h=t.next;if(r?Sh(t,s,n,r):xh(t))e.push(l.i,t.i,h.i),Bh(t),t=h.next,a=h.next;else if((t=h)===a){o?1===o?bh(t=Eh(wh(t),e),e,i,s,n,r,2):2===o&&Ch(t,e,i,s,n,r):bh(wh(t),e,i,s,n,r,1);break}}}function xh(t){const e=t.prev,i=t,s=t.next;if(Mh(e,i,s)>=0)return!1;const n=e.x,r=i.x,o=s.x,a=e.y,l=i.y,h=s.y,c=Math.min(n,r,o),d=Math.min(a,l,h),u=Math.max(n,r,o),p=Math.max(a,l,h);let f=s.next;for(;f!==e;){if(f.x>=c&&f.x<=u&&f.y>=d&&f.y<=p&&Ph(n,a,r,l,o,h,f.x,f.y)&&Mh(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function Sh(t,e,i,s){const n=t.prev,r=t,o=t.next;if(Mh(n,r,o)>=0)return!1;const a=n.x,l=r.x,h=o.x,c=n.y,d=r.y,u=o.y,p=Math.min(a,l,h),f=Math.min(c,d,u),m=Math.max(a,l,h),g=Math.max(c,d,u),v=Th(p,f,e,i,s),_=Th(m,g,e,i,s);let y=t.prevZ,w=t.nextZ;for(;y&&y.z>=v&&w&&w.z<=_;){if(y.x>=p&&y.x<=m&&y.y>=f&&y.y<=g&&y!==n&&y!==o&&Ph(a,c,l,d,h,u,y.x,y.y)&&Mh(y.prev,y,y.next)>=0||(y=y.prevZ,w.x>=p&&w.x<=m&&w.y>=f&&w.y<=g&&w!==n&&w!==o&&Ph(a,c,l,d,h,u,w.x,w.y)&&Mh(w.prev,w,w.next)>=0))return!1;w=w.nextZ}for(;y&&y.z>=v;){if(y.x>=p&&y.x<=m&&y.y>=f&&y.y<=g&&y!==n&&y!==o&&Ph(a,c,l,d,h,u,y.x,y.y)&&Mh(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;w&&w.z<=_;){if(w.x>=p&&w.x<=m&&w.y>=f&&w.y<=g&&w!==n&&w!==o&&Ph(a,c,l,d,h,u,w.x,w.y)&&Mh(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function Eh(t,e){let i=t;do{const s=i.prev,n=i.next.next;!Oh(s,n)&&Dh(s,i,i.next,n)&&kh(s,n)&&kh(n,s)&&(e.push(s.i,i.i,n.i),Bh(i),Bh(i.next),i=t=n),i=i.next}while(i!==t);return wh(i)}function Ch(t,e,i,s,n,r){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.i!==t.i&&Ah(o,t)){let a=Lh(o,t);return o=wh(o,o.next),a=wh(a,a.next),bh(o,e,i,s,n,r,0),void bh(a,e,i,s,n,r,0)}t=t.next}o=o.next}while(o!==t)}function Th(t,e,i,s,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*n|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*n|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Ph(t,e,i,s,n,r,o,a){return!(t===o&&e===a)&&function(t,e,i,s,n,r,o,a){return(n-o)*(e-a)>=(t-o)*(r-a)&&(t-o)*(s-a)>=(i-o)*(e-a)&&(i-o)*(r-a)>=(n-o)*(s-a)}(t,e,i,s,n,r,o,a)}function Ah(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Dh(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(kh(t,e)&&kh(e,t)&&function(t,e){let i=t,s=!1;const n=(t.x+e.x)/2,r=(t.y+e.y)/2;do{i.y>r!=i.next.y>r&&i.next.y!==i.y&&n<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next}while(i!==t);return s}(t,e)&&(Mh(t.prev,t,e.prev)||Mh(t,e.prev,e))||Oh(t,e)&&Mh(t.prev,t,t.next)>0&&Mh(e.prev,e,e.next)>0)}function Mh(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function Oh(t,e){return t.x===e.x&&t.y===e.y}function Dh(t,e,i,s){const n=Ih(Mh(t,e,i)),r=Ih(Mh(t,e,s)),o=Ih(Mh(i,s,t)),a=Ih(Mh(i,s,e));return!!(n!==r&&o!==a||0===n&&zh(t,i,e)||0===r&&zh(t,s,e)||0===o&&zh(i,t,s)||0===a&&zh(i,e,s))}function zh(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function Ih(t){return t>0?1:t<0?-1:0}function kh(t,e){return Mh(t.prev,t,t.next)<0?Mh(t,e,t.next)>=0&&Mh(t,t.prev,e)>=0:Mh(t,e,t.prev)<0||Mh(t,t.next,e)<0}function Lh(t,e){const i=Uh(t.i,t.x,t.y),s=Uh(e.i,e.x,e.y),n=t.next,r=e.prev;return t.next=e,e.prev=t,i.next=n,n.prev=i,s.next=i,i.prev=s,r.next=s,s.prev=r,s}function Nh(t,e,i,s){const n=Uh(t,e,i);return s?(n.next=s.next,n.prev=s,s.next.prev=n,s.next=n):(n.prev=n,n.next=n),n}function Bh(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Uh(t,e,i){return{i:t,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class Rh extends Ha{constructor(t){const i=document.createElement("div");i.style.backgroundColor="blue",i.style.color="white",i.style.padding="6px",i.style.borderRadius="6px",i.style.boxShadow="0px 4px 6px rgba(0, 0, 0, 0.6)",i.style.zIndex="-10",super(t,i),e(this,"_value",0),e(this,"_units","m2"),e(this,"_worldUnits","m2"),e(this,"_color",new o.Color),e(this,"_textColor",new o.Color),e(this,"_rounding",2),this.three.renderOrder=1,i.textContent=this.formattedValue}set value(t){this._value=t,this.three.element.textContent=this.formattedValue}get value(){return this._value}set units(t){this._units=t,this.three.element.textContent=this.formattedValue}get units(){return this._units}set worldUnits(t){this._worldUnits=t,this.three.element.textContent=this.formattedValue}get worldUnits(){return this._worldUnits}set color(t){this._color=t;const e=`#${t.getHexString()}`;this.three.element.style.backgroundColor=e}get color(){return this._color}set textColor(t){this._textColor=t;const e=`#${t.getHexString()}`;this.three.element.style.color=e}get textColor(){return this._textColor}set rounding(t){this._rounding=t,this.three.element.textContent=this.formattedValue}get rounding(){return this._rounding}get formattedValue(){const t=Ia.convertUnits(this.value,this.worldUnits,this.units,this.rounding);return`${Hh.valueFormatter?Hh.valueFormatter(t):t.toFixed(this.rounding)} ${this.units}`}}class Fh{constructor(t,i,s=new vh){e(this,"_root",new o.Group),e(this,"_components"),e(this,"_material",new o.MeshLambertMaterial({color:"red",transparent:!0,opacity:.5,side:o.DoubleSide,depthTest:!1})),e(this,"_visible",!0),e(this,"_color",new o.Color),e(this,"label"),e(this,"three",new o.Mesh),e(this,"world"),e(this,"area"),e(this,"_triggerUpdate",()=>this.update()),this._components=t,this.world=i,this.area=s,this.world.scene.three.add(this.three),this.label=new Rh(i),this._root.renderOrder=2,this.visible=!0,this.update(),s.points.onItemAdded.add(this._triggerUpdate),s.points.onItemDeleted.add(this._triggerUpdate),s.points.onCleared.add(this._triggerUpdate)}set material(t){this._material.dispose(),this._material=t,this.three.material=t}get material(){return this._material}set visible(t){this._visible=t,this.label.visible=t;const e=this.label.three;t?(this._root.add(e,this.three),this.world.scene.three.add(this._root)):(e.removeFromParent(),this._root.removeFromParent())}get visible(){return this._visible}set rounding(t){this.label.rounding=t}get rounding(){return this.label.rounding}set units(t){this.label.units=t}get units(){return this.label.units}set color(t){this._color=t,this.label.color=t,this._material.color.set(t)}get color(){return this._color}applyPlanesVisibility(t){if(!this.label.wasVisible)return;let e=!1;const i=this.area.center;if(i)for(const s of t)if(s.distanceToPoint(i)<0){e=!0;break}this.label.three.visible=!e}updateMesh(){if(this.area.points.size<3)return;const t=this.area.points2D;if(!t||t.length<3)return;const e=yh(t.flatMap(t=>[t.x,t.y])),i=[];for(const e of t){const t=this.area.convertPointTo3D(e);t&&i.push(t.x,t.y,t.z)}this.three.geometry&&this.three.geometry.dispose();const s=new o.BufferGeometry;s.setAttribute("position",new o.Float32BufferAttribute(i,3)),s.setIndex(e),this.three.geometry=s,this.three.material=this.material}update(){if(this.updateMesh(),0===this.area.rawValue)this.label.visible=!1;else{this.label.value=this.area.rawValue,this.label.visible=!0;const t=this.area.center;t&&this.label.three.position.copy(t)}}dispose(){this.label.dispose(),this._components.get(Lt).destroy(this._root,!0,!0),this.area.points.clear()}}const Vh={length:"m",area:"m2",volume:"m3"};class jh{constructor(t,i,s=new _h(t)){e(this,"_root",new o.Group),e(this,"_components"),e(this,"_material",new o.MeshLambertMaterial({color:"red",transparent:!0,opacity:.75,side:o.DoubleSide,depthTest:!1})),e(this,"_visible",!0),e(this,"_color",new o.Color),e(this,"label"),e(this,"world"),e(this,"volume"),e(this,"meshes",[]),this._components=t,this.world=i,this.volume=s,this.label=new Rh(i),this._root.renderOrder=2,this.visible=!0,this.update(),this.volume.onItemsChanged.add(()=>this.update())}set material(t){this._material.dispose(),this._material=t;for(const e of this.meshes)e.material=t}get material(){return this._material}set visible(t){this._visible=t,this.label.visible=t;for(const e of this.meshes)t?this.world.scene.three.add(e):e.removeFromParent()}get visible(){return this._visible}set rounding(t){this.label.rounding=t}get rounding(){return this.label.rounding}set units(t){this.label.units=t}get units(){return this.label.units}set color(t){this._color=t,this.label.color=t,this._material.color.set(t)}get color(){return this._color}applyPlanesVisibility(t){if(!this.label.wasVisible)return;let e=!1;for(const i of this.meshes){for(const s of t)if(s.distanceToPoint(i.position)<0){e=!0;break}this.label.three.visible=!e}}async updateMesh(){this.cleanMeshes();const t=this._components.get(Jl),e=await t.get(this.volume.items,{material:this.material});this.meshes=t.getMeshesFromResult(e);for(const t of this.meshes)this.world.scene.three.add(t)}async update(){this.updateMesh();const t=await this.volume.getRawValue();this.label.visible=0!==t,this.label.value=t;const e=await this.volume.getCenter();e&&this.label.three.position.copy(e)}cleanMeshes(){const t=this._components.get(Lt);for(const e of this.meshes)t.destroy(e,!0,!0);this._components.get(Jl).remove(),this.meshes=[]}dispose(){this.label.dispose(),this.cleanMeshes(),this.volume.items={}}}class Hh extends Ot{constructor(t,s){super(t),e(this,"list",new n),e(this,"onDisposed",new At),e(this,"snappings",[i.SnappingClass.LINE,i.SnappingClass.POINT,i.SnappingClass.FACE]),e(this,"lines",new n),e(this,"fills",new n),e(this,"labels",new n),e(this,"volumes",new n),e(this,"delay",300),e(this,"_world",null),e(this,"measureType"),e(this,"onPointerStop",new At),e(this,"onPointerMove",new At),e(this,"onStateChanged",new At),e(this,"pointerStopTimeout",null),e(this,"onMove",()=>{this.enabled&&(this._vertexPicker.updatePointer(),null!==this.pointerStopTimeout&&clearTimeout(this.pointerStopTimeout),this.pointerStopTimeout=window.setTimeout(()=>{this.onPointerStop.trigger()},this.delay),this.onPointerMove.trigger())}),e(this,"onKeydown",t=>{this.enabled&&"Escape"===t.key&&this.cancelCreation()}),e(this,"onEnabledChange",new At),e(this,"_enabled",!1),e(this,"onVisibilityChange",new At),e(this,"_visible",!0),e(this,"_units"),e(this,"_rounding",2),e(this,"_linesEndpointElement",fh()),e(this,"_linesMaterial",new o.LineBasicMaterial({color:"#0000FF",depthTest:!1})),e(this,"_fillsMaterial",new o.MeshLambertMaterial({color:2392594,side:o.DoubleSide,transparent:!0,opacity:.3,depthTest:!1})),e(this,"_volumesMaterial",new o.MeshLambertMaterial({color:2392594,side:o.DoubleSide,transparent:!0,opacity:.3,depthTest:!1})),e(this,"_color",new o.Color),e(this,"_vertexPicker",new ph(this.components)),e(this,"create",t=>{}),e(this,"endCreation",t=>{}),e(this,"cancelCreation",()=>{}),e(this,"delete",t=>{}),this.measureType=s,this._units=Vh[this.measureType],this.lines.onBeforeDelete.add(t=>t.dispose()),this.fills.onBeforeDelete.add(t=>t.dispose()),this.labels.onBeforeDelete.add(t=>t.dispose()),this.volumes.onBeforeDelete.add(t=>t.dispose()),this.list.onCleared.add(()=>{this.lines.clear(),this.fills.clear(),this.labels.clear(),this.volumes.clear()})}set world(t){this._world=t,this._vertexPicker.world=t}get world(){return this._world}get unitsList(){let t=[];return t="length"===this.measureType?["mm","cm","m","km"]:"area"===this.measureType?["mm2","cm2","m2","km2"]:["mm3","cm3","m3","km3"],t}setEvents(t){if(!this.world)throw new Error("Measurement: you must specify a world first!");if(this.world.isDisposing)return;if(!this.world.renderer)throw new Error("Measurement: the world needs a renderer!");const e=this.world.renderer.three.domElement.parentElement;e&&(e.removeEventListener("pointermove",this.onMove),window.removeEventListener("keydown",this.onKeydown),t&&(e.addEventListener("pointermove",this.onMove),window.addEventListener("keydown",this.onKeydown)))}set enabled(t){this._enabled=t,this._vertexPicker.enabled=t,this.setEvents(t),this.cancelCreation(),this.onEnabledChange.trigger(t),this.onStateChanged.trigger(["enabled"])}get enabled(){return this._enabled}set visible(t){this._visible=t;for(const e of this.lines)e.visible=t;for(const e of this.fills)e.visible=t;for(const e of this.volumes)e.visible=t;this.onVisibilityChange.trigger(t),this.onStateChanged.trigger(["visibility"])}get visible(){return this._visible}set units(t){let e;this._units=t,e=t.endsWith("2")?"area":t.endsWith("3")?"volume":"length";for(const e of this.list)(e instanceof mh||e instanceof vh||e instanceof _h)&&(e.units=t);if("length"===e)for(const e of this.lines)e.units=t;else if("area"===e)for(const e of this.fills)e.units=t;else if("volume"===e)for(const e of this.volumes)e.units=t;this.onStateChanged.trigger(["units"])}get units(){return this._units}set rounding(t){this._rounding=t;for(const e of this.list)"rounding"in e&&"number"==typeof e.rounding&&(e.rounding=t);for(const e of this.lines)e.rounding=t;for(const e of this.fills)e.rounding=t;for(const e of this.volumes)e.rounding=t;this.onStateChanged.trigger(["rounding"])}get rounding(){return this._rounding}set linesEndpointElement(t){this._linesEndpointElement=t;for(const e of this.lines)e.endpointElement=t}get linesEndpointElement(){return this._linesEndpointElement}set linesMaterial(t){this._linesMaterial.dispose(),this._linesMaterial=t;for(const e of this.lines)e.material=t}get linesMaterial(){return this._linesMaterial}set fillsMaterial(t){this._fillsMaterial.dispose(),this._fillsMaterial=t;for(const e of this.fills)e.material=t}get fillsMaterial(){return this._fillsMaterial}set volumesMaterial(t){this._volumesMaterial.dispose(),this._volumesMaterial=t;for(const e of this.volumes)e.material=t}get volumesMaterial(){return this._volumesMaterial}set color(t){this._color=t,this._linesMaterial.color.set(t),this._fillsMaterial.color.set(t),this._volumesMaterial.color.set(t);for(const e of this.lines)e.color=t;for(const e of this.fills)e.color=t;for(const e of this.volumes)e.color=t;this.onStateChanged.trigger(["color"])}get color(){return this._color}get pickerMode(){return this._vertexPicker.mode}set pickerMode(t){this._vertexPicker.mode=t}get snapDistance(){return this._vertexPicker.maxDistance}set snapDistance(t){this._vertexPicker.maxDistance=t}dispose(){this._vertexPicker.dispose(),this.list.clear(),this.linesMaterial.dispose(),this.fillsMaterial.dispose(),this.volumesMaterial.dispose(),this.onDisposed.trigger()}applyPlanesVisibility(t){for(const e of this.lines)e.applyPlanesVisibility(t);for(const e of this.fills)e.applyPlanesVisibility(t);for(const e of this.volumes)e.applyPlanesVisibility(t)}createLineElement(t,e=null){if(!this.world)throw new Error("Measurement: world is need!");return new gh(this.components,this.world,{line:t,startNormal:e??void 0,lineMaterial:this.linesMaterial,endpointElement:this.linesEndpointElement},this.rounding,this.units)}createFillElement(t){if(!this.world)throw new Error("Measurement: world is need!");const e=new Fh(this.components,this.world,t);return e.rounding=this.rounding,"area"===(this.units.endsWith("2")?"area":void 0)&&(e.units=this.units),e}createVolumeElement(t){if(!this.world)throw new Error("Measurement: world is need!");const e=new jh(this.components,this.world,t);return e.rounding=this.rounding,"volume"===(this.units.endsWith("3")?"volume":void 0)&&(e.units=this.units),e}addLineElementsFromPoints(t){for(let e=0;e<t.length;e++){const i=t[e],s=t[(e+1)%t.length],n=new mh(i,s),r=this.createLineElement(n);r.label.visible=!1,this.lines.add(r)}}getLineBoxes(){const t=[];for(const e of this.lines)t.push(e.boundingBox);return t}getFillBoxes(){const t=[];for(const e of this.fills)t.push(e.three);return t}async getVolumeBoxes(){const t=[];for(const e of this.volumes)t.push(e.meshes);return t}}e(Hh,"valueFormatter",null);const Wh=class t extends Hh{constructor(i){super(i,"area"),e(this,"pickTolerance",.1),e(this,"tolerance",.005),e(this,"modes",["free","square","face"]),e(this,"_mode","free"),e(this,"_temp",{isDragging:!1,area:new vh,lines:new n,point:new o.Vector3}),e(this,"_lineToAreaMap",new WeakMap),e(this,"computeLineElements",()=>{this._temp.lines.clear();const t=[...this._temp.area.points];if(this._temp.area.isPointInPlane(this._temp.point)&&t.push(this._temp.point),!(t.length<2)&&this.world)for(let e=0;e<t.length;e++){const i=t[e],s=t[(e+1)%t.length],n=new mh(i,s),r=this.createLineElement(n);this._temp.lines.add(r)}}),e(this,"create",async()=>{if(!this.enabled)return;if(!this.world)throw new Error("Area Measurement: world is not defined!");const t=await this._vertexPicker.get({snappingClasses:this.snappings});if(!t||!t.point)return;if("face"===this.mode){const e=t.facePoints;if(!e)return;const i=[];for(let t=0;t<e.length-2;t+=3){const s=e[t],n=e[t+1],r=e[t+2];i.push(new o.Vector3(s,n,r))}return this._temp.area.points.add(...i),void this.endCreation()}const{area:e,point:i}=this._temp;if(this._temp.isDragging||(e.tolerance=this.tolerance,e.points.clear(),this._temp.isDragging=!0),0===e.points.size&&i.copy(t.point),e.points.add(i.clone()),"square"===this.mode&&2===e.points.size&&t.normal){const[t,i]=e.points,s=(new o.Vector3).subVectors(i,t),n=s.clone(),r=s.clone().negate();Math.abs(s.y)>=.1?(n.y=0,r.y=0):(n.x=0,r.x=0);const a=t.clone().add(n),l=i.clone().add(r);e.points.clear(),e.points.add(t,a,i,l),this.endCreation()}}),e(this,"endCreation",()=>{this.enabled&&(this._temp.isDragging=!1,this._temp.area.points.size>=3&&this.list.add(this._temp.area.clone()),this._temp.area.points.clear(),this._temp.lines.clear())}),e(this,"cancelCreation",()=>{this.enabled&&(this._temp.isDragging=!1,this._temp.area.points.clear(),this._temp.lines.clear())}),e(this,"delete",()=>{if(!this.enabled||0===this.list.size||!this.world)return;const t=this.getFillBoxes(),e=this.components.get(Mi).get(this.world).castRayToObjects(t);if(!e)return;const i=[...this.fills].find(t=>t.three===e.object);if(!i)return;const s=i.area;this.fills.delete(i),this.list.delete(s),this.components.get(Lt).destroy(e.object)}),i.add(t.uuid,this),this.initHandlers(),this.color=new o.Color("#6528d7")}get mode(){return this._mode}set mode(t){this._mode=t,this.cancelCreation(),this.onStateChanged.trigger(["mode"])}initHandlers(){this.onVisibilityChange.add(()=>{for(const t of this.lines)t.label.visible=!1}),this.list.onItemAdded.add(t=>{if(!this.world)return;const e=this.createFillElement(t);e.color=this.color,this.fills.add(e),this.addLineElementsFromPointsForArea([...t.points],t)}),this.list.onBeforeDelete.add(t=>{const e=[...this.fills].find(e=>e.area===t);e&&this.fills.delete(e);const i=[];for(const e of this.lines)this._lineToAreaMap.get(e)===t&&i.push(e);for(const t of i)this.lines.delete(t),this._lineToAreaMap.delete(t)}),this.onPointerStop.add(()=>this.updatePreview()),this._temp.lines.onItemAdded.add(t=>t.label.visible=!1),this._temp.lines.onBeforeDelete.add(t=>t.dispose()),this._temp.area.points.onItemAdded.add(()=>{this.computeLineElements()}),this._temp.area.points.onItemDeleted.add(()=>{this._temp.lines.clear()}),this.onStateChanged.add(t=>{t.includes("rounding")&&(this._temp.area.rounding=this.rounding),t.includes("units")&&(this._temp.area.units=this.units)})}async updatePreview(){if(!this.enabled||!this.world)throw new Error("Measurement is not enabled or world is not defined!");const t=await this._vertexPicker.get({snappingClasses:this.snappings});if(!(t&&t.point&&this._temp.isDragging))return;const e=t.point.clone(),{plane:i}=this._temp.area;if(i){const t=i.distanceToPoint(e);if(Math.abs(t)<.1){const t=new o.Vector3;i.projectPoint(e,t),e.copy(t)}}this._temp.point.copy(e),this.computeLineElements()}addLineElementsFromPointsForArea(t,e){for(let i=0;i<t.length;i++){const s=t[i],n=t[(i+1)%t.length],r=new mh(s,n),o=this.createLineElement(r);o.label.visible=!1,this.lines.add(o),this._lineToAreaMap.set(o,e)}}};e(Wh,"uuid","09b78c1f-0ff1-4630-a818-ceda3d878c75");let Gh=Wh;const Zh=class t extends Hh{constructor(i){super(i,"length"),e(this,"_temp",{isDragging:!1,line:new mh}),e(this,"modes",["free","edge"]),e(this,"_mode","free"),e(this,"create",async()=>{if(this.enabled){if(!this._temp.isDragging)return void await this.initPreview();this.endCreation()}}),e(this,"endCreation",()=>{this.enabled&&this._temp.dimension&&(this.list.add(this._temp.line.clone()),"free"===this.mode&&(this._temp.dimension.dispose(),this._temp.dimension=void 0,this._temp.isDragging=!1,this._temp.startNormal=void 0))}),e(this,"cancelCreation",()=>{var t;this.enabled&&(this._temp.isDragging=!1,this._temp.dimension&&(null==(t=this._temp.dimension)||t.dispose(),this._temp.dimension=void 0))}),e(this,"delete",()=>{if(!this.enabled||0===this.list.size||!this.world)return;const t=this.getLineBoxes(),e=this.components.get(Mi).get(this.world).castRayToObjects(t);if(!e)return;const i=[...this.lines].find(t=>t.boundingBox===e.object);i&&this.list.delete(i.line)}),i.add(t.uuid,this),this.initHandlers()}get mode(){return this._mode}set mode(t){this._mode=t,this.cancelCreation(),"edge"===t&&this.initPreview(),this.onStateChanged.trigger(["mode"])}get isDragging(){return this._temp.isDragging}initHandlers(){this.list.onItemAdded.add(t=>{const e=this.createLineElement(t,this._temp.startNormal);e.createBoundingBox(),this.lines.add(e)}),this.list.onBeforeDelete.add(t=>{const e=[...this.lines].find(e=>e.line===t);e&&this.lines.delete(e)}),this.onPointerStop.add(()=>this.updatePreviewLine()),this.onEnabledChange.add(t=>{t&&"edge"===this.mode&&this.initPreview()})}async initPreview(){if(!this.world)throw new Error("Measurement: world is need!");const t=await this._vertexPicker.get({snappingClasses:this.snappings});if("free"===this.mode){if(null==t||!t.point)return;const e=t.point;this._temp.line.set(e,e.clone()),this._temp.isDragging=!0,this._temp.dimension=this.createLineElement(this._temp.line),this._temp.startNormal=t.normal??void 0}else if("edge"===this.mode){const e=null==t?void 0:t.snappedEdgeP1,i=null==t?void 0:t.snappedEdgeP2,s=e||new o.Vector3,n=s||i;this._temp.line.set(s,n),this._temp.isDragging=!0,this._temp.dimension=this.createLineElement(this._temp.line),this._temp.dimension.visible=!(!e||!i)}}async updatePreviewLine(){if(!this.world)throw new Error("Measurement: world is need!");const t=await this._vertexPicker.get({snappingClasses:this.snappings});if("free"===this.mode){if(null==t||!t.point||(this._temp.line.end.copy(t.point),!this._temp.dimension))return;this._temp.dimension.end=this._temp.line.end}else if("edge"===this.mode){const e=null==t?void 0:t.snappedEdgeP1,i=null==t?void 0:t.snappedEdgeP2;if(this._temp.dimension&&(this._temp.dimension.visible=!(!e||!i)),!e||!i||(this._temp.line.start.copy(e),this._temp.line.end.copy(i),!this._temp.dimension))return;this._temp.dimension.start=this._temp.line.start,this._temp.dimension.end=this._temp.line.end}}};e(Zh,"uuid","2f9bcacf-18a9-4be6-a293-e898eae64ea1");let Yh=Zh;const Xh=class t extends Hh{constructor(i){super(i,"volume"),e(this,"_temp",{}),e(this,"onPreviewInitialized",new At),e(this,"modes",["free"]),e(this,"_mode","free"),e(this,"_previousHovererState",!1),e(this,"create",async()=>{if(!this.enabled)return;const t=await this._vertexPicker.get();t&&(this._temp.preview||await this.initPreview(),this._temp.preview.volume.items=ri.join([this._temp.preview.volume.items,{[t.fragments.modelId]:new Set([t.localId])}]))}),e(this,"endCreation",()=>{if(!this._temp.preview||ri.isEmpty(this._temp.preview.volume.items))return;const t=this._temp.preview.volume.clone();this.list.add(t),this._temp.preview.dispose(),delete this._temp.preview}),e(this,"cancelCreation",()=>{var t;null==(t=this._temp.preview)||t.dispose(),delete this._temp.preview}),e(this,"delete",async()=>{if(0===this.list.size||!this.world)return;const t=await this.getVolumeBoxes(),e=this.components.get(Mi).get(this.world);for(const i of t){const t=e.castRayToObjects(i);if(!t)continue;const s=[...this.volumes].find(e=>e.meshes.some(e=>e===t.object));if(!s)return;this.list.delete(s.volume)}}),i.add(t.uuid,this),this.initHandlers()}get mode(){return this._mode}set mode(t){this._mode=t,this.cancelCreation(),this.onStateChanged.trigger(["mode"])}initHandlers(){this.list.onItemAdded.add(t=>{const e=this.createVolumeElement(t);e.color=this.color,e.rounding=this.rounding,e.units=this.units,this.volumes.add(e)}),this.list.onBeforeDelete.add(t=>{const e=[...this.volumes].find(e=>e.volume===t);e&&this.volumes.delete(e)}),this.onStateChanged.add(t=>{if(t.includes("color")){if(!this._temp.preview)return;this._temp.preview.color=this.color}if(t.includes("units")){if(!this._temp.preview)return;this._temp.preview.units=this.units}if(t.includes("rounding")){if(!this._temp.preview)return;this._temp.preview.rounding=this.rounding}if(t.includes("enabled")){const t=this.components.get(ih);t.world=this.world,this.enabled?(this._previousHovererState=t.enabled,t.enabled=!0):(t.clear(),t.enabled=this._previousHovererState),t.hover()}})}async initPreview(){if(this.enabled){if(!this.world)throw new Error("Measurement: world is need!");this._temp.preview=new jh(this.components,this.world),this._temp.preview.color=this.color,this._temp.preview.rounding=this.rounding,this._temp.preview.units=this.units,this.onPreviewInitialized.trigger(this._temp.preview)}}};e(Xh,"uuid","01f885ab-ec4e-4e6c-a853-9dfc0d6766ed");let qh=Xh;export{vh as Area,Gh as AreaMeasurement,ch as CivilCrossSectionNavigator,lh as CivilMarkerType,ah as CivilNavigators,sh as CivilRaycaster,nh as CivilUtils,Zl as ClipEdges,Xl as ClipStyler,gh as DimensionLine,gl as EdgeDetectionPassMode,bl as GlossPass,ph as GraphicVertexPicker,dh as GraphicVertexPickerMode,Ql as Highlighter,ih as Hoverer,Yh as LengthMeasurement,mh as Line,Ha as Mark,Za as Marker,Fh as MeasureFill,Rh as MeasureMark,Hh as Measurement,Jl as Mesher,th as Outliner,La as PlatformComponents,xl as PostproductionAspect,El as PostproductionRenderer,Wa as RendererWith2D,_h as Volume,qh as VolumeMeasurement};
